

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>agi_cluster.agi_distributor.agi_distributor &mdash; AGILab 2025.12.12 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css?v=4ae1632d" />
      <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-design.min.css?v=95c83b7e" />
      <link rel="stylesheet" type="text/css" href="../../../_static/custom.css?v=d96b187f" />

  
    <link rel="canonical" href="https://thalesgroup.github.io/agilab/_modules/agi_cluster/agi_distributor/agi_distributor.html" />
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=b39c3bb1"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../../_static/design-tabs.js?v=f930bc37"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            AGILab
              <img src="../../../_static/agi_logo.svg" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../quick-start.html">Quick-Start</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../quick-start.html#prerequisites">Prerequisites</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../quick-start.html#license">LICENSE</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../quick-start.html#install-agilab">Install Agilab</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../quick-start.html#cluster-installs">Cluster installs</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../quick-start.html#next-steps">Next steps</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../quick-start.html#support">Support</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../introduction.html">Introduction</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../introduction.html#overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../introduction.html#purpose"><strong>Purpose</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../introduction.html#target-audience"><strong>Target Audience</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../introduction.html#main-dependencies"><strong>Main Dependencies</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../introduction.html#technologies-selection-criteria"><strong>Technologies Selection Criteria</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../introduction.html#example-aircraft-radio-communication">Example: Aircraft Radio Communication</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../features.html">Features</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../features.html#agi-core">agi-core</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../features.html#agilab">agilab</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Core Topics</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../cluster.html">Cluster</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../cluster-help.html">Cluster Help</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../cluster-help.html#overview">Overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../cluster-help.html#principle">Principle</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../key-generation.html">Key Generation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../key-generation.html#generate-the-keys">1. Generate the keys</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../key-generation.html#loading-the-private-key-in-ssh-agent">2. Loading the private key in SSH Agent</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../key-generation.html#load-the-private-key">2.1 Load the private key</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../key-generation.html#verify-the-key-addition">2.2 Verify the key Addition</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../key-generation.html#copy-the-public-key-to-the-server">3. Copy the public key to the server</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../key-generation.html#allow-your-key">3.1 Allow your key</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../key-generation.html#verification">3.2 Verification</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../key-generation.html#bidirectional-trust-between-worker-macs">Bidirectional trust between worker Macs</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../key-generation.html#troubleshooting">Troubleshooting</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../key-generation.html#sshd-service">SSHD Service</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../key-generation.html#useful-links">Useful links</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../cluster-help.html">Cluster Help</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../cluster-help.html#overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../cluster-help.html#principle">Principle</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../agilab.html">AGILab</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../architecture.html">AGILab Architecture</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../architecture.html#component-view">Component view</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../architecture.html#pipeline-example">Pipeline example</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../architecture.html#agilab-py-navigation">AGILAB.py navigation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../architecture.html#manager-vs-worker-responsibilities">Manager vs worker responsibilities</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../architecture.html#layers-at-a-glance">Layers at a glance</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../architecture.html#runtime-flow">Runtime flow</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../architecture.html#repository-map">Repository map</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../architecture.html#core-vs-optional-apps">Core vs optional apps</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../architecture.html#documentation-map">Documentation map</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../architecture.html#see-also">See also</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../agi-core-architecture.html">AGI Core Architecture</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../agi-core-architecture.html#modules-at-a-glance">Modules at a glance</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../agi-core-architecture.html#execution-flow">Execution flow</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../agi-core-architecture.html#repository-pointers">Repository pointers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../agi-core-architecture.html#tips-for-contributions">Tips for contributions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../agi-core-architecture.html#see-also">See also</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../agilab-mlops-positioning.html">AGILab in the MLOps Toolchain</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../agilab-mlops-positioning.html#where-agilab-helps">Where AGILab helps</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../agilab-mlops-positioning.html#what-agilab-does-not-aim-to-cover">What AGILab does <em>not</em> aim to cover</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../agilab-mlops-positioning.html#positioning-vs-other-tools">Positioning vs. other tools</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../agilab-mlops-positioning.html#suggested-workflow">Suggested workflow</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../agilab-mlops-positioning.html#see-also">See also</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../learning-workflows.html">Learning Workflows</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../learning-workflows.html#training-vs-inference">Training vs inference</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../learning-workflows.html#reinforcement-learning-example">Reinforcement learning (example)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../learning-workflows.html#optimization-ilp-baseline-example">Optimization / ILP baseline (example)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../learning-workflows.html#continuous-learning-optional">Continuous learning (optional)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../learning-workflows.html#graph-neural-networks-message-passing">Graph neural networks (message passing)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../learning-workflows.html#federated-learning-optional">Federated learning (optional)</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../framework-api.html">Framework API</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../framework-api.html#core-packages">Core packages</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../agi-env.html">agi-env API</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../agi-env.html#usage-example">Usage Example</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../agi-env.html#reference">Reference</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../agi-node.html">agi-node API</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../agi-node.html#path-handling">Path handling</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../agi-node.html#argument-helpers">Argument helpers</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../agi-node.html#managed-pc-path-remapping">Managed PC path remapping</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../agi-node.html#output-directory-helpers">Output directory helpers</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../agi-node.html#reference">Reference</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../agi-distributor.html">agi-distributor API</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../agi-distributor.html#usage-example">Usage Example</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../agi-distributor.html#reference">Reference</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../framework-api.html#working-with-the-api">Working with the API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../framework-api.html#app-structure-conventions">App structure conventions</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../modules.html">Module Reference</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../module-agi-env.html">agi_env package</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../module-agi-env.html#notes-on-singleton-and-preinit-behavior">Notes on singleton and preâ€‘init behavior</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../module-agi-env.html#agi_env.agi_env.AgiEnv"><code class="docutils literal notranslate"><span class="pre">AgiEnv</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-env.html#agi_env.agi_env.AgiEnv.EXTRA_INDEX_URL"><code class="docutils literal notranslate"><span class="pre">AgiEnv.EXTRA_INDEX_URL</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-env.html#agi_env.agi_env.AgiEnv.GUI_SAMPLING"><code class="docutils literal notranslate"><span class="pre">AgiEnv.GUI_SAMPLING</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-env.html#agi_env.agi_env.AgiEnv.INDEX_URL"><code class="docutils literal notranslate"><span class="pre">AgiEnv.INDEX_URL</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-env.html#agi_env.agi_env.AgiEnv.TABLE_MAX_ROWS"><code class="docutils literal notranslate"><span class="pre">AgiEnv.TABLE_MAX_ROWS</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-env.html#agi_env.agi_env.AgiEnv.__init__"><code class="docutils literal notranslate"><span class="pre">AgiEnv.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-env.html#agi_env.agi_env.AgiEnv.active"><code class="docutils literal notranslate"><span class="pre">AgiEnv.active()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-env.html#agi_env.agi_env.AgiEnv.app"><code class="docutils literal notranslate"><span class="pre">AgiEnv.app</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-env.html#agi_env.agi_env.AgiEnv.apps_path"><code class="docutils literal notranslate"><span class="pre">AgiEnv.apps_path</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-env.html#agi_env.agi_env.AgiEnv.apps_repository_root"><code class="docutils literal notranslate"><span class="pre">AgiEnv.apps_repository_root</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-env.html#agi_env.agi_env.AgiEnv.benchmark"><code class="docutils literal notranslate"><span class="pre">AgiEnv.benchmark</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-env.html#agi_env.agi_env.AgiEnv.change_app"><code class="docutils literal notranslate"><span class="pre">AgiEnv.change_app()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-env.html#agi_env.agi_env.AgiEnv.check_internet"><code class="docutils literal notranslate"><span class="pre">AgiEnv.check_internet()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-env.html#agi_env.agi_env.AgiEnv.clone_directory"><code class="docutils literal notranslate"><span class="pre">AgiEnv.clone_directory()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-env.html#agi_env.agi_env.AgiEnv.clone_project"><code class="docutils literal notranslate"><span class="pre">AgiEnv.clone_project()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-env.html#agi_env.agi_env.AgiEnv.copy_existing_projects"><code class="docutils literal notranslate"><span class="pre">AgiEnv.copy_existing_projects()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-env.html#agi_env.agi_env.AgiEnv.create_junction_windows"><code class="docutils literal notranslate"><span class="pre">AgiEnv.create_junction_windows()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-env.html#agi_env.agi_env.AgiEnv.create_rename_map"><code class="docutils literal notranslate"><span class="pre">AgiEnv.create_rename_map()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-env.html#agi_env.agi_env.AgiEnv.create_symlink"><code class="docutils literal notranslate"><span class="pre">AgiEnv.create_symlink()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-env.html#agi_env.agi_env.AgiEnv.create_symlink_windows"><code class="docutils literal notranslate"><span class="pre">AgiEnv.create_symlink_windows()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-env.html#agi_env.agi_env.AgiEnv.current"><code class="docutils literal notranslate"><span class="pre">AgiEnv.current()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-env.html#agi_env.agi_env.AgiEnv.debug"><code class="docutils literal notranslate"><span class="pre">AgiEnv.debug</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-env.html#agi_env.agi_env.AgiEnv.envars"><code class="docutils literal notranslate"><span class="pre">AgiEnv.envars</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-env.html#agi_env.agi_env.AgiEnv.err_log"><code class="docutils literal notranslate"><span class="pre">AgiEnv.err_log</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-env.html#agi_env.agi_env.AgiEnv.extract_base_info"><code class="docutils literal notranslate"><span class="pre">AgiEnv.extract_base_info()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-env.html#agi_env.agi_env.AgiEnv.get_base_classes"><code class="docutils literal notranslate"><span class="pre">AgiEnv.get_base_classes()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-env.html#agi_env.agi_env.AgiEnv.get_base_worker_cls"><code class="docutils literal notranslate"><span class="pre">AgiEnv.get_base_worker_cls()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-env.html#agi_env.agi_env.AgiEnv.get_full_attribute_name"><code class="docutils literal notranslate"><span class="pre">AgiEnv.get_full_attribute_name()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-env.html#agi_env.agi_env.AgiEnv.get_import_mapping"><code class="docutils literal notranslate"><span class="pre">AgiEnv.get_import_mapping()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-env.html#agi_env.agi_env.AgiEnv.get_projects"><code class="docutils literal notranslate"><span class="pre">AgiEnv.get_projects()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-env.html#agi_env.agi_env.AgiEnv.has_admin_rights"><code class="docutils literal notranslate"><span class="pre">AgiEnv.has_admin_rights()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-env.html#agi_env.agi_env.AgiEnv.has_agilab_anywhere_under_home"><code class="docutils literal notranslate"><span class="pre">AgiEnv.has_agilab_anywhere_under_home()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-env.html#agi_env.agi_env.AgiEnv.humanize_validation_errors"><code class="docutils literal notranslate"><span class="pre">AgiEnv.humanize_validation_errors()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-env.html#agi_env.agi_env.AgiEnv.hw_rapids_capable"><code class="docutils literal notranslate"><span class="pre">AgiEnv.hw_rapids_capable</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-env.html#agi_env.agi_env.AgiEnv.init_done"><code class="docutils literal notranslate"><span class="pre">AgiEnv.init_done</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-env.html#agi_env.agi_env.AgiEnv.init_envars_app"><code class="docutils literal notranslate"><span class="pre">AgiEnv.init_envars_app()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-env.html#agi_env.agi_env.AgiEnv.install_type"><code class="docutils literal notranslate"><span class="pre">AgiEnv.install_type</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-env.html#agi_env.agi_env.AgiEnv.is_local"><code class="docutils literal notranslate"><span class="pre">AgiEnv.is_local()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-env.html#agi_env.agi_env.AgiEnv.is_local_worker"><code class="docutils literal notranslate"><span class="pre">AgiEnv.is_local_worker</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-env.html#agi_env.agi_env.AgiEnv.is_source_env"><code class="docutils literal notranslate"><span class="pre">AgiEnv.is_source_env</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-env.html#agi_env.agi_env.AgiEnv.is_valid_ip"><code class="docutils literal notranslate"><span class="pre">AgiEnv.is_valid_ip()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-env.html#agi_env.agi_env.AgiEnv.is_worker_env"><code class="docutils literal notranslate"><span class="pre">AgiEnv.is_worker_env</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-env.html#agi_env.agi_env.AgiEnv.locate_agi_installation"><code class="docutils literal notranslate"><span class="pre">AgiEnv.locate_agi_installation()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-env.html#agi_env.agi_env.AgiEnv.locate_agilab_installation"><code class="docutils literal notranslate"><span class="pre">AgiEnv.locate_agilab_installation()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-env.html#agi_env.agi_env.AgiEnv.log_info"><code class="docutils literal notranslate"><span class="pre">AgiEnv.log_info()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-env.html#agi_env.agi_env.AgiEnv.logger"><code class="docutils literal notranslate"><span class="pre">AgiEnv.logger</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-env.html#agi_env.agi_env.AgiEnv.mode2int"><code class="docutils literal notranslate"><span class="pre">AgiEnv.mode2int()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-env.html#agi_env.agi_env.AgiEnv.mode2str"><code class="docutils literal notranslate"><span class="pre">AgiEnv.mode2str()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-env.html#agi_env.agi_env.AgiEnv.out_log"><code class="docutils literal notranslate"><span class="pre">AgiEnv.out_log</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-env.html#agi_env.agi_env.AgiEnv.pyvers_worker"><code class="docutils literal notranslate"><span class="pre">AgiEnv.pyvers_worker</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-env.html#agi_env.agi_env.AgiEnv.read_agilab_path"><code class="docutils literal notranslate"><span class="pre">AgiEnv.read_agilab_path()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-env.html#agi_env.agi_env.AgiEnv.read_gitignore"><code class="docutils literal notranslate"><span class="pre">AgiEnv.read_gitignore()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-env.html#agi_env.agi_env.AgiEnv.replace_content"><code class="docutils literal notranslate"><span class="pre">AgiEnv.replace_content()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-env.html#agi_env.agi_env.AgiEnv.reset"><code class="docutils literal notranslate"><span class="pre">AgiEnv.reset()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-env.html#agi_env.agi_env.AgiEnv.resolve_share_path"><code class="docutils literal notranslate"><span class="pre">AgiEnv.resolve_share_path()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-env.html#agi_env.agi_env.AgiEnv.resources_path"><code class="docutils literal notranslate"><span class="pre">AgiEnv.resources_path</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-env.html#agi_env.agi_env.AgiEnv.run"><code class="docutils literal notranslate"><span class="pre">AgiEnv.run()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-env.html#agi_env.agi_env.AgiEnv.run_agi"><code class="docutils literal notranslate"><span class="pre">AgiEnv.run_agi()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-env.html#agi_env.agi_env.AgiEnv.run_async"><code class="docutils literal notranslate"><span class="pre">AgiEnv.run_async()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-env.html#agi_env.agi_env.AgiEnv.set_env_var"><code class="docutils literal notranslate"><span class="pre">AgiEnv.set_env_var()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-env.html#agi_env.agi_env.AgiEnv.share_root_path"><code class="docutils literal notranslate"><span class="pre">AgiEnv.share_root_path()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-env.html#agi_env.agi_env.AgiEnv.skip_repo_links"><code class="docutils literal notranslate"><span class="pre">AgiEnv.skip_repo_links</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-env.html#agi_env.agi_env.AgiEnv.snippet_tail"><code class="docutils literal notranslate"><span class="pre">AgiEnv.snippet_tail</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-env.html#agi_env.agi_env.AgiEnv.target"><code class="docutils literal notranslate"><span class="pre">AgiEnv.target</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-env.html#agi_env.agi_env.AgiEnv.unzip_data"><code class="docutils literal notranslate"><span class="pre">AgiEnv.unzip_data()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-env.html#agi_env.agi_env.AgiEnv.uv"><code class="docutils literal notranslate"><span class="pre">AgiEnv.uv</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-env.html#agi_env.agi_env.AgiEnv.verbose"><code class="docutils literal notranslate"><span class="pre">AgiEnv.verbose</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../module-agi-env.html#agi_env.agi_env.ContentRenamer"><code class="docutils literal notranslate"><span class="pre">ContentRenamer</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-env.html#agi_env.agi_env.ContentRenamer.__init__"><code class="docutils literal notranslate"><span class="pre">ContentRenamer.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-env.html#agi_env.agi_env.ContentRenamer.generic_visit"><code class="docutils literal notranslate"><span class="pre">ContentRenamer.generic_visit()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-env.html#agi_env.agi_env.ContentRenamer.visit"><code class="docutils literal notranslate"><span class="pre">ContentRenamer.visit()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-env.html#agi_env.agi_env.ContentRenamer.visit_AnnAssign"><code class="docutils literal notranslate"><span class="pre">ContentRenamer.visit_AnnAssign()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-env.html#agi_env.agi_env.ContentRenamer.visit_Assign"><code class="docutils literal notranslate"><span class="pre">ContentRenamer.visit_Assign()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-env.html#agi_env.agi_env.ContentRenamer.visit_Attribute"><code class="docutils literal notranslate"><span class="pre">ContentRenamer.visit_Attribute()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-env.html#agi_env.agi_env.ContentRenamer.visit_ClassDef"><code class="docutils literal notranslate"><span class="pre">ContentRenamer.visit_ClassDef()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-env.html#agi_env.agi_env.ContentRenamer.visit_Constant"><code class="docutils literal notranslate"><span class="pre">ContentRenamer.visit_Constant()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-env.html#agi_env.agi_env.ContentRenamer.visit_For"><code class="docutils literal notranslate"><span class="pre">ContentRenamer.visit_For()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-env.html#agi_env.agi_env.ContentRenamer.visit_FunctionDef"><code class="docutils literal notranslate"><span class="pre">ContentRenamer.visit_FunctionDef()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-env.html#agi_env.agi_env.ContentRenamer.visit_Global"><code class="docutils literal notranslate"><span class="pre">ContentRenamer.visit_Global()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-env.html#agi_env.agi_env.ContentRenamer.visit_Import"><code class="docutils literal notranslate"><span class="pre">ContentRenamer.visit_Import()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-env.html#agi_env.agi_env.ContentRenamer.visit_ImportFrom"><code class="docutils literal notranslate"><span class="pre">ContentRenamer.visit_ImportFrom()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-env.html#agi_env.agi_env.ContentRenamer.visit_Name"><code class="docutils literal notranslate"><span class="pre">ContentRenamer.visit_Name()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-env.html#agi_env.agi_env.ContentRenamer.visit_arg"><code class="docutils literal notranslate"><span class="pre">ContentRenamer.visit_arg()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-env.html#agi_env.agi_env.ContentRenamer.visit_nonlocal"><code class="docutils literal notranslate"><span class="pre">ContentRenamer.visit_nonlocal()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../module-agi-env.html#agi_env.agi_env.is_packaging_cmd"><code class="docutils literal notranslate"><span class="pre">is_packaging_cmd()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../module-agi-env.html#agi_env.agi_env.normalize_path"><code class="docutils literal notranslate"><span class="pre">normalize_path()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../module-agi-env.html#agi_env.agi_env.parse_level"><code class="docutils literal notranslate"><span class="pre">parse_level()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../module-agi-env.html#agi_env.agi_env.strip_time_level_prefix"><code class="docutils literal notranslate"><span class="pre">strip_time_level_prefix()</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../module-agi-node.html">agi_node package</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../module-agi-node.html#agi_node.dag_worker.dag_worker.DagWorker"><code class="docutils literal notranslate"><span class="pre">DagWorker</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-node.html#agi_node.dag_worker.dag_worker.DagWorker.args_dump_mode"><code class="docutils literal notranslate"><span class="pre">DagWorker.args_dump_mode</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-node.html#agi_node.dag_worker.dag_worker.DagWorker.args_dumper"><code class="docutils literal notranslate"><span class="pre">DagWorker.args_dumper</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-node.html#agi_node.dag_worker.dag_worker.DagWorker.args_ensure_defaults"><code class="docutils literal notranslate"><span class="pre">DagWorker.args_ensure_defaults</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-node.html#agi_node.dag_worker.dag_worker.DagWorker.args_loader"><code class="docutils literal notranslate"><span class="pre">DagWorker.args_loader</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-node.html#agi_node.dag_worker.dag_worker.DagWorker.args_merger"><code class="docutils literal notranslate"><span class="pre">DagWorker.args_merger</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-node.html#agi_node.dag_worker.dag_worker.DagWorker.as_dict"><code class="docutils literal notranslate"><span class="pre">DagWorker.as_dict()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-node.html#agi_node.dag_worker.dag_worker.DagWorker.break"><code class="docutils literal notranslate"><span class="pre">DagWorker.break()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-node.html#agi_node.dag_worker.dag_worker.DagWorker.break_loop"><code class="docutils literal notranslate"><span class="pre">DagWorker.break_loop()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-node.html#agi_node.dag_worker.dag_worker.DagWorker.default_settings_path"><code class="docutils literal notranslate"><span class="pre">DagWorker.default_settings_path</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-node.html#agi_node.dag_worker.dag_worker.DagWorker.default_settings_section"><code class="docutils literal notranslate"><span class="pre">DagWorker.default_settings_section</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-node.html#agi_node.dag_worker.dag_worker.DagWorker.env"><code class="docutils literal notranslate"><span class="pre">DagWorker.env</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-node.html#agi_node.dag_worker.dag_worker.DagWorker.expand"><code class="docutils literal notranslate"><span class="pre">DagWorker.expand()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-node.html#agi_node.dag_worker.dag_worker.DagWorker.expand_and_join"><code class="docutils literal notranslate"><span class="pre">DagWorker.expand_and_join()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-node.html#agi_node.dag_worker.dag_worker.DagWorker.from_toml"><code class="docutils literal notranslate"><span class="pre">DagWorker.from_toml()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-node.html#agi_node.dag_worker.dag_worker.DagWorker.get_work"><code class="docutils literal notranslate"><span class="pre">DagWorker.get_work()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-node.html#agi_node.dag_worker.dag_worker.DagWorker.loop"><code class="docutils literal notranslate"><span class="pre">DagWorker.loop()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-node.html#agi_node.dag_worker.dag_worker.DagWorker.managed_pc_home_suffix"><code class="docutils literal notranslate"><span class="pre">DagWorker.managed_pc_home_suffix</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-node.html#agi_node.dag_worker.dag_worker.DagWorker.managed_pc_path_fields"><code class="docutils literal notranslate"><span class="pre">DagWorker.managed_pc_path_fields</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-node.html#agi_node.dag_worker.dag_worker.DagWorker.normalize_dataset_path"><code class="docutils literal notranslate"><span class="pre">DagWorker.normalize_dataset_path()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-node.html#agi_node.dag_worker.dag_worker.DagWorker.prepare_output_dir"><code class="docutils literal notranslate"><span class="pre">DagWorker.prepare_output_dir()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-node.html#agi_node.dag_worker.dag_worker.DagWorker.setup_args"><code class="docutils literal notranslate"><span class="pre">DagWorker.setup_args()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-node.html#agi_node.dag_worker.dag_worker.DagWorker.setup_data_directories"><code class="docutils literal notranslate"><span class="pre">DagWorker.setup_data_directories()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-node.html#agi_node.dag_worker.dag_worker.DagWorker.start"><code class="docutils literal notranslate"><span class="pre">DagWorker.start()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-node.html#agi_node.dag_worker.dag_worker.DagWorker.stop"><code class="docutils literal notranslate"><span class="pre">DagWorker.stop()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-node.html#agi_node.dag_worker.dag_worker.DagWorker.to_toml"><code class="docutils literal notranslate"><span class="pre">DagWorker.to_toml()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-node.html#agi_node.dag_worker.dag_worker.DagWorker.verbose"><code class="docutils literal notranslate"><span class="pre">DagWorker.verbose</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-node.html#agi_node.dag_worker.dag_worker.DagWorker.works"><code class="docutils literal notranslate"><span class="pre">DagWorker.works()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../module-agi-node.html#pandas-worker-framework-callback-functions-module">pandas_worker Framework Callback Functions Module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../module-agi-node.html#agi_node.pandas_worker.pandas_worker.PandasWorker"><code class="docutils literal notranslate"><span class="pre">PandasWorker</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-node.html#agi_node.pandas_worker.pandas_worker.PandasWorker.verbose"><code class="docutils literal notranslate"><span class="pre">PandasWorker.verbose</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-node.html#agi_node.pandas_worker.pandas_worker.PandasWorker.data_out"><code class="docutils literal notranslate"><span class="pre">PandasWorker.data_out</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-node.html#agi_node.pandas_worker.pandas_worker.PandasWorker.worker_id"><code class="docutils literal notranslate"><span class="pre">PandasWorker.worker_id</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-node.html#agi_node.pandas_worker.pandas_worker.PandasWorker.args"><code class="docutils literal notranslate"><span class="pre">PandasWorker.args</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-node.html#agi_node.pandas_worker.pandas_worker.PandasWorker.args_dump_mode"><code class="docutils literal notranslate"><span class="pre">PandasWorker.args_dump_mode</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-node.html#agi_node.pandas_worker.pandas_worker.PandasWorker.args_dumper"><code class="docutils literal notranslate"><span class="pre">PandasWorker.args_dumper</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-node.html#agi_node.pandas_worker.pandas_worker.PandasWorker.args_ensure_defaults"><code class="docutils literal notranslate"><span class="pre">PandasWorker.args_ensure_defaults</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-node.html#agi_node.pandas_worker.pandas_worker.PandasWorker.args_loader"><code class="docutils literal notranslate"><span class="pre">PandasWorker.args_loader</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-node.html#agi_node.pandas_worker.pandas_worker.PandasWorker.args_merger"><code class="docutils literal notranslate"><span class="pre">PandasWorker.args_merger</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-node.html#agi_node.pandas_worker.pandas_worker.PandasWorker.as_dict"><code class="docutils literal notranslate"><span class="pre">PandasWorker.as_dict()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-node.html#agi_node.pandas_worker.pandas_worker.PandasWorker.break"><code class="docutils literal notranslate"><span class="pre">PandasWorker.break()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-node.html#agi_node.pandas_worker.pandas_worker.PandasWorker.break_loop"><code class="docutils literal notranslate"><span class="pre">PandasWorker.break_loop()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-node.html#agi_node.pandas_worker.pandas_worker.PandasWorker.default_settings_path"><code class="docutils literal notranslate"><span class="pre">PandasWorker.default_settings_path</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-node.html#agi_node.pandas_worker.pandas_worker.PandasWorker.default_settings_section"><code class="docutils literal notranslate"><span class="pre">PandasWorker.default_settings_section</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-node.html#agi_node.pandas_worker.pandas_worker.PandasWorker.env"><code class="docutils literal notranslate"><span class="pre">PandasWorker.env</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-node.html#agi_node.pandas_worker.pandas_worker.PandasWorker.expand"><code class="docutils literal notranslate"><span class="pre">PandasWorker.expand()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-node.html#agi_node.pandas_worker.pandas_worker.PandasWorker.expand_and_join"><code class="docutils literal notranslate"><span class="pre">PandasWorker.expand_and_join()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-node.html#agi_node.pandas_worker.pandas_worker.PandasWorker.from_toml"><code class="docutils literal notranslate"><span class="pre">PandasWorker.from_toml()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-node.html#agi_node.pandas_worker.pandas_worker.PandasWorker.loop"><code class="docutils literal notranslate"><span class="pre">PandasWorker.loop()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-node.html#agi_node.pandas_worker.pandas_worker.PandasWorker.managed_pc_home_suffix"><code class="docutils literal notranslate"><span class="pre">PandasWorker.managed_pc_home_suffix</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-node.html#agi_node.pandas_worker.pandas_worker.PandasWorker.managed_pc_path_fields"><code class="docutils literal notranslate"><span class="pre">PandasWorker.managed_pc_path_fields</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-node.html#agi_node.pandas_worker.pandas_worker.PandasWorker.normalize_dataset_path"><code class="docutils literal notranslate"><span class="pre">PandasWorker.normalize_dataset_path()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-node.html#agi_node.pandas_worker.pandas_worker.PandasWorker.prepare_output_dir"><code class="docutils literal notranslate"><span class="pre">PandasWorker.prepare_output_dir()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-node.html#agi_node.pandas_worker.pandas_worker.PandasWorker.setup_args"><code class="docutils literal notranslate"><span class="pre">PandasWorker.setup_args()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-node.html#agi_node.pandas_worker.pandas_worker.PandasWorker.setup_data_directories"><code class="docutils literal notranslate"><span class="pre">PandasWorker.setup_data_directories()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-node.html#agi_node.pandas_worker.pandas_worker.PandasWorker.start"><code class="docutils literal notranslate"><span class="pre">PandasWorker.start()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-node.html#agi_node.pandas_worker.pandas_worker.PandasWorker.stop"><code class="docutils literal notranslate"><span class="pre">PandasWorker.stop()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-node.html#agi_node.pandas_worker.pandas_worker.PandasWorker.to_toml"><code class="docutils literal notranslate"><span class="pre">PandasWorker.to_toml()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-node.html#id0"><code class="docutils literal notranslate"><span class="pre">PandasWorker.verbose</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-node.html#agi_node.pandas_worker.pandas_worker.PandasWorker.work_done"><code class="docutils literal notranslate"><span class="pre">PandasWorker.work_done()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-node.html#agi_node.pandas_worker.pandas_worker.PandasWorker.work_pool"><code class="docutils literal notranslate"><span class="pre">PandasWorker.work_pool()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-node.html#agi_node.pandas_worker.pandas_worker.PandasWorker.works"><code class="docutils literal notranslate"><span class="pre">PandasWorker.works()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../module-agi-node.html#data-worker-framework-callback-functions-module">data_worker Framework Callback Functions Module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../module-agi-node.html#agi_node.polars_worker.polars_worker.PolarsWorker"><code class="docutils literal notranslate"><span class="pre">PolarsWorker</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-node.html#agi_node.polars_worker.polars_worker.PolarsWorker.verbose"><code class="docutils literal notranslate"><span class="pre">PolarsWorker.verbose</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-node.html#agi_node.polars_worker.polars_worker.PolarsWorker.data_out"><code class="docutils literal notranslate"><span class="pre">PolarsWorker.data_out</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-node.html#agi_node.polars_worker.polars_worker.PolarsWorker.worker_id"><code class="docutils literal notranslate"><span class="pre">PolarsWorker.worker_id</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-node.html#agi_node.polars_worker.polars_worker.PolarsWorker.args"><code class="docutils literal notranslate"><span class="pre">PolarsWorker.args</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-node.html#agi_node.polars_worker.polars_worker.PolarsWorker.args_dump_mode"><code class="docutils literal notranslate"><span class="pre">PolarsWorker.args_dump_mode</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-node.html#agi_node.polars_worker.polars_worker.PolarsWorker.args_dumper"><code class="docutils literal notranslate"><span class="pre">PolarsWorker.args_dumper</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-node.html#agi_node.polars_worker.polars_worker.PolarsWorker.args_ensure_defaults"><code class="docutils literal notranslate"><span class="pre">PolarsWorker.args_ensure_defaults</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-node.html#agi_node.polars_worker.polars_worker.PolarsWorker.args_loader"><code class="docutils literal notranslate"><span class="pre">PolarsWorker.args_loader</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-node.html#agi_node.polars_worker.polars_worker.PolarsWorker.args_merger"><code class="docutils literal notranslate"><span class="pre">PolarsWorker.args_merger</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-node.html#agi_node.polars_worker.polars_worker.PolarsWorker.as_dict"><code class="docutils literal notranslate"><span class="pre">PolarsWorker.as_dict()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-node.html#agi_node.polars_worker.polars_worker.PolarsWorker.break"><code class="docutils literal notranslate"><span class="pre">PolarsWorker.break()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-node.html#agi_node.polars_worker.polars_worker.PolarsWorker.break_loop"><code class="docutils literal notranslate"><span class="pre">PolarsWorker.break_loop()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-node.html#agi_node.polars_worker.polars_worker.PolarsWorker.default_settings_path"><code class="docutils literal notranslate"><span class="pre">PolarsWorker.default_settings_path</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-node.html#agi_node.polars_worker.polars_worker.PolarsWorker.default_settings_section"><code class="docutils literal notranslate"><span class="pre">PolarsWorker.default_settings_section</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-node.html#agi_node.polars_worker.polars_worker.PolarsWorker.env"><code class="docutils literal notranslate"><span class="pre">PolarsWorker.env</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-node.html#agi_node.polars_worker.polars_worker.PolarsWorker.expand"><code class="docutils literal notranslate"><span class="pre">PolarsWorker.expand()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-node.html#agi_node.polars_worker.polars_worker.PolarsWorker.expand_and_join"><code class="docutils literal notranslate"><span class="pre">PolarsWorker.expand_and_join()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-node.html#agi_node.polars_worker.polars_worker.PolarsWorker.from_toml"><code class="docutils literal notranslate"><span class="pre">PolarsWorker.from_toml()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-node.html#agi_node.polars_worker.polars_worker.PolarsWorker.loop"><code class="docutils literal notranslate"><span class="pre">PolarsWorker.loop()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-node.html#agi_node.polars_worker.polars_worker.PolarsWorker.managed_pc_home_suffix"><code class="docutils literal notranslate"><span class="pre">PolarsWorker.managed_pc_home_suffix</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-node.html#agi_node.polars_worker.polars_worker.PolarsWorker.managed_pc_path_fields"><code class="docutils literal notranslate"><span class="pre">PolarsWorker.managed_pc_path_fields</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-node.html#agi_node.polars_worker.polars_worker.PolarsWorker.normalize_dataset_path"><code class="docutils literal notranslate"><span class="pre">PolarsWorker.normalize_dataset_path()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-node.html#agi_node.polars_worker.polars_worker.PolarsWorker.prepare_output_dir"><code class="docutils literal notranslate"><span class="pre">PolarsWorker.prepare_output_dir()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-node.html#agi_node.polars_worker.polars_worker.PolarsWorker.setup_args"><code class="docutils literal notranslate"><span class="pre">PolarsWorker.setup_args()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-node.html#agi_node.polars_worker.polars_worker.PolarsWorker.setup_data_directories"><code class="docutils literal notranslate"><span class="pre">PolarsWorker.setup_data_directories()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-node.html#agi_node.polars_worker.polars_worker.PolarsWorker.start"><code class="docutils literal notranslate"><span class="pre">PolarsWorker.start()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-node.html#agi_node.polars_worker.polars_worker.PolarsWorker.stop"><code class="docutils literal notranslate"><span class="pre">PolarsWorker.stop()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-node.html#agi_node.polars_worker.polars_worker.PolarsWorker.to_toml"><code class="docutils literal notranslate"><span class="pre">PolarsWorker.to_toml()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-node.html#id1"><code class="docutils literal notranslate"><span class="pre">PolarsWorker.verbose</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-node.html#agi_node.polars_worker.polars_worker.PolarsWorker.work_done"><code class="docutils literal notranslate"><span class="pre">PolarsWorker.work_done()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-node.html#agi_node.polars_worker.polars_worker.PolarsWorker.work_pool"><code class="docutils literal notranslate"><span class="pre">PolarsWorker.work_pool()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-node.html#agi_node.polars_worker.polars_worker.PolarsWorker.works"><code class="docutils literal notranslate"><span class="pre">PolarsWorker.works()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../module-agi-cluster.html">agi_cluster package</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../module-agi-cluster.html#agi_cluster.agi_distributor.agi_distributor.AGI"><code class="docutils literal notranslate"><span class="pre">AGI</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-cluster.html#agi_cluster.agi_distributor.agi_distributor.AGI.CYTHON_MODE"><code class="docutils literal notranslate"><span class="pre">AGI.CYTHON_MODE</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-cluster.html#agi_cluster.agi_distributor.agi_distributor.AGI.DASK_MODE"><code class="docutils literal notranslate"><span class="pre">AGI.DASK_MODE</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-cluster.html#agi_cluster.agi_distributor.agi_distributor.AGI.PYTHON_MODE"><code class="docutils literal notranslate"><span class="pre">AGI.PYTHON_MODE</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-cluster.html#agi_cluster.agi_distributor.agi_distributor.AGI.RAPIDS_MODE"><code class="docutils literal notranslate"><span class="pre">AGI.RAPIDS_MODE</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-cluster.html#agi_cluster.agi_distributor.agi_distributor.AGI.__init__"><code class="docutils literal notranslate"><span class="pre">AGI.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-cluster.html#agi_cluster.agi_distributor.agi_distributor.AGI.debug"><code class="docutils literal notranslate"><span class="pre">AGI.debug</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-cluster.html#agi_cluster.agi_distributor.agi_distributor.AGI.distribute"><code class="docutils literal notranslate"><span class="pre">AGI.distribute()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-cluster.html#agi_cluster.agi_distributor.agi_distributor.AGI.env"><code class="docutils literal notranslate"><span class="pre">AGI.env</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-cluster.html#agi_cluster.agi_distributor.agi_distributor.AGI.exec_ssh"><code class="docutils literal notranslate"><span class="pre">AGI.exec_ssh()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-cluster.html#agi_cluster.agi_distributor.agi_distributor.AGI.exec_ssh_async"><code class="docutils literal notranslate"><span class="pre">AGI.exec_ssh_async()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-cluster.html#agi_cluster.agi_distributor.agi_distributor.AGI.find_free_port"><code class="docutils literal notranslate"><span class="pre">AGI.find_free_port()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-cluster.html#agi_cluster.agi_distributor.agi_distributor.AGI.get_default_local_ip"><code class="docutils literal notranslate"><span class="pre">AGI.get_default_local_ip()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-cluster.html#agi_cluster.agi_distributor.agi_distributor.AGI.get_distrib"><code class="docutils literal notranslate"><span class="pre">AGI.get_distrib()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-cluster.html#agi_cluster.agi_distributor.agi_distributor.AGI.get_ssh_connection"><code class="docutils literal notranslate"><span class="pre">AGI.get_ssh_connection()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-cluster.html#agi_cluster.agi_distributor.agi_distributor.AGI.install"><code class="docutils literal notranslate"><span class="pre">AGI.install()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-cluster.html#agi_cluster.agi_distributor.agi_distributor.AGI.run"><code class="docutils literal notranslate"><span class="pre">AGI.run()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-cluster.html#agi_cluster.agi_distributor.agi_distributor.AGI.send_file"><code class="docutils literal notranslate"><span class="pre">AGI.send_file()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-cluster.html#agi_cluster.agi_distributor.agi_distributor.AGI.send_files"><code class="docutils literal notranslate"><span class="pre">AGI.send_files()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-cluster.html#agi_cluster.agi_distributor.agi_distributor.AGI.serve"><code class="docutils literal notranslate"><span class="pre">AGI.serve()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-cluster.html#agi_cluster.agi_distributor.agi_distributor.AGI.update"><code class="docutils literal notranslate"><span class="pre">AGI.update()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../module-agi-cluster.html#agi_cluster.agi_distributor.agi_distributor.AGI.verbose"><code class="docutils literal notranslate"><span class="pre">AGI.verbose</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../module-agilab.html">agilab package</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../module-agilab.html#agilab.lab_run.main"><code class="docutils literal notranslate"><span class="pre">main()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../environment.html">Environment Variables</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../faq.html">FAQ</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../faq.html#missing-worker-packages-during-agi-run">Missing worker packages during <cite>AGI.run_*</cite></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../faq.html#why-installers-still-build-eggs">Why installers still build eggs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../faq.html#do-we-already-have-dag-task-orchestration">Do we already have DAG/task orchestration?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../faq.html#who-manages-multithreading-when-dask-is-disabled">Who manages multithreading when Dask is disabled?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../faq.html#regenerating-ide-run-configurations">Regenerating IDE run configurations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../faq.html#virtual-env-does-not-match-the-project-environment-warning">â€œVIRTUAL_ENV â€¦ does not match the project environmentâ€ warning</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../faq.html#why-does-a-run-create-distribution-json">Why does a run create <code class="docutils literal notranslate"><span class="pre">distribution.json</span></code>?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../faq.html#switching-the-active-app-in-streamlit">Switching the active app in Streamlit</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../faq.html#docs-drift-after-touching-core-apis">Docs drift after touching core APIs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../faq.html#agi-install-fails-looking-for-pyproject-toml"><cite>AGI.install_*</cite> fails looking for <code class="docutils literal notranslate"><span class="pre">pyproject.toml</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../faq.html#where-are-installer-logs-written">Where are installer logs written?</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../directory-structure.html">Project Files Structure</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../troubleshooting.html">Troubleshooting</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../troubleshooting.html#a-prerequisite">A - Prerequisite:</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../troubleshooting.html#b-pycharm-run-debug-configurations">B - Pycharm Run/Debug configurations:</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../troubleshooting.html#c-exemple-of-tests-sequence">C - Exemple of Tests Sequence:</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../troubleshooting.html#d-agilab-run-dev-vs-agilab-run-enduser-vs-lab-run">D - agilab_run_dev vs agilab_run_enduser vs lab_run:</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../troubleshooting.html#e-macos-nfs-server-checklist">E - macOS NFS server checklist:</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../troubleshooting.html#known-bugs">Known Bugs</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../troubleshooting.html#install-sh-do-not-install-your-run-debug-configurations">&lt;install.sh&gt; do not install your Run/Debug Configurations :</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../troubleshooting.html#install-sh-freeze">&lt;install.sh&gt; freeze:</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../troubleshooting.html#uv-virtual-env-warning">&lt;UV&gt; VIRTUAL_ENV Warning</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../troubleshooting.html#uv-sync-failed">&lt;UV&gt; Sync Failed</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../troubleshooting.html#dask-debug-issue">&lt;DASK&gt; Debug Issue</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../troubleshooting.html#pycharm-run-debug-configuration-is-broken">&lt;PYCHARM&gt; Run/Debug Configuration is Broken</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../troubleshooting.html#pycharm-can-t-open-your-project">&lt;PYCHARM&gt; Canâ€™t open your project</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../troubleshooting.html#failed-to-read-pydantic-metadata">Failed to read pydantic metadata</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../license.html">Licenses</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../agi-cluster-licenses.html">Agi-cluster Licenses</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../agi-node-licenses.html">Agi-node Licenses</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../agi-env-licenses.html">Agi-env Licenses</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../agi-core-licenses.html">Agi-core Licenses</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../mycode-project-licenses.html">Mycode-project Licenses</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../flight-project-licenses.html">Flight-project Licenses</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Streamlit UI</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../agilab-help.html">â–¶ï¸ HOME (AGILAB.py)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../agilab-help.html#how-pages-are-presented">How pages are presented</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../agilab-help.html#core-pages">Core pages</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../agilab-help.html#page-bundles-apps-pages">Page bundles (apps-pages)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../agilab-help.html#see-also">See also</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../edit-help.html">â–¶ï¸ EDIT</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../edit-help.html#sidebar">Sidebar</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../edit-help.html#main-content-area">Main Content Area</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../edit-help.html#support">Support</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../execute-help.html">â–¶ï¸ EXECUTE</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../execute-help.html#introduction">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../execute-help.html#sidebar">Sidebar</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../execute-help.html#main-content-area">Main Content Area</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../experiment-help.html">â–¶ï¸ EXPERIMENT</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../experiment-help.html#sidebar">Sidebar</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../experiment-help.html#main-content-area">Main Content Area</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../experiment-help.html#assistant">ASSISTANT</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../experiment-help.html#history">HISTORY</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../explore-help.html">â–¶ï¸ EXPLORE</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../explore-help.html#introduction">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../explore-help.html#sidebar">Sidebar</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../explore-help.html#main-content-area">Main Content Area</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../explore-help.html#tips-notes">Tips &amp; Notes</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../apps-pages.html">â–¶ï¸ PAGE BUNDLES</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../apps-pages.html#what-is-a-page-bundle">What is a page bundle?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../apps-pages.html#enabling-bundles-per-project">Enabling bundles (per project)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../apps-pages.html#included-page-bundles">Included page bundles</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../apps-pages.html#view-autoencoder-latenspace">view_autoencoder_latenspace</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../apps-pages.html#view-barycentric">view_barycentric</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../apps-pages.html#view-maps">view_maps</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../apps-pages.html#view-maps-3d">view_maps_3d</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../apps-pages.html#view-maps-network">view_maps_network</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Apps Examples</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../mycode-project.html">MyCode Project</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../mycode-project.html#overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../mycode-project.html#scientific-placeholders">Scientific placeholders</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../mycode-project.html#manager-mycode-mycode">Manager (<cite>mycode.mycode</cite>)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../mycode-project.html#args-mycode-app-args">Args (<cite>mycode.app_args</cite>)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../mycode-project.html#worker-mycode-worker-mycode-worker">Worker (<cite>mycode_worker.mycode_worker</cite>)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../mycode-project.html#assets-tests">Assets &amp; Tests</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../mycode-project.html#api-reference">API Reference</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../mycode-project.html#mycode.mycode.Mycode"><code class="docutils literal notranslate"><span class="pre">Mycode</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode.mycode.Mycode.__init__"><code class="docutils literal notranslate"><span class="pre">Mycode.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode.mycode.Mycode.args_dump_mode"><code class="docutils literal notranslate"><span class="pre">Mycode.args_dump_mode</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode.mycode.Mycode.args_dumper"><code class="docutils literal notranslate"><span class="pre">Mycode.args_dumper</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode.mycode.Mycode.args_ensure_defaults"><code class="docutils literal notranslate"><span class="pre">Mycode.args_ensure_defaults</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode.mycode.Mycode.args_loader"><code class="docutils literal notranslate"><span class="pre">Mycode.args_loader</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode.mycode.Mycode.args_merger"><code class="docutils literal notranslate"><span class="pre">Mycode.args_merger</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode.mycode.Mycode.as_dict"><code class="docutils literal notranslate"><span class="pre">Mycode.as_dict()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode.mycode.Mycode.break"><code class="docutils literal notranslate"><span class="pre">Mycode.break()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode.mycode.Mycode.break_loop"><code class="docutils literal notranslate"><span class="pre">Mycode.break_loop()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode.mycode.Mycode.build_distribution"><code class="docutils literal notranslate"><span class="pre">Mycode.build_distribution()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode.mycode.Mycode.default_settings_path"><code class="docutils literal notranslate"><span class="pre">Mycode.default_settings_path</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode.mycode.Mycode.default_settings_section"><code class="docutils literal notranslate"><span class="pre">Mycode.default_settings_section</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode.mycode.Mycode.env"><code class="docutils literal notranslate"><span class="pre">Mycode.env</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode.mycode.Mycode.expand"><code class="docutils literal notranslate"><span class="pre">Mycode.expand()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode.mycode.Mycode.expand_and_join"><code class="docutils literal notranslate"><span class="pre">Mycode.expand_and_join()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode.mycode.Mycode.from_toml"><code class="docutils literal notranslate"><span class="pre">Mycode.from_toml()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode.mycode.Mycode.loop"><code class="docutils literal notranslate"><span class="pre">Mycode.loop()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode.mycode.Mycode.managed_pc_home_suffix"><code class="docutils literal notranslate"><span class="pre">Mycode.managed_pc_home_suffix</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode.mycode.Mycode.managed_pc_path_fields"><code class="docutils literal notranslate"><span class="pre">Mycode.managed_pc_path_fields</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode.mycode.Mycode.normalize_dataset_path"><code class="docutils literal notranslate"><span class="pre">Mycode.normalize_dataset_path()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode.mycode.Mycode.pool_init"><code class="docutils literal notranslate"><span class="pre">Mycode.pool_init()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode.mycode.Mycode.prepare_output_dir"><code class="docutils literal notranslate"><span class="pre">Mycode.prepare_output_dir()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode.mycode.Mycode.setup_args"><code class="docutils literal notranslate"><span class="pre">Mycode.setup_args()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode.mycode.Mycode.setup_data_directories"><code class="docutils literal notranslate"><span class="pre">Mycode.setup_data_directories()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode.mycode.Mycode.start"><code class="docutils literal notranslate"><span class="pre">Mycode.start()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode.mycode.Mycode.stop"><code class="docutils literal notranslate"><span class="pre">Mycode.stop()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode.mycode.Mycode.to_toml"><code class="docutils literal notranslate"><span class="pre">Mycode.to_toml()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode.mycode.Mycode.verbose"><code class="docutils literal notranslate"><span class="pre">Mycode.verbose</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode.mycode.Mycode.work_done"><code class="docutils literal notranslate"><span class="pre">Mycode.work_done()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode.mycode.Mycode.work_pool"><code class="docutils literal notranslate"><span class="pre">Mycode.work_pool()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode.mycode.Mycode.worker_vars"><code class="docutils literal notranslate"><span class="pre">Mycode.worker_vars</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../mycode-project.html#mycode.mycode.MycodeApp"><code class="docutils literal notranslate"><span class="pre">MycodeApp</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode.mycode.MycodeApp.__init__"><code class="docutils literal notranslate"><span class="pre">MycodeApp.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode.mycode.MycodeApp.args_dump_mode"><code class="docutils literal notranslate"><span class="pre">MycodeApp.args_dump_mode</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode.mycode.MycodeApp.args_dumper"><code class="docutils literal notranslate"><span class="pre">MycodeApp.args_dumper</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode.mycode.MycodeApp.args_ensure_defaults"><code class="docutils literal notranslate"><span class="pre">MycodeApp.args_ensure_defaults</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode.mycode.MycodeApp.args_loader"><code class="docutils literal notranslate"><span class="pre">MycodeApp.args_loader</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode.mycode.MycodeApp.args_merger"><code class="docutils literal notranslate"><span class="pre">MycodeApp.args_merger</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode.mycode.MycodeApp.as_dict"><code class="docutils literal notranslate"><span class="pre">MycodeApp.as_dict()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode.mycode.MycodeApp.break"><code class="docutils literal notranslate"><span class="pre">MycodeApp.break()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode.mycode.MycodeApp.break_loop"><code class="docutils literal notranslate"><span class="pre">MycodeApp.break_loop()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode.mycode.MycodeApp.build_distribution"><code class="docutils literal notranslate"><span class="pre">MycodeApp.build_distribution()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode.mycode.MycodeApp.default_settings_path"><code class="docutils literal notranslate"><span class="pre">MycodeApp.default_settings_path</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode.mycode.MycodeApp.default_settings_section"><code class="docutils literal notranslate"><span class="pre">MycodeApp.default_settings_section</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode.mycode.MycodeApp.env"><code class="docutils literal notranslate"><span class="pre">MycodeApp.env</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode.mycode.MycodeApp.expand"><code class="docutils literal notranslate"><span class="pre">MycodeApp.expand()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode.mycode.MycodeApp.expand_and_join"><code class="docutils literal notranslate"><span class="pre">MycodeApp.expand_and_join()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode.mycode.MycodeApp.from_toml"><code class="docutils literal notranslate"><span class="pre">MycodeApp.from_toml()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode.mycode.MycodeApp.loop"><code class="docutils literal notranslate"><span class="pre">MycodeApp.loop()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode.mycode.MycodeApp.managed_pc_home_suffix"><code class="docutils literal notranslate"><span class="pre">MycodeApp.managed_pc_home_suffix</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode.mycode.MycodeApp.managed_pc_path_fields"><code class="docutils literal notranslate"><span class="pre">MycodeApp.managed_pc_path_fields</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode.mycode.MycodeApp.normalize_dataset_path"><code class="docutils literal notranslate"><span class="pre">MycodeApp.normalize_dataset_path()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode.mycode.MycodeApp.pool_init"><code class="docutils literal notranslate"><span class="pre">MycodeApp.pool_init()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode.mycode.MycodeApp.prepare_output_dir"><code class="docutils literal notranslate"><span class="pre">MycodeApp.prepare_output_dir()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode.mycode.MycodeApp.setup_args"><code class="docutils literal notranslate"><span class="pre">MycodeApp.setup_args()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode.mycode.MycodeApp.setup_data_directories"><code class="docutils literal notranslate"><span class="pre">MycodeApp.setup_data_directories()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode.mycode.MycodeApp.start"><code class="docutils literal notranslate"><span class="pre">MycodeApp.start()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode.mycode.MycodeApp.stop"><code class="docutils literal notranslate"><span class="pre">MycodeApp.stop()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode.mycode.MycodeApp.to_toml"><code class="docutils literal notranslate"><span class="pre">MycodeApp.to_toml()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode.mycode.MycodeApp.verbose"><code class="docutils literal notranslate"><span class="pre">MycodeApp.verbose</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode.mycode.MycodeApp.work_done"><code class="docutils literal notranslate"><span class="pre">MycodeApp.work_done()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode.mycode.MycodeApp.work_pool"><code class="docutils literal notranslate"><span class="pre">MycodeApp.work_pool()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode.mycode.MycodeApp.worker_vars"><code class="docutils literal notranslate"><span class="pre">MycodeApp.worker_vars</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../mycode-project.html#mycode.app_args.ArgsModel"><code class="docutils literal notranslate"><span class="pre">ArgsModel</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../mycode-project.html#mycode.app_args.ArgsOverrides"><code class="docutils literal notranslate"><span class="pre">ArgsOverrides</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../mycode-project.html#mycode.app_args.MycodeArgs"><code class="docutils literal notranslate"><span class="pre">MycodeArgs</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode.app_args.MycodeArgs.__init__"><code class="docutils literal notranslate"><span class="pre">MycodeArgs.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode.app_args.MycodeArgs.construct"><code class="docutils literal notranslate"><span class="pre">MycodeArgs.construct()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode.app_args.MycodeArgs.copy"><code class="docutils literal notranslate"><span class="pre">MycodeArgs.copy()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode.app_args.MycodeArgs.data_in"><code class="docutils literal notranslate"><span class="pre">MycodeArgs.data_in</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode.app_args.MycodeArgs.data_out"><code class="docutils literal notranslate"><span class="pre">MycodeArgs.data_out</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode.app_args.MycodeArgs.dict"><code class="docutils literal notranslate"><span class="pre">MycodeArgs.dict()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode.app_args.MycodeArgs.files"><code class="docutils literal notranslate"><span class="pre">MycodeArgs.files</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode.app_args.MycodeArgs.from_orm"><code class="docutils literal notranslate"><span class="pre">MycodeArgs.from_orm()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode.app_args.MycodeArgs.json"><code class="docutils literal notranslate"><span class="pre">MycodeArgs.json()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode.app_args.MycodeArgs.model_computed_fields"><code class="docutils literal notranslate"><span class="pre">MycodeArgs.model_computed_fields</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode.app_args.MycodeArgs.model_config"><code class="docutils literal notranslate"><span class="pre">MycodeArgs.model_config</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode.app_args.MycodeArgs.model_construct"><code class="docutils literal notranslate"><span class="pre">MycodeArgs.model_construct()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode.app_args.MycodeArgs.model_copy"><code class="docutils literal notranslate"><span class="pre">MycodeArgs.model_copy()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode.app_args.MycodeArgs.model_dump"><code class="docutils literal notranslate"><span class="pre">MycodeArgs.model_dump()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode.app_args.MycodeArgs.model_dump_json"><code class="docutils literal notranslate"><span class="pre">MycodeArgs.model_dump_json()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode.app_args.MycodeArgs.model_extra"><code class="docutils literal notranslate"><span class="pre">MycodeArgs.model_extra</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode.app_args.MycodeArgs.model_fields"><code class="docutils literal notranslate"><span class="pre">MycodeArgs.model_fields</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode.app_args.MycodeArgs.model_fields_set"><code class="docutils literal notranslate"><span class="pre">MycodeArgs.model_fields_set</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode.app_args.MycodeArgs.model_json_schema"><code class="docutils literal notranslate"><span class="pre">MycodeArgs.model_json_schema()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode.app_args.MycodeArgs.model_parametrized_name"><code class="docutils literal notranslate"><span class="pre">MycodeArgs.model_parametrized_name()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode.app_args.MycodeArgs.model_post_init"><code class="docutils literal notranslate"><span class="pre">MycodeArgs.model_post_init()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode.app_args.MycodeArgs.model_rebuild"><code class="docutils literal notranslate"><span class="pre">MycodeArgs.model_rebuild()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode.app_args.MycodeArgs.model_validate"><code class="docutils literal notranslate"><span class="pre">MycodeArgs.model_validate()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode.app_args.MycodeArgs.model_validate_json"><code class="docutils literal notranslate"><span class="pre">MycodeArgs.model_validate_json()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode.app_args.MycodeArgs.model_validate_strings"><code class="docutils literal notranslate"><span class="pre">MycodeArgs.model_validate_strings()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode.app_args.MycodeArgs.nfile"><code class="docutils literal notranslate"><span class="pre">MycodeArgs.nfile</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode.app_args.MycodeArgs.nread"><code class="docutils literal notranslate"><span class="pre">MycodeArgs.nread</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode.app_args.MycodeArgs.nskip"><code class="docutils literal notranslate"><span class="pre">MycodeArgs.nskip</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode.app_args.MycodeArgs.parse_file"><code class="docutils literal notranslate"><span class="pre">MycodeArgs.parse_file()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode.app_args.MycodeArgs.parse_obj"><code class="docutils literal notranslate"><span class="pre">MycodeArgs.parse_obj()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode.app_args.MycodeArgs.parse_raw"><code class="docutils literal notranslate"><span class="pre">MycodeArgs.parse_raw()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode.app_args.MycodeArgs.reset_target"><code class="docutils literal notranslate"><span class="pre">MycodeArgs.reset_target</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode.app_args.MycodeArgs.schema"><code class="docutils literal notranslate"><span class="pre">MycodeArgs.schema()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode.app_args.MycodeArgs.schema_json"><code class="docutils literal notranslate"><span class="pre">MycodeArgs.schema_json()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode.app_args.MycodeArgs.update_forward_refs"><code class="docutils literal notranslate"><span class="pre">MycodeArgs.update_forward_refs()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode.app_args.MycodeArgs.validate"><code class="docutils literal notranslate"><span class="pre">MycodeArgs.validate()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../mycode-project.html#mycode.app_args.MycodeArgsTD"><code class="docutils literal notranslate"><span class="pre">MycodeArgsTD</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode.app_args.MycodeArgsTD.__init__"><code class="docutils literal notranslate"><span class="pre">MycodeArgsTD.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode.app_args.MycodeArgsTD.clear"><code class="docutils literal notranslate"><span class="pre">MycodeArgsTD.clear()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode.app_args.MycodeArgsTD.copy"><code class="docutils literal notranslate"><span class="pre">MycodeArgsTD.copy()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode.app_args.MycodeArgsTD.data_in"><code class="docutils literal notranslate"><span class="pre">MycodeArgsTD.data_in</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode.app_args.MycodeArgsTD.data_out"><code class="docutils literal notranslate"><span class="pre">MycodeArgsTD.data_out</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode.app_args.MycodeArgsTD.files"><code class="docutils literal notranslate"><span class="pre">MycodeArgsTD.files</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode.app_args.MycodeArgsTD.fromkeys"><code class="docutils literal notranslate"><span class="pre">MycodeArgsTD.fromkeys()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode.app_args.MycodeArgsTD.get"><code class="docutils literal notranslate"><span class="pre">MycodeArgsTD.get()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode.app_args.MycodeArgsTD.items"><code class="docutils literal notranslate"><span class="pre">MycodeArgsTD.items()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode.app_args.MycodeArgsTD.keys"><code class="docutils literal notranslate"><span class="pre">MycodeArgsTD.keys()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode.app_args.MycodeArgsTD.nfile"><code class="docutils literal notranslate"><span class="pre">MycodeArgsTD.nfile</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode.app_args.MycodeArgsTD.nread"><code class="docutils literal notranslate"><span class="pre">MycodeArgsTD.nread</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode.app_args.MycodeArgsTD.nskip"><code class="docutils literal notranslate"><span class="pre">MycodeArgsTD.nskip</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode.app_args.MycodeArgsTD.pop"><code class="docutils literal notranslate"><span class="pre">MycodeArgsTD.pop()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode.app_args.MycodeArgsTD.popitem"><code class="docutils literal notranslate"><span class="pre">MycodeArgsTD.popitem()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode.app_args.MycodeArgsTD.reset_target"><code class="docutils literal notranslate"><span class="pre">MycodeArgsTD.reset_target</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode.app_args.MycodeArgsTD.setdefault"><code class="docutils literal notranslate"><span class="pre">MycodeArgsTD.setdefault()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode.app_args.MycodeArgsTD.update"><code class="docutils literal notranslate"><span class="pre">MycodeArgsTD.update()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode.app_args.MycodeArgsTD.values"><code class="docutils literal notranslate"><span class="pre">MycodeArgsTD.values()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../mycode-project.html#mycode.app_args.dump_args"><code class="docutils literal notranslate"><span class="pre">dump_args()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../mycode-project.html#mycode.app_args.ensure_defaults"><code class="docutils literal notranslate"><span class="pre">ensure_defaults()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../mycode-project.html#mycode.app_args.load_args"><code class="docutils literal notranslate"><span class="pre">load_args()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../mycode-project.html#mycode.app_args.merge_args"><code class="docutils literal notranslate"><span class="pre">merge_args()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../mycode-project.html#mycode_worker.mycode_worker.MycodeWorker"><code class="docutils literal notranslate"><span class="pre">MycodeWorker</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode_worker.mycode_worker.MycodeWorker.args_dump_mode"><code class="docutils literal notranslate"><span class="pre">MycodeWorker.args_dump_mode</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode_worker.mycode_worker.MycodeWorker.args_dumper"><code class="docutils literal notranslate"><span class="pre">MycodeWorker.args_dumper</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode_worker.mycode_worker.MycodeWorker.args_ensure_defaults"><code class="docutils literal notranslate"><span class="pre">MycodeWorker.args_ensure_defaults</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode_worker.mycode_worker.MycodeWorker.args_loader"><code class="docutils literal notranslate"><span class="pre">MycodeWorker.args_loader</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode_worker.mycode_worker.MycodeWorker.args_merger"><code class="docutils literal notranslate"><span class="pre">MycodeWorker.args_merger</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode_worker.mycode_worker.MycodeWorker.as_dict"><code class="docutils literal notranslate"><span class="pre">MycodeWorker.as_dict()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode_worker.mycode_worker.MycodeWorker.break"><code class="docutils literal notranslate"><span class="pre">MycodeWorker.break()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode_worker.mycode_worker.MycodeWorker.break_loop"><code class="docutils literal notranslate"><span class="pre">MycodeWorker.break_loop()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode_worker.mycode_worker.MycodeWorker.default_settings_path"><code class="docutils literal notranslate"><span class="pre">MycodeWorker.default_settings_path</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode_worker.mycode_worker.MycodeWorker.default_settings_section"><code class="docutils literal notranslate"><span class="pre">MycodeWorker.default_settings_section</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode_worker.mycode_worker.MycodeWorker.env"><code class="docutils literal notranslate"><span class="pre">MycodeWorker.env</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode_worker.mycode_worker.MycodeWorker.expand"><code class="docutils literal notranslate"><span class="pre">MycodeWorker.expand()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode_worker.mycode_worker.MycodeWorker.expand_and_join"><code class="docutils literal notranslate"><span class="pre">MycodeWorker.expand_and_join()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode_worker.mycode_worker.MycodeWorker.from_toml"><code class="docutils literal notranslate"><span class="pre">MycodeWorker.from_toml()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode_worker.mycode_worker.MycodeWorker.loop"><code class="docutils literal notranslate"><span class="pre">MycodeWorker.loop()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode_worker.mycode_worker.MycodeWorker.managed_pc_home_suffix"><code class="docutils literal notranslate"><span class="pre">MycodeWorker.managed_pc_home_suffix</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode_worker.mycode_worker.MycodeWorker.managed_pc_path_fields"><code class="docutils literal notranslate"><span class="pre">MycodeWorker.managed_pc_path_fields</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode_worker.mycode_worker.MycodeWorker.normalize_dataset_path"><code class="docutils literal notranslate"><span class="pre">MycodeWorker.normalize_dataset_path()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode_worker.mycode_worker.MycodeWorker.prepare_output_dir"><code class="docutils literal notranslate"><span class="pre">MycodeWorker.prepare_output_dir()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode_worker.mycode_worker.MycodeWorker.setup_args"><code class="docutils literal notranslate"><span class="pre">MycodeWorker.setup_args()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode_worker.mycode_worker.MycodeWorker.setup_data_directories"><code class="docutils literal notranslate"><span class="pre">MycodeWorker.setup_data_directories()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode_worker.mycode_worker.MycodeWorker.start"><code class="docutils literal notranslate"><span class="pre">MycodeWorker.start()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode_worker.mycode_worker.MycodeWorker.stop"><code class="docutils literal notranslate"><span class="pre">MycodeWorker.stop()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode_worker.mycode_worker.MycodeWorker.to_toml"><code class="docutils literal notranslate"><span class="pre">MycodeWorker.to_toml()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode_worker.mycode_worker.MycodeWorker.verbose"><code class="docutils literal notranslate"><span class="pre">MycodeWorker.verbose</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode_worker.mycode_worker.MycodeWorker.work_done"><code class="docutils literal notranslate"><span class="pre">MycodeWorker.work_done()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode_worker.mycode_worker.MycodeWorker.work_pool"><code class="docutils literal notranslate"><span class="pre">MycodeWorker.work_pool()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../mycode-project.html#mycode_worker.mycode_worker.MycodeWorker.works"><code class="docutils literal notranslate"><span class="pre">MycodeWorker.works()</span></code></a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../flight-project.html">Flight Project</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../flight-project.html#overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../flight-project.html#scientific-highlights">Scientific highlights</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../flight-project.html#manager-flight-flight">Manager (<cite>flight.flight</cite>)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../flight-project.html#args-flight-flight-args">Args (<cite>flight.flight_args</cite>)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../flight-project.html#worker-flight-worker-flight-worker">Worker (<cite>flight_worker.flight_worker</cite>)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../flight-project.html#assets-tests">Assets &amp; Tests</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../flight-project.html#api-reference">API Reference</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../flight-project.html#flight.flight.Flight"><code class="docutils literal notranslate"><span class="pre">Flight</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight.Flight.__init__"><code class="docutils literal notranslate"><span class="pre">Flight.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight.Flight.args_dump_mode"><code class="docutils literal notranslate"><span class="pre">Flight.args_dump_mode</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight.Flight.args_dumper"><code class="docutils literal notranslate"><span class="pre">Flight.args_dumper</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight.Flight.args_ensure_defaults"><code class="docutils literal notranslate"><span class="pre">Flight.args_ensure_defaults</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight.Flight.args_loader"><code class="docutils literal notranslate"><span class="pre">Flight.args_loader</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight.Flight.args_merger"><code class="docutils literal notranslate"><span class="pre">Flight.args_merger</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight.Flight.as_dict"><code class="docutils literal notranslate"><span class="pre">Flight.as_dict()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight.Flight.break"><code class="docutils literal notranslate"><span class="pre">Flight.break()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight.Flight.break_loop"><code class="docutils literal notranslate"><span class="pre">Flight.break_loop()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight.Flight.build_distribution"><code class="docutils literal notranslate"><span class="pre">Flight.build_distribution()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight.Flight.default_settings_path"><code class="docutils literal notranslate"><span class="pre">Flight.default_settings_path</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight.Flight.default_settings_section"><code class="docutils literal notranslate"><span class="pre">Flight.default_settings_section</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight.Flight.env"><code class="docutils literal notranslate"><span class="pre">Flight.env</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight.Flight.expand"><code class="docutils literal notranslate"><span class="pre">Flight.expand()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight.Flight.expand_and_join"><code class="docutils literal notranslate"><span class="pre">Flight.expand_and_join()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight.Flight.extract_plane_from_file_name"><code class="docutils literal notranslate"><span class="pre">Flight.extract_plane_from_file_name()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight.Flight.from_toml"><code class="docutils literal notranslate"><span class="pre">Flight.from_toml()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight.Flight.get_data_from_files"><code class="docutils literal notranslate"><span class="pre">Flight.get_data_from_files()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight.Flight.get_data_from_hawk"><code class="docutils literal notranslate"><span class="pre">Flight.get_data_from_hawk()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight.Flight.get_partition_by_planes"><code class="docutils literal notranslate"><span class="pre">Flight.get_partition_by_planes()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight.Flight.ivq_logs"><code class="docutils literal notranslate"><span class="pre">Flight.ivq_logs</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight.Flight.loop"><code class="docutils literal notranslate"><span class="pre">Flight.loop()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight.Flight.managed_pc_home_suffix"><code class="docutils literal notranslate"><span class="pre">Flight.managed_pc_home_suffix</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight.Flight.managed_pc_path_fields"><code class="docutils literal notranslate"><span class="pre">Flight.managed_pc_path_fields</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight.Flight.normalize_dataset_path"><code class="docutils literal notranslate"><span class="pre">Flight.normalize_dataset_path()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight.Flight.prepare_output_dir"><code class="docutils literal notranslate"><span class="pre">Flight.prepare_output_dir()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight.Flight.setup_args"><code class="docutils literal notranslate"><span class="pre">Flight.setup_args()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight.Flight.setup_data_directories"><code class="docutils literal notranslate"><span class="pre">Flight.setup_data_directories()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight.Flight.start"><code class="docutils literal notranslate"><span class="pre">Flight.start()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight.Flight.stop"><code class="docutils literal notranslate"><span class="pre">Flight.stop()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight.Flight.to_toml"><code class="docutils literal notranslate"><span class="pre">Flight.to_toml()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight.Flight.verbose"><code class="docutils literal notranslate"><span class="pre">Flight.verbose</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../flight-project.html#flight.flight.FlightApp"><code class="docutils literal notranslate"><span class="pre">FlightApp</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight.FlightApp.__init__"><code class="docutils literal notranslate"><span class="pre">FlightApp.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight.FlightApp.args_dump_mode"><code class="docutils literal notranslate"><span class="pre">FlightApp.args_dump_mode</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight.FlightApp.args_dumper"><code class="docutils literal notranslate"><span class="pre">FlightApp.args_dumper</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight.FlightApp.args_ensure_defaults"><code class="docutils literal notranslate"><span class="pre">FlightApp.args_ensure_defaults</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight.FlightApp.args_loader"><code class="docutils literal notranslate"><span class="pre">FlightApp.args_loader</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight.FlightApp.args_merger"><code class="docutils literal notranslate"><span class="pre">FlightApp.args_merger</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight.FlightApp.as_dict"><code class="docutils literal notranslate"><span class="pre">FlightApp.as_dict()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight.FlightApp.break"><code class="docutils literal notranslate"><span class="pre">FlightApp.break()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight.FlightApp.break_loop"><code class="docutils literal notranslate"><span class="pre">FlightApp.break_loop()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight.FlightApp.build_distribution"><code class="docutils literal notranslate"><span class="pre">FlightApp.build_distribution()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight.FlightApp.default_settings_path"><code class="docutils literal notranslate"><span class="pre">FlightApp.default_settings_path</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight.FlightApp.default_settings_section"><code class="docutils literal notranslate"><span class="pre">FlightApp.default_settings_section</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight.FlightApp.env"><code class="docutils literal notranslate"><span class="pre">FlightApp.env</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight.FlightApp.expand"><code class="docutils literal notranslate"><span class="pre">FlightApp.expand()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight.FlightApp.expand_and_join"><code class="docutils literal notranslate"><span class="pre">FlightApp.expand_and_join()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight.FlightApp.extract_plane_from_file_name"><code class="docutils literal notranslate"><span class="pre">FlightApp.extract_plane_from_file_name()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight.FlightApp.from_toml"><code class="docutils literal notranslate"><span class="pre">FlightApp.from_toml()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight.FlightApp.get_data_from_files"><code class="docutils literal notranslate"><span class="pre">FlightApp.get_data_from_files()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight.FlightApp.get_data_from_hawk"><code class="docutils literal notranslate"><span class="pre">FlightApp.get_data_from_hawk()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight.FlightApp.get_partition_by_planes"><code class="docutils literal notranslate"><span class="pre">FlightApp.get_partition_by_planes()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight.FlightApp.ivq_logs"><code class="docutils literal notranslate"><span class="pre">FlightApp.ivq_logs</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight.FlightApp.loop"><code class="docutils literal notranslate"><span class="pre">FlightApp.loop()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight.FlightApp.managed_pc_home_suffix"><code class="docutils literal notranslate"><span class="pre">FlightApp.managed_pc_home_suffix</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight.FlightApp.managed_pc_path_fields"><code class="docutils literal notranslate"><span class="pre">FlightApp.managed_pc_path_fields</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight.FlightApp.normalize_dataset_path"><code class="docutils literal notranslate"><span class="pre">FlightApp.normalize_dataset_path()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight.FlightApp.prepare_output_dir"><code class="docutils literal notranslate"><span class="pre">FlightApp.prepare_output_dir()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight.FlightApp.setup_args"><code class="docutils literal notranslate"><span class="pre">FlightApp.setup_args()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight.FlightApp.setup_data_directories"><code class="docutils literal notranslate"><span class="pre">FlightApp.setup_data_directories()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight.FlightApp.start"><code class="docutils literal notranslate"><span class="pre">FlightApp.start()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight.FlightApp.stop"><code class="docutils literal notranslate"><span class="pre">FlightApp.stop()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight.FlightApp.to_toml"><code class="docutils literal notranslate"><span class="pre">FlightApp.to_toml()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight.FlightApp.verbose"><code class="docutils literal notranslate"><span class="pre">FlightApp.verbose</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../flight-project.html#flight.flight_args.ArgsModel"><code class="docutils literal notranslate"><span class="pre">ArgsModel</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../flight-project.html#flight.flight_args.ArgsOverrides"><code class="docutils literal notranslate"><span class="pre">ArgsOverrides</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../flight-project.html#flight.flight_args.FlightArgs"><code class="docutils literal notranslate"><span class="pre">FlightArgs</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight_args.FlightArgs.__init__"><code class="docutils literal notranslate"><span class="pre">FlightArgs.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight_args.FlightArgs.construct"><code class="docutils literal notranslate"><span class="pre">FlightArgs.construct()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight_args.FlightArgs.copy"><code class="docutils literal notranslate"><span class="pre">FlightArgs.copy()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight_args.FlightArgs.data_in"><code class="docutils literal notranslate"><span class="pre">FlightArgs.data_in</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight_args.FlightArgs.data_out"><code class="docutils literal notranslate"><span class="pre">FlightArgs.data_out</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight_args.FlightArgs.data_source"><code class="docutils literal notranslate"><span class="pre">FlightArgs.data_source</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight_args.FlightArgs.datemax"><code class="docutils literal notranslate"><span class="pre">FlightArgs.datemax</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight_args.FlightArgs.datemin"><code class="docutils literal notranslate"><span class="pre">FlightArgs.datemin</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight_args.FlightArgs.dict"><code class="docutils literal notranslate"><span class="pre">FlightArgs.dict()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight_args.FlightArgs.files"><code class="docutils literal notranslate"><span class="pre">FlightArgs.files</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight_args.FlightArgs.from_orm"><code class="docutils literal notranslate"><span class="pre">FlightArgs.from_orm()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight_args.FlightArgs.json"><code class="docutils literal notranslate"><span class="pre">FlightArgs.json()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight_args.FlightArgs.model_computed_fields"><code class="docutils literal notranslate"><span class="pre">FlightArgs.model_computed_fields</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight_args.FlightArgs.model_config"><code class="docutils literal notranslate"><span class="pre">FlightArgs.model_config</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight_args.FlightArgs.model_construct"><code class="docutils literal notranslate"><span class="pre">FlightArgs.model_construct()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight_args.FlightArgs.model_copy"><code class="docutils literal notranslate"><span class="pre">FlightArgs.model_copy()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight_args.FlightArgs.model_dump"><code class="docutils literal notranslate"><span class="pre">FlightArgs.model_dump()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight_args.FlightArgs.model_dump_json"><code class="docutils literal notranslate"><span class="pre">FlightArgs.model_dump_json()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight_args.FlightArgs.model_extra"><code class="docutils literal notranslate"><span class="pre">FlightArgs.model_extra</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight_args.FlightArgs.model_fields"><code class="docutils literal notranslate"><span class="pre">FlightArgs.model_fields</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight_args.FlightArgs.model_fields_set"><code class="docutils literal notranslate"><span class="pre">FlightArgs.model_fields_set</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight_args.FlightArgs.model_json_schema"><code class="docutils literal notranslate"><span class="pre">FlightArgs.model_json_schema()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight_args.FlightArgs.model_parametrized_name"><code class="docutils literal notranslate"><span class="pre">FlightArgs.model_parametrized_name()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight_args.FlightArgs.model_post_init"><code class="docutils literal notranslate"><span class="pre">FlightArgs.model_post_init()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight_args.FlightArgs.model_rebuild"><code class="docutils literal notranslate"><span class="pre">FlightArgs.model_rebuild()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight_args.FlightArgs.model_validate"><code class="docutils literal notranslate"><span class="pre">FlightArgs.model_validate()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight_args.FlightArgs.model_validate_json"><code class="docutils literal notranslate"><span class="pre">FlightArgs.model_validate_json()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight_args.FlightArgs.model_validate_strings"><code class="docutils literal notranslate"><span class="pre">FlightArgs.model_validate_strings()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight_args.FlightArgs.nfile"><code class="docutils literal notranslate"><span class="pre">FlightArgs.nfile</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight_args.FlightArgs.nread"><code class="docutils literal notranslate"><span class="pre">FlightArgs.nread</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight_args.FlightArgs.nskip"><code class="docutils literal notranslate"><span class="pre">FlightArgs.nskip</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight_args.FlightArgs.output_format"><code class="docutils literal notranslate"><span class="pre">FlightArgs.output_format</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight_args.FlightArgs.parse_file"><code class="docutils literal notranslate"><span class="pre">FlightArgs.parse_file()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight_args.FlightArgs.parse_obj"><code class="docutils literal notranslate"><span class="pre">FlightArgs.parse_obj()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight_args.FlightArgs.parse_raw"><code class="docutils literal notranslate"><span class="pre">FlightArgs.parse_raw()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight_args.FlightArgs.reset_target"><code class="docutils literal notranslate"><span class="pre">FlightArgs.reset_target</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight_args.FlightArgs.sampling_rate"><code class="docutils literal notranslate"><span class="pre">FlightArgs.sampling_rate</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight_args.FlightArgs.schema"><code class="docutils literal notranslate"><span class="pre">FlightArgs.schema()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight_args.FlightArgs.schema_json"><code class="docutils literal notranslate"><span class="pre">FlightArgs.schema_json()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight_args.FlightArgs.to_toml_payload"><code class="docutils literal notranslate"><span class="pre">FlightArgs.to_toml_payload()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight_args.FlightArgs.update_forward_refs"><code class="docutils literal notranslate"><span class="pre">FlightArgs.update_forward_refs()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight_args.FlightArgs.validate"><code class="docutils literal notranslate"><span class="pre">FlightArgs.validate()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../flight-project.html#flight.flight_args.FlightArgsTD"><code class="docutils literal notranslate"><span class="pre">FlightArgsTD</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight_args.FlightArgsTD.__init__"><code class="docutils literal notranslate"><span class="pre">FlightArgsTD.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight_args.FlightArgsTD.clear"><code class="docutils literal notranslate"><span class="pre">FlightArgsTD.clear()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight_args.FlightArgsTD.copy"><code class="docutils literal notranslate"><span class="pre">FlightArgsTD.copy()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight_args.FlightArgsTD.data_in"><code class="docutils literal notranslate"><span class="pre">FlightArgsTD.data_in</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight_args.FlightArgsTD.data_out"><code class="docutils literal notranslate"><span class="pre">FlightArgsTD.data_out</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight_args.FlightArgsTD.data_source"><code class="docutils literal notranslate"><span class="pre">FlightArgsTD.data_source</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight_args.FlightArgsTD.datemax"><code class="docutils literal notranslate"><span class="pre">FlightArgsTD.datemax</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight_args.FlightArgsTD.datemin"><code class="docutils literal notranslate"><span class="pre">FlightArgsTD.datemin</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight_args.FlightArgsTD.files"><code class="docutils literal notranslate"><span class="pre">FlightArgsTD.files</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight_args.FlightArgsTD.fromkeys"><code class="docutils literal notranslate"><span class="pre">FlightArgsTD.fromkeys()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight_args.FlightArgsTD.get"><code class="docutils literal notranslate"><span class="pre">FlightArgsTD.get()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight_args.FlightArgsTD.items"><code class="docutils literal notranslate"><span class="pre">FlightArgsTD.items()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight_args.FlightArgsTD.keys"><code class="docutils literal notranslate"><span class="pre">FlightArgsTD.keys()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight_args.FlightArgsTD.nfile"><code class="docutils literal notranslate"><span class="pre">FlightArgsTD.nfile</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight_args.FlightArgsTD.nread"><code class="docutils literal notranslate"><span class="pre">FlightArgsTD.nread</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight_args.FlightArgsTD.nskip"><code class="docutils literal notranslate"><span class="pre">FlightArgsTD.nskip</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight_args.FlightArgsTD.output_format"><code class="docutils literal notranslate"><span class="pre">FlightArgsTD.output_format</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight_args.FlightArgsTD.pop"><code class="docutils literal notranslate"><span class="pre">FlightArgsTD.pop()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight_args.FlightArgsTD.popitem"><code class="docutils literal notranslate"><span class="pre">FlightArgsTD.popitem()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight_args.FlightArgsTD.reset_target"><code class="docutils literal notranslate"><span class="pre">FlightArgsTD.reset_target</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight_args.FlightArgsTD.sampling_rate"><code class="docutils literal notranslate"><span class="pre">FlightArgsTD.sampling_rate</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight_args.FlightArgsTD.setdefault"><code class="docutils literal notranslate"><span class="pre">FlightArgsTD.setdefault()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight_args.FlightArgsTD.update"><code class="docutils literal notranslate"><span class="pre">FlightArgsTD.update()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight.flight_args.FlightArgsTD.values"><code class="docutils literal notranslate"><span class="pre">FlightArgsTD.values()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../flight-project.html#flight.flight_args.apply_source_defaults"><code class="docutils literal notranslate"><span class="pre">apply_source_defaults()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../flight-project.html#flight.flight_args.dump_args"><code class="docutils literal notranslate"><span class="pre">dump_args()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../flight-project.html#flight.flight_args.dump_args_to_toml"><code class="docutils literal notranslate"><span class="pre">dump_args_to_toml()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../flight-project.html#flight.flight_args.ensure_defaults"><code class="docutils literal notranslate"><span class="pre">ensure_defaults()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../flight-project.html#flight.flight_args.load_args"><code class="docutils literal notranslate"><span class="pre">load_args()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../flight-project.html#flight.flight_args.load_args_from_toml"><code class="docutils literal notranslate"><span class="pre">load_args_from_toml()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../flight-project.html#flight.flight_args.merge_args"><code class="docutils literal notranslate"><span class="pre">merge_args()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../flight-project.html#flight_worker.flight_worker.FlightWorker"><code class="docutils literal notranslate"><span class="pre">FlightWorker</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight_worker.flight_worker.FlightWorker.args_dump_mode"><code class="docutils literal notranslate"><span class="pre">FlightWorker.args_dump_mode</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight_worker.flight_worker.FlightWorker.args_dumper"><code class="docutils literal notranslate"><span class="pre">FlightWorker.args_dumper</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight_worker.flight_worker.FlightWorker.args_ensure_defaults"><code class="docutils literal notranslate"><span class="pre">FlightWorker.args_ensure_defaults</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight_worker.flight_worker.FlightWorker.args_loader"><code class="docutils literal notranslate"><span class="pre">FlightWorker.args_loader</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight_worker.flight_worker.FlightWorker.args_merger"><code class="docutils literal notranslate"><span class="pre">FlightWorker.args_merger</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight_worker.flight_worker.FlightWorker.as_dict"><code class="docutils literal notranslate"><span class="pre">FlightWorker.as_dict()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight_worker.flight_worker.FlightWorker.break"><code class="docutils literal notranslate"><span class="pre">FlightWorker.break()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight_worker.flight_worker.FlightWorker.break_loop"><code class="docutils literal notranslate"><span class="pre">FlightWorker.break_loop()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight_worker.flight_worker.FlightWorker.calculate_speed"><code class="docutils literal notranslate"><span class="pre">FlightWorker.calculate_speed()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight_worker.flight_worker.FlightWorker.default_settings_path"><code class="docutils literal notranslate"><span class="pre">FlightWorker.default_settings_path</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight_worker.flight_worker.FlightWorker.default_settings_section"><code class="docutils literal notranslate"><span class="pre">FlightWorker.default_settings_section</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight_worker.flight_worker.FlightWorker.env"><code class="docutils literal notranslate"><span class="pre">FlightWorker.env</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight_worker.flight_worker.FlightWorker.expand"><code class="docutils literal notranslate"><span class="pre">FlightWorker.expand()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight_worker.flight_worker.FlightWorker.expand_and_join"><code class="docutils literal notranslate"><span class="pre">FlightWorker.expand_and_join()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight_worker.flight_worker.FlightWorker.from_toml"><code class="docutils literal notranslate"><span class="pre">FlightWorker.from_toml()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight_worker.flight_worker.FlightWorker.loop"><code class="docutils literal notranslate"><span class="pre">FlightWorker.loop()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight_worker.flight_worker.FlightWorker.managed_pc_home_suffix"><code class="docutils literal notranslate"><span class="pre">FlightWorker.managed_pc_home_suffix</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight_worker.flight_worker.FlightWorker.managed_pc_path_fields"><code class="docutils literal notranslate"><span class="pre">FlightWorker.managed_pc_path_fields</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight_worker.flight_worker.FlightWorker.normalize_dataset_path"><code class="docutils literal notranslate"><span class="pre">FlightWorker.normalize_dataset_path()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight_worker.flight_worker.FlightWorker.pool_init"><code class="docutils literal notranslate"><span class="pre">FlightWorker.pool_init()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight_worker.flight_worker.FlightWorker.pool_vars"><code class="docutils literal notranslate"><span class="pre">FlightWorker.pool_vars</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight_worker.flight_worker.FlightWorker.prepare_output_dir"><code class="docutils literal notranslate"><span class="pre">FlightWorker.prepare_output_dir()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight_worker.flight_worker.FlightWorker.preprocess_df"><code class="docutils literal notranslate"><span class="pre">FlightWorker.preprocess_df()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight_worker.flight_worker.FlightWorker.setup_args"><code class="docutils literal notranslate"><span class="pre">FlightWorker.setup_args()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight_worker.flight_worker.FlightWorker.setup_data_directories"><code class="docutils literal notranslate"><span class="pre">FlightWorker.setup_data_directories()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight_worker.flight_worker.FlightWorker.start"><code class="docutils literal notranslate"><span class="pre">FlightWorker.start()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight_worker.flight_worker.FlightWorker.stop"><code class="docutils literal notranslate"><span class="pre">FlightWorker.stop()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight_worker.flight_worker.FlightWorker.to_toml"><code class="docutils literal notranslate"><span class="pre">FlightWorker.to_toml()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight_worker.flight_worker.FlightWorker.verbose"><code class="docutils literal notranslate"><span class="pre">FlightWorker.verbose</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight_worker.flight_worker.FlightWorker.work_done"><code class="docutils literal notranslate"><span class="pre">FlightWorker.work_done()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight_worker.flight_worker.FlightWorker.work_init"><code class="docutils literal notranslate"><span class="pre">FlightWorker.work_init()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight_worker.flight_worker.FlightWorker.work_pool"><code class="docutils literal notranslate"><span class="pre">FlightWorker.work_pool()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../flight-project.html#flight_worker.flight_worker.FlightWorker.works"><code class="docutils literal notranslate"><span class="pre">FlightWorker.works()</span></code></a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Hosting Sites</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../agilab-github.html"><strong>Agilab project</strong></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../agilab-github.html#agilab-components"><strong>Agilab components</strong></a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">AGILab</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">agi_cluster.agi_distributor.agi_distributor</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for agi_cluster.agi_distributor.agi_distributor</h1><div class="highlight"><pre>
<span></span><span class="c1"># BSD 3-Clause License</span>
<span class="c1">#</span>
<span class="c1"># Copyright (c) 2025, Jean-Pierre Morard, THALES SIX GTS France SAS</span>
<span class="c1"># All rights reserved.</span>
<span class="c1">#</span>
<span class="c1"># Redistribution and use in source and binary forms, with or without modification, are permitted provided that the following conditions are met:</span>
<span class="c1">#</span>
<span class="c1"># 1. Redistributions of source code must retain the above copyright notice, this list of conditions and the following disclaimer.</span>
<span class="c1"># 2. Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following disclaimer in the documentation and/or other materials provided with the distribution.</span>
<span class="c1"># 3. Neither the name of Jean-Pierre Morard nor the names of its contributors, or THALES SIX GTS France SAS, may be used to endorse or promote products derived from this software without specific prior written permission.</span>
<span class="c1">#</span>
<span class="c1"># THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>
<span class="sd">&quot;&quot;&quot;Cluster workplan utilities for distributing AGILab workloads.&quot;&quot;&quot;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">traceback</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Set</span>  <span class="c1"># Ajoute Tuple et Set</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">IPython.lib</span><span class="w"> </span><span class="kn">import</span> <span class="n">backgroundjobs</span> <span class="k">as</span> <span class="n">bg</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">inspect</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">getpass</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">io</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pickle</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">random</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">shutil</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">socket</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">shlex</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">copy</span><span class="w"> </span><span class="kn">import</span> <span class="n">deepcopy</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">timedelta</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ipaddress</span><span class="w"> </span><span class="kn">import</span> <span class="n">ip_address</span> <span class="k">as</span> <span class="n">is_ip</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tempfile</span><span class="w"> </span><span class="kn">import</span> <span class="n">gettempdir</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">agi_cluster.agi_distributor</span><span class="w"> </span><span class="kn">import</span> <span class="n">cli</span> <span class="k">as</span> <span class="n">distributor_cli</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">agi_env</span><span class="w"> </span><span class="kn">import</span> <span class="n">normalize_path</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="c1"># ---------------------------------------------------------------------------</span>
<span class="c1"># Asyncio compatibility helpers (PyCharm debugger patches asyncio.run)</span>
<span class="c1"># ---------------------------------------------------------------------------</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_ensure_asyncio_run_signature</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Ensure ``asyncio.run`` accepts the ``loop_factory`` argument.</span>

<span class="sd">    PyCharm&#39;s debugger replaces ``asyncio.run`` with a shim that only accepts</span>
<span class="sd">    ``main`` and ``debug``.  Python 3.13 introduced a ``loop_factory`` keyword</span>
<span class="sd">    that ``distributed`` relies on; without it, AGI runs fail with</span>
<span class="sd">    ``TypeError``.  When we detect the truncated signature (and the replacement</span>
<span class="sd">    originates from ``pydevd``), we wrap it so ``loop_factory`` works again.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">current</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">current</span><span class="p">)</span><span class="o">.</span><span class="n">parameters</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>  <span class="c1"># pragma: no cover - unable to introspect</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="s2">&quot;loop_factory&quot;</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="k">if</span> <span class="s2">&quot;pydevd&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="s2">&quot;__module__&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="k">return</span>

    <span class="n">original</span> <span class="o">=</span> <span class="n">current</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_patched_run</span><span class="p">(</span><span class="n">main</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">loop_factory</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">loop_factory</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">original</span><span class="p">(</span><span class="n">main</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">)</span>

        <span class="n">loop</span> <span class="o">=</span> <span class="n">loop_factory</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">asyncio</span><span class="o">.</span><span class="n">set_event_loop</span><span class="p">(</span><span class="n">loop</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">if</span> <span class="n">debug</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">loop</span><span class="o">.</span><span class="n">set_debug</span><span class="p">(</span><span class="n">debug</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">main</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">loop</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">asyncio</span><span class="o">.</span><span class="n">set_event_loop</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
                    <span class="k">pass</span>

    <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span> <span class="o">=</span> <span class="n">_patched_run</span>


<span class="n">_ensure_asyncio_run_signature</span><span class="p">()</span>


<span class="c1"># --- Added minimal TestPyPI fallback for uv sync ---</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_agi__version_missing_on_pypi</span><span class="p">(</span><span class="n">project_path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return True if any pinned &#39;agi*&#39; or &#39;agilab&#39; dependency version in pyproject.toml</span>
<span class="sd">    is not available on pypi.org (so we should use TestPyPI fallback).&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">json</span><span class="o">,</span><span class="w"> </span><span class="nn">urllib.request</span><span class="o">,</span><span class="w"> </span><span class="nn">re</span>
        <span class="n">pyproj</span> <span class="o">=</span> <span class="p">(</span><span class="n">project_path</span> <span class="o">/</span> <span class="s1">&#39;pyproject.toml&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pyproj</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">pyproj</span><span class="o">.</span><span class="n">read_text</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
        <span class="c1"># naive scan for lines like: agi-core = &quot;==1.2.3&quot; or &quot;1.2.3&quot;</span>
        <span class="n">deps</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^(?:\s*)(ag(?:i[-_].+|ilab))\s*=\s*[&quot;</span><span class="se">\&#39;</span><span class="s1">]([^&quot;</span><span class="se">\&#39;</span><span class="s1">]+)[&quot;</span><span class="se">\&#39;</span><span class="s1">]&#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">deps</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="c1"># extract exact pins</span>
        <span class="n">pairs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">spec</span> <span class="ow">in</span> <span class="n">deps</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^(?:==\s*)?(\d+(?:\.\d+){1,2})$&#39;</span><span class="p">,</span> <span class="n">spec</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
                <span class="n">version</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">pairs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">),</span> <span class="n">version</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pairs</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="c1"># check first pair only to keep it minimal/fast</span>
        <span class="n">pkg</span><span class="p">,</span> <span class="n">ver</span> <span class="o">=</span> <span class="n">pairs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;https://pypi.org/pypi/</span><span class="si">{</span><span class="n">pkg</span><span class="si">}</span><span class="s1">/json&#39;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span> <span class="k">as</span> <span class="n">r</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
            <span class="n">exists</span> <span class="o">=</span> <span class="n">ver</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;releases&#39;</span><span class="p">,</span> <span class="p">{})</span>
            <span class="k">return</span> <span class="ow">not</span> <span class="n">exists</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="c1"># If pypi query fails, don&#39;t force fallback.</span>
            <span class="k">return</span> <span class="kc">False</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>


<span class="c1"># --- end added helper ---</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Union</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sysconfig</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">contextlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">redirect_stdout</span><span class="p">,</span> <span class="n">redirect_stderr</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">errno</span>

<span class="c1"># External Libraries</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">asyncssh</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">asyncssh.process</span><span class="w"> </span><span class="kn">import</span> <span class="n">ProcessError</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">contextlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">asynccontextmanager</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">humanize</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">polars</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pl</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">psutil</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dask.distributed</span><span class="w"> </span><span class="kn">import</span> <span class="n">Client</span><span class="p">,</span> <span class="n">wait</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.ensemble</span><span class="w"> </span><span class="kn">import</span> <span class="n">RandomForestRegressor</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">subprocess</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">runpy</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">tomlkit</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">packaging.requirements</span><span class="w"> </span><span class="kn">import</span> <span class="n">Requirement</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">importlib.metadata</span><span class="w"> </span><span class="kn">import</span> <span class="n">PackageNotFoundError</span><span class="p">,</span> <span class="n">version</span> <span class="k">as</span> <span class="n">pkg_version</span>

<span class="c1"># Project Libraries:</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">agi_env</span><span class="w"> </span><span class="kn">import</span> <span class="n">AgiEnv</span><span class="p">,</span> <span class="n">normalize_path</span>

<span class="n">_node_src</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">prefix</span><span class="p">)</span><span class="o">.</span><span class="n">parents</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="s2">&quot;agi-node/src&quot;</span><span class="p">)</span>
<span class="k">if</span> <span class="n">_node_src</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="p">:</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_node_src</span><span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">agi_node.agi_dispatcher</span><span class="w"> </span><span class="kn">import</span> <span class="n">WorkDispatcher</span><span class="p">,</span> <span class="n">BaseWorker</span>

<span class="c1"># os.environ[&quot;DASK_DISTRIBUTED__LOGGING__DISTRIBUTED__LEVEL&quot;] = &quot;INFO&quot;</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
<span class="n">_workers_default</span> <span class="o">=</span> <span class="p">{</span><span class="n">socket</span><span class="o">.</span><span class="n">gethostbyname</span><span class="p">(</span><span class="s2">&quot;localhost&quot;</span><span class="p">):</span> <span class="mi">1</span><span class="p">}</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">agi_env.agi_logger</span><span class="w"> </span><span class="kn">import</span> <span class="n">AgiLogger</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">AgiLogger</span><span class="o">.</span><span class="n">get_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<div class="viewcode-block" id="AGI">
<a class="viewcode-back" href="../../../module-agi-cluster.html#agi_cluster.agi_distributor.agi_distributor.AGI">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">AGI</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Coordinate installation, scheduling, and execution of AGILab workloads.&quot;&quot;&quot;</span>

    <span class="c1"># Constants as class attributes</span>
    <span class="n">_TIMEOUT</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="n">PYTHON_MODE</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">CYTHON_MODE</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">DASK_MODE</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="n">RAPIDS_MODE</span> <span class="o">=</span> <span class="mi">16</span>
    <span class="n">_INSTALL_MASK</span> <span class="o">=</span> <span class="mb">0b11</span> <span class="o">&lt;&lt;</span> <span class="n">DASK_MODE</span>
    <span class="n">_INSTALL_MODE</span> <span class="o">=</span> <span class="mb">0b01</span> <span class="o">&lt;&lt;</span> <span class="n">DASK_MODE</span>
    <span class="n">_UPDATE_MODE</span> <span class="o">=</span> <span class="mb">0b10</span> <span class="o">&lt;&lt;</span> <span class="n">DASK_MODE</span>
    <span class="n">_SIMULATE_MODE</span> <span class="o">=</span> <span class="mb">0b11</span> <span class="o">&lt;&lt;</span> <span class="n">DASK_MODE</span>
    <span class="n">_DEPLOYEMENT_MASK</span> <span class="o">=</span> <span class="mb">0b110000</span>
    <span class="n">_RUN_MASK</span> <span class="o">=</span> <span class="mb">0b001111</span>
    <span class="n">_RAPIDS_SET</span> <span class="o">=</span> <span class="mb">0b111111</span>
    <span class="n">_RAPIDS_RESET</span> <span class="o">=</span> <span class="mb">0b110111</span>
    <span class="n">_DASK_RESET</span> <span class="o">=</span> <span class="mb">0b111011</span>
    <span class="n">_args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_dask_client</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Client</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_dask_scheduler</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_dask_workers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_jobs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">bg</span><span class="o">.</span><span class="n">BackgroundJobManager</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_local_ip</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">_install_done_local</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">_mode</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_mode_auto</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">_remote_ip</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">_install_done</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">_install_todo</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">_scheduler</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_scheduler_ip</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_target</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">verbose</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_worker_init_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">_workers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_capacity</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_capacity_data_file</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_capacity_model_file</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_capacity_predictor</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">RandomForestRegressor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_worker_default</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">_workers_default</span>
    <span class="n">_run_time</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">_run_type</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_run_types</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">_target_built</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_module_to_clean</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">_ssh_connections</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">_best_mode</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">_work_plan</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_work_plan_metadata</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">debug</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Cache with default local IPs</span>
    <span class="n">_dask_log_level</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;AGI_DASK_LOG_LEVEL&quot;</span><span class="p">,</span> <span class="s2">&quot;critical&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="n">env</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AgiEnv</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_service_futures</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">_service_workers</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">_service_shutdown_on_stop</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">_service_stop_timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">30.0</span>
    <span class="n">_service_poll_interval</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="AGI.__init__">
<a class="viewcode-back" href="../../../module-agi-cluster.html#agi_cluster.agi_distributor.agi_distributor.AGI.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize a Agi object with a target and verbosity level.</span>

<span class="sd">        Args:</span>
<span class="sd">            target (str): The target for the env object.</span>
<span class="sd">            verbose (int): Verbosity level (0-3).</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>

<span class="sd">        Raises:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># At the top of __init__:</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">AGI</span><span class="p">,</span> <span class="s2">&quot;_instantiated&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_instantiated</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;AGI class is a singleton. Only one instance allowed per process.&quot;</span><span class="p">)</span>
        <span class="n">AGI</span><span class="o">.</span><span class="n">_instantiated</span> <span class="o">=</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="AGI.run">
<a class="viewcode-back" href="../../../module-agi-cluster.html#agi_cluster.agi_distributor.agi_distributor.AGI.run">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span>
            <span class="n">env</span><span class="p">:</span> <span class="n">AgiEnv</span><span class="p">,</span>  <span class="c1"># some_default_value must be defined</span>
            <span class="n">scheduler</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">workers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">verbose</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
            <span class="n">mode</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">rapids_enabled</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
            <span class="o">**</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compiles the target module in Cython and runs it on the cluster.</span>

<span class="sd">        Args:</span>
<span class="sd">            target (str): The target Python module to run.</span>
<span class="sd">            scheduler (str, optional): IP and port address of the Dask scheduler. Defaults to &#39;127.0.0.1:8786&#39;.</span>
<span class="sd">            workers (dict, optional): Dictionary of worker IPs and their counts. Defaults to `workers_default`.</span>
<span class="sd">            verbose (int, optional): Verbosity level. Defaults to 0.</span>
<span class="sd">            mode (int | list[int] | str | None, optional): Mode(s) for execution. Defaults to None.</span>
<span class="sd">                When an int is provided, it is treated as a 4-bit mask controlling RAPIDS/Dask/Cython/Pool features.</span>
<span class="sd">                When a string is provided, it must match r&quot;^[dcrp]+$&quot; (letters enable features).</span>
<span class="sd">                When a list is provided, the modes are benchmarked sequentially.</span>
<span class="sd">            rapids_enabled (bool, optional): Flag to enable RAPIDS. Defaults to False.</span>
<span class="sd">            **args (Any): Additional keyword arguments.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Any: Result of the execution.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If `mode` is invalid.</span>
<span class="sd">            RuntimeError: If the target module fails to load.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">AGI</span><span class="o">.</span><span class="n">env</span> <span class="o">=</span> <span class="n">env</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">workers</span><span class="p">:</span>
            <span class="n">workers</span> <span class="o">=</span> <span class="n">_workers_default</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">workers</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;workers must be a dict. {&#39;ip-address&#39;:nb-worker}&quot;</span><span class="p">)</span>

        <span class="n">AGI</span><span class="o">.</span><span class="n">target_path</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">manager_path</span>
        <span class="n">AGI</span><span class="o">.</span><span class="n">_target</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">target</span>
        <span class="n">AGI</span><span class="o">.</span><span class="n">_rapids_enabled</span> <span class="o">=</span> <span class="n">rapids_enabled</span>
        <span class="k">if</span> <span class="n">env</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AGI instance created for target </span><span class="si">{</span><span class="n">env</span><span class="o">.</span><span class="n">target</span><span class="si">}</span><span class="s2"> with verbosity </span><span class="si">{</span><span class="n">env</span><span class="o">.</span><span class="n">verbose</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">mode</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">mode_range</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="k">if</span> <span class="n">mode</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>
            <span class="k">return</span> <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_benchmark</span><span class="p">(</span>
                <span class="n">env</span><span class="p">,</span> <span class="n">scheduler</span><span class="p">,</span> <span class="n">workers</span><span class="p">,</span> <span class="n">verbose</span><span class="p">,</span> <span class="n">mode_range</span><span class="p">,</span> <span class="n">rapids_enabled</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;^[dcrp]+$&quot;</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">fullmatch</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">mode</span><span class="o">.</span><span class="n">lower</span><span class="p">()):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;parameter &lt;mode&gt; must only contain the letters &#39;d&#39;, &#39;c&#39;, &#39;r&#39;, &#39;p&#39;&quot;</span><span class="p">)</span>
                <span class="n">AGI</span><span class="o">.</span><span class="n">_mode</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">mode2int</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                <span class="n">AGI</span><span class="o">.</span><span class="n">_mode</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;parameter &lt;mode&gt; must be an int, a list of int or a string&quot;</span><span class="p">)</span>

            <span class="n">AGI</span><span class="o">.</span><span class="n">_run_types</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;run --no-sync&quot;</span><span class="p">,</span> <span class="s2">&quot;sync --dev&quot;</span><span class="p">,</span> <span class="s2">&quot;sync --upgrade --dev&quot;</span><span class="p">,</span> <span class="s2">&quot;simulate&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_mode</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_mode</span> <span class="o">&amp;</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_RUN_MASK</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">AGI</span><span class="o">.</span><span class="n">RAPIDS_MODE</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;mode </span><span class="si">{</span><span class="n">AGI</span><span class="o">.</span><span class="n">_mode</span><span class="si">}</span><span class="s2"> not implemented&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># 16 first modes are &quot;run&quot; type, then there 16, 17 and 18</span>
                <span class="n">AGI</span><span class="o">.</span><span class="n">_run_type</span> <span class="o">=</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_run_types</span><span class="p">[(</span><span class="n">AGI</span><span class="o">.</span><span class="n">_mode</span> <span class="o">&amp;</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_DEPLOYEMENT_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">AGI</span><span class="o">.</span><span class="n">DASK_MODE</span><span class="p">]</span>
            <span class="n">AGI</span><span class="o">.</span><span class="n">_args</span> <span class="o">=</span> <span class="n">args</span>
            <span class="n">AGI</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>
            <span class="n">AGI</span><span class="o">.</span><span class="n">_workers</span> <span class="o">=</span> <span class="n">workers</span>
            <span class="n">AGI</span><span class="o">.</span><span class="n">_run_time</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="n">AGI</span><span class="o">.</span><span class="n">_capacity_data_file</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">resources_path</span> <span class="o">/</span> <span class="s2">&quot;balancer_df.csv&quot;</span>
            <span class="n">AGI</span><span class="o">.</span><span class="n">_capacity_model_file</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">resources_path</span> <span class="o">/</span> <span class="s2">&quot;balancer_model.pkl&quot;</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">AGI</span><span class="o">.</span><span class="n">_capacity_model_file</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">AGI</span><span class="o">.</span><span class="n">_capacity_predictor</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">AGI</span><span class="o">.</span><span class="n">_train_capacity</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">home_abs</span><span class="p">))</span>

        <span class="c1"># import of derived Class of WorkDispatcher, name target_inst which is typically instance of Flight or MyCode</span>
        <span class="n">AGI</span><span class="o">.</span><span class="n">agi_workers</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;AgiDataWorker&quot;</span><span class="p">:</span> <span class="s2">&quot;pandas-worker&quot;</span><span class="p">,</span>
            <span class="s2">&quot;PolarsWorker&quot;</span><span class="p">:</span> <span class="s2">&quot;polars-worker&quot;</span><span class="p">,</span>
            <span class="s2">&quot;PandasWorker&quot;</span><span class="p">:</span> <span class="s2">&quot;pandas-worker&quot;</span><span class="p">,</span>
            <span class="s2">&quot;FireducksWorker&quot;</span><span class="p">:</span> <span class="s2">&quot;fireducks-worker&quot;</span><span class="p">,</span>
            <span class="s2">&quot;DagWorker&quot;</span><span class="p">:</span> <span class="s2">&quot;dag-worker&quot;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">AGI</span><span class="o">.</span><span class="n">install_worker_group</span> <span class="o">=</span> <span class="p">[</span><span class="n">AGI</span><span class="o">.</span><span class="n">agi_workers</span><span class="p">[</span><span class="n">env</span><span class="o">.</span><span class="n">base_worker_cls</span><span class="p">]]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_main</span><span class="p">(</span><span class="n">scheduler</span><span class="p">)</span>

        <span class="k">except</span> <span class="n">ProcessError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;failed to run </span><span class="se">\n</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">except</span> <span class="ne">ConnectionError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">or</span> <span class="s2">&quot;Failed to connect to remote host.&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">message</span><span class="p">,</span> <span class="s2">&quot;kind&quot;</span><span class="p">:</span> <span class="s2">&quot;connection&quot;</span><span class="p">}</span>

        <span class="k">except</span> <span class="ne">ModuleNotFoundError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;failed to load module </span><span class="se">\n</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="n">_format_exception_chain</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unhandled exception in AGI.run: </span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">logger</span><span class="o">.</span><span class="n">isEnabledFor</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Traceback:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="k">raise</span></div>


<div class="viewcode-block" id="AGI.serve">
<a class="viewcode-back" href="../../../module-agi-cluster.html#agi_cluster.agi_distributor.agi_distributor.AGI.serve">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">serve</span><span class="p">(</span>
            <span class="n">env</span><span class="p">:</span> <span class="n">AgiEnv</span><span class="p">,</span>
            <span class="n">scheduler</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">workers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">verbose</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
            <span class="n">mode</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">rapids_enabled</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
            <span class="n">action</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;start&quot;</span><span class="p">,</span>
            <span class="n">poll_interval</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">shutdown_on_stop</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
            <span class="n">stop_timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">30.0</span><span class="p">,</span>
            <span class="o">**</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Manage persistent worker services without invoking the run workplan.</span>

<span class="sd">        ``action=&quot;start&quot;`` provisions workers and submits ``BaseWorker.loop`` as a</span>
<span class="sd">        long-lived service task pinned to each Dask worker. ``action=&quot;stop&quot;``</span>
<span class="sd">        signals the loop through ``BaseWorker.break`` and optionally tears down</span>
<span class="sd">        the Dask cluster when ``shutdown_on_stop`` is true.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">command</span> <span class="o">=</span> <span class="p">(</span><span class="n">action</span> <span class="ow">or</span> <span class="s2">&quot;start&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">command</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;start&quot;</span><span class="p">,</span> <span class="s2">&quot;stop&quot;</span><span class="p">}:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;action must be &#39;start&#39; or &#39;stop&#39;&quot;</span><span class="p">)</span>

        <span class="n">AGI</span><span class="o">.</span><span class="n">_service_shutdown_on_stop</span> <span class="o">=</span> <span class="n">shutdown_on_stop</span>
        <span class="n">AGI</span><span class="o">.</span><span class="n">_service_stop_timeout</span> <span class="o">=</span> <span class="n">stop_timeout</span>
        <span class="n">AGI</span><span class="o">.</span><span class="n">_service_poll_interval</span> <span class="o">=</span> <span class="n">poll_interval</span>

        <span class="k">if</span> <span class="n">command</span> <span class="o">==</span> <span class="s2">&quot;stop&quot;</span><span class="p">:</span>
            <span class="n">client</span> <span class="o">=</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_dask_client</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_service_futures</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;AGI.serve(stop): no active service loops to stop.&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">shutdown_on_stop</span> <span class="ow">and</span> <span class="n">client</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_stop</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_jobs</span><span class="p">:</span>
                    <span class="n">AGI</span><span class="o">.</span><span class="n">_clean_job</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;idle&quot;</span><span class="p">,</span> <span class="s2">&quot;workers&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;pending&quot;</span><span class="p">:</span> <span class="p">[]}</span>

            <span class="k">if</span> <span class="n">client</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="s2">&quot;AGI.serve(stop): service futures registered but Dask client is unavailable&quot;</span>
                <span class="p">)</span>
                <span class="n">pending</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">AGI</span><span class="o">.</span><span class="n">_service_futures</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                <span class="n">AGI</span><span class="o">.</span><span class="n">_service_futures</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
                <span class="n">AGI</span><span class="o">.</span><span class="n">_service_workers</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_jobs</span><span class="p">:</span>
                    <span class="n">AGI</span><span class="o">.</span><span class="n">_clean_job</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="s2">&quot;workers&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;pending&quot;</span><span class="p">:</span> <span class="n">pending</span><span class="p">}</span>

            <span class="n">future_map</span> <span class="o">=</span> <span class="p">{</span><span class="n">future</span><span class="p">:</span> <span class="n">worker</span> <span class="k">for</span> <span class="n">worker</span><span class="p">,</span> <span class="n">future</span> <span class="ow">in</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_service_futures</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

            <span class="n">break_tasks</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">client</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span>
                    <span class="n">BaseWorker</span><span class="o">.</span><span class="n">break_loop</span><span class="p">,</span>
                    <span class="n">workers</span><span class="o">=</span><span class="p">[</span><span class="n">worker</span><span class="p">],</span>
                    <span class="n">allow_other_workers</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">pure</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">key</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;agi-serve-break-</span><span class="si">{</span><span class="n">env</span><span class="o">.</span><span class="n">target</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">worker</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;-&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">worker</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">AGI</span><span class="o">.</span><span class="n">_service_futures</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="p">]</span>
            <span class="n">client</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">break_tasks</span><span class="p">)</span>

            <span class="n">wait_kwargs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="n">stop_timeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">wait_kwargs</span><span class="p">[</span><span class="s2">&quot;timeout&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stop_timeout</span>

            <span class="n">done</span><span class="p">,</span> <span class="n">not_done</span> <span class="o">=</span> <span class="n">wait</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">future_map</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span> <span class="o">**</span><span class="n">wait_kwargs</span><span class="p">)</span>

            <span class="n">stopped_workers</span> <span class="o">=</span> <span class="p">[</span><span class="n">future_map</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">done</span><span class="p">]</span>
            <span class="n">pending_workers</span> <span class="o">=</span> <span class="p">[</span><span class="n">future_map</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">not_done</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">done</span><span class="p">:</span>
                <span class="n">client</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">done</span><span class="p">),</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;raise&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">pending_workers</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;Service loop shutdown timed out on workers: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">pending_workers</span>
                <span class="p">)</span>

            <span class="n">AGI</span><span class="o">.</span><span class="n">_service_futures</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="n">AGI</span><span class="o">.</span><span class="n">_service_workers</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">if</span> <span class="n">shutdown_on_stop</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_stop</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_jobs</span><span class="p">:</span>
                <span class="n">AGI</span><span class="o">.</span><span class="n">_clean_job</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

            <span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;stopped&quot;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">pending_workers</span> <span class="k">else</span> <span class="s2">&quot;partial&quot;</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="n">status</span><span class="p">,</span> <span class="s2">&quot;workers&quot;</span><span class="p">:</span> <span class="n">stopped_workers</span><span class="p">,</span> <span class="s2">&quot;pending&quot;</span><span class="p">:</span> <span class="n">pending_workers</span><span class="p">}</span>

        <span class="c1"># command == &quot;start&quot;</span>
        <span class="k">if</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_service_futures</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s2">&quot;Service loop already running. Please call AGI.serve(..., action=&#39;stop&#39;) first.&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">workers</span><span class="p">:</span>
            <span class="n">workers</span> <span class="o">=</span> <span class="n">_workers_default</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">workers</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;workers must be a dict. {&#39;ip-address&#39;:nb-worker}&quot;</span><span class="p">)</span>

        <span class="n">AGI</span><span class="o">.</span><span class="n">_jobs</span> <span class="o">=</span> <span class="n">bg</span><span class="o">.</span><span class="n">BackgroundJobManager</span><span class="p">()</span>
        <span class="n">AGI</span><span class="o">.</span><span class="n">env</span> <span class="o">=</span> <span class="n">env</span>
        <span class="n">AGI</span><span class="o">.</span><span class="n">target_path</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">manager_path</span>
        <span class="n">AGI</span><span class="o">.</span><span class="n">_target</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">target</span>
        <span class="n">AGI</span><span class="o">.</span><span class="n">_rapids_enabled</span> <span class="o">=</span> <span class="n">rapids_enabled</span>

        <span class="k">if</span> <span class="n">env</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;AGI service instance created for target </span><span class="si">%s</span><span class="s2"> with verbosity </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">env</span><span class="o">.</span><span class="n">target</span><span class="p">,</span>
                <span class="n">env</span><span class="o">.</span><span class="n">verbose</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">mode</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">AGI</span><span class="o">.</span><span class="n">_mode</span> <span class="o">=</span> <span class="n">AGI</span><span class="o">.</span><span class="n">DASK_MODE</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;^[dcrp]+$&quot;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">fullmatch</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">mode</span><span class="o">.</span><span class="n">lower</span><span class="p">()):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;parameter &lt;mode&gt; must only contain the letters &#39;d&#39;, &#39;c&#39;, &#39;r&#39;, &#39;p&#39;&quot;</span><span class="p">)</span>
            <span class="n">AGI</span><span class="o">.</span><span class="n">_mode</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">mode2int</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">AGI</span><span class="o">.</span><span class="n">_mode</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;parameter &lt;mode&gt; must be an int or a string&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">AGI</span><span class="o">.</span><span class="n">_mode</span> <span class="o">&amp;</span> <span class="n">AGI</span><span class="o">.</span><span class="n">DASK_MODE</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;AGI.serve requires Dask mode (include &#39;d&#39; in mode)&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_mode</span> <span class="o">&amp;</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_RUN_MASK</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">AGI</span><span class="o">.</span><span class="n">RAPIDS_MODE</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;mode </span><span class="si">{</span><span class="n">AGI</span><span class="o">.</span><span class="n">_mode</span><span class="si">}</span><span class="s2"> not implemented&quot;</span><span class="p">)</span>

        <span class="n">AGI</span><span class="o">.</span><span class="n">_mode_auto</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">AGI</span><span class="o">.</span><span class="n">_run_types</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;run --no-sync&quot;</span><span class="p">,</span> <span class="s2">&quot;sync --dev&quot;</span><span class="p">,</span> <span class="s2">&quot;sync --upgrade --dev&quot;</span><span class="p">,</span> <span class="s2">&quot;simulate&quot;</span><span class="p">]</span>
        <span class="n">AGI</span><span class="o">.</span><span class="n">_run_type</span> <span class="o">=</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_run_types</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">AGI</span><span class="o">.</span><span class="n">_args</span> <span class="o">=</span> <span class="n">args</span>
        <span class="n">AGI</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>
        <span class="n">AGI</span><span class="o">.</span><span class="n">_workers</span> <span class="o">=</span> <span class="n">workers</span>
        <span class="n">AGI</span><span class="o">.</span><span class="n">_run_time</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">AGI</span><span class="o">.</span><span class="n">_capacity_data_file</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">resources_path</span> <span class="o">/</span> <span class="s2">&quot;balancer_df.csv&quot;</span>
        <span class="n">AGI</span><span class="o">.</span><span class="n">_capacity_model_file</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">resources_path</span> <span class="o">/</span> <span class="s2">&quot;balancer_model.pkl&quot;</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">AGI</span><span class="o">.</span><span class="n">_capacity_model_file</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">AGI</span><span class="o">.</span><span class="n">_capacity_predictor</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">AGI</span><span class="o">.</span><span class="n">_train_capacity</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">home_abs</span><span class="p">))</span>

        <span class="n">AGI</span><span class="o">.</span><span class="n">agi_workers</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;PolarsWorker&quot;</span><span class="p">:</span> <span class="s2">&quot;polars-worker&quot;</span><span class="p">,</span>
            <span class="s2">&quot;PandasWorker&quot;</span><span class="p">:</span> <span class="s2">&quot;pandas-worker&quot;</span><span class="p">,</span>
            <span class="s2">&quot;FireducksWorker&quot;</span><span class="p">:</span> <span class="s2">&quot;fireducks-worker&quot;</span><span class="p">,</span>
            <span class="s2">&quot;DagWorker&quot;</span><span class="p">:</span> <span class="s2">&quot;dag-worker&quot;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">AGI</span><span class="o">.</span><span class="n">install_worker_group</span> <span class="o">=</span> <span class="p">[</span><span class="n">AGI</span><span class="o">.</span><span class="n">agi_workers</span><span class="p">[</span><span class="n">env</span><span class="o">.</span><span class="n">base_worker_cls</span><span class="p">]]</span>

        <span class="n">client</span> <span class="o">=</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_dask_client</span>
        <span class="k">if</span> <span class="n">client</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="s2">&quot;status&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;closed&quot;</span><span class="p">,</span> <span class="s2">&quot;closing&quot;</span><span class="p">}:</span>
            <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_start</span><span class="p">(</span><span class="n">scheduler</span><span class="p">)</span>
            <span class="n">client</span> <span class="o">=</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_dask_client</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_sync</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">client</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Failed to obtain Dask client for service start&quot;</span><span class="p">)</span>

        <span class="n">AGI</span><span class="o">.</span><span class="n">_dask_workers</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">worker</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">worker</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">client</span><span class="o">.</span><span class="n">scheduler_info</span><span class="p">()[</span><span class="s2">&quot;workers&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="p">]</span>

        <span class="n">dask_workers</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">AGI</span><span class="o">.</span><span class="n">_dask_workers</span><span class="p">)</span>

        <span class="n">init_futures</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">client</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span>
                <span class="n">BaseWorker</span><span class="o">.</span><span class="n">_new</span><span class="p">,</span>
                <span class="n">env</span><span class="o">=</span><span class="mi">0</span> <span class="k">if</span> <span class="n">env</span><span class="o">.</span><span class="n">debug</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">app</span><span class="o">=</span><span class="n">env</span><span class="o">.</span><span class="n">target_worker</span><span class="p">,</span>
                <span class="n">mode</span><span class="o">=</span><span class="n">AGI</span><span class="o">.</span><span class="n">_mode</span><span class="p">,</span>
                <span class="n">verbose</span><span class="o">=</span><span class="n">AGI</span><span class="o">.</span><span class="n">verbose</span><span class="p">,</span>
                <span class="n">worker_id</span><span class="o">=</span><span class="n">index</span><span class="p">,</span>
                <span class="n">worker</span><span class="o">=</span><span class="n">worker</span><span class="p">,</span>
                <span class="n">args</span><span class="o">=</span><span class="n">AGI</span><span class="o">.</span><span class="n">_args</span><span class="p">,</span>
                <span class="n">workers</span><span class="o">=</span><span class="p">[</span><span class="n">worker</span><span class="p">],</span>
                <span class="n">allow_other_workers</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">pure</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">key</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;agi-worker-init-</span><span class="si">{</span><span class="n">env</span><span class="o">.</span><span class="n">target</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">worker</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;-&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">worker</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dask_workers</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="n">client</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">init_futures</span><span class="p">)</span>

        <span class="n">service_futures</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">worker</span> <span class="ow">in</span> <span class="n">dask_workers</span><span class="p">:</span>
            <span class="n">future</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span>
                <span class="n">BaseWorker</span><span class="o">.</span><span class="n">loop</span><span class="p">,</span>
                <span class="n">poll_interval</span><span class="o">=</span><span class="n">poll_interval</span><span class="p">,</span>
                <span class="n">workers</span><span class="o">=</span><span class="p">[</span><span class="n">worker</span><span class="p">],</span>
                <span class="n">allow_other_workers</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">pure</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">key</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;agi-serve-loop-</span><span class="si">{</span><span class="n">env</span><span class="o">.</span><span class="n">target</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">worker</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;-&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">service_futures</span><span class="p">[</span><span class="n">worker</span><span class="p">]</span> <span class="o">=</span> <span class="n">future</span>

        <span class="n">AGI</span><span class="o">.</span><span class="n">_service_futures</span> <span class="o">=</span> <span class="n">service_futures</span>
        <span class="n">AGI</span><span class="o">.</span><span class="n">_service_workers</span> <span class="o">=</span> <span class="n">dask_workers</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Service loops started for workers: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">dask_workers</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;running&quot;</span><span class="p">,</span> <span class="s2">&quot;workers&quot;</span><span class="p">:</span> <span class="n">dask_workers</span><span class="p">,</span> <span class="s2">&quot;pending&quot;</span><span class="p">:</span> <span class="p">[]}</span></div>


    <span class="nd">@staticmethod</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_benchmark</span><span class="p">(</span>
            <span class="n">env</span><span class="p">:</span> <span class="n">AgiEnv</span><span class="p">,</span>
            <span class="n">scheduler</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">workers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">verbose</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
            <span class="n">mode_range</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="nb">range</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">rapids_enabled</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="o">**</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run all modes to find the fastest one.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: A dictionary where keys are each mode (from mode_range) and values are dicts</span>
<span class="sd">                  with keys including:</span>
<span class="sd">                    - &quot;mode&quot;: an identifying string for the mode,</span>
<span class="sd">                    - &quot;timing&quot;: a human-readable formatted string of the runtime,</span>
<span class="sd">                    - &quot;time&quot;: the runtime in seconds (as a float),</span>
<span class="sd">                    - &quot;order&quot;: the rank order (an integer, 1 for fastest, etc.).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rapids_mode_mask</span> <span class="o">=</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_RAPIDS_SET</span> <span class="k">if</span> <span class="n">rapids_enabled</span> <span class="k">else</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_RAPIDS_RESET</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">BaseWorker</span><span class="o">.</span><span class="n">_is_cython_installed</span><span class="p">(</span><span class="n">env</span><span class="p">):</span>
            <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">install</span><span class="p">(</span>
                <span class="n">env</span><span class="p">,</span>
                <span class="n">scheduler</span><span class="o">=</span><span class="n">scheduler</span><span class="p">,</span>
                <span class="n">workers</span><span class="o">=</span><span class="n">workers</span><span class="p">,</span>
                <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
                <span class="n">modes_enabled</span><span class="o">=</span><span class="n">AGI</span><span class="o">.</span><span class="n">CYTHON_MODE</span><span class="p">,</span>
                <span class="o">**</span><span class="n">args</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="n">AGI</span><span class="o">.</span><span class="n">_mode_auto</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">runs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">env</span><span class="o">.</span><span class="n">benchmark</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">benchmark</span><span class="p">)</span>
        <span class="n">local_modes</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">mode_range</span> <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">m</span> <span class="o">&amp;</span> <span class="n">AGI</span><span class="o">.</span><span class="n">DASK_MODE</span><span class="p">)]</span>
        <span class="n">dask_modes</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">mode_range</span> <span class="k">if</span> <span class="n">m</span> <span class="o">&amp;</span> <span class="n">AGI</span><span class="o">.</span><span class="n">DASK_MODE</span><span class="p">]</span>

        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_record</span><span class="p">(</span><span class="n">run_value</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">runtime</span> <span class="o">=</span> <span class="n">run_value</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">runtime</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected run format: </span><span class="si">{</span><span class="n">run_value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">runtime_float</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">runtime</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">runs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;mode&quot;</span><span class="p">:</span> <span class="n">runtime</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="s2">&quot;timing&quot;</span><span class="p">:</span> <span class="n">humanize</span><span class="o">.</span><span class="n">precisedelta</span><span class="p">(</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">runtime_float</span><span class="p">)),</span>
                <span class="s2">&quot;seconds&quot;</span><span class="p">:</span> <span class="n">runtime_float</span><span class="p">,</span>
            <span class="p">}</span>

        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">local_modes</span><span class="p">:</span>
            <span class="n">run_mode</span> <span class="o">=</span> <span class="n">m</span> <span class="o">&amp;</span> <span class="n">rapids_mode_mask</span>
            <span class="n">run</span> <span class="o">=</span> <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
                <span class="n">env</span><span class="p">,</span>
                <span class="n">scheduler</span><span class="o">=</span><span class="n">scheduler</span><span class="p">,</span>
                <span class="n">workers</span><span class="o">=</span><span class="n">workers</span><span class="p">,</span>
                <span class="n">mode</span><span class="o">=</span><span class="n">run_mode</span><span class="p">,</span>
                <span class="o">**</span><span class="n">args</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">await</span> <span class="n">_record</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">dask_modes</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_benchmark_dask_modes</span><span class="p">(</span>
                <span class="n">env</span><span class="p">,</span>
                <span class="n">scheduler</span><span class="p">,</span>
                <span class="n">workers</span><span class="p">,</span>
                <span class="n">dask_modes</span><span class="p">,</span>
                <span class="n">rapids_mode_mask</span><span class="p">,</span>
                <span class="n">runs</span><span class="p">,</span>
                <span class="o">**</span><span class="n">args</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># Sort the runs by &quot;seconds&quot; (fastest to slowest) and assign order values.</span>
        <span class="n">ordered_runs</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">runs</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;seconds&quot;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="p">(</span><span class="n">mode_key</span><span class="p">,</span> <span class="n">run_data</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ordered_runs</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">run_data</span><span class="p">[</span><span class="s2">&quot;order&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">idx</span>

        <span class="c1"># The fastest run is the first in the ordered list.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ordered_runs</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;No ordered runs available after sorting.&quot;</span><span class="p">)</span>

        <span class="n">best_mode_key</span><span class="p">,</span> <span class="n">best_run_data</span> <span class="o">=</span> <span class="n">ordered_runs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Calculate delta based on &quot;seconds&quot;</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">runs</span><span class="p">:</span>
            <span class="n">runs</span><span class="p">[</span><span class="n">m</span><span class="p">][</span><span class="s2">&quot;delta&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">runs</span><span class="p">[</span><span class="n">m</span><span class="p">][</span><span class="s2">&quot;seconds&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">best_run_data</span><span class="p">[</span><span class="s2">&quot;seconds&quot;</span><span class="p">]</span>

        <span class="n">AGI</span><span class="o">.</span><span class="n">_best_mode</span><span class="p">[</span><span class="n">env</span><span class="o">.</span><span class="n">target</span><span class="p">]</span> <span class="o">=</span> <span class="n">best_run_data</span>
        <span class="n">AGI</span><span class="o">.</span><span class="n">_mode_auto</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Convert numeric keys to strings for valid JSON output.</span>
        <span class="n">runs_str_keys</span> <span class="o">=</span> <span class="p">{</span><span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">):</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">runs</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

        <span class="c1"># Return a JSON-formatted string</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">benchmark</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">runs_str_keys</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">runs_str_keys</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_benchmark_dask_modes</span><span class="p">(</span>
        <span class="n">env</span><span class="p">:</span> <span class="n">AgiEnv</span><span class="p">,</span>
        <span class="n">scheduler</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">workers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]],</span>
        <span class="n">mode_range</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
        <span class="n">rapids_mode_mask</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">runs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="o">**</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Run all Dask-enabled modes without tearing down the cluster between runs.&quot;&quot;&quot;</span>
        <span class="n">workers_dict</span> <span class="o">=</span> <span class="n">workers</span> <span class="ow">or</span> <span class="n">_workers_default</span>

        <span class="n">AGI</span><span class="o">.</span><span class="n">env</span> <span class="o">=</span> <span class="n">env</span>
        <span class="n">AGI</span><span class="o">.</span><span class="n">target_path</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">manager_path</span>
        <span class="n">AGI</span><span class="o">.</span><span class="n">_target</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">target</span>
        <span class="n">AGI</span><span class="o">.</span><span class="n">_workers</span> <span class="o">=</span> <span class="n">workers_dict</span>
        <span class="n">AGI</span><span class="o">.</span><span class="n">_args</span> <span class="o">=</span> <span class="n">args</span>
        <span class="n">AGI</span><span class="o">.</span><span class="n">_rapids_enabled</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">rapids_mode_mask</span> <span class="o">==</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_RAPIDS_SET</span><span class="p">)</span>

        <span class="n">first_mode</span> <span class="o">=</span> <span class="n">mode_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">rapids_mode_mask</span>
        <span class="n">AGI</span><span class="o">.</span><span class="n">_mode</span> <span class="o">=</span> <span class="n">first_mode</span>
        <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_start</span><span class="p">(</span><span class="n">scheduler</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">mode_range</span><span class="p">:</span>
                <span class="n">run_mode</span> <span class="o">=</span> <span class="n">m</span> <span class="o">&amp;</span> <span class="n">rapids_mode_mask</span>
                <span class="n">AGI</span><span class="o">.</span><span class="n">_mode</span> <span class="o">=</span> <span class="n">run_mode</span>
                <span class="n">run</span> <span class="o">=</span> <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_distribute</span><span class="p">()</span>
                <span class="n">AGI</span><span class="o">.</span><span class="n">_update_capacity</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="n">runtime</span> <span class="o">=</span> <span class="n">run</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">runtime</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected run format: </span><span class="si">{</span><span class="n">run</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">runtime_float</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">runtime</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">runs</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">&quot;mode&quot;</span><span class="p">:</span> <span class="n">runtime</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="s2">&quot;timing&quot;</span><span class="p">:</span> <span class="n">humanize</span><span class="o">.</span><span class="n">precisedelta</span><span class="p">(</span>
                            <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">runtime_float</span><span class="p">)</span>
                        <span class="p">),</span>
                        <span class="s2">&quot;seconds&quot;</span><span class="p">:</span> <span class="n">runtime_float</span><span class="p">,</span>
                    <span class="p">}</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_stop</span><span class="p">()</span>

<div class="viewcode-block" id="AGI.get_default_local_ip">
<a class="viewcode-back" href="../../../module-agi-cluster.html#agi_cluster.agi_distributor.agi_distributor.AGI.get_default_local_ip">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_default_local_ip</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the default local IP address of the machine.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: The default local IP address.</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception: If unable to determine the local IP address.</span>
<span class="sd">        &quot;&quot;&quot;</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Attempt to connect to a non-local address and capture the local endpoint&#39;s IP</span>
            <span class="k">with</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_DGRAM</span><span class="p">)</span> <span class="k">as</span> <span class="n">s</span><span class="p">:</span>
                <span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="s2">&quot;8.8.8.8&quot;</span><span class="p">,</span> <span class="mi">80</span><span class="p">))</span>
                <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">getsockname</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;Unable to determine local IP&quot;</span></div>


<div class="viewcode-block" id="AGI.find_free_port">
<a class="viewcode-back" href="../../../module-agi-cluster.html#agi_cluster.agi_distributor.agi_distributor.AGI.find_free_port">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">find_free_port</span><span class="p">(</span><span class="n">start</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5000</span><span class="p">,</span> <span class="n">end</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">,</span> <span class="n">attempts</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">attempts</span><span class="p">):</span>
            <span class="n">port</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span> <span class="k">as</span> <span class="n">sock</span><span class="p">:</span>
                <span class="c1"># set SO_REUSEADDR to avoid &#39;address already in use&#39; issues during testing</span>
                <span class="n">sock</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SO_REUSEADDR</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">sock</span><span class="o">.</span><span class="n">bind</span><span class="p">((</span><span class="s2">&quot;localhost&quot;</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>
                    <span class="c1"># if binding succeeds, the port is free; close socket and return port</span>
                    <span class="k">return</span> <span class="n">port</span>
                <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                    <span class="c1"># port is already in use, try another</span>
                    <span class="k">continue</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;No free port found in the specified range.&quot;</span><span class="p">)</span></div>


    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_get_scheduler</span><span class="p">(</span><span class="n">ip_sched</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;get scheduler ip V4 address</span>
<span class="sd">        when no scheduler provided, scheduler address is localhost or the first address if workers are not local.</span>
<span class="sd">        port is random</span>

<span class="sd">        Args:</span>
<span class="sd">          ip_sched:</span>

<span class="sd">        Returns:</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">port</span> <span class="o">=</span> <span class="n">AGI</span><span class="o">.</span><span class="n">find_free_port</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ip_sched</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_workers</span><span class="p">:</span>
                <span class="n">ip</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">AGI</span><span class="o">.</span><span class="n">_workers</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ip</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostbyname</span><span class="p">(</span><span class="s2">&quot;localhost&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ip_sched</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="c1"># end-user already has provided a port</span>
            <span class="n">ip</span><span class="p">,</span> <span class="n">port</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">ip_sched</span><span class="o">.</span><span class="n">items</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ip_sched</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Scheduler ip address is not valid&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ip</span> <span class="o">=</span> <span class="n">ip_sched</span>
        <span class="n">AGI</span><span class="o">.</span><span class="n">_scheduler</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">return</span> <span class="n">ip</span><span class="p">,</span> <span class="n">port</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_get_stdout</span><span class="p">(</span><span class="n">func</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;to get the stdout stream</span>

<span class="sd">        Args:</span>
<span class="sd">          func: param args:</span>
<span class="sd">          kwargs: return: the return of the func</span>
<span class="sd">          *args:</span>
<span class="sd">          **kwargs:</span>

<span class="sd">        Returns:</span>
<span class="sd">          : the return of the func</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">redirect_stdout</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">f</span><span class="o">.</span><span class="n">getvalue</span><span class="p">(),</span> <span class="n">result</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_read_stderr</span><span class="p">(</span><span class="n">output_stream</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Read remote stderr robustly on Linux (UTF-8), Windows OEM (CP850), then ANSI (CP1252).&quot;&quot;&quot;</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">decode_bytes</span><span class="p">(</span><span class="n">bs</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
            <span class="c1"># try UTF-8, then OEM (CP850) for console accents, then ANSI (CP1252)</span>
            <span class="k">for</span> <span class="n">enc</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="s1">&#39;cp850&#39;</span><span class="p">,</span> <span class="s1">&#39;cp1252&#39;</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">bs</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">enc</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">continue</span>
            <span class="c1"># final fallback</span>
            <span class="k">return</span> <span class="n">bs</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;cp850&#39;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;replace&#39;</span><span class="p">)</span>

        <span class="n">chan</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">output_stream</span><span class="p">,</span> <span class="s1">&#39;channel&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">chan</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># simple iteration fallback</span>
            <span class="k">for</span> <span class="n">raw</span> <span class="ow">in</span> <span class="n">output_stream</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
                    <span class="n">decoded</span> <span class="o">=</span> <span class="n">decode_bytes</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">decoded</span> <span class="o">=</span> <span class="n">decode_bytes</span><span class="p">(</span><span class="n">raw</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;latin-1&#39;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;replace&#39;</span><span class="p">))</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">decoded</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="n">AGI</span><span class="o">.</span><span class="n">_worker_init_error</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;[ProjectError]&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># non-blocking channel read</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">chan</span><span class="o">.</span><span class="n">recv_stderr_ready</span><span class="p">():</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">raw</span> <span class="o">=</span> <span class="n">chan</span><span class="o">.</span><span class="n">recv_stderr</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">raw</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="n">decoded</span> <span class="o">=</span> <span class="n">decode_bytes</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">decoded</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="n">part</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                    <span class="n">AGI</span><span class="o">.</span><span class="n">_worker_init_error</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;[ProjectError]&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">chan</span><span class="o">.</span><span class="n">exit_status_ready</span><span class="p">():</span>
                <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>

<div class="viewcode-block" id="AGI.send_file">
<a class="viewcode-back" href="../../../module-agi-cluster.html#agi_cluster.agi_distributor.agi_distributor.AGI.send_file">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">send_file</span><span class="p">(</span>
            <span class="n">env</span><span class="p">:</span> <span class="n">AgiEnv</span><span class="p">,</span>
            <span class="n">ip</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="n">local_path</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
            <span class="n">remote_path</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
            <span class="n">user</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">password</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="n">AgiEnv</span><span class="o">.</span><span class="n">is_local</span><span class="p">(</span><span class="n">ip</span><span class="p">):</span>
            <span class="n">destination</span> <span class="o">=</span> <span class="n">remote_path</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">destination</span><span class="o">.</span><span class="n">is_absolute</span><span class="p">():</span>
                <span class="n">destination</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">home_abs</span><span class="p">)</span> <span class="o">/</span> <span class="n">destination</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;mkdir </span><span class="si">{</span><span class="n">destination</span><span class="o">.</span><span class="n">parent</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">destination</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">local_path</span><span class="p">,</span> <span class="n">destination</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">user</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">password</span><span class="p">:</span>
            <span class="n">password</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">password</span>

        <span class="n">user_at_ip</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">user</span><span class="si">}</span><span class="s2">@</span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">user</span> <span class="k">else</span> <span class="n">ip</span>
        <span class="n">remote</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">user_at_ip</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">remote_path</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="n">cmd</span><span class="p">,</span> <span class="n">cmd_base</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">password</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="s2">&quot;nt&quot;</span><span class="p">:</span>
            <span class="n">cmd_base</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;sshpass&quot;</span><span class="p">]</span>
            <span class="n">cmd</span> <span class="o">+=</span> <span class="n">cmd_base</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;-p&quot;</span><span class="p">,</span> <span class="n">password</span><span class="p">]</span>

        <span class="n">scp_cmd</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;scp&quot;</span><span class="p">,</span>
            <span class="s2">&quot;-o&quot;</span><span class="p">,</span>
            <span class="s2">&quot;StrictHostKeyChecking=no&quot;</span><span class="p">,</span>
            <span class="s2">&quot;-o&quot;</span><span class="p">,</span>
            <span class="s2">&quot;UserKnownHostsFile=/dev/null&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="n">ssh_key_path</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">ssh_key_path</span>
        <span class="k">if</span> <span class="n">ssh_key_path</span><span class="p">:</span>
            <span class="n">scp_cmd</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;-i&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">ssh_key_path</span><span class="p">)</span><span class="o">.</span><span class="n">expanduser</span><span class="p">())])</span>
        <span class="n">scp_cmd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">local_path</span><span class="p">))</span>
        <span class="n">scp_cmd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">remote</span><span class="p">)</span>
        <span class="n">cmd_end</span> <span class="o">=</span> <span class="n">scp_cmd</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span> <span class="o">+</span> <span class="n">cmd_end</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">process</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_subprocess_exec</span><span class="p">(</span>
                <span class="o">*</span><span class="n">cmd</span><span class="p">,</span>
                <span class="n">stdout</span><span class="o">=</span><span class="n">asyncio</span><span class="o">.</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                <span class="n">stderr</span><span class="o">=</span><span class="n">asyncio</span><span class="o">.</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="k">await</span> <span class="n">process</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">process</span><span class="o">.</span><span class="n">returncode</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SCP failed sending </span><span class="si">{</span><span class="n">local_path</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">remote</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">stderr</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ConnectionError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SCP error: </span><span class="si">{</span><span class="n">stderr</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sent file </span><span class="si">{</span><span class="n">local_path</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">remote</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd_base</span> <span class="o">+</span> <span class="n">cmd_end</span>
                <span class="n">process</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_subprocess_exec</span><span class="p">(</span>
                    <span class="o">*</span><span class="n">cmd</span><span class="p">,</span>
                    <span class="n">stdout</span><span class="o">=</span><span class="n">asyncio</span><span class="o">.</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                    <span class="n">stderr</span><span class="o">=</span><span class="n">asyncio</span><span class="o">.</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="k">await</span> <span class="n">process</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>

                <span class="k">if</span> <span class="n">process</span><span class="o">.</span><span class="n">returncode</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SCP failed sending </span><span class="si">{</span><span class="n">local_path</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">remote</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">stderr</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">ConnectionError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SCP error: </span><span class="si">{</span><span class="n">stderr</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sent file </span><span class="si">{</span><span class="n">local_path</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">remote</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span></div>


<div class="viewcode-block" id="AGI.send_files">
<a class="viewcode-back" href="../../../module-agi-cluster.html#agi_cluster.agi_distributor.agi_distributor.AGI.send_files">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">send_files</span><span class="p">(</span><span class="n">env</span><span class="p">:</span> <span class="n">AgiEnv</span><span class="p">,</span> <span class="n">ip</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">files</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Path</span><span class="p">],</span> <span class="n">remote_dir</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">user</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">tasks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="n">remote_path</span> <span class="o">=</span> <span class="n">remote_dir</span> <span class="o">/</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span>
            <span class="n">tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">AGI</span><span class="o">.</span><span class="n">send_file</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">remote_path</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">))</span>
        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="n">tasks</span><span class="p">)</span></div>

        <span class="c1"># logger.info(f&quot;Sent {len(files)} files to {user if user else self.user}@{ip}:{remote_dir}&quot;)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_remove_dir_forcefully</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">shutil</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">time</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">onerror</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">exc_info</span><span class="p">):</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">stat</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">W_OK</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IWUSR</span><span class="p">)</span>
                <span class="n">func</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2"> not removed due to </span><span class="si">{</span><span class="n">exc_info</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">onerror</span><span class="o">=</span><span class="n">onerror</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Exception while deleting </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">onerror</span><span class="o">=</span><span class="n">onerror</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e2</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Second failure deleting </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e2</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">raise</span>

    <span class="nd">@staticmethod</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_kill</span><span class="p">(</span><span class="n">ip</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">current_pid</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">force</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Terminate &#39;uv&#39; and Dask processes on the given host and clean up pid files.</span>

<span class="sd">        Args:</span>
<span class="sd">            ip (str, optional): IP address of the host to kill processes on. Defaults to local host.</span>
<span class="sd">            current_pid (int, optional): PID of this process to exclude. Defaults to this process.</span>
<span class="sd">            force (bool, optional): Whether to kill all &#39;dask&#39; processes by name. Defaults to True.</span>
<span class="sd">        Returns:</span>
<span class="sd">            The result of the last kill command (dict or None).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">env</span> <span class="o">=</span> <span class="n">AGI</span><span class="o">.</span><span class="n">env</span>
        <span class="n">uv</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">uv</span>
        <span class="n">localhost</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostbyname</span><span class="p">(</span><span class="s2">&quot;localhost&quot;</span><span class="p">)</span>
        <span class="n">ip</span> <span class="o">=</span> <span class="n">ip</span> <span class="ow">or</span> <span class="n">localhost</span>
        <span class="n">current_pid</span> <span class="o">=</span> <span class="n">current_pid</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span>

        <span class="c1"># 1) Collect PIDs from any pid files and remove those files</span>
        <span class="n">pids_to_kill</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">pid_file</span> <span class="ow">in</span> <span class="n">Path</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">wenv_abs</span><span class="o">.</span><span class="n">parent</span><span class="p">)</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*.pid&quot;</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">text</span> <span class="o">=</span> <span class="n">pid_file</span><span class="o">.</span><span class="n">read_text</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">pid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">pid</span> <span class="o">!=</span> <span class="n">current_pid</span><span class="p">:</span>
                    <span class="n">pids_to_kill</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not read PID from </span><span class="si">{</span><span class="n">pid_file</span><span class="si">}</span><span class="s2">, skipping&quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">pid_file</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to remove pid file </span><span class="si">{</span><span class="n">pid_file</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">cmds</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">cli_rel</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">wenv_rel</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="s2">&quot;cli.py&quot;</span>
        <span class="n">cli_abs</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">wenv_abs</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="n">cli_rel</span><span class="o">.</span><span class="n">name</span>
        <span class="n">cmd_prefix</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">envars</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s2">_CMD_PREFIX&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">kill_prefix</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">cmd_prefix</span><span class="si">}{</span><span class="n">uv</span><span class="si">}</span><span class="s1"> run --no-sync python&#39;</span>

        <span class="k">if</span> <span class="n">env</span><span class="o">.</span><span class="n">is_local</span><span class="p">(</span><span class="n">ip</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">cli_abs</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">cluster_pck</span> <span class="o">/</span> <span class="s2">&quot;agi_distributor/cli.py&quot;</span><span class="p">,</span> <span class="n">cli_abs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">force</span><span class="p">:</span>
                <span class="n">exclude_arg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">current_pid</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">current_pid</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
                <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">kill_prefix</span><span class="si">}</span><span class="s2"> &#39;</span><span class="si">{</span><span class="n">cli_abs</span><span class="si">}</span><span class="s2">&#39; kill</span><span class="si">{</span><span class="n">exclude_arg</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">cmds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">force</span><span class="p">:</span>
                <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">kill_prefix</span><span class="si">}</span><span class="s2"> &#39;</span><span class="si">{</span><span class="n">cli_rel</span><span class="si">}</span><span class="s2">&#39; kill&quot;</span>
                <span class="n">cmds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>

        <span class="n">last_res</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="n">cmds</span><span class="p">:</span>
            <span class="c1"># choose working directory based on local vs remote</span>
            <span class="n">cwd</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">agi_cluster</span> <span class="k">if</span> <span class="n">ip</span> <span class="o">==</span> <span class="n">localhost</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">wenv_abs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">env</span><span class="o">.</span><span class="n">is_local</span><span class="p">(</span><span class="n">ip</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">env</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">argv</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;python &#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
                    <span class="n">runpy</span><span class="o">.</span><span class="n">run_path</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">run_name</span><span class="o">=</span><span class="s2">&quot;__main__&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">AgiEnv</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">cwd</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cli</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">wenv_rel</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="s2">&quot;cli.py&quot;</span>
                <span class="n">last_res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">exec_ssh</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span>

            <span class="c1"># handle tuple or dict result</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">last_res</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">out</span> <span class="o">=</span> <span class="n">last_res</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;stdout&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="n">err</span> <span class="o">=</span> <span class="n">last_res</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;stderr&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">last_res</span>

    <span class="nd">@staticmethod</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_wait_for_port_release</span><span class="p">(</span><span class="n">ip</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">port</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5.0</span><span class="p">,</span> <span class="n">interval</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Poll until no process is listening on (ip, port).&quot;&quot;&quot;</span>
        <span class="n">ip</span> <span class="o">=</span> <span class="n">ip</span> <span class="ow">or</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostbyname</span><span class="p">(</span><span class="s2">&quot;localhost&quot;</span><span class="p">)</span>
        <span class="n">deadline</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span> <span class="o">+</span> <span class="n">timeout</span>
        <span class="k">while</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">deadline</span><span class="p">:</span>
            <span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">sock</span><span class="o">.</span><span class="n">bind</span><span class="p">((</span><span class="n">ip</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">interval</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">sock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_clean_dirs_local</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Clean up local worker env directory</span>

<span class="sd">        Args:</span>
<span class="sd">          wenv: worker environment dictionary</span>

<span class="sd">        Returns:</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">me</span> <span class="o">=</span> <span class="n">getpass</span><span class="o">.</span><span class="n">getuser</span><span class="p">()</span>
        <span class="n">self_pid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">psutil</span><span class="o">.</span><span class="n">process_iter</span><span class="p">([</span><span class="s1">&#39;pid&#39;</span><span class="p">,</span> <span class="s1">&#39;username&#39;</span><span class="p">,</span> <span class="s1">&#39;cmdline&#39;</span><span class="p">]):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span>
                        <span class="n">p</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">p</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">me</span><span class="p">)</span>
                        <span class="ow">and</span> <span class="n">p</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;pid&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">p</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;pid&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">self_pid</span>
                        <span class="ow">and</span> <span class="n">p</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;cmdline&#39;</span><span class="p">]</span>
                        <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="s1">&#39;dask&#39;</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;cmdline&#39;</span><span class="p">])</span>
                <span class="p">):</span>
                    <span class="n">p</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>
            <span class="k">except</span> <span class="p">(</span><span class="n">psutil</span><span class="o">.</span><span class="n">NoSuchProcess</span><span class="p">,</span> <span class="n">psutil</span><span class="o">.</span><span class="n">AccessDenied</span><span class="p">):</span>
                <span class="k">pass</span>

        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">gettempdir</span><span class="p">()</span><span class="si">}</span><span class="s2">/dask-scratch-space&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">AGI</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">wenv_abs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="p">]:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">ignore_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>

    <span class="nd">@staticmethod</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_clean_dirs</span><span class="p">(</span><span class="n">ip</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Clean up remote worker</span>

<span class="sd">        Args:</span>
<span class="sd">          ip: address of remote worker</span>

<span class="sd">        Returns:</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">env</span> <span class="o">=</span> <span class="n">AGI</span><span class="o">.</span><span class="n">env</span>
        <span class="n">uv</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">uv</span>
        <span class="n">wenv_abs</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">wenv_abs</span>
        <span class="k">if</span> <span class="n">wenv_abs</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">AGI</span><span class="o">.</span><span class="n">_remove_dir_forcefully</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">wenv_abs</span><span class="p">))</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">wenv_abs</span> <span class="o">/</span> <span class="s2">&quot;src&quot;</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">cmd_prefix</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">envars</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s2">_CMD_PREFIX&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">wenv</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">wenv_rel</span>
        <span class="n">cli</span> <span class="o">=</span> <span class="n">wenv</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="s1">&#39;cli.py&#39;</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cmd_prefix</span><span class="si">}{</span><span class="n">uv</span><span class="si">}</span><span class="s2"> run --no-sync -p </span><span class="si">{</span><span class="n">env</span><span class="o">.</span><span class="n">python_version</span><span class="si">}</span><span class="s2"> python </span><span class="si">{</span><span class="n">cli</span><span class="si">}</span><span class="s2"> clean </span><span class="si">{</span><span class="n">wenv</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">exec_ssh</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_clean_nodes</span><span class="p">(</span><span class="n">scheduler_addr</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">force</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="c1"># Compose list of IPs: workers plus scheduler&#39;s IP</span>
        <span class="n">list_ip</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">AGI</span><span class="o">.</span><span class="n">_workers</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="n">AGI</span><span class="o">.</span><span class="n">_get_scheduler</span><span class="p">(</span><span class="n">scheduler_addr</span><span class="p">)[</span><span class="mi">0</span><span class="p">]])</span>
        <span class="n">localhost_ip</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostbyname</span><span class="p">(</span><span class="s2">&quot;localhost&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">list_ip</span><span class="p">:</span>
            <span class="n">list_ip</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">localhost_ip</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">ip</span> <span class="ow">in</span> <span class="n">list_ip</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">AgiEnv</span><span class="o">.</span><span class="n">is_local</span><span class="p">(</span><span class="n">ip</span><span class="p">):</span>
                <span class="c1"># Assuming this cleans local dirs once per IP (or should be once per call)</span>
                <span class="n">AGI</span><span class="o">.</span><span class="n">_clean_dirs_local</span><span class="p">()</span>

        <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_clean_remote_procs</span><span class="p">(</span><span class="n">list_ip</span><span class="o">=</span><span class="n">list_ip</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="n">force</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_clean_remote_dirs</span><span class="p">(</span><span class="n">list_ip</span><span class="o">=</span><span class="n">list_ip</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">list_ip</span>

    <span class="nd">@staticmethod</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_clean_remote_procs</span><span class="p">(</span><span class="n">list_ip</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">force</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">tasks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ip</span> <span class="ow">in</span> <span class="n">list_ip</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">AgiEnv</span><span class="o">.</span><span class="n">is_local</span><span class="p">(</span><span class="n">ip</span><span class="p">):</span>
                <span class="n">tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">AGI</span><span class="o">.</span><span class="n">_kill</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">(),</span> <span class="n">force</span><span class="o">=</span><span class="n">force</span><span class="p">)))</span>

        <span class="k">if</span> <span class="n">tasks</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="n">tasks</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_clean_remote_dirs</span><span class="p">(</span><span class="n">list_ip</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">tasks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ip</span> <span class="ow">in</span> <span class="n">list_ip</span><span class="p">:</span>
            <span class="n">tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">AGI</span><span class="o">.</span><span class="n">_clean_dirs</span><span class="p">(</span><span class="n">ip</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">tasks</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="n">tasks</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_prepare_local_env</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Validate and prepare each remote node in the cluster:</span>
<span class="sd">        - Verify each IP is valid and reachable.</span>
<span class="sd">        - Detect and install Python interpreters if missing.</span>
<span class="sd">        - Detect and install &#39;uv&#39; CLI via pip if missing.</span>
<span class="sd">        - Use &#39;uv&#39; to install the specified Pytho</span>
<span class="sd">        n version, create necessary directories, and install packages.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">env</span> <span class="o">=</span> <span class="n">AGI</span><span class="o">.</span><span class="n">env</span>
        <span class="n">wenv_abs</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">wenv_abs</span>
        <span class="n">pyvers</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">python_version</span>
        <span class="n">env</span> <span class="o">=</span> <span class="n">AGI</span><span class="o">.</span><span class="n">env</span>
        <span class="n">ip</span> <span class="o">=</span> <span class="s2">&quot;127.0.0.1&quot;</span>
        <span class="n">hw_rapids_capable</span> <span class="o">=</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_hardware_supports_rapids</span><span class="p">()</span> <span class="ow">and</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_rapids_enabled</span>
        <span class="n">env</span><span class="o">.</span><span class="n">hw_rapids_capable</span> <span class="o">=</span> <span class="n">hw_rapids_capable</span>

        <span class="k">if</span> <span class="n">hw_rapids_capable</span><span class="p">:</span>
            <span class="n">AgiEnv</span><span class="o">.</span><span class="n">set_env_var</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="s2">&quot;hw_rapids_capable&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">AgiEnv</span><span class="o">.</span><span class="n">set_env_var</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="s2">&quot;no_rapids_hw&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">env</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Rapids-capable GPU[</span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s2">]: </span><span class="si">{</span><span class="n">hw_rapids_capable</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># # Install Python</span>
        <span class="n">cmd_prefix</span> <span class="o">=</span> <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_detect_export_cmd</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span>
        <span class="n">AgiEnv</span><span class="o">.</span><span class="n">set_env_var</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s2">_CMD_PREFIX&quot;</span><span class="p">,</span> <span class="n">cmd_prefix</span><span class="p">)</span>
        <span class="n">uv</span> <span class="o">=</span> <span class="n">cmd_prefix</span> <span class="o">+</span> <span class="n">env</span><span class="o">.</span><span class="n">uv</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;mkdir </span><span class="si">{</span><span class="n">wenv_abs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">wenv_abs</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;nt&quot;</span><span class="p">:</span>
            <span class="n">standalone_uv</span> <span class="o">=</span> <span class="n">Path</span><span class="o">.</span><span class="n">home</span><span class="p">()</span> <span class="o">/</span> <span class="s2">&quot;.local&quot;</span> <span class="o">/</span> <span class="s2">&quot;bin&quot;</span> <span class="o">/</span> <span class="s2">&quot;uv.exe&quot;</span>
            <span class="k">if</span> <span class="n">standalone_uv</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="n">uv_parts</span> <span class="o">=</span> <span class="n">shlex</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">uv</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">uv_parts</span><span class="p">:</span>
                    <span class="n">uv_parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">standalone_uv</span><span class="p">)</span>
                    <span class="n">windows_uv</span> <span class="o">=</span> <span class="n">cmd_prefix</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">shlex</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="n">part</span><span class="p">)</span> <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">uv_parts</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">windows_uv</span> <span class="o">=</span> <span class="n">cmd_prefix</span> <span class="o">+</span> <span class="n">shlex</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">standalone_uv</span><span class="p">))</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">AgiEnv</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">windows_uv</span><span class="si">}</span><span class="s2"> self update&quot;</span><span class="p">,</span> <span class="n">wenv_abs</span><span class="o">.</span><span class="n">parent</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">RuntimeError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="s2">&quot;Failed to update standalone uv at </span><span class="si">%s</span><span class="s2"> (skipping self update): </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="n">standalone_uv</span><span class="p">,</span>
                        <span class="n">exc</span><span class="p">,</span>
                    <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;Standalone uv not found at </span><span class="si">%s</span><span class="s2">; skipping &#39;uv self update&#39; on Windows&quot;</span><span class="p">,</span>
                    <span class="n">standalone_uv</span><span class="p">,</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">AgiEnv</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">uv</span><span class="si">}</span><span class="s2"> self update&quot;</span><span class="p">,</span> <span class="n">wenv_abs</span><span class="o">.</span><span class="n">parent</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">AgiEnv</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">uv</span><span class="si">}</span><span class="s2"> python install </span><span class="si">{</span><span class="n">pyvers</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">wenv_abs</span><span class="o">.</span><span class="n">parent</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">RuntimeError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;No download found for request&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;uv could not download interpreter &#39;</span><span class="si">%s</span><span class="s2">&#39;; assuming a system interpreter is available&quot;</span><span class="p">,</span>
                    <span class="n">pyvers</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span>

        <span class="n">res</span> <span class="o">=</span> <span class="n">distributor_cli</span><span class="o">.</span><span class="n">python_version</span><span class="p">()</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
        <span class="n">pyvers</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">AgiEnv</span><span class="o">.</span><span class="n">set_env_var</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s2">_PYTHON_VERSION&quot;</span><span class="p">,</span> <span class="n">pyvers</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">env</span><span class="o">.</span><span class="n">is_worker_env</span><span class="p">:</span>
             <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">uv</span><span class="si">}</span><span class="s2"> --project </span><span class="si">{</span><span class="n">wenv_abs</span><span class="si">}</span><span class="s2"> init --bare --no-workspace&quot;</span>
             <span class="k">await</span> <span class="n">AgiEnv</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">wenv_abs</span><span class="p">)</span>

        <span class="c1"># cmd = f&quot;{uv} --project {wenv_abs} add agi-env agi-node&quot;</span>
        <span class="c1"># await AgiEnv.run(cmd, wenv_abs)</span>

        <span class="c1">#cmd = f&quot;{uv} run -p {pyvers} --project {wenv_abs} python {cli} threaded&quot;</span>
        <span class="c1">#await AgiEnv.run(cmd, wenv_abs)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_prepare_cluster_env</span><span class="p">(</span><span class="n">scheduler_addr</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Validate and prepare each remote node in the cluster:</span>
<span class="sd">        - Verify each IP is valid and reachable.</span>
<span class="sd">        - Detect and install Python interpreters if missing.</span>
<span class="sd">        - Detect and install &#39;uv&#39; CLI via pip if missing.</span>
<span class="sd">        - Use &#39;uv&#39; to install the specified Pytho</span>
<span class="sd">        n version, create necessary directories, and install packages.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">list_ip</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">AGI</span><span class="o">.</span><span class="n">_workers</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="n">AGI</span><span class="o">.</span><span class="n">_get_scheduler</span><span class="p">(</span><span class="n">scheduler_addr</span><span class="p">)[</span><span class="mi">0</span><span class="p">]])</span>
        <span class="n">localhost_ip</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostbyname</span><span class="p">(</span><span class="s2">&quot;localhost&quot;</span><span class="p">)</span>
        <span class="n">env</span> <span class="o">=</span> <span class="n">AGI</span><span class="o">.</span><span class="n">env</span>
        <span class="n">dist_rel</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">dist_rel</span>
        <span class="n">wenv_rel</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">wenv_rel</span>
        <span class="n">pyvers_worker</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">pyvers_worker</span>

        <span class="c1"># You can remove this check or keep it if you expect no scheduler/workers (rare)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">list_ip</span><span class="p">:</span>
            <span class="n">list_ip</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">localhost_ip</span><span class="p">)</span>

        <span class="c1"># Validate IPs</span>
        <span class="k">for</span> <span class="n">ip</span> <span class="ow">in</span> <span class="n">list_ip</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">env</span><span class="o">.</span><span class="n">is_local</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_ip</span><span class="p">(</span><span class="n">ip</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid IP address: </span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Prepare each remote node (skip local)</span>
        <span class="n">AGI</span><span class="o">.</span><span class="n">list_ip</span> <span class="o">=</span> <span class="n">list_ip</span>
        <span class="k">for</span> <span class="n">ip</span> <span class="ow">in</span> <span class="n">list_ip</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">env</span><span class="o">.</span><span class="n">is_local</span><span class="p">(</span><span class="n">ip</span><span class="p">):</span>
                <span class="k">continue</span>

            <span class="c1"># 1) Check if need to export path (linux and macos)</span>
            <span class="n">cmd_prefix</span> <span class="o">=</span> <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_detect_export_cmd</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span>
            <span class="n">AgiEnv</span><span class="o">.</span><span class="n">set_env_var</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s2">_CMD_PREFIX&quot;</span><span class="p">,</span> <span class="n">cmd_prefix</span><span class="p">)</span>
            <span class="n">uv_is_installed</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="c1"># 2) Check uv</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">exec_ssh</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cmd_prefix</span><span class="si">}{</span><span class="n">env</span><span class="o">.</span><span class="n">uv</span><span class="si">}</span><span class="s2"> --version&quot;</span><span class="p">)</span>
                <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">exec_ssh</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cmd_prefix</span><span class="si">}{</span><span class="n">env</span><span class="o">.</span><span class="n">uv</span><span class="si">}</span><span class="s2"> self update&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ConnectionError</span><span class="p">:</span>
                <span class="k">raise</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">uv_is_installed</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="c1"># Try Windows installer</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">exec_ssh</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span>
                                       <span class="s1">&#39;powershell -ExecutionPolicy ByPass -c &quot;irm https://astral.sh/uv/install.ps1 | iex&quot;&#39;</span>
                                       <span class="p">)</span>
                    <span class="n">uv_is_installed</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">except</span> <span class="ne">ConnectionError</span><span class="p">:</span>
                    <span class="k">raise</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">uv_is_installed</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="c1"># Fallback to Unix installer</span>
                    <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">exec_ssh</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="s1">&#39;curl -LsSf https://astral.sh/uv/install.sh | sh&#39;</span><span class="p">)</span>
                    <span class="c1"># Rely on PATH export via cmd_prefix for subsequent commands</span>
                    <span class="c1"># await AGI.exec_ssh(ip, &#39;source ~/.local/bin/env&#39;)</span>
                    <span class="n">uv_is_installed</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">uv_is_installed</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">AgiEnv</span><span class="o">.</span><span class="n">check_internet</span><span class="p">():</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Failed to install uv&quot;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">EnvironmentError</span><span class="p">(</span><span class="s2">&quot;Failed to install uv&quot;</span><span class="p">)</span>

            <span class="c1"># 3) Install Python</span>
            <span class="n">cmd_prefix</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">envars</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s2">_CMD_PREFIX&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">uv</span> <span class="o">=</span> <span class="n">cmd_prefix</span> <span class="o">+</span> <span class="n">env</span><span class="o">.</span><span class="n">uv</span>

            <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">uv</span><span class="si">}</span><span class="s2"> run python -c </span><span class="se">\&quot;</span><span class="s2">import os; os.makedirs(&#39;</span><span class="si">{</span><span class="n">dist_rel</span><span class="o">.</span><span class="n">parents</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39;, exist_ok=True)</span><span class="se">\&quot;</span><span class="s2">&quot;</span>
            <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">exec_ssh</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span>

            <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">exec_ssh</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">uv</span><span class="si">}</span><span class="s2"> self update&quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">exec_ssh</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">uv</span><span class="si">}</span><span class="s2"> python install </span><span class="si">{</span><span class="n">pyvers_worker</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">ProcessError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;No download found for request&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">):</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="s2">&quot;[</span><span class="si">%s</span><span class="s2">] uv could not download interpreter &#39;</span><span class="si">%s</span><span class="s2">&#39;; assuming a system interpreter is available&quot;</span><span class="p">,</span>
                        <span class="n">ip</span><span class="p">,</span>
                        <span class="n">pyvers_worker</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span>

            <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">send_files</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="p">[</span><span class="n">env</span><span class="o">.</span><span class="n">cluster_pck</span> <span class="o">/</span> <span class="s2">&quot;agi_distributor/cli.py&quot;</span><span class="p">],</span>
                                 <span class="n">wenv_rel</span><span class="o">.</span><span class="n">parent</span><span class="p">)</span>

            <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_kill</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_clean_dirs</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span>

            <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">uv</span><span class="si">}</span><span class="s2"> run python -c </span><span class="se">\&quot;</span><span class="s2">import os; os.makedirs(&#39;</span><span class="si">{</span><span class="n">dist_rel</span><span class="si">}</span><span class="s2">&#39;, exist_ok=True)</span><span class="se">\&quot;</span><span class="s2">&quot;</span>
            <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">exec_ssh</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span>

            <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">send_files</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="p">[</span><span class="n">env</span><span class="o">.</span><span class="n">worker_pyproject</span><span class="p">,</span> <span class="n">env</span><span class="o">.</span><span class="n">uvproject</span><span class="p">],</span>
                                 <span class="n">wenv_rel</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_deploy_application</span><span class="p">(</span><span class="n">scheduler_addr</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">AGI</span><span class="o">.</span><span class="n">_reset_deploy_state</span><span class="p">()</span>
        <span class="n">env</span> <span class="o">=</span> <span class="n">AGI</span><span class="o">.</span><span class="n">env</span>
        <span class="n">app_path</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">active_app</span>
        <span class="n">wenv_rel</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">wenv_rel</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">base_worker_cls</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">options_worker</span> <span class="o">=</span> <span class="s2">&quot; --extra &quot;</span> <span class="o">+</span> <span class="s2">&quot; --extra &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">AGI</span><span class="o">.</span><span class="n">install_worker_group</span><span class="p">)</span>

        <span class="c1"># node_ips = await AGI._clean_nodes(scheduler)</span>
        <span class="n">node_ips</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">AGI</span><span class="o">.</span><span class="n">_workers</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="n">AGI</span><span class="o">.</span><span class="n">_get_scheduler</span><span class="p">(</span><span class="n">scheduler_addr</span><span class="p">)[</span><span class="mi">0</span><span class="p">]])</span>
        <span class="n">AGI</span><span class="o">.</span><span class="n">_venv_todo</span><span class="p">(</span><span class="n">node_ips</span><span class="p">)</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">env</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Installing </span><span class="si">{</span><span class="n">app_path</span><span class="si">}</span><span class="s2"> on 127.0.0.1&quot;</span><span class="p">)</span>

        <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_deploy_local_worker</span><span class="p">(</span><span class="n">app_path</span><span class="p">,</span> <span class="n">Path</span><span class="p">(</span><span class="n">wenv_rel</span><span class="p">),</span> <span class="n">options_worker</span><span class="p">)</span>
        <span class="c1"># logger.info(AGI.run(cmd, wenv_abs))</span>
        <span class="k">if</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_mode</span> <span class="o">&amp;</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">tasks</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">ip</span> <span class="ow">in</span> <span class="n">node_ips</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">env</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Installing worker on </span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">env</span><span class="o">.</span><span class="n">is_local</span><span class="p">(</span><span class="n">ip</span><span class="p">):</span>
                    <span class="n">tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span>
                        <span class="n">AGI</span><span class="o">.</span><span class="n">_deploy_remote_worker</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">wenv_rel</span><span class="p">,</span> <span class="n">options_worker</span><span class="p">)</span>
                    <span class="p">))</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="n">tasks</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">AGI</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">duration</span> <span class="o">=</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_format_elapsed</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">env</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;uv </span><span class="si">{</span><span class="n">AGI</span><span class="o">.</span><span class="n">_run_type</span><span class="si">}</span><span class="s2"> completed in </span><span class="si">{</span><span class="n">duration</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_reset_deploy_state</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize installation flags and run type.&quot;&quot;&quot;</span>
        <span class="n">AGI</span><span class="o">.</span><span class="n">_run_type</span> <span class="o">=</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_run_types</span><span class="p">[(</span><span class="n">AGI</span><span class="o">.</span><span class="n">_mode</span> <span class="o">&amp;</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_DEPLOYEMENT_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">]</span>
        <span class="n">AGI</span><span class="o">.</span><span class="n">_install_done_local</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">AGI</span><span class="o">.</span><span class="n">_install_done</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">AGI</span><span class="o">.</span><span class="n">_worker_init_error</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_hardware_supports_rapids</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
                <span class="p">[</span><span class="s2">&quot;nvidia-smi&quot;</span><span class="p">],</span>
                <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">DEVNULL</span><span class="p">,</span>
                <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">DEVNULL</span><span class="p">,</span>
                <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="p">(</span><span class="n">subprocess</span><span class="o">.</span><span class="n">CalledProcessError</span><span class="p">,</span> <span class="ne">FileNotFoundError</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="nd">@staticmethod</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_deploy_local_worker</span><span class="p">(</span><span class="n">src</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">wenv_rel</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">options_worker</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Installe lâ€™environnement localement.</span>

<span class="sd">        Args:</span>
<span class="sd">            src: chemin vers la racine du projet local</span>
<span class="sd">            wenv_rel: chemin relatif vers lâ€™environnement virtuel local</span>
<span class="sd">            options_worker: le setup</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">env</span> <span class="o">=</span> <span class="n">AGI</span><span class="o">.</span><span class="n">env</span>
        <span class="n">run_type</span> <span class="o">=</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_run_type</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">env</span><span class="o">.</span><span class="n">is_source_env</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">env</span><span class="o">.</span><span class="n">is_worker_env</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">run_type</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;--dev&quot;</span> <span class="ow">in</span> <span class="n">run_type</span><span class="p">:</span>
            <span class="n">run_type</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">part</span> <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">run_type</span><span class="o">.</span><span class="n">split</span><span class="p">()</span> <span class="k">if</span> <span class="n">part</span> <span class="o">!=</span> <span class="s2">&quot;--dev&quot;</span><span class="p">)</span>
        <span class="n">ip</span> <span class="o">=</span> <span class="s2">&quot;127.0.0.1&quot;</span>
        <span class="n">hw_rapids_capable</span> <span class="o">=</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_hardware_supports_rapids</span><span class="p">()</span> <span class="ow">and</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_rapids_enabled</span>
        <span class="n">env</span><span class="o">.</span><span class="n">hw_rapids_capable</span> <span class="o">=</span> <span class="n">hw_rapids_capable</span>
        <span class="n">repo_root</span><span class="p">:</span> <span class="n">Path</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">repo_env_project</span><span class="p">:</span> <span class="n">Path</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">repo_node_project</span><span class="p">:</span> <span class="n">Path</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">repo_core_project</span><span class="p">:</span> <span class="n">Path</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">repo_cluster_project</span><span class="p">:</span> <span class="n">Path</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">repo_agilab_root</span><span class="p">:</span> <span class="n">Path</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">dependency_info</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">dep_versions</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">worker_pyprojects</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_cleanup_editable</span><span class="p">(</span><span class="n">site_packages</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">patterns</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s1">&#39;__editable__.agi_env*.pth&#39;</span><span class="p">,</span>
                <span class="s1">&#39;__editable__.agi_node*.pth&#39;</span><span class="p">,</span>
                <span class="s1">&#39;__editable__.agi_core*.pth&#39;</span><span class="p">,</span>
                <span class="s1">&#39;__editable__.agi_cluster*.pth&#39;</span><span class="p">,</span>
                <span class="s1">&#39;__editable__.agilab*.pth&#39;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="n">patterns</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">editable</span> <span class="ow">in</span> <span class="n">site_packages</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">pattern</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">editable</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
                    <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
                        <span class="k">pass</span>

        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_ensure_pip</span><span class="p">(</span><span class="n">uv_cmd</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">project</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">uv_cmd</span><span class="si">}</span><span class="s2"> run --project &#39;</span><span class="si">{</span><span class="n">project</span><span class="si">}</span><span class="s2">&#39; python -m ensurepip --upgrade&quot;</span>
            <span class="k">await</span> <span class="n">AgiEnv</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">project</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_format_dependency_spec</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">extras</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">specifiers</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
            <span class="n">extras_part</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">if</span> <span class="n">extras</span><span class="p">:</span>
                <span class="n">extras_part</span> <span class="o">=</span> <span class="s1">&#39;[&#39;</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">extras</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;]&#39;</span>
            <span class="n">spec_part</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">if</span> <span class="n">specifiers</span><span class="p">:</span>
                <span class="n">spec_part</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">specifiers</span><span class="p">)</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}{</span><span class="n">extras_part</span><span class="si">}{</span><span class="n">spec_part</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_update_pyproject_dependencies</span><span class="p">(</span>
            <span class="n">pyproject_file</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
            <span class="n">pinned_versions</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
            <span class="o">*</span><span class="p">,</span>
            <span class="n">filter_to_worker</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">tomlkit</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">pyproject_file</span><span class="o">.</span><span class="n">read_text</span><span class="p">())</span>
            <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">tomlkit</span><span class="o">.</span><span class="n">document</span><span class="p">()</span>

            <span class="n">project_tbl</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;project&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">project_tbl</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">project_tbl</span> <span class="o">=</span> <span class="n">tomlkit</span><span class="o">.</span><span class="n">table</span><span class="p">()</span>

            <span class="n">deps</span> <span class="o">=</span> <span class="n">project_tbl</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dependencies&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">deps</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">deps</span> <span class="o">=</span> <span class="n">tomlkit</span><span class="o">.</span><span class="n">array</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">deps</span><span class="p">,</span> <span class="n">tomlkit</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">Array</span><span class="p">):</span>
                    <span class="n">arr</span> <span class="o">=</span> <span class="n">tomlkit</span><span class="o">.</span><span class="n">array</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">deps</span><span class="p">:</span>
                        <span class="n">arr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                    <span class="n">deps</span> <span class="o">=</span> <span class="n">arr</span>

            <span class="n">existing</span> <span class="o">=</span> <span class="p">{</span><span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">deps</span><span class="p">}</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">meta</span> <span class="ow">in</span> <span class="n">dependency_info</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">filter_to_worker</span> <span class="ow">and</span> <span class="n">worker_pyprojects</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;sources&#39;</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">worker_pyprojects</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="n">version</span> <span class="o">=</span> <span class="p">(</span><span class="n">pinned_versions</span> <span class="ow">or</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">version</span><span class="p">:</span>
                    <span class="n">extras_part</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                    <span class="k">if</span> <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;extras&#39;</span><span class="p">]:</span>
                        <span class="n">extras_part</span> <span class="o">=</span> <span class="s1">&#39;[&#39;</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;extras&#39;</span><span class="p">]))</span> <span class="o">+</span> <span class="s1">&#39;]&#39;</span>
                    <span class="n">spec</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}{</span><span class="n">extras_part</span><span class="si">}</span><span class="s2">==</span><span class="si">{</span><span class="n">version</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">spec</span> <span class="o">=</span> <span class="n">_format_dependency_spec</span><span class="p">(</span>
                        <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
                        <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;extras&#39;</span><span class="p">],</span>
                        <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;specifiers&#39;</span><span class="p">],</span>
                    <span class="p">)</span>
                <span class="k">if</span> <span class="n">spec</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">existing</span><span class="p">:</span>
                    <span class="n">deps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
                    <span class="n">existing</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>

            <span class="n">project_tbl</span><span class="p">[</span><span class="s2">&quot;dependencies&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">deps</span>
            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">project_tbl</span>
            <span class="n">pyproject_file</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span><span class="n">tomlkit</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>


        <span class="k">def</span><span class="w"> </span><span class="nf">_gather_dependency_specs</span><span class="p">(</span><span class="n">projects</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Path</span> <span class="o">|</span> <span class="kc">None</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">seen_pyprojects</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">project_path</span> <span class="ow">in</span> <span class="n">projects</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">project_path</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">pyproject_file</span> <span class="o">=</span> <span class="n">project_path</span> <span class="o">/</span> <span class="s1">&#39;pyproject.toml&#39;</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">resolved_pyproject</span> <span class="o">=</span> <span class="n">pyproject_file</span><span class="o">.</span><span class="n">resolve</span><span class="p">(</span><span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">resolved_pyproject</span> <span class="ow">in</span> <span class="n">seen_pyprojects</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">seen_pyprojects</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">resolved_pyproject</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">project_doc</span> <span class="o">=</span> <span class="n">tomlkit</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">resolved_pyproject</span><span class="o">.</span><span class="n">read_text</span><span class="p">())</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">deps</span> <span class="o">=</span> <span class="n">project_doc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;project&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dependencies&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">deps</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="n">deps</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">req</span> <span class="o">=</span> <span class="n">Requirement</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dep</span><span class="p">))</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="n">req</span><span class="o">.</span><span class="n">marker</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">req</span><span class="o">.</span><span class="n">marker</span><span class="o">.</span><span class="n">evaluate</span><span class="p">():</span>
                        <span class="k">continue</span>
                    <span class="n">normalized</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">normalized</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;agi-&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">normalized</span> <span class="o">==</span> <span class="s1">&#39;agilab&#39;</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">meta</span> <span class="o">=</span> <span class="n">dependency_info</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span>
                        <span class="n">normalized</span><span class="p">,</span>
                        <span class="p">{</span>
                            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">req</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                            <span class="s1">&#39;extras&#39;</span><span class="p">:</span> <span class="nb">set</span><span class="p">(),</span>
                            <span class="s1">&#39;specifiers&#39;</span><span class="p">:</span> <span class="p">[],</span>
                            <span class="s1">&#39;has_exact&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                            <span class="s1">&#39;sources&#39;</span><span class="p">:</span> <span class="nb">set</span><span class="p">(),</span>
                        <span class="p">},</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">req</span><span class="o">.</span><span class="n">extras</span><span class="p">:</span>
                        <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;extras&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">extras</span><span class="p">)</span>
                    <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;sources&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">resolved_pyproject</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">req</span><span class="o">.</span><span class="n">specifier</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">specifier</span> <span class="ow">in</span> <span class="n">req</span><span class="o">.</span><span class="n">specifier</span><span class="p">:</span>
                            <span class="n">spec_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">specifier</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">specifier</span><span class="o">.</span><span class="n">operator</span> <span class="ow">in</span> <span class="p">{</span><span class="s1">&#39;==&#39;</span><span class="p">,</span> <span class="s1">&#39;===&#39;</span><span class="p">}:</span>
                                <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;has_exact&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                                <span class="k">if</span> <span class="ow">not</span> <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;specifiers&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;specifiers&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">spec_str</span><span class="p">:</span>
                                    <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;specifiers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">spec_str</span><span class="p">]</span>
                                <span class="k">break</span>
                            <span class="k">if</span> <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;has_exact&#39;</span><span class="p">]:</span>
                                <span class="k">continue</span>
                            <span class="k">if</span> <span class="n">spec_str</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;specifiers&#39;</span><span class="p">]:</span>
                                <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;specifiers&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spec_str</span><span class="p">)</span>


        <span class="k">if</span> <span class="n">env</span><span class="o">.</span><span class="n">install_type</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">repo_root</span> <span class="o">=</span> <span class="n">AgiEnv</span><span class="o">.</span><span class="n">read_agilab_path</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">repo_root</span><span class="p">:</span>
                <span class="n">repo_env_project</span> <span class="o">=</span> <span class="n">repo_root</span> <span class="o">/</span> <span class="s2">&quot;core&quot;</span> <span class="o">/</span> <span class="s2">&quot;agi-env&quot;</span>
                <span class="n">repo_node_project</span> <span class="o">=</span> <span class="n">repo_root</span> <span class="o">/</span> <span class="s2">&quot;core&quot;</span> <span class="o">/</span> <span class="s2">&quot;agi-node&quot;</span>
                <span class="n">repo_core_project</span> <span class="o">=</span> <span class="n">repo_root</span> <span class="o">/</span> <span class="s2">&quot;core&quot;</span> <span class="o">/</span> <span class="s2">&quot;agi-core&quot;</span>
                <span class="n">repo_cluster_project</span> <span class="o">=</span> <span class="n">repo_root</span> <span class="o">/</span> <span class="s2">&quot;core&quot;</span> <span class="o">/</span> <span class="s2">&quot;agi-cluster&quot;</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">repo_agilab_root</span> <span class="o">=</span> <span class="n">repo_root</span><span class="o">.</span><span class="n">parents</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                    <span class="n">repo_agilab_root</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="n">env_project</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">repo_env_project</span>
                <span class="k">if</span> <span class="n">repo_env_project</span> <span class="ow">and</span> <span class="n">repo_env_project</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
                <span class="k">else</span> <span class="n">env</span><span class="o">.</span><span class="n">agi_env</span>
            <span class="p">)</span>
            <span class="n">node_project</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">repo_node_project</span>
                <span class="k">if</span> <span class="n">repo_node_project</span> <span class="ow">and</span> <span class="n">repo_node_project</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
                <span class="k">else</span> <span class="n">env</span><span class="o">.</span><span class="n">agi_node</span>
            <span class="p">)</span>
            <span class="n">core_project</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">repo_core_project</span>
                <span class="k">if</span> <span class="n">repo_core_project</span> <span class="ow">and</span> <span class="n">repo_core_project</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
                <span class="k">else</span> <span class="kc">None</span>
            <span class="p">)</span>
            <span class="n">cluster_project</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">repo_cluster_project</span>
                <span class="k">if</span> <span class="n">repo_cluster_project</span> <span class="ow">and</span> <span class="n">repo_cluster_project</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
                <span class="k">else</span> <span class="kc">None</span>
            <span class="p">)</span>
            <span class="n">agilab_project</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">repo_agilab_root</span>
                <span class="k">if</span> <span class="n">repo_agilab_root</span> <span class="ow">and</span> <span class="n">repo_agilab_root</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
                <span class="k">else</span> <span class="kc">None</span>
            <span class="p">)</span>

            <span class="n">projects_for_specs</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">agilab_project</span><span class="p">,</span>
                <span class="n">env_project</span><span class="p">,</span>
                <span class="n">node_project</span><span class="p">,</span>
                <span class="n">core_project</span><span class="p">,</span>
                <span class="n">cluster_project</span><span class="p">,</span>
            <span class="p">]</span>
            <span class="n">_gather_dependency_specs</span><span class="p">(</span><span class="n">projects_for_specs</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">project_path</span> <span class="ow">in</span> <span class="p">(</span><span class="n">env_project</span><span class="p">,</span> <span class="n">node_project</span><span class="p">,</span> <span class="n">core_project</span><span class="p">,</span> <span class="n">cluster_project</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">project_path</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">pyproject_file</span> <span class="o">=</span> <span class="n">project_path</span> <span class="o">/</span> <span class="s2">&quot;pyproject.toml&quot;</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">worker_pyprojects</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">pyproject_file</span><span class="o">.</span><span class="n">resolve</span><span class="p">(</span><span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">)))</span>
                <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
                    <span class="k">continue</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">env_project</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">agi_env</span>
            <span class="n">node_project</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">agi_node</span>
            <span class="n">core_project</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">cluster_project</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">agilab_project</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">worker_pyprojects</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="n">wenv_abs</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">wenv_abs</span>
        <span class="n">cmd_prefix</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">envars</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s2">_CMD_PREFIX&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">uv</span> <span class="o">=</span> <span class="n">cmd_prefix</span> <span class="o">+</span> <span class="n">env</span><span class="o">.</span><span class="n">uv</span>
        <span class="n">pyvers</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">python_version</span>

        <span class="k">if</span> <span class="n">hw_rapids_capable</span><span class="p">:</span>
            <span class="n">AgiEnv</span><span class="o">.</span><span class="n">set_env_var</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="s2">&quot;hw_rapids_capable&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">AgiEnv</span><span class="o">.</span><span class="n">set_env_var</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="s2">&quot;no_rapids_hw&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">env</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Rapids-capable GPU[</span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s2">]: </span><span class="si">{</span><span class="n">hw_rapids_capable</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># =========</span>
        <span class="c1"># MANAGER install command with and without rapids capable</span>
        <span class="c1"># =========</span>

        <span class="n">app_path</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">active_app</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">env</span><span class="o">.</span><span class="n">is_source_env</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">env</span><span class="o">.</span><span class="n">is_worker_env</span><span class="p">)</span> <span class="ow">and</span> <span class="n">dependency_info</span><span class="p">:</span>
            <span class="n">_update_pyproject_dependencies</span><span class="p">(</span>
                <span class="n">app_path</span> <span class="o">/</span> <span class="s2">&quot;pyproject.toml&quot;</span><span class="p">,</span>
                <span class="n">pinned_versions</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">filter_to_worker</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="n">extra_indexes</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">run_type</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;sync&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">_agi__version_missing_on_pypi</span><span class="p">(</span><span class="n">app_path</span><span class="p">):</span>
            <span class="n">extra_indexes</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;PIP_INDEX_URL=https://test.pypi.org/simple &quot;</span>
                <span class="s2">&quot;PIP_EXTRA_INDEX_URL=https://pypi.org/simple &quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">hw_rapids_capable</span><span class="p">:</span>
            <span class="n">cmd_manager</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">extra_indexes</span><span class="si">}{</span><span class="n">uv</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">run_type</span><span class="si">}</span><span class="s2"> --config-file uv_config.toml --project &#39;</span><span class="si">{</span><span class="n">app_path</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cmd_manager</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">extra_indexes</span><span class="si">}{</span><span class="n">uv</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">run_type</span><span class="si">}</span><span class="s2"> --project &#39;</span><span class="si">{</span><span class="n">app_path</span><span class="si">}</span><span class="s2">&#39;&quot;</span>

        <span class="c1"># Reset manager virtualenv to avoid stale or partially-created interpreters.</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">app_path</span> <span class="o">/</span> <span class="s2">&quot;.venv&quot;</span><span class="p">,</span> <span class="n">ignore_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="p">(</span><span class="n">app_path</span> <span class="o">/</span> <span class="s2">&quot;uv.lock&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">if</span> <span class="n">env</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Installing manager: </span><span class="si">{</span><span class="n">cmd_manager</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">AgiEnv</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd_manager</span><span class="p">,</span> <span class="n">app_path</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">env</span><span class="o">.</span><span class="n">is_source_env</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">env</span><span class="o">.</span><span class="n">is_worker_env</span><span class="p">):</span>
            <span class="k">await</span> <span class="n">_ensure_pip</span><span class="p">(</span><span class="n">uv</span><span class="p">,</span> <span class="n">app_path</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">project_path</span> <span class="ow">in</span> <span class="p">(</span>
                <span class="n">agilab_project</span><span class="p">,</span>
                <span class="n">env_project</span><span class="p">,</span>
                <span class="n">node_project</span><span class="p">,</span>
                <span class="n">core_project</span><span class="p">,</span>
                <span class="n">cluster_project</span><span class="p">,</span>
            <span class="p">):</span>
                <span class="k">if</span> <span class="n">project_path</span> <span class="ow">and</span> <span class="n">project_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">repo_agilab_root</span> <span class="ow">and</span> <span class="n">project_path</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span> <span class="o">==</span> <span class="n">repo_agilab_root</span><span class="o">.</span><span class="n">resolve</span><span class="p">():</span>
                        <span class="k">continue</span>
                    <span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">uv</span><span class="si">}</span><span class="s2"> run --project &#39;</span><span class="si">{</span><span class="n">app_path</span><span class="si">}</span><span class="s2">&#39; python -m pip install &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;--upgrade --no-deps &#39;</span><span class="si">{</span><span class="n">project_path</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
                    <span class="p">)</span>
                    <span class="k">await</span> <span class="n">AgiEnv</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">app_path</span><span class="p">)</span>

            <span class="n">resources_src</span> <span class="o">=</span> <span class="n">env_project</span> <span class="o">/</span> <span class="s1">&#39;src/agi_env/resources&#39;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">resources_src</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="n">resources_src</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">env_pck</span> <span class="o">/</span> <span class="s1">&#39;resources&#39;</span>
            <span class="n">manager_resources</span> <span class="o">=</span> <span class="n">app_path</span> <span class="o">/</span> <span class="s1">&#39;agilab/core/agi-env/src/agi_env/resources&#39;</span>
            <span class="k">if</span> <span class="n">resources_src</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;mkdir </span><span class="si">{</span><span class="n">manager_resources</span><span class="o">.</span><span class="n">parent</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">manager_resources</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">manager_resources</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                    <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">manager_resources</span><span class="p">)</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">copytree</span><span class="p">(</span><span class="n">resources_src</span><span class="p">,</span> <span class="n">manager_resources</span><span class="p">,</span> <span class="n">dirs_exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="n">site_packages_manager</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">env_pck</span><span class="o">.</span><span class="n">parent</span>
            <span class="n">_cleanup_editable</span><span class="p">(</span><span class="n">site_packages_manager</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">dependency_info</span><span class="p">:</span>
                <span class="n">dep_versions</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">meta</span> <span class="ow">in</span> <span class="n">dependency_info</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">dep_versions</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">pkg_version</span><span class="p">(</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span>
                    <span class="k">except</span> <span class="n">PackageNotFoundError</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Dependency </span><span class="si">%s</span><span class="s2"> not installed in manager environment&quot;</span><span class="p">,</span> <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">env</span><span class="o">.</span><span class="n">is_source_env</span><span class="p">:</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">uv</span><span class="si">}</span><span class="s2"> pip install -e &#39;</span><span class="si">{</span><span class="n">env</span><span class="o">.</span><span class="n">agi_env</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
            <span class="k">await</span> <span class="n">AgiEnv</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">app_path</span><span class="p">)</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">uv</span><span class="si">}</span><span class="s2"> pip install -e &#39;</span><span class="si">{</span><span class="n">env</span><span class="o">.</span><span class="n">agi_node</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
            <span class="k">await</span> <span class="n">AgiEnv</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">app_path</span><span class="p">)</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">uv</span><span class="si">}</span><span class="s2"> pip install -e &#39;</span><span class="si">{</span><span class="n">env</span><span class="o">.</span><span class="n">agi_cluster</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
            <span class="k">await</span> <span class="n">AgiEnv</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">app_path</span><span class="p">)</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">uv</span><span class="si">}</span><span class="s2"> pip install -e .&quot;</span>
            <span class="k">await</span> <span class="n">AgiEnv</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">app_path</span><span class="p">)</span>

        <span class="c1"># in case of core src has changed</span>
        <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_build_lib_local</span><span class="p">()</span>

        <span class="c1"># ========</span>
        <span class="c1"># WORKER install command with and without rapids capable</span>
        <span class="c1"># ========</span>

        <span class="n">uv_worker</span> <span class="o">=</span> <span class="n">cmd_prefix</span> <span class="o">+</span> <span class="n">env</span><span class="o">.</span><span class="n">uv_worker</span>
        <span class="n">pyvers_worker</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">pyvers_worker</span>

        <span class="n">worker_extra_indexes</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">run_type</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;sync&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">_agi__version_missing_on_pypi</span><span class="p">(</span><span class="n">wenv_abs</span><span class="p">):</span>
            <span class="n">worker_extra_indexes</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;PIP_INDEX_URL=https://test.pypi.org/simple; &quot;</span>
                <span class="s2">&quot;PIP_EXTRA_INDEX_URL=https://pypi.org/simple; &quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">env</span><span class="o">.</span><span class="n">is_source_env</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">env</span><span class="o">.</span><span class="n">is_worker_env</span><span class="p">)</span> <span class="ow">and</span> <span class="n">dep_versions</span><span class="p">:</span>
            <span class="n">_update_pyproject_dependencies</span><span class="p">(</span>
                <span class="n">wenv_abs</span> <span class="o">/</span> <span class="s2">&quot;pyproject.toml&quot;</span><span class="p">,</span>
                <span class="n">dep_versions</span><span class="p">,</span>
                <span class="n">filter_to_worker</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">wenv_abs</span> <span class="o">/</span> <span class="s2">&quot;.venv&quot;</span><span class="p">,</span> <span class="n">ignore_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">env</span><span class="o">.</span><span class="n">is_source_env</span><span class="p">:</span>
            <span class="c1"># add missing agi-anv and agi-node as there are not in pyproject.toml as wished</span>
            <span class="n">cmd_worker</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">worker_extra_indexes</span><span class="si">}{</span><span class="n">uv_worker</span><span class="si">}</span><span class="s2"> --project </span><span class="si">{</span><span class="n">wenv_abs</span><span class="si">}</span><span class="s2"> add </span><span class="se">\&quot;</span><span class="si">{</span><span class="n">env</span><span class="o">.</span><span class="n">agi_env</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2">&quot;</span>
            <span class="k">await</span> <span class="n">AgiEnv</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd_worker</span><span class="p">,</span> <span class="n">wenv_abs</span><span class="p">)</span>

            <span class="n">cmd_worker</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">worker_extra_indexes</span><span class="si">}{</span><span class="n">uv_worker</span><span class="si">}</span><span class="s2"> --project </span><span class="si">{</span><span class="n">wenv_abs</span><span class="si">}</span><span class="s2"> add </span><span class="se">\&quot;</span><span class="si">{</span><span class="n">env</span><span class="o">.</span><span class="n">agi_node</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2">&quot;</span>
            <span class="k">await</span> <span class="n">AgiEnv</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd_worker</span><span class="p">,</span> <span class="n">wenv_abs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># add missing agi-anv and agi-node as there are not in pyproject.toml as wished</span>
            <span class="n">cmd_worker</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">worker_extra_indexes</span><span class="si">}{</span><span class="n">uv_worker</span><span class="si">}</span><span class="s2"> --project </span><span class="si">{</span><span class="n">wenv_abs</span><span class="si">}</span><span class="s2"> add agi-env&quot;</span>
            <span class="k">await</span> <span class="n">AgiEnv</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd_worker</span><span class="p">,</span> <span class="n">wenv_abs</span><span class="p">)</span>

            <span class="n">cmd_worker</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">worker_extra_indexes</span><span class="si">}{</span><span class="n">uv_worker</span><span class="si">}</span><span class="s2"> --project </span><span class="si">{</span><span class="n">wenv_abs</span><span class="si">}</span><span class="s2"> add agi-node&quot;</span>
            <span class="k">await</span> <span class="n">AgiEnv</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd_worker</span><span class="p">,</span> <span class="n">wenv_abs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">hw_rapids_capable</span><span class="p">:</span>
            <span class="n">cmd_worker</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">worker_extra_indexes</span><span class="si">}{</span><span class="n">uv_worker</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">run_type</span><span class="si">}</span><span class="s2"> --python </span><span class="si">{</span><span class="n">pyvers_worker</span><span class="si">}</span><span class="s2"> &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;--config-file uv_config.toml --project </span><span class="se">\&quot;</span><span class="si">{</span><span class="n">wenv_abs</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cmd_worker</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">worker_extra_indexes</span><span class="si">}{</span><span class="n">uv_worker</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">run_type</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">options_worker</span><span class="si">}</span><span class="s2"> &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;--python </span><span class="si">{</span><span class="n">pyvers_worker</span><span class="si">}</span><span class="s2"> --project </span><span class="se">\&quot;</span><span class="si">{</span><span class="n">wenv_abs</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">env</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Installing workers: </span><span class="si">{</span><span class="n">cmd_worker</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">AgiEnv</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd_worker</span><span class="p">,</span> <span class="n">wenv_abs</span><span class="p">)</span>

        <span class="c1">#############</span>
        <span class="c1"># install env</span>
        <span class="c1">##############</span>

        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">env</span><span class="o">.</span><span class="n">is_source_env</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">env</span><span class="o">.</span><span class="n">is_worker_env</span><span class="p">):</span>
            <span class="k">await</span> <span class="n">_ensure_pip</span><span class="p">(</span><span class="n">uv_worker</span><span class="p">,</span> <span class="n">wenv_abs</span><span class="p">)</span>

            <span class="n">worker_resources_src</span> <span class="o">=</span> <span class="n">env_project</span> <span class="o">/</span> <span class="s1">&#39;src/agi_env/resources&#39;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">worker_resources_src</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="n">worker_resources_src</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">env_pck</span> <span class="o">/</span> <span class="s1">&#39;resources&#39;</span>
            <span class="n">resources_dest</span> <span class="o">=</span> <span class="n">wenv_abs</span> <span class="o">/</span> <span class="s1">&#39;agilab/core/agi-env/src/agi_env/resources&#39;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;mkdir </span><span class="si">{</span><span class="n">resources_dest</span><span class="o">.</span><span class="n">parent</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">resources_dest</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">resources_dest</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">resources_dest</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">worker_resources_src</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">copytree</span><span class="p">(</span><span class="n">worker_resources_src</span><span class="p">,</span> <span class="n">resources_dest</span><span class="p">,</span> <span class="n">dirs_exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">project_path</span> <span class="ow">in</span> <span class="p">(</span>
                <span class="n">agilab_project</span><span class="p">,</span>
                <span class="n">env_project</span><span class="p">,</span>
                <span class="n">node_project</span><span class="p">,</span>
                <span class="n">core_project</span><span class="p">,</span>
                <span class="n">cluster_project</span><span class="p">,</span>
            <span class="p">):</span>
                <span class="k">if</span> <span class="n">project_path</span> <span class="ow">and</span> <span class="n">project_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">repo_agilab_root</span> <span class="ow">and</span> <span class="n">project_path</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span> <span class="o">==</span> <span class="n">repo_agilab_root</span><span class="o">.</span><span class="n">resolve</span><span class="p">():</span>
                        <span class="k">continue</span>
                    <span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">uv_worker</span><span class="si">}</span><span class="s2"> run --project </span><span class="se">\&quot;</span><span class="si">{</span><span class="n">wenv_abs</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2"> python -m pip install &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;--upgrade --no-deps </span><span class="se">\&quot;</span><span class="si">{</span><span class="n">project_path</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                    <span class="k">await</span> <span class="n">AgiEnv</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">wenv_abs</span><span class="p">)</span>

            <span class="n">python_dirs</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">pyvers_worker</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">python_dirs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;t&quot;</span><span class="p">):</span>
                <span class="n">python_dir</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">python_dirs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">python_dirs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">t&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">python_dir</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">python_dirs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">python_dirs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">site_packages_worker</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">wenv_abs</span> <span class="o">/</span> <span class="s2">&quot;.venv&quot;</span> <span class="o">/</span> <span class="s2">&quot;lib&quot;</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;python</span><span class="si">{</span><span class="n">python_dir</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">/</span> <span class="s2">&quot;site-packages&quot;</span>
            <span class="p">)</span>
            <span class="n">_cleanup_editable</span><span class="p">(</span><span class="n">site_packages_worker</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># build agi_env*.whl</span>
            <span class="n">menv</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">agi_env</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">uv</span><span class="si">}</span><span class="s2"> --project </span><span class="se">\&quot;</span><span class="si">{</span><span class="n">menv</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2"> build --wheel&quot;</span>
            <span class="k">await</span> <span class="n">AgiEnv</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">menv</span><span class="p">)</span>
            <span class="n">src</span> <span class="o">=</span> <span class="n">menv</span> <span class="o">/</span> <span class="s2">&quot;dist&quot;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">whl</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;agi_env*.whl&quot;</span><span class="p">)))</span>
                <span class="c1"># shutil.copy2(whl, wenv_abs)</span>
            <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>

            <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">uv_worker</span><span class="si">}</span><span class="s2"> pip install --project </span><span class="se">\&quot;</span><span class="si">{</span><span class="n">wenv_abs</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2"> -e </span><span class="se">\&quot;</span><span class="si">{</span><span class="n">env</span><span class="o">.</span><span class="n">agi_env</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2">&quot;</span>
            <span class="k">await</span> <span class="n">AgiEnv</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">wenv_abs</span><span class="p">)</span>

            <span class="c1"># build agi_node*.whl</span>
            <span class="n">menv</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">agi_node</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">uv</span><span class="si">}</span><span class="s2"> --project </span><span class="se">\&quot;</span><span class="si">{</span><span class="n">menv</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2"> build --wheel&quot;</span>
            <span class="k">await</span> <span class="n">AgiEnv</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">menv</span><span class="p">)</span>
            <span class="n">src</span> <span class="o">=</span> <span class="n">menv</span> <span class="o">/</span> <span class="s2">&quot;dist&quot;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">whl</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;agi_node*.whl&quot;</span><span class="p">)))</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="n">whl</span><span class="p">,</span> <span class="n">wenv_abs</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>

            <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">uv_worker</span><span class="si">}</span><span class="s2"> pip install --project </span><span class="se">\&quot;</span><span class="si">{</span><span class="n">wenv_abs</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2"> -e </span><span class="se">\&quot;</span><span class="si">{</span><span class="n">env</span><span class="o">.</span><span class="n">agi_node</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2">&quot;</span>
            <span class="k">await</span> <span class="n">AgiEnv</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">wenv_abs</span><span class="p">)</span>

        <span class="c1"># Install the app sources into the worker venv using the absolute app path</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">uv_worker</span><span class="si">}</span><span class="s2"> pip install --project </span><span class="se">\&quot;</span><span class="si">{</span><span class="n">wenv_abs</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2"> -e </span><span class="se">\&quot;</span><span class="si">{</span><span class="n">env</span><span class="o">.</span><span class="n">active_app</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2">&quot;</span>
        <span class="k">await</span> <span class="n">AgiEnv</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">wenv_abs</span><span class="p">)</span>

        <span class="c1"># dataset</span>
        <span class="n">dest</span> <span class="o">=</span> <span class="n">wenv_abs</span> <span class="o">/</span> <span class="s2">&quot;src&quot;</span> <span class="o">/</span> <span class="n">env</span><span class="o">.</span><span class="n">target_worker</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">src</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">dataset_archive</span>
        <span class="k">if</span> <span class="n">src</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">share_root</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">share_root_path</span><span class="p">()</span>
                <span class="c1"># why this line ???</span>
                <span class="c1"># install_dataset_dir = share_root / &quot;dataset&quot;</span>
                <span class="n">install_dataset_dir</span> <span class="o">=</span> <span class="n">share_root</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;mkdir </span><span class="si">{</span><span class="n">install_dataset_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">install_dataset_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dest</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">FileNotFoundError</span><span class="p">,</span> <span class="ne">PermissionError</span><span class="p">,</span> <span class="ne">RuntimeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Skipping dataset copy to </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">install_dataset_dir</span> <span class="k">if</span> <span class="s1">&#39;install_dataset_dir&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;&lt;share root&gt;&quot;</span><span class="p">,</span> <span class="n">exc</span><span class="p">)</span>

        <span class="n">post_install_cmd</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">uv_worker</span><span class="si">}</span><span class="s2"> run --no-sync --project </span><span class="se">\&quot;</span><span class="si">{</span><span class="n">wenv_abs</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2"> &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;--python </span><span class="si">{</span><span class="n">pyvers_worker</span><span class="si">}</span><span class="s2"> python -m </span><span class="si">{</span><span class="n">env</span><span class="o">.</span><span class="n">post_install_rel</span><span class="si">}</span><span class="s2"> &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">wenv_rel</span><span class="o">.</span><span class="n">stem</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">env</span><span class="o">.</span><span class="n">user</span> <span class="ow">and</span> <span class="n">env</span><span class="o">.</span><span class="n">user</span> <span class="o">!=</span> <span class="n">getpass</span><span class="o">.</span><span class="n">getuser</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">exec_ssh</span><span class="p">(</span><span class="s2">&quot;127.0.0.1&quot;</span><span class="p">,</span> <span class="n">post_install_cmd</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ConnectionError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;SSH execution failed on localhost (</span><span class="si">%s</span><span class="s2">), falling back to local run.&quot;</span><span class="p">,</span> <span class="n">exc</span><span class="p">)</span>
                <span class="k">await</span> <span class="n">AgiEnv</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">post_install_cmd</span><span class="p">,</span> <span class="n">wenv_abs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">AgiEnv</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">post_install_cmd</span><span class="p">,</span> <span class="n">wenv_abs</span><span class="p">)</span>

        <span class="c1"># Cleanup modules</span>
        <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_uninstall_modules</span><span class="p">()</span>
        <span class="n">AGI</span><span class="o">.</span><span class="n">_install_done_local</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">cli</span> <span class="o">=</span> <span class="n">wenv_abs</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="s2">&quot;cli.py&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">cli</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">cluster_pck</span> <span class="o">/</span> <span class="s2">&quot;agi_distributor/cli.py&quot;</span><span class="p">,</span> <span class="n">cli</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">FileNotFoundError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Missing cli.py for local worker: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc</span><span class="p">)</span>
                <span class="k">raise</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">uv_worker</span><span class="si">}</span><span class="s2"> run --no-sync --project </span><span class="se">\&quot;</span><span class="si">{</span><span class="n">wenv_abs</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2"> python </span><span class="se">\&quot;</span><span class="si">{</span><span class="n">cli</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2"> threaded&quot;</span>
        <span class="k">await</span> <span class="n">AgiEnv</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">wenv_abs</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_deploy_remote_worker</span><span class="p">(</span><span class="n">ip</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">env</span><span class="p">:</span> <span class="n">AgiEnv</span><span class="p">,</span> <span class="n">wenv_rel</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">option</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Install packages and set up the environment on a remote node.&quot;&quot;&quot;</span>

        <span class="n">wenv_abs</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">wenv_abs</span>
        <span class="n">wenv_rel</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">wenv_rel</span>
        <span class="n">dist_rel</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">dist_rel</span>
        <span class="n">dist_abs</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">dist_abs</span>
        <span class="n">pyvers</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">pyvers_worker</span>
        <span class="n">cmd_prefix</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">envars</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s2">_CMD_PREFIX&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">uv</span> <span class="o">=</span> <span class="n">cmd_prefix</span> <span class="o">+</span> <span class="n">env</span><span class="o">.</span><span class="n">uv_worker</span>

        <span class="k">if</span> <span class="n">env</span><span class="o">.</span><span class="n">is_source_env</span><span class="p">:</span>
            <span class="c1"># Then send the files to the remote directory</span>
            <span class="n">egg_file</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">dist_abs</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">env</span><span class="o">.</span><span class="n">target_worker</span><span class="si">}</span><span class="s2">*.egg&quot;</span><span class="p">)),</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">egg_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">egg_file</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">dist_abs</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">env</span><span class="o">.</span><span class="n">app</span><span class="si">}</span><span class="s2">*.egg&quot;</span><span class="p">)),</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">egg_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;searching for </span><span class="si">{</span><span class="n">dist_abs</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">env</span><span class="o">.</span><span class="n">target_worker</span><span class="si">}</span><span class="s2">*.egg or </span><span class="si">{</span><span class="n">dist_abs</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">env</span><span class="o">.</span><span class="n">app</span><span class="si">}</span><span class="s2">*.egg&quot;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;no existing egg file in </span><span class="si">{</span><span class="n">dist_abs</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">env</span><span class="o">.</span><span class="n">target_worker</span><span class="si">}</span><span class="s2">* or </span><span class="si">{</span><span class="n">dist_abs</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">env</span><span class="o">.</span><span class="n">app</span><span class="si">}</span><span class="s2">*&quot;</span><span class="p">)</span>

            <span class="n">wenv</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">agi_env</span> <span class="o">/</span> <span class="s1">&#39;dist&#39;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">env_whl</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">wenv</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;agi_env*.whl&quot;</span><span class="p">)))</span>
            <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;no existing whl file in </span><span class="si">{</span><span class="n">wenv</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="s2">&quot;agi_env*&quot;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># build agi_node*.whl</span>
            <span class="n">wenv</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">agi_node</span> <span class="o">/</span> <span class="s1">&#39;dist&#39;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">node_whl</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">wenv</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;agi_node*.whl&quot;</span><span class="p">)))</span>
            <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;no existing whl file in </span><span class="si">{</span><span class="n">wenv</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="s2">&quot;agi_node*&quot;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">dist_remote</span> <span class="o">=</span> <span class="n">wenv_rel</span> <span class="o">/</span> <span class="s2">&quot;dist&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;mkdir </span><span class="si">{</span><span class="n">dist_remote</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">exec_ssh</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;mkdir -p &#39;</span><span class="si">{</span><span class="n">dist_remote</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">send_files</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="p">[</span><span class="n">egg_file</span><span class="p">],</span> <span class="n">wenv_rel</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">send_files</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="p">[</span><span class="n">node_whl</span><span class="p">,</span> <span class="n">env_whl</span><span class="p">],</span> <span class="n">dist_remote</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Then send the files to the remote directory</span>
            <span class="n">egg_file</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">dist_abs</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">env</span><span class="o">.</span><span class="n">target_worker</span><span class="si">}</span><span class="s2">*.egg&quot;</span><span class="p">)),</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">egg_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">egg_file</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">dist_abs</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">env</span><span class="o">.</span><span class="n">app</span><span class="si">}</span><span class="s2">*.egg&quot;</span><span class="p">)),</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">egg_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;searching for </span><span class="si">{</span><span class="n">dist_abs</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">env</span><span class="o">.</span><span class="n">target_worker</span><span class="si">}</span><span class="s2">*.egg or </span><span class="si">{</span><span class="n">dist_abs</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">env</span><span class="o">.</span><span class="n">app</span><span class="si">}</span><span class="s2">*.egg&quot;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;no existing egg file in </span><span class="si">{</span><span class="n">dist_abs</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">env</span><span class="o">.</span><span class="n">target_worker</span><span class="si">}</span><span class="s2">* or </span><span class="si">{</span><span class="n">dist_abs</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">env</span><span class="o">.</span><span class="n">app</span><span class="si">}</span><span class="s2">*&quot;</span><span class="p">)</span>

            <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">send_files</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="p">[</span><span class="n">egg_file</span><span class="p">],</span> <span class="n">wenv_rel</span><span class="p">)</span>

        <span class="c1"># 5) Check remote Rapids hardware support via nvidia-smi</span>
        <span class="n">hw_rapids_capable</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_rapids_enabled</span><span class="p">:</span>
            <span class="n">check_rapids</span> <span class="o">=</span> <span class="s1">&#39;nvidia-smi&#39;</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">exec_ssh</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">check_rapids</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;rapids is requested but not supported by node [</span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
                <span class="k">raise</span>

            <span class="n">hw_rapids_capable</span> <span class="o">=</span> <span class="p">(</span><span class="n">result</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_rapids_enabled</span>
            <span class="n">env</span><span class="o">.</span><span class="n">hw_rapids_capable</span> <span class="o">=</span> <span class="n">hw_rapids_capable</span>
            <span class="k">if</span> <span class="n">hw_rapids_capable</span><span class="p">:</span>
                <span class="n">AgiEnv</span><span class="o">.</span><span class="n">set_env_var</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="s2">&quot;hw_rapids_capable&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Rapids-capable GPU[</span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s2">]: </span><span class="si">{</span><span class="n">hw_rapids_capable</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># unzip egg to get src/</span>
        <span class="n">cli</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">wenv_rel</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="s2">&quot;cli.py&quot;</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">uv</span><span class="si">}</span><span class="s2"> run -p </span><span class="si">{</span><span class="n">pyvers</span><span class="si">}</span><span class="s2"> python  </span><span class="si">{</span><span class="n">cli</span><span class="si">}</span><span class="s2"> unzip </span><span class="si">{</span><span class="n">wenv_rel</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">exec_ssh</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span>

        <span class="c1">#############</span>
        <span class="c1"># install env</span>
        <span class="c1">#############</span>

        <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">uv</span><span class="si">}</span><span class="s2"> --project </span><span class="si">{</span><span class="n">wenv_rel</span><span class="si">}</span><span class="s2"> run -p </span><span class="si">{</span><span class="n">pyvers</span><span class="si">}</span><span class="s2"> python -m ensurepip&quot;</span>
        <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">exec_ssh</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">env</span><span class="o">.</span><span class="n">is_source_env</span><span class="p">:</span>
            <span class="n">env_pck</span> <span class="o">=</span> <span class="n">wenv_rel</span> <span class="o">/</span> <span class="s2">&quot;dist&quot;</span> <span class="o">/</span> <span class="n">env_whl</span><span class="o">.</span><span class="n">name</span>
            <span class="n">node_pck</span> <span class="o">=</span> <span class="n">wenv_rel</span> <span class="o">/</span> <span class="s2">&quot;dist&quot;</span> <span class="o">/</span> <span class="n">node_whl</span><span class="o">.</span><span class="n">name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">env_pck</span> <span class="o">=</span> <span class="s2">&quot;agi-env&quot;</span>
            <span class="n">node_pck</span> <span class="o">=</span> <span class="s2">&quot;agi-node&quot;</span>

        <span class="c1"># install env</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">uv</span><span class="si">}</span><span class="s2"> --project </span><span class="si">{</span><span class="n">wenv_rel</span><span class="si">}</span><span class="s2"> add -p </span><span class="si">{</span><span class="n">pyvers</span><span class="si">}</span><span class="s2"> --upgrade </span><span class="si">{</span><span class="n">env_pck</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">exec_ssh</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span>

        <span class="c1"># install node</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">uv</span><span class="si">}</span><span class="s2"> --project </span><span class="si">{</span><span class="n">wenv_rel</span><span class="si">}</span><span class="s2"> add -p </span><span class="si">{</span><span class="n">pyvers</span><span class="si">}</span><span class="s2"> --upgrade </span><span class="si">{</span><span class="n">node_pck</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">exec_ssh</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span>

        <span class="c1"># unzip egg to get src/</span>
        <span class="n">cli</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">wenv_rel</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="s2">&quot;cli.py&quot;</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">uv</span><span class="si">}</span><span class="s2"> --project </span><span class="si">{</span><span class="n">wenv_rel</span><span class="si">}</span><span class="s2">  run --no-sync -p </span><span class="si">{</span><span class="n">pyvers</span><span class="si">}</span><span class="s2"> python </span><span class="si">{</span><span class="n">cli</span><span class="si">}</span><span class="s2"> unzip </span><span class="si">{</span><span class="n">wenv_rel</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">exec_ssh</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span>

        <span class="c1"># Post-install script</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">uv</span><span class="si">}</span><span class="s2"> --project </span><span class="si">{</span><span class="n">wenv_rel</span><span class="si">}</span><span class="s2"> run --no-sync -p </span><span class="si">{</span><span class="n">pyvers</span><span class="si">}</span><span class="s2"> python -m &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">env</span><span class="o">.</span><span class="n">post_install_rel</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">wenv_rel</span><span class="o">.</span><span class="n">stem</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">exec_ssh</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span>

        <span class="c1"># build target_worker lib from src/</span>
        <span class="k">if</span> <span class="n">env</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">uv</span><span class="si">}</span><span class="s2"> --project &#39;</span><span class="si">{</span><span class="n">wenv_rel</span><span class="si">}</span><span class="s2">&#39; run --no-sync -p </span><span class="si">{</span><span class="n">pyvers</span><span class="si">}</span><span class="s2"> python -m &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;agi_node.agi_dispatcher.build  --app-path  &#39;</span><span class="si">{</span><span class="n">wenv_rel</span><span class="si">}</span><span class="s2">&#39; build_ext -b &#39;</span><span class="si">{</span><span class="n">wenv_rel</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">uv</span><span class="si">}</span><span class="s2"> --project &#39;</span><span class="si">{</span><span class="n">wenv_rel</span><span class="si">}</span><span class="s2">&#39; run --no-sync -p </span><span class="si">{</span><span class="n">pyvers</span><span class="si">}</span><span class="s2"> python -m &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;agi_node.agi_dispatcher.build --app-path &#39;</span><span class="si">{</span><span class="n">wenv_rel</span><span class="si">}</span><span class="s2">&#39; -q build_ext -b &#39;</span><span class="si">{</span><span class="n">wenv_rel</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
            <span class="p">)</span>
        <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">exec_ssh</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_should_install_pip</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">getpass</span><span class="o">.</span><span class="n">getuser</span><span class="p">())</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;T0&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">prefix</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;Scripts/pip.exe&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>

    <span class="nd">@staticmethod</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_uninstall_modules</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Uninstall specified modules.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">module</span> <span class="ow">in</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_module_to_clean</span><span class="p">:</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">env</span><span class="o">.</span><span class="n">uv</span><span class="si">}</span><span class="s2"> pip uninstall </span><span class="si">{</span><span class="n">module</span><span class="si">}</span><span class="s2"> -y&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Executing: </span><span class="si">{</span><span class="n">cmd</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">AgiEnv</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">AGI</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">agi_env</span><span class="p">)</span>
        <span class="n">AGI</span><span class="o">.</span><span class="n">_module_to_clean</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_format_elapsed</span><span class="p">(</span><span class="n">seconds</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Format the duration from seconds to a human-readable format.</span>

<span class="sd">        Args:</span>
<span class="sd">            seconds (float): The duration in seconds.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: The formatted duration.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">humanize</span><span class="o">.</span><span class="n">precisedelta</span><span class="p">(</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">seconds</span><span class="p">))</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_venv_todo</span><span class="p">(</span><span class="n">list_ip</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Args:</span>
<span class="sd">          list_ip: return:</span>

<span class="sd">        Returns:</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="n">AGI</span><span class="o">.</span><span class="n">_local_ip</span><span class="p">,</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_remote_ip</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">ip</span> <span class="ow">in</span> <span class="n">list_ip</span><span class="p">:</span>
            <span class="p">(</span><span class="n">AGI</span><span class="o">.</span><span class="n">_local_ip</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span> <span class="k">if</span> <span class="n">AgiEnv</span><span class="o">.</span><span class="n">is_local</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span> <span class="k">else</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_remote_ip</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ip</span><span class="p">))</span>
        <span class="n">AGI</span><span class="o">.</span><span class="n">_install_todo</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">AGI</span><span class="o">.</span><span class="n">_remote_ip</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">AGI</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;remote worker to install: </span><span class="si">{</span><span class="n">AGI</span><span class="o">.</span><span class="n">_install_todo</span><span class="si">}</span><span class="s2"> &quot;</span><span class="p">)</span>

<div class="viewcode-block" id="AGI.install">
<a class="viewcode-back" href="../../../module-agi-cluster.html#agi_cluster.agi_distributor.agi_distributor.AGI.install">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">install</span><span class="p">(</span>
            <span class="n">env</span><span class="p">:</span> <span class="n">AgiEnv</span><span class="p">,</span>
            <span class="n">scheduler</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">workers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">modes_enabled</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">_RUN_MASK</span><span class="p">,</span>
            <span class="n">verbose</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="o">**</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the cluster&#39;s virtual environment.</span>

<span class="sd">        Args:</span>
<span class="sd">            project_path (Path):</span>
<span class="sd">                The name of the module to install or the path to the module.</span>
<span class="sd">            list_ip (List[str], optional):</span>
<span class="sd">                A list of IPv4 addresses with SSH access. Each IP should have Python,</span>
<span class="sd">                `psutil`, and `pdm` installed. Defaults to None.</span>
<span class="sd">            modes_enabled (int, optional):</span>
<span class="sd">                Bitmask indicating enabled modes. Defaults to `0b0111`.</span>
<span class="sd">            verbose (int, optional):</span>
<span class="sd">                Verbosity level (0-3). Higher numbers increase the verbosity of the output.</span>
<span class="sd">                Defaults to 1.</span>
<span class="sd">            **args:</span>
<span class="sd">                Additional keyword arguments.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool:</span>
<span class="sd">                `True` if the installation was successful, `False` otherwise.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError:</span>
<span class="sd">                If `module_name_or_path` is invalid.</span>
<span class="sd">            ConnectionError:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">AGI</span><span class="o">.</span><span class="n">_run_type</span> <span class="o">=</span> <span class="s2">&quot;sync&quot;</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="p">(</span><span class="n">AGI</span><span class="o">.</span><span class="n">_INSTALL_MODE</span> <span class="o">|</span> <span class="n">modes_enabled</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
            <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">,</span>
            <span class="n">scheduler</span><span class="o">=</span><span class="n">scheduler</span><span class="p">,</span>
            <span class="n">workers</span><span class="o">=</span><span class="n">workers</span><span class="p">,</span>
            <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span>
            <span class="n">rapids_enabled</span><span class="o">=</span><span class="n">AGI</span><span class="o">.</span><span class="n">_INSTALL_MODE</span> <span class="o">&amp;</span> <span class="n">modes_enabled</span><span class="p">,</span>
            <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="AGI.update">
<a class="viewcode-back" href="../../../module-agi-cluster.html#agi_cluster.agi_distributor.agi_distributor.AGI.update">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span>
            <span class="n">env</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AgiEnv</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">scheduler</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">workers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">modes_enabled</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">_RUN_MASK</span><span class="p">,</span>
            <span class="n">verbose</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="o">**</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        install cluster virtual environment</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        package: any Agi target apps or project created with AGILAB</span>
<span class="sd">        list_ip: any ip V4 with ssh access and python (upto you to link it to python3) with psutil and uv synced</span>
<span class="sd">        mode_enabled: this is typically a mode mask to know for example if cython or rapids are required</span>
<span class="sd">        force_update: make a Spud.update before the installation, default is True</span>
<span class="sd">        verbose: verbosity [0-3]</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">AGI</span><span class="o">.</span><span class="n">_run_type</span> <span class="o">=</span> <span class="s2">&quot;upgrade&quot;</span>
        <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">,</span> <span class="n">scheduler</span><span class="o">=</span><span class="n">scheduler</span><span class="p">,</span> <span class="n">workers</span><span class="o">=</span><span class="n">workers</span><span class="p">,</span>
                      <span class="n">mode</span><span class="o">=</span><span class="p">(</span><span class="n">AGI</span><span class="o">.</span><span class="n">_UPDATE_MODE</span> <span class="o">|</span> <span class="n">modes_enabled</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_DASK_RESET</span><span class="p">,</span>
                      <span class="n">rapids_enabled</span><span class="o">=</span><span class="n">AGI</span><span class="o">.</span><span class="n">_UPDATE_MODE</span> <span class="o">&amp;</span> <span class="n">modes_enabled</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">)</span></div>


<div class="viewcode-block" id="AGI.get_distrib">
<a class="viewcode-back" href="../../../module-agi-cluster.html#agi_cluster.agi_distributor.agi_distributor.AGI.get_distrib">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_distrib</span><span class="p">(</span>
            <span class="n">env</span><span class="p">:</span> <span class="n">AgiEnv</span><span class="p">,</span>
            <span class="n">scheduler</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">workers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">verbose</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
            <span class="o">**</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        check the distribution with a dry run</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        package: any Agi target apps or project created by AGILAB</span>
<span class="sd">        list_ip: any ip V4 with ssh access and python (upto you to link it to python3) with psutil and uv synced</span>
<span class="sd">        verbose: verbosity [0-3]</span>

<span class="sd">        Returns</span>
<span class="sd">        the distribution tree</span>
<span class="sd">        -------</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">AGI</span><span class="o">.</span><span class="n">_run_type</span> <span class="o">=</span> <span class="s2">&quot;simulate&quot;</span>
        <span class="k">return</span> <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">scheduler</span><span class="p">,</span> <span class="n">workers</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">AGI</span><span class="o">.</span><span class="n">_SIMULATE_MODE</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">)</span></div>


    <span class="c1"># Backward compatibility alias</span>
<div class="viewcode-block" id="AGI.distribute">
<a class="viewcode-back" href="../../../module-agi-cluster.html#agi_cluster.agi_distributor.agi_distributor.AGI.distribute">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">distribute</span><span class="p">(</span>
            <span class="n">env</span><span class="p">:</span> <span class="n">AgiEnv</span><span class="p">,</span>
            <span class="n">scheduler</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">workers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">verbose</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
            <span class="o">**</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="k">return</span> <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">get_distrib</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">scheduler</span><span class="p">,</span> <span class="n">workers</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">)</span></div>


    <span class="nd">@staticmethod</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_start_scheduler</span><span class="p">(</span><span class="n">scheduler</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Start Dask scheduler either locally or remotely.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True on success.</span>

<span class="sd">        Raises:</span>
<span class="sd">            FileNotFoundError: if worker initialization error occurs.</span>
<span class="sd">            SystemExit: on fatal error starting scheduler or Dask client.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">env</span> <span class="o">=</span> <span class="n">AGI</span><span class="o">.</span><span class="n">env</span>
        <span class="n">cli_rel</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">wenv_rel</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="s2">&quot;cli.py&quot;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">AGI</span><span class="o">.</span><span class="n">_mode_auto</span> <span class="ow">and</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_mode</span> <span class="o">==</span> <span class="n">AGI</span><span class="o">.</span><span class="n">DASK_MODE</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_mode_auto</span><span class="p">:</span>
            <span class="n">env</span><span class="o">.</span><span class="n">hw_rapids_capable</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_mode</span> <span class="o">&amp;</span> <span class="n">AGI</span><span class="o">.</span><span class="n">DASK_MODE</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">scheduler</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">list</span><span class="p">(</span><span class="n">AGI</span><span class="o">.</span><span class="n">_workers</span><span class="p">)</span> <span class="o">==</span> <span class="p">[</span><span class="s2">&quot;127.0.0.1&quot;</span><span class="p">]:</span>
                        <span class="n">scheduler</span> <span class="o">=</span> <span class="s2">&quot;127.0.0.1&quot;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;AGI.run(...scheduler=&#39;scheduler ip address&#39; is required -&gt; Stop&quot;</span><span class="p">)</span>

                <span class="n">AGI</span><span class="o">.</span><span class="n">_scheduler_ip</span><span class="p">,</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_scheduler_port</span> <span class="o">=</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_get_scheduler</span><span class="p">(</span><span class="n">scheduler</span><span class="p">)</span>

            <span class="c1"># Clean worker</span>
            <span class="k">for</span> <span class="n">ip</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">AGI</span><span class="o">.</span><span class="n">_workers</span><span class="p">):</span>
                <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">send_file</span><span class="p">(</span>
                    <span class="n">env</span><span class="p">,</span>
                    <span class="n">ip</span><span class="p">,</span>
                    <span class="n">env</span><span class="o">.</span><span class="n">cluster_pck</span> <span class="o">/</span> <span class="s2">&quot;agi_distributor/cli.py&quot;</span><span class="p">,</span>
                    <span class="n">cli_rel</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">hw_rapids_capable</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">envars</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">hw_rapids_capable</span> <span class="ow">or</span> <span class="n">hw_rapids_capable</span> <span class="o">==</span> <span class="s2">&quot;no_rapids_hw&quot;</span><span class="p">:</span>
                    <span class="n">env</span><span class="o">.</span><span class="n">hw_rapids_capable</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_kill</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">(),</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">raise</span>

            <span class="c1"># clean scheduler (avoid duplicate kill when scheduler host already handled as worker)</span>
            <span class="k">if</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_scheduler_ip</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_workers</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_kill</span><span class="p">(</span><span class="n">AGI</span><span class="o">.</span><span class="n">_scheduler_ip</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">(),</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">raise</span>

            <span class="n">toml_local</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">active_app</span> <span class="o">/</span> <span class="s2">&quot;pyproject.toml&quot;</span>
            <span class="n">wenv_rel</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">wenv_rel</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">toml_local</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">active_app</span> <span class="o">/</span> <span class="s2">&quot;pyproject.toml&quot;</span>
            <span class="n">wenv_rel</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">wenv_rel</span>
        <span class="n">wenv_abs</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">wenv_abs</span>
        <span class="k">if</span> <span class="n">env</span><span class="o">.</span><span class="n">is_local</span><span class="p">(</span><span class="n">AGI</span><span class="o">.</span><span class="n">_scheduler_ip</span><span class="p">):</span>
            <span class="n">released</span> <span class="o">=</span> <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_wait_for_port_release</span><span class="p">(</span><span class="n">AGI</span><span class="o">.</span><span class="n">_scheduler_ip</span><span class="p">,</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_scheduler_port</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">released</span><span class="p">:</span>
                <span class="n">new_port</span> <span class="o">=</span> <span class="n">AGI</span><span class="o">.</span><span class="n">find_free_port</span><span class="p">()</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;Scheduler port </span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="s2"> still busy. Switching scheduler port to </span><span class="si">%s</span><span class="s2">.&quot;</span><span class="p">,</span>
                    <span class="n">AGI</span><span class="o">.</span><span class="n">_scheduler_ip</span><span class="p">,</span>
                    <span class="n">AGI</span><span class="o">.</span><span class="n">_scheduler_port</span><span class="p">,</span>
                    <span class="n">new_port</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">AGI</span><span class="o">.</span><span class="n">_scheduler_port</span> <span class="o">=</span> <span class="n">new_port</span>
                <span class="n">AGI</span><span class="o">.</span><span class="n">_scheduler</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">AGI</span><span class="o">.</span><span class="n">_scheduler_ip</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">AGI</span><span class="o">.</span><span class="n">_scheduler_port</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">elif</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_mode_auto</span><span class="p">:</span>
                <span class="c1"># Rotate ports between benchmark iterations to avoid TIME_WAIT collisions.</span>
                <span class="n">new_port</span> <span class="o">=</span> <span class="n">AGI</span><span class="o">.</span><span class="n">find_free_port</span><span class="p">()</span>
                <span class="n">AGI</span><span class="o">.</span><span class="n">_scheduler_ip</span><span class="p">,</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_scheduler_port</span> <span class="o">=</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_get_scheduler</span><span class="p">(</span>
                    <span class="p">{</span><span class="n">AGI</span><span class="o">.</span><span class="n">_scheduler_ip</span><span class="p">:</span> <span class="n">new_port</span><span class="p">}</span>
                <span class="p">)</span>

        <span class="n">cmd_prefix</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">envars</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">AGI</span><span class="o">.</span><span class="n">_scheduler_ip</span><span class="si">}</span><span class="s2">_CMD_PREFIX&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">cmd_prefix</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">cmd_prefix</span> <span class="o">=</span> <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_detect_export_cmd</span><span class="p">(</span><span class="n">AGI</span><span class="o">.</span><span class="n">_scheduler_ip</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">cmd_prefix</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">if</span> <span class="n">cmd_prefix</span><span class="p">:</span>
                <span class="n">AgiEnv</span><span class="o">.</span><span class="n">set_env_var</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">AGI</span><span class="o">.</span><span class="n">_scheduler_ip</span><span class="si">}</span><span class="s2">_CMD_PREFIX&quot;</span><span class="p">,</span> <span class="n">cmd_prefix</span><span class="p">)</span>

        <span class="n">dask_env</span> <span class="o">=</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_dask_env_prefix</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">env</span><span class="o">.</span><span class="n">is_local</span><span class="p">(</span><span class="n">AGI</span><span class="o">.</span><span class="n">_scheduler_ip</span><span class="p">):</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># non-blocking sleep</span>
            <span class="n">local_prefix</span> <span class="o">=</span> <span class="n">cmd_prefix</span> <span class="ow">or</span> <span class="n">env</span><span class="o">.</span><span class="n">export_local_bin</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">local_prefix</span><span class="si">}{</span><span class="n">dask_env</span><span class="si">}{</span><span class="n">env</span><span class="o">.</span><span class="n">uv</span><span class="si">}</span><span class="s2"> run --no-sync --project </span><span class="si">{</span><span class="n">env</span><span class="o">.</span><span class="n">wenv_abs</span><span class="si">}</span><span class="s2"> &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;dask scheduler &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;--port </span><span class="si">{</span><span class="n">AGI</span><span class="o">.</span><span class="n">_scheduler_port</span><span class="si">}</span><span class="s2"> &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;--host </span><span class="si">{</span><span class="n">AGI</span><span class="o">.</span><span class="n">_scheduler_ip</span><span class="si">}</span><span class="s2"> &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;--dashboard-address :0 &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;--pid-file </span><span class="si">{</span><span class="n">wenv_abs</span><span class="o">.</span><span class="n">parent</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="s1">&#39;dask_scheduler.pid&#39;</span><span class="si">}</span><span class="s2"> &quot;</span>
            <span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting dask scheduler locally: </span><span class="si">{</span><span class="n">cmd</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_exec_bg</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">env</span><span class="o">.</span><span class="n">app</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">result</span><span class="p">:</span>  <span class="c1"># assuming _exec_bg is sync</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Create remote directory</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cmd_prefix</span><span class="si">}{</span><span class="n">env</span><span class="o">.</span><span class="n">uv</span><span class="si">}</span><span class="s2"> run --no-sync python -c &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">import os; os.makedirs(&#39;</span><span class="si">{</span><span class="n">wenv_rel</span><span class="si">}</span><span class="s2">&#39;, exist_ok=True)</span><span class="se">\&quot;</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">exec_ssh</span><span class="p">(</span><span class="n">AGI</span><span class="o">.</span><span class="n">_scheduler_ip</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span>

            <span class="n">toml_wenv</span> <span class="o">=</span> <span class="n">wenv_rel</span> <span class="o">/</span> <span class="s2">&quot;pyproject.toml&quot;</span>
            <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">send_file</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_scheduler_ip</span><span class="p">,</span> <span class="n">toml_local</span><span class="p">,</span> <span class="n">toml_wenv</span><span class="p">)</span>

            <span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cmd_prefix</span><span class="si">}{</span><span class="n">dask_env</span><span class="si">}{</span><span class="n">env</span><span class="o">.</span><span class="n">uv</span><span class="si">}</span><span class="s2"> --project </span><span class="si">{</span><span class="n">wenv_rel</span><span class="si">}</span><span class="s2"> run --no-sync &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;dask scheduler &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;--port </span><span class="si">{</span><span class="n">AGI</span><span class="o">.</span><span class="n">_scheduler_port</span><span class="si">}</span><span class="s2"> &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;--host </span><span class="si">{</span><span class="n">AGI</span><span class="o">.</span><span class="n">_scheduler_ip</span><span class="si">}</span><span class="s2"> --dashboard-address :0 --pid-file dask_scheduler.pid&quot;</span>
            <span class="p">)</span>
            <span class="c1"># Run scheduler asynchronously over SSH without awaiting completion (fire and forget)</span>
            <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">AGI</span><span class="o">.</span><span class="n">exec_ssh_async</span><span class="p">(</span><span class="n">AGI</span><span class="o">.</span><span class="n">_scheduler_ip</span><span class="p">,</span> <span class="n">cmd</span><span class="p">))</span>

        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Give scheduler a moment to spin up</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">client</span> <span class="o">=</span> <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_connect_scheduler_with_retry</span><span class="p">(</span>
                <span class="n">AGI</span><span class="o">.</span><span class="n">_scheduler</span><span class="p">,</span>
                <span class="n">timeout</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="n">AGI</span><span class="o">.</span><span class="n">_TIMEOUT</span> <span class="o">*</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">15</span><span class="p">),</span>
                <span class="n">heartbeat_interval</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">AGI</span><span class="o">.</span><span class="n">_dask_client</span> <span class="o">=</span> <span class="n">client</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Dask Client instantiation trouble, run aborted due to:&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="ne">RuntimeError</span><span class="p">):</span>
                <span class="k">raise</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Failed to instantiate Dask Client&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>

        <span class="n">AGI</span><span class="o">.</span><span class="n">_install_done</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_worker_init_error</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Please run AGI.install([</span><span class="si">{</span><span class="n">AGI</span><span class="o">.</span><span class="n">_scheduler_ip</span><span class="si">}</span><span class="s2">])&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="kc">True</span>

    <span class="nd">@staticmethod</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_connect_scheduler_with_retry</span><span class="p">(</span>
        <span class="n">address</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">heartbeat_interval</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5000</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Client</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Attempt to connect to the scheduler until ``timeout`` elapses.&quot;&quot;&quot;</span>

        <span class="n">deadline</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span> <span class="o">+</span> <span class="nb">max</span><span class="p">(</span><span class="n">timeout</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">attempt</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">last_exc</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="ne">Exception</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">while</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">deadline</span><span class="p">:</span>
            <span class="n">attempt</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">remaining</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">deadline</span> <span class="o">-</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">(),</span> <span class="mf">0.5</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="k">await</span> <span class="n">Client</span><span class="p">(</span>
                    <span class="n">address</span><span class="p">,</span>
                    <span class="n">heartbeat_interval</span><span class="o">=</span><span class="n">heartbeat_interval</span><span class="p">,</span>
                    <span class="n">timeout</span><span class="o">=</span><span class="n">remaining</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="n">last_exc</span> <span class="o">=</span> <span class="n">exc</span>
                <span class="n">sleep_for</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">*</span> <span class="n">attempt</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="s2">&quot;Dask scheduler at </span><span class="si">%s</span><span class="s2"> not ready (attempt </span><span class="si">%s</span><span class="s2">, retrying in </span><span class="si">%.1f</span><span class="s2">s): </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">address</span><span class="p">,</span>
                    <span class="n">attempt</span><span class="p">,</span>
                    <span class="n">sleep_for</span><span class="p">,</span>
                    <span class="n">exc</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">sleep_for</span><span class="p">)</span>

        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Failed to instantiate Dask Client&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">last_exc</span>

    <span class="nd">@staticmethod</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_detect_export_cmd</span><span class="p">(</span><span class="n">ip</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">AgiEnv</span><span class="o">.</span><span class="n">is_local</span><span class="p">(</span><span class="n">ip</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">AgiEnv</span><span class="o">.</span><span class="n">export_local_bin</span>

        <span class="c1"># probe remote OS via SSH</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os_id</span> <span class="o">=</span> <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">exec_ssh</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="s2">&quot;uname -s&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">os_id</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">x</span> <span class="ow">in</span> <span class="n">os_id</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;Linux&#39;</span><span class="p">,</span> <span class="s1">&#39;Darwin&#39;</span><span class="p">,</span> <span class="s1">&#39;BSD&#39;</span><span class="p">)):</span>
            <span class="k">return</span> <span class="s1">&#39;export PATH=&quot;$HOME/.local/bin:$PATH&quot;;&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span>  <span class="c1"># &#39;set PATH=%USERPROFILE%\\.local\\bin;%PATH% &amp;&amp;&#39;</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_dask_env_prefix</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">level</span> <span class="o">=</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_dask_log_level</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">level</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span>
        <span class="n">env_vars</span> <span class="o">=</span> <span class="p">[</span>
            <span class="sa">f</span><span class="s2">&quot;DASK_DISTRIBUTED__LOGGING__distributed=</span><span class="si">{</span><span class="n">level</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">env_vars</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_start</span><span class="p">(</span><span class="n">scheduler</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;_start(</span>
<span class="sd">        Start Dask workers locally and remotely,</span>
<span class="sd">        launching remote workers detached in background,</span>
<span class="sd">        compatible with Windows and POSIX.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">env</span> <span class="o">=</span> <span class="n">AGI</span><span class="o">.</span><span class="n">env</span>
        <span class="n">dask_env</span> <span class="o">=</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_dask_env_prefix</span><span class="p">()</span>

        <span class="c1"># Start scheduler first</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_start_scheduler</span><span class="p">(</span><span class="n">scheduler</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">AGI</span><span class="o">.</span><span class="n">_workers</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="n">is_local</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">is_local</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span>
            <span class="n">cmd_prefix</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">envars</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s2">_CMD_PREFIX&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">cmd_prefix</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">cmd_prefix</span> <span class="o">=</span> <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_detect_export_cmd</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">cmd_prefix</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="k">if</span> <span class="n">cmd_prefix</span><span class="p">:</span>
                    <span class="n">AgiEnv</span><span class="o">.</span><span class="n">set_env_var</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s2">_CMD_PREFIX&quot;</span><span class="p">,</span> <span class="n">cmd_prefix</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting worker #</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s2"> on [</span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
                    <span class="n">pid_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;dask_worker_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s2">.pid&quot;</span>
                    <span class="k">if</span> <span class="n">is_local</span><span class="p">:</span>
                        <span class="n">wenv_abs</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">wenv_abs</span>
                        <span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">cmd_prefix</span><span class="si">}{</span><span class="n">dask_env</span><span class="si">}{</span><span class="n">env</span><span class="o">.</span><span class="n">uv</span><span class="si">}</span><span class="s1"> --project </span><span class="si">{</span><span class="n">wenv_abs</span><span class="si">}</span><span class="s1"> run --no-sync &#39;</span>
                            <span class="sa">f</span><span class="s1">&#39;dask worker &#39;</span>
                            <span class="sa">f</span><span class="s1">&#39;tcp://</span><span class="si">{</span><span class="n">AGI</span><span class="o">.</span><span class="n">_scheduler</span><span class="si">}</span><span class="s1"> --no-nanny &#39;</span>
                            <span class="sa">f</span><span class="s1">&#39;--pid-file </span><span class="si">{</span><span class="n">wenv_abs</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">pid_file</span><span class="si">}</span><span class="s1">&#39;</span>
                        <span class="p">)</span>
                        <span class="c1"># Run locally in background (non-blocking)</span>
                        <span class="n">AGI</span><span class="o">.</span><span class="n">_exec_bg</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">wenv_abs</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">wenv_rel</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">wenv_rel</span>
                        <span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">cmd_prefix</span><span class="si">}{</span><span class="n">dask_env</span><span class="si">}{</span><span class="n">env</span><span class="o">.</span><span class="n">uv</span><span class="si">}</span><span class="s1"> --project </span><span class="si">{</span><span class="n">wenv_rel</span><span class="si">}</span><span class="s1"> run --no-sync &#39;</span>
                            <span class="sa">f</span><span class="s1">&#39;dask worker &#39;</span>
                            <span class="sa">f</span><span class="s1">&#39;tcp://</span><span class="si">{</span><span class="n">AGI</span><span class="o">.</span><span class="n">_scheduler</span><span class="si">}</span><span class="s1"> --no-nanny --pid-file </span><span class="si">{</span><span class="n">wenv_rel</span><span class="o">.</span><span class="n">parent</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">pid_file</span><span class="si">}</span><span class="s1">&#39;</span>
                        <span class="p">)</span>
                        <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">AGI</span><span class="o">.</span><span class="n">exec_ssh_async</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">cmd</span><span class="p">))</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Launched remote worker in background on </span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">cmd</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to start worker on </span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">raise</span>

                <span class="k">if</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_worker_init_error</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Please run AGI.install([</span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s2">])&quot;</span><span class="p">)</span>

        <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_sync</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="n">AGI</span><span class="o">.</span><span class="n">_TIMEOUT</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_mode_auto</span> <span class="ow">or</span> <span class="p">(</span><span class="n">AGI</span><span class="o">.</span><span class="n">_mode_auto</span> <span class="ow">and</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_mode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_build_lib_remote</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_mode</span> <span class="o">&amp;</span> <span class="n">AGI</span><span class="o">.</span><span class="n">DASK_MODE</span><span class="p">:</span>
                <span class="c1"># load lib</span>
                <span class="k">for</span> <span class="n">egg_file</span> <span class="ow">in</span> <span class="p">(</span><span class="n">AGI</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">wenv_abs</span> <span class="o">/</span> <span class="s2">&quot;dist&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*.egg&quot;</span><span class="p">):</span>
                    <span class="n">AGI</span><span class="o">.</span><span class="n">_dask_client</span><span class="o">.</span><span class="n">upload_file</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">egg_file</span><span class="p">))</span>

    <span class="nd">@staticmethod</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_sync</span><span class="p">(</span><span class="n">timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">60</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">AGI</span><span class="o">.</span><span class="n">_dask_client</span><span class="p">,</span> <span class="n">Client</span><span class="p">):</span>
            <span class="k">return</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">expected_workers</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">AGI</span><span class="o">.</span><span class="n">_workers</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">info</span> <span class="o">=</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_dask_client</span><span class="o">.</span><span class="n">scheduler_info</span><span class="p">()</span>
                <span class="n">workers_info</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;workers&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">workers_info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Scheduler info &#39;workers&#39; not ready yet.&quot;</span><span class="p">)</span>
                    <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span> <span class="o">&gt;</span> <span class="n">timeout</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Timeout waiting for scheduler workers info.&quot;</span><span class="p">)</span>
                        <span class="k">raise</span> <span class="ne">TimeoutError</span><span class="p">(</span><span class="s2">&quot;Timed out waiting for scheduler workers info&quot;</span><span class="p">)</span>
                    <span class="k">continue</span>

                <span class="n">runners</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">workers_info</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                <span class="n">current_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">runners</span><span class="p">)</span>
                <span class="n">remaining</span> <span class="o">=</span> <span class="n">expected_workers</span> <span class="o">-</span> <span class="n">current_count</span>

                <span class="k">if</span> <span class="n">runners</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Current workers connected: </span><span class="si">{</span><span class="n">runners</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Waiting for number of workers to attach: </span><span class="si">{</span><span class="n">remaining</span><span class="si">}</span><span class="s2"> remaining...&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">current_count</span> <span class="o">&gt;=</span> <span class="n">expected_workers</span><span class="p">:</span>
                    <span class="k">break</span>

                <span class="k">if</span> <span class="n">remaining</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">break</span>

                <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span> <span class="o">&gt;</span> <span class="n">timeout</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Timeout waiting for all workers. </span><span class="si">{remaining}</span><span class="s2"> workers missing.&quot;</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">TimeoutError</span><span class="p">(</span><span class="s2">&quot;Timed out waiting for all workers to attach&quot;</span><span class="p">)</span>
                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Exception in _sync: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span> <span class="o">&gt;</span> <span class="n">timeout</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">TimeoutError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Timeout waiting for all workers due to exception: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;All workers successfully attached to scheduler&quot;</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_build_lib_local</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Returns:</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">env</span> <span class="o">=</span> <span class="n">AGI</span><span class="o">.</span><span class="n">env</span>
        <span class="n">wenv</span> <span class="o">=</span> <span class="n">normalize_path</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">wenv_abs</span><span class="p">))</span>
        <span class="n">is_cy</span> <span class="o">=</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_mode</span> <span class="o">&amp;</span> <span class="n">AGI</span><span class="o">.</span><span class="n">CYTHON_MODE</span>
        <span class="n">packages</span> <span class="o">=</span> <span class="s2">&quot;agi_dispatcher, &quot;</span>

        <span class="n">baseworker</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">base_worker_cls</span>
        <span class="k">if</span> <span class="n">baseworker</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;Agent&quot;</span><span class="p">):</span>
            <span class="n">packages</span> <span class="o">+=</span> <span class="s2">&quot;agent_worker&quot;</span>
        <span class="k">elif</span> <span class="n">baseworker</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;Dag&quot;</span><span class="p">):</span>
            <span class="n">packages</span> <span class="o">+=</span> <span class="s2">&quot;dag_worker&quot;</span>
        <span class="k">elif</span> <span class="n">baseworker</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;Pandas&quot;</span><span class="p">):</span>
            <span class="n">packages</span> <span class="o">+=</span> <span class="s2">&quot;pandas_worker&quot;</span>
        <span class="k">elif</span> <span class="n">baseworker</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;Polars&quot;</span><span class="p">):</span>
            <span class="n">packages</span> <span class="o">+=</span> <span class="s2">&quot;polars_worker&quot;</span>
        <span class="k">elif</span> <span class="n">baseworker</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;Fireducks&quot;</span><span class="p">):</span>
            <span class="n">packages</span> <span class="o">+=</span> <span class="s2">&quot;fireducks_worker&quot;</span>

        <span class="n">app_path</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">active_app</span>
        <span class="n">wenv_abs</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">wenv_abs</span>
        <span class="n">module</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">setup_app_module</span>

        <span class="c1"># build egg and unzip it into wenv</span>
        <span class="n">uv</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">uv</span>
        <span class="n">cmd_prefix</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">envars</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;127.0.0.1_CMD_PREFIX&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">env</span><span class="o">.</span><span class="n">is_free_threading_available</span><span class="p">:</span>
            <span class="n">uv</span> <span class="o">=</span> <span class="n">cmd_prefix</span> <span class="o">+</span> <span class="s2">&quot; PYTHON_GIL=0 &quot;</span> <span class="o">+</span> <span class="n">env</span><span class="o">.</span><span class="n">uv</span>
        <span class="n">module_cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;python -m </span><span class="si">{</span><span class="n">module</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">app_path_arg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="si">{</span><span class="n">app_path</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="c1"># shlex.quote(str(app_path))</span>
        <span class="n">wenv_arg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="si">{</span><span class="n">wenv_abs</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="c1"># shlex.quote(str(wenv_abs))</span>

        <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">worker_pyproject</span><span class="p">,</span> <span class="n">env</span><span class="o">.</span><span class="n">wenv_abs</span><span class="p">)</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">uvproject</span><span class="p">,</span> <span class="n">env</span><span class="o">.</span><span class="n">wenv_abs</span><span class="p">)</span>

        <span class="c1"># install agi-env and agi-node</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">env</span><span class="o">.</span><span class="n">uv</span><span class="si">}</span><span class="s2"> --project </span><span class="si">{</span><span class="n">app_path_arg</span><span class="si">}</span><span class="s2"> pip install agi-env &quot;</span>
        <span class="k">await</span> <span class="n">AgiEnv</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">app_path</span><span class="p">)</span>

        <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">env</span><span class="o">.</span><span class="n">uv</span><span class="si">}</span><span class="s2"> --project </span><span class="si">{</span><span class="n">app_path_arg</span><span class="si">}</span><span class="s2"> pip install agi-node &quot;</span>
        <span class="k">await</span> <span class="n">AgiEnv</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">app_path</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">env</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">env</span><span class="o">.</span><span class="n">uv</span><span class="si">}</span><span class="s2"> --project </span><span class="si">{</span><span class="n">app_path_arg</span><span class="si">}</span><span class="s2"> run --no-sync &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">module_cmd</span><span class="si">}</span><span class="s2"> --app-path </span><span class="si">{</span><span class="n">app_path_arg</span><span class="si">}</span><span class="s2"> bdist_egg --packages </span><span class="se">\&quot;</span><span class="si">{</span><span class="n">packages</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2"> -d </span><span class="si">{</span><span class="n">wenv_arg</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">env</span><span class="o">.</span><span class="n">uv</span><span class="si">}</span><span class="s2"> --project </span><span class="si">{</span><span class="n">app_path_arg</span><span class="si">}</span><span class="s2"> run --no-sync &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">module_cmd</span><span class="si">}</span><span class="s2"> --app-path </span><span class="si">{</span><span class="n">app_path_arg</span><span class="si">}</span><span class="s2"> -q bdist_egg --packages </span><span class="se">\&quot;</span><span class="si">{</span><span class="n">packages</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2"> -d </span><span class="si">{</span><span class="n">wenv_arg</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="k">await</span> <span class="n">AgiEnv</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">app_path</span><span class="p">)</span>

        <span class="n">dask_client</span> <span class="o">=</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_dask_client</span>
        <span class="k">if</span> <span class="n">dask_client</span><span class="p">:</span>
            <span class="n">egg_files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">((</span><span class="n">wenv_abs</span> <span class="o">/</span> <span class="s2">&quot;dist&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*.egg&quot;</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">egg_file</span> <span class="ow">in</span> <span class="n">egg_files</span><span class="p">:</span>
                <span class="n">dask_client</span><span class="o">.</span><span class="n">upload_file</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">egg_file</span><span class="p">))</span>

        <span class="c1"># compile in cython when cython is requested</span>
        <span class="k">if</span> <span class="n">is_cy</span><span class="p">:</span>
            <span class="c1"># cython compilation of wenv/src into wenv</span>
            <span class="k">if</span> <span class="n">env</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">env</span><span class="o">.</span><span class="n">uv</span><span class="si">}</span><span class="s2"> --project </span><span class="si">{</span><span class="n">app_path_arg</span><span class="si">}</span><span class="s2"> run --no-sync &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">module_cmd</span><span class="si">}</span><span class="s2"> --app-path </span><span class="si">{</span><span class="n">wenv_arg</span><span class="si">}</span><span class="s2"> build_ext -b </span><span class="si">{</span><span class="n">wenv_arg</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">env</span><span class="o">.</span><span class="n">uv</span><span class="si">}</span><span class="s2"> --project </span><span class="si">{</span><span class="n">app_path_arg</span><span class="si">}</span><span class="s2"> run --no-sync &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">module_cmd</span><span class="si">}</span><span class="s2"> --app-path </span><span class="si">{</span><span class="n">wenv_arg</span><span class="si">}</span><span class="s2"> -q build_ext -b </span><span class="si">{</span><span class="n">wenv_arg</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

            <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">AgiEnv</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">app_path</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">worker_lib</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">((</span><span class="n">wenv_abs</span> <span class="o">/</span> <span class="s1">&#39;dist&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*_cy.*&quot;</span><span class="p">)),</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>

            <span class="c1"># platlib = sysconfig.get_path(&quot;platlib&quot;)</span>
            <span class="c1"># platlib_idx = platlib.index(&#39;.venv&#39;)</span>
            <span class="c1"># wenv_platlib = platlib[platlib_idx:]</span>
            <span class="c1"># target_platlib = wenv_abs / wenv_platlib</span>
            <span class="c1"># destination = os.path.join(target_platlib, os.path.basename(worker_lib))</span>

            <span class="n">python_dirs</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">pyvers_worker</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">python_dirs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;t&quot;</span><span class="p">:</span>
                <span class="n">python_version</span> <span class="o">=</span> <span class="n">python_dirs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">python_dirs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;t&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">python_version</span> <span class="o">=</span> <span class="n">python_dirs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">python_dirs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">destination_dir</span> <span class="o">=</span> <span class="n">wenv_abs</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;.venv/lib/python</span><span class="si">{</span><span class="n">python_version</span><span class="si">}</span><span class="s2">/site-packages&quot;</span>

            <span class="c1"># Copy the file while preserving metadata into the site-packages directory.</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">destination_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="n">worker_lib</span><span class="p">,</span> <span class="n">destination_dir</span> <span class="o">/</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">worker_lib</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">res</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>

        <span class="k">return</span>

    <span class="nd">@staticmethod</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_build_lib_remote</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        workers init</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># worker</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">AGI</span><span class="o">.</span><span class="n">_dask_client</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">open</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="n">AGI</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">runners</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">AGI</span><span class="o">.</span><span class="n">_dask_client</span><span class="o">.</span><span class="n">scheduler_info</span><span class="p">()[</span><span class="s2">&quot;workers&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;warning: no scheduler found but requested mode is dask=1 =&gt; switch to dask&quot;</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_run</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Returns:</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">env</span> <span class="o">=</span> <span class="n">AGI</span><span class="o">.</span><span class="n">env</span>
        <span class="n">env</span><span class="o">.</span><span class="n">hw_rapids_capable</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">envars</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;127.0.0.1&quot;</span><span class="p">,</span> <span class="s2">&quot;hw_rapids_capable&quot;</span><span class="p">)</span>

        <span class="c1"># check first that install is done</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">wenv_abs</span> <span class="o">/</span> <span class="s2">&quot;.venv&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Worker installation not found&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s2">&quot;Worker installation (.venv) not found&quot;</span><span class="p">)</span>

        <span class="n">pid_file</span> <span class="o">=</span> <span class="s2">&quot;dask_worker_0.pid&quot;</span>
        <span class="n">current_pid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">pid_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">current_pid</span><span class="p">))</span>

        <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_kill</span><span class="p">(</span><span class="n">current_pid</span><span class="o">=</span><span class="n">current_pid</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_mode</span> <span class="o">&amp;</span> <span class="n">AGI</span><span class="o">.</span><span class="n">CYTHON_MODE</span><span class="p">:</span>
            <span class="n">wenv_abs</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">wenv_abs</span>
            <span class="n">cython_lib_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">wenv_abs</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;debug=</span><span class="si">{</span><span class="n">env</span><span class="o">.</span><span class="n">debug</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">env</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
            <span class="n">BaseWorker</span><span class="o">.</span><span class="n">_new</span><span class="p">(</span><span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">AGI</span><span class="o">.</span><span class="n">_mode</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">env</span><span class="o">.</span><span class="n">verbose</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">AGI</span><span class="o">.</span><span class="n">_args</span><span class="p">)</span>
            <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">BaseWorker</span><span class="o">.</span><span class="n">_run</span><span class="p">(</span><span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">AGI</span><span class="o">.</span><span class="n">_mode</span><span class="p">,</span> <span class="n">workers</span><span class="o">=</span><span class="n">AGI</span><span class="o">.</span><span class="n">_workers</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">env</span><span class="o">.</span><span class="n">verbose</span><span class="p">,</span>
                                       <span class="n">args</span><span class="o">=</span><span class="n">AGI</span><span class="o">.</span><span class="n">_args</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">env</span><span class="o">.</span><span class="n">uv</span><span class="si">}</span><span class="s2"> run --preview-features python-upgrade --no-sync --project </span><span class="si">{</span><span class="n">env</span><span class="o">.</span><span class="n">wenv_abs</span><span class="si">}</span><span class="s2"> python -c </span><span class="se">\&quot;</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;from agi_node.agi_dispatcher import  BaseWorker</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;import asyncio</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;async def main():</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;  BaseWorker._new(app=&#39;</span><span class="si">{</span><span class="n">env</span><span class="o">.</span><span class="n">target_worker</span><span class="si">}</span><span class="s2">&#39;, mode=</span><span class="si">{</span><span class="n">AGI</span><span class="o">.</span><span class="n">_mode</span><span class="si">}</span><span class="s2">, verbose=</span><span class="si">{</span><span class="n">env</span><span class="o">.</span><span class="n">verbose</span><span class="si">}</span><span class="s2">, args=</span><span class="si">{</span><span class="n">AGI</span><span class="o">.</span><span class="n">_args</span><span class="si">}</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;  res = await BaseWorker._run(mode=</span><span class="si">{</span><span class="n">AGI</span><span class="o">.</span><span class="n">_mode</span><span class="si">}</span><span class="s2">, workers=</span><span class="si">{</span><span class="n">AGI</span><span class="o">.</span><span class="n">_workers</span><span class="si">}</span><span class="s2">, args=</span><span class="si">{</span><span class="n">AGI</span><span class="o">.</span><span class="n">_args</span><span class="si">}</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;  print(res)</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;if __name__ == &#39;__main__&#39;:</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;  asyncio.run(main())</span><span class="se">\&quot;</span><span class="s2">&quot;</span>
            <span class="p">)</span>

            <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">AgiEnv</span><span class="o">.</span><span class="n">run_async</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">env</span><span class="o">.</span><span class="n">wenv_abs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">res</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">res</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">res_lines</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">res_lines</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">res</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">res</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>

    <span class="nd">@staticmethod</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_distribute</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        workers run calibration and targets job</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">env</span> <span class="o">=</span> <span class="n">AGI</span><span class="o">.</span><span class="n">env</span>

        <span class="c1"># AGI distribute work on cluster</span>
        <span class="n">AGI</span><span class="o">.</span><span class="n">_dask_workers</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">worker</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">worker</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">AGI</span><span class="o">.</span><span class="n">_dask_client</span><span class="o">.</span><span class="n">scheduler_info</span><span class="p">()[</span><span class="s2">&quot;workers&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="p">]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AGI run mode=</span><span class="si">{</span><span class="n">AGI</span><span class="o">.</span><span class="n">_mode</span><span class="si">}</span><span class="s2"> on </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">AGI</span><span class="o">.</span><span class="n">_dask_workers</span><span class="p">)</span><span class="si">}</span><span class="s2"> ... &quot;</span><span class="p">)</span>

        <span class="n">AGI</span><span class="o">.</span><span class="n">_workers</span><span class="p">,</span> <span class="n">workers_plan</span><span class="p">,</span> <span class="n">workers_plan_metadata</span> <span class="o">=</span> <span class="k">await</span> <span class="n">WorkDispatcher</span><span class="o">.</span><span class="n">_do_distrib</span><span class="p">(</span>
            <span class="n">env</span><span class="p">,</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_workers</span><span class="p">,</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_args</span>
        <span class="p">)</span>
        <span class="n">AGI</span><span class="o">.</span><span class="n">_work_plan</span> <span class="o">=</span> <span class="n">workers_plan</span>
        <span class="n">AGI</span><span class="o">.</span><span class="n">_work_plan_metadata</span> <span class="o">=</span> <span class="n">workers_plan_metadata</span>

        <span class="n">AGI</span><span class="o">.</span><span class="n">_scale_cluster</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_mode</span> <span class="o">==</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_INSTALL_MODE</span><span class="p">:</span>
            <span class="n">workers_plan</span>

        <span class="n">dask_workers</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">AGI</span><span class="o">.</span><span class="n">_dask_workers</span><span class="p">)</span>
        <span class="n">client</span> <span class="o">=</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_dask_client</span>

        <span class="n">AGI</span><span class="o">.</span><span class="n">_dask_client</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">client</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span>
                    <span class="n">BaseWorker</span><span class="o">.</span><span class="n">_new</span><span class="p">,</span>
                    <span class="n">env</span><span class="o">=</span><span class="mi">0</span> <span class="k">if</span> <span class="n">env</span><span class="o">.</span><span class="n">debug</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="n">app</span><span class="o">=</span><span class="n">env</span><span class="o">.</span><span class="n">target_worker</span><span class="p">,</span>
                    <span class="n">mode</span><span class="o">=</span><span class="n">AGI</span><span class="o">.</span><span class="n">_mode</span><span class="p">,</span>
                    <span class="n">verbose</span><span class="o">=</span><span class="n">AGI</span><span class="o">.</span><span class="n">verbose</span><span class="p">,</span>
                    <span class="n">worker_id</span><span class="o">=</span><span class="n">dask_workers</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">worker</span><span class="p">),</span>
                    <span class="n">worker</span><span class="o">=</span><span class="n">worker</span><span class="p">,</span>
                    <span class="n">args</span><span class="o">=</span><span class="n">AGI</span><span class="o">.</span><span class="n">_args</span><span class="p">,</span>
                    <span class="n">workers</span><span class="o">=</span><span class="p">[</span><span class="n">worker</span><span class="p">],</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">worker</span> <span class="ow">in</span> <span class="n">dask_workers</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_calibration</span><span class="p">()</span>

        <span class="n">t</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_wrap_chunk</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">worker_index</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">payload</span>
            <span class="n">chunk</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="n">worker_index</span><span class="p">]</span> <span class="k">if</span> <span class="n">worker_index</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span> <span class="k">else</span> <span class="p">[]</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;__agi_worker_chunk__&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s2">&quot;chunk&quot;</span><span class="p">:</span> <span class="n">chunk</span><span class="p">,</span>
                <span class="s2">&quot;total_workers&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">),</span>
                <span class="s2">&quot;worker_idx&quot;</span><span class="p">:</span> <span class="n">worker_index</span><span class="p">,</span>
            <span class="p">}</span>

        <span class="n">futures</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">worker_idx</span><span class="p">,</span> <span class="n">worker_addr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dask_workers</span><span class="p">):</span>
            <span class="n">plan_payload</span> <span class="o">=</span> <span class="n">_wrap_chunk</span><span class="p">(</span><span class="n">workers_plan</span> <span class="ow">or</span> <span class="p">[],</span> <span class="n">worker_idx</span><span class="p">)</span>
            <span class="n">metadata_payload</span> <span class="o">=</span> <span class="n">_wrap_chunk</span><span class="p">(</span><span class="n">workers_plan_metadata</span> <span class="ow">or</span> <span class="p">[],</span> <span class="n">worker_idx</span><span class="p">)</span>
            <span class="n">futures</span><span class="p">[</span><span class="n">worker_addr</span><span class="p">]</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span>
                <span class="n">BaseWorker</span><span class="o">.</span><span class="n">_do_works</span><span class="p">,</span>
                <span class="n">plan_payload</span><span class="p">,</span>
                <span class="n">metadata_payload</span><span class="p">,</span>
                <span class="n">workers</span><span class="o">=</span><span class="p">[</span><span class="n">worker_addr</span><span class="p">],</span>
            <span class="p">)</span>

        <span class="n">gathered_logs</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">futures</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span> <span class="k">if</span> <span class="n">futures</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="n">worker_logs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">worker_addr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">futures</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">log_value</span> <span class="o">=</span> <span class="n">gathered_logs</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="k">if</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">gathered_logs</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
            <span class="n">worker_logs</span><span class="p">[</span><span class="n">worker_addr</span><span class="p">]</span> <span class="o">=</span> <span class="n">log_value</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="n">AGI</span><span class="o">.</span><span class="n">debug</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">worker_logs</span><span class="p">:</span>
            <span class="n">worker_logs</span> <span class="o">=</span> <span class="p">{</span><span class="n">worker</span><span class="p">:</span> <span class="s2">&quot;&quot;</span> <span class="k">for</span> <span class="n">worker</span> <span class="ow">in</span> <span class="n">dask_workers</span><span class="p">}</span>

        <span class="c1"># LOG ONLY, no print:</span>
        <span class="k">for</span> <span class="n">worker</span><span class="p">,</span> <span class="n">log</span> <span class="ow">in</span> <span class="n">worker_logs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">=== Worker </span><span class="si">{</span><span class="n">worker</span><span class="si">}</span><span class="s2"> logs ===</span><span class="se">\n</span><span class="si">{</span><span class="n">log</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">runtime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">env</span><span class="o">.</span><span class="n">mode2str</span><span class="p">(</span><span class="n">AGI</span><span class="o">.</span><span class="n">_mode</span><span class="p">)</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">runtime</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">env</span><span class="o">.</span><span class="n">mode2str</span><span class="p">(</span><span class="n">AGI</span><span class="o">.</span><span class="n">_mode</span><span class="p">)</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">runtime</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="nd">@staticmethod</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_main</span><span class="p">(</span><span class="n">scheduler</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="n">cond_clean</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">AGI</span><span class="o">.</span><span class="n">_jobs</span> <span class="o">=</span> <span class="n">bg</span><span class="o">.</span><span class="n">BackgroundJobManager</span><span class="p">()</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">AGI</span><span class="o">.</span><span class="n">_mode</span> <span class="o">&amp;</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_DEPLOYEMENT_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_SIMULATE_MODE</span><span class="p">:</span>
            <span class="c1"># case simulate mode #0b11xxxx</span>
            <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_run</span><span class="p">()</span>

        <span class="k">elif</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_mode</span> <span class="o">&gt;=</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_INSTALL_MODE</span><span class="p">:</span>
            <span class="c1"># case install modes</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

            <span class="n">AGI</span><span class="o">.</span><span class="n">_clean_dirs_local</span><span class="p">()</span>
            <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_prepare_local_env</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_mode</span> <span class="o">&amp;</span> <span class="n">AGI</span><span class="o">.</span><span class="n">DASK_MODE</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_prepare_cluster_env</span><span class="p">(</span><span class="n">scheduler</span><span class="p">)</span>

            <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_deploy_application</span><span class="p">(</span><span class="n">scheduler</span><span class="p">)</span>

            <span class="n">res</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t</span>

        <span class="k">elif</span> <span class="p">(</span><span class="n">AGI</span><span class="o">.</span><span class="n">_mode</span> <span class="o">&amp;</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_DEPLOYEMENT_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_SIMULATE_MODE</span><span class="p">:</span>
            <span class="c1"># case simulate mode #0b11xxxx</span>
            <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_run</span><span class="p">()</span>

        <span class="k">elif</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_mode</span> <span class="o">&amp;</span> <span class="n">AGI</span><span class="o">.</span><span class="n">DASK_MODE</span><span class="p">:</span>

            <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_start</span><span class="p">(</span><span class="n">scheduler</span><span class="p">)</span>

            <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_distribute</span><span class="p">()</span>
            <span class="n">AGI</span><span class="o">.</span><span class="n">_update_capacity</span><span class="p">()</span>

            <span class="c1"># stop the cluster</span>
            <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_stop</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># case local run</span>
            <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_run</span><span class="p">()</span>

        <span class="n">AGI</span><span class="o">.</span><span class="n">_clean_job</span><span class="p">(</span><span class="n">cond_clean</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">res</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_clean_job</span><span class="p">(</span><span class="n">cond_clean</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Args:</span>
<span class="sd">          cond_clean:</span>

<span class="sd">        Returns:</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># clean background job</span>
        <span class="k">if</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_jobs</span> <span class="ow">and</span> <span class="n">cond_clean</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">AGI</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="n">AGI</span><span class="o">.</span><span class="n">_jobs</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">devnull</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">,</span> <span class="n">redirect_stdout</span><span class="p">(</span><span class="n">f</span><span class="p">),</span> <span class="n">redirect_stderr</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
                    <span class="n">AGI</span><span class="o">.</span><span class="n">_jobs</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_scale_cluster</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Remove unnecessary workers&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_dask_workers</span><span class="p">:</span>
            <span class="n">nb_kept_workers</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">workers_to_remove</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">dask_worker</span> <span class="ow">in</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_dask_workers</span><span class="p">:</span>
                <span class="n">ip</span> <span class="o">=</span> <span class="n">dask_worker</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">ip</span> <span class="ow">in</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_workers</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">ip</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">nb_kept_workers</span><span class="p">:</span>
                        <span class="n">nb_kept_workers</span><span class="p">[</span><span class="n">ip</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">if</span> <span class="n">nb_kept_workers</span><span class="p">[</span><span class="n">ip</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_workers</span><span class="p">[</span><span class="n">ip</span><span class="p">]:</span>
                        <span class="n">workers_to_remove</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dask_worker</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">nb_kept_workers</span><span class="p">[</span><span class="n">ip</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">workers_to_remove</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dask_worker</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">workers_to_remove</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;unused workers: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">workers_to_remove</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">worker</span> <span class="ow">in</span> <span class="n">workers_to_remove</span><span class="p">:</span>
                    <span class="n">AGI</span><span class="o">.</span><span class="n">_dask_workers</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">worker</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_stop</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Stop the Dask workers and scheduler&quot;&quot;&quot;</span>
        <span class="n">env</span> <span class="o">=</span> <span class="n">AGI</span><span class="o">.</span><span class="n">env</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;stop Agi core&quot;</span><span class="p">)</span>

        <span class="n">retire_attempts</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">retire_attempts</span> <span class="o">&lt;</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_TIMEOUT</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">scheduler_info</span> <span class="o">=</span> <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_dask_client</span><span class="o">.</span><span class="n">scheduler_info</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Unable to fetch scheduler info during shutdown: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc</span><span class="p">)</span>
                <span class="k">break</span>

            <span class="n">workers</span> <span class="o">=</span> <span class="n">scheduler_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;workers&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">workers</span><span class="p">:</span>
                <span class="k">break</span>

            <span class="n">retire_attempts</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_dask_client</span><span class="o">.</span><span class="n">retire_workers</span><span class="p">(</span>
                    <span class="n">workers</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">workers</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
                    <span class="n">close_workers</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">remove</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;retire_workers failed: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc</span><span class="p">)</span>
                <span class="k">break</span>

            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">AGI</span><span class="o">.</span><span class="n">_mode_auto</span> <span class="ow">and</span> <span class="p">(</span><span class="n">AGI</span><span class="o">.</span><span class="n">_mode</span> <span class="o">==</span> <span class="mi">7</span> <span class="ow">or</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_mode</span> <span class="o">==</span> <span class="mi">15</span><span class="p">)</span>
            <span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_mode_auto</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_dask_client</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Dask client shutdown raised: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc</span><span class="p">)</span>

        <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_close_all_connections</span><span class="p">()</span>

    <span class="nd">@staticmethod</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_calibration</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        balancer calibration</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">res_workers_info</span> <span class="o">=</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_dask_client</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">AGI</span><span class="o">.</span><span class="n">_dask_client</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
                    <span class="c1"># BaseWorker.get_logs_and_result,</span>
                    <span class="n">BaseWorker</span><span class="o">.</span><span class="n">_get_worker_info</span><span class="p">,</span>
                    <span class="n">BaseWorker</span><span class="o">.</span><span class="n">_worker_id</span><span class="p">,</span>
                    <span class="n">workers</span><span class="o">=</span><span class="n">AGI</span><span class="o">.</span><span class="n">_dask_workers</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="n">infos</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">res_workers_info</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">worker</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">info</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">worker</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">info</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">infos</span><span class="p">[</span><span class="n">worker</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span>

        <span class="n">AGI</span><span class="o">.</span><span class="n">workers_info</span> <span class="o">=</span> <span class="n">infos</span>
        <span class="n">AGI</span><span class="o">.</span><span class="n">_capacity</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">workers_info</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">worker</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">AGI</span><span class="o">.</span><span class="n">workers_info</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">ipport</span> <span class="o">=</span> <span class="n">worker</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">infos</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">AGI</span><span class="o">.</span><span class="n">workers_info</span><span class="p">[</span><span class="n">worker</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
            <span class="n">infos</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">[</span><span class="n">AGI</span><span class="o">.</span><span class="n">_workers</span><span class="p">[</span><span class="n">ipport</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]])</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">infos</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
            <span class="n">AGI</span><span class="o">.</span><span class="n">_capacity</span><span class="p">[</span><span class="n">ipport</span><span class="p">]</span> <span class="o">=</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_capacity_predictor</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">data</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">info</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_capacity</span><span class="p">[</span><span class="n">ipport</span><span class="p">]</span>
            <span class="n">workers_info</span><span class="p">[</span><span class="n">ipport</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span>

        <span class="n">AGI</span><span class="o">.</span><span class="n">workers_info</span> <span class="o">=</span> <span class="n">workers_info</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_capacity</span><span class="p">:</span>
            <span class="n">fallback_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">workers_info</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">fallback_keys</span><span class="p">:</span>
                <span class="n">fallback_keys</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">worker</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;://&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">worker</span> <span class="ow">in</span> <span class="p">(</span><span class="n">AGI</span><span class="o">.</span><span class="n">_dask_workers</span> <span class="ow">or</span> <span class="p">[])</span>
                <span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">fallback_keys</span> <span class="ow">and</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_workers</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">ip</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_workers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">count</span><span class="p">):</span>
                        <span class="n">fallback_keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">fallback_keys</span><span class="p">:</span>
                <span class="n">fallback_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;localhost:0&quot;</span><span class="p">]</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Capacity predictor returned no data; assuming uniform capacity for </span><span class="si">%s</span><span class="s2"> worker(s).&quot;</span><span class="p">,</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">fallback_keys</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">workers_info</span><span class="p">:</span>
                <span class="n">AGI</span><span class="o">.</span><span class="n">workers_info</span> <span class="o">=</span> <span class="p">{</span><span class="n">ipport</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">}</span> <span class="k">for</span> <span class="n">ipport</span> <span class="ow">in</span> <span class="n">fallback_keys</span><span class="p">}</span>
            <span class="n">AGI</span><span class="o">.</span><span class="n">_capacity</span> <span class="o">=</span> <span class="p">{</span><span class="n">ipport</span><span class="p">:</span> <span class="mf">1.0</span> <span class="k">for</span> <span class="n">ipport</span> <span class="ow">in</span> <span class="n">fallback_keys</span><span class="p">}</span>

        <span class="n">cap_min</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">AGI</span><span class="o">.</span><span class="n">_capacity</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="k">if</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_capacity</span> <span class="k">else</span> <span class="mf">1.0</span>
        <span class="n">workers_capacity</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">ipport</span><span class="p">,</span> <span class="n">pred_cap</span> <span class="ow">in</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_capacity</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">workers_capacity</span><span class="p">[</span><span class="n">ipport</span><span class="p">]</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">pred_cap</span> <span class="o">/</span> <span class="n">cap_min</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">AGI</span><span class="o">.</span><span class="n">_capacity</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="nb">sorted</span><span class="p">(</span><span class="n">workers_capacity</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_train_capacity</span><span class="p">(</span><span class="n">train_home</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;train the balancer model</span>

<span class="sd">        Args:</span>
<span class="sd">          train_home:</span>

<span class="sd">        Returns:</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data_file</span> <span class="o">=</span> <span class="n">train_home</span> <span class="o">/</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_capacity_data_file</span>
        <span class="k">if</span> <span class="n">data_file</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">balancer_csv</span> <span class="o">=</span> <span class="n">data_file</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="n">data_file</span><span class="p">)</span>

        <span class="n">schema</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;nb_workers&quot;</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Int64</span><span class="p">,</span>
            <span class="s2">&quot;ram_total&quot;</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Float64</span><span class="p">,</span>
            <span class="s2">&quot;ram_available&quot;</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Float64</span><span class="p">,</span>
            <span class="s2">&quot;cpu_count&quot;</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Float64</span><span class="p">,</span>  <span class="c1"># Assuming CPU count can be a float</span>
            <span class="s2">&quot;cpu_frequency&quot;</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Float64</span><span class="p">,</span>
            <span class="s2">&quot;network_speed&quot;</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Float64</span><span class="p">,</span>
            <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Float64</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># Read the CSV file with correct parameters</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
            <span class="n">balancer_csv</span><span class="p">,</span>
            <span class="n">has_header</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># Correctly identifies the header row</span>
            <span class="n">skip_rows_after_header</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>  <span class="c1"># Skips the next two rows after the header</span>
            <span class="n">schema_overrides</span><span class="o">=</span><span class="n">schema</span><span class="p">,</span>  <span class="c1"># Applies the defined schema</span>
            <span class="n">ignore_errors</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>  <span class="c1"># Set to True if you want to skip malformed rows</span>
        <span class="p">)</span>
        <span class="c1"># Get the list of column names</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span>

        <span class="c1"># Select all columns except the last one as features</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">columns</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

        <span class="c1"># Select the last column as the target variable</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">columns</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

        <span class="c1"># Split the data into training and testing sets</span>
        <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
            <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span>
        <span class="p">)</span>
        <span class="n">AGI</span><span class="o">.</span><span class="n">_capacity_predictor</span> <span class="o">=</span> <span class="n">RandomForestRegressor</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;AGI.balancer_train_mode - Accuracy of the prediction of the workers capacity = &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">AGI</span><span class="o">.</span><span class="n">_capacity_predictor</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span><span class="w"> </span><span class="n">y_test</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

        <span class="n">capacity_model</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">train_home</span><span class="p">,</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_capacity_model_file</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">capacity_model</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">AGI</span><span class="o">.</span><span class="n">_capacity_predictor</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_update_capacity</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;update the balancer model&quot;&quot;&quot;</span>
        <span class="n">workers_rt</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">balancer_cols</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;nb_workers&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ram_total&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ram_available&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cpu_count&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cpu_frequency&quot;</span><span class="p">,</span>
            <span class="s2">&quot;network_speed&quot;</span><span class="p">,</span>
            <span class="s2">&quot;label&quot;</span><span class="p">,</span>
        <span class="p">]</span>

        <span class="k">for</span> <span class="n">wrt</span> <span class="ow">in</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_run_time</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">wrt</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">return</span>

            <span class="n">worker</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">wrt</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">w</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">AGI</span><span class="o">.</span><span class="n">workers_info</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">w</span> <span class="o">==</span> <span class="n">worker</span><span class="p">:</span>
                    <span class="n">info</span><span class="p">[</span><span class="s2">&quot;run_time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">wrt</span><span class="p">[</span><span class="n">w</span><span class="p">]</span>
                    <span class="n">workers_rt</span><span class="p">[</span><span class="n">w</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span>

        <span class="n">current_state</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">workers_rt</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">worker</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">workers_rt</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">worker_cap</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span>  <span class="c1"># CapacitÃ© actuelle du mycode_wprker</span>
            <span class="n">worker_rt</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;run_time&quot;</span><span class="p">]</span>  <span class="c1"># Temps d&#39;exÃ©cution du mycode_worker</span>

            <span class="c1"># Calculer le delta de temps et mettre Ã  jour la capacitÃ© pour chaque autre mycode_worker</span>
            <span class="k">for</span> <span class="n">other_worker</span><span class="p">,</span> <span class="n">other_data</span> <span class="ow">in</span> <span class="n">current_state</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">other_worker</span> <span class="o">!=</span> <span class="n">worker</span><span class="p">:</span>
                    <span class="n">other_rt</span> <span class="o">=</span> <span class="n">other_data</span><span class="p">[</span>
                        <span class="s2">&quot;run_time&quot;</span>
                    <span class="p">]</span>  <span class="c1"># Temps d&#39;exÃ©cution de l&#39;autre mycode_worker</span>
                    <span class="n">delta</span> <span class="o">=</span> <span class="n">worker_rt</span> <span class="o">-</span> <span class="n">other_rt</span>
                    <span class="n">workers_rt</span><span class="p">[</span><span class="n">worker</span><span class="p">][</span><span class="s2">&quot;label&quot;</span><span class="p">]</span> <span class="o">-=</span> <span class="p">(</span>
                            <span class="mf">0.1</span> <span class="o">*</span> <span class="n">worker_cap</span> <span class="o">*</span> <span class="n">delta</span> <span class="o">/</span> <span class="n">worker_rt</span> <span class="o">/</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">current_state</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">workers_rt</span><span class="p">[</span><span class="n">worker</span><span class="p">][</span><span class="s2">&quot;nb_workers&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
                        <span class="n">AGI</span><span class="o">.</span><span class="n">_workers</span><span class="p">[</span><span class="n">worker</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span>
                    <span class="p">)</span>

        <span class="k">for</span> <span class="n">w</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">workers_rt</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">del</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;run_time&quot;</span><span class="p">]</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">balancer_cols</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">df</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="n">df</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;inf&quot;</span><span class="p">):</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">AGI</span><span class="o">.</span><span class="n">_capacity_data_file</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">df</span><span class="o">.</span><span class="n">write_csv</span><span class="p">(</span>
                        <span class="n">f</span><span class="p">,</span>
                        <span class="n">include_header</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">line_terminator</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">w</span><span class="si">}</span><span class="s2"> workers BaseWorker.do_works failed&quot;</span><span class="p">)</span>

        <span class="n">AGI</span><span class="o">.</span><span class="n">_train_capacity</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">AGI</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">home_abs</span><span class="p">))</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_exec_bg</span><span class="p">(</span><span class="n">cmd</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">cwd</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Execute background command</span>
<span class="sd">        Args:</span>
<span class="sd">            cmd: the command to be run</span>
<span class="sd">            cwd: the current working directory</span>

<span class="sd">        Returns:</span>
<span class="sd">            &quot;&quot;&quot;</span>
        <span class="n">AGI</span><span class="o">.</span><span class="n">_jobs</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;subprocess.Popen(cmd, shell=True)&quot;</span><span class="p">,</span> <span class="n">cwd</span><span class="o">=</span><span class="n">cwd</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_jobs</span><span class="o">.</span><span class="n">result</span><span class="p">(</span><span class="mi">0</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;running </span><span class="si">{</span><span class="n">cmd</span><span class="si">}</span><span class="s2"> at </span><span class="si">{</span><span class="n">cwd</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="AGI.get_ssh_connection">
<a class="viewcode-back" href="../../../module-agi-cluster.html#agi_cluster.agi_distributor.agi_distributor.AGI.get_ssh_connection">[docs]</a>
    <span class="nd">@asynccontextmanager</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_ssh_connection</span><span class="p">(</span><span class="n">ip</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">timeout_sec</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">):</span>

        <span class="n">env</span> <span class="o">=</span> <span class="n">AGI</span><span class="o">.</span><span class="n">env</span>
        <span class="k">if</span> <span class="n">AgiEnv</span><span class="o">.</span><span class="n">is_local</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">env</span><span class="o">.</span><span class="n">user</span><span class="p">:</span>
            <span class="n">env</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">getpass</span><span class="o">.</span><span class="n">getuser</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">env</span><span class="o">.</span><span class="n">user</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;SSH username is not configured. Please set &#39;user&#39; in your .env file.&quot;</span><span class="p">)</span>

        <span class="n">conn</span> <span class="o">=</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_ssh_connections</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">conn</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">conn</span><span class="o">.</span><span class="n">is_closed</span><span class="p">():</span>
            <span class="k">yield</span> <span class="n">conn</span>
            <span class="k">return</span>

        <span class="n">agent_path</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">client_keys</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">ssh_key_override</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">ssh_key_path</span>
            <span class="k">if</span> <span class="n">ssh_key_override</span><span class="p">:</span>
                <span class="n">client_keys</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">ssh_key_override</span><span class="p">)</span><span class="o">.</span><span class="n">expanduser</span><span class="p">())]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># If a password is provided, disable key/agent auth unless explicitly overridden</span>
                <span class="k">if</span> <span class="n">env</span><span class="o">.</span><span class="n">password</span><span class="p">:</span>
                    <span class="n">client_keys</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">agent_path</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ssh_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;~/.ssh&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span>
                    <span class="n">keys</span> <span class="o">=</span> <span class="p">[]</span>

                    <span class="k">if</span> <span class="n">ssh_dir</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">ssh_dir</span><span class="o">.</span><span class="n">iterdir</span><span class="p">():</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">file</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
                                <span class="k">continue</span>

                            <span class="n">name</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">name</span>
                            <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;authorized_keys&#39;</span><span class="p">):</span>
                                <span class="k">continue</span>
                            <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;known_hosts&#39;</span><span class="p">):</span>
                                <span class="k">continue</span>
                            <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.pub&#39;</span><span class="p">):</span>
                                <span class="k">continue</span>

                            <span class="n">keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">file</span><span class="p">))</span>

                    <span class="n">client_keys</span> <span class="o">=</span> <span class="n">keys</span> <span class="k">if</span> <span class="n">keys</span> <span class="k">else</span> <span class="kc">None</span>

            <span class="n">conn</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">wait_for</span><span class="p">(</span>
                <span class="n">asyncssh</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
                    <span class="n">ip</span><span class="p">,</span>
                    <span class="n">username</span><span class="o">=</span><span class="n">env</span><span class="o">.</span><span class="n">user</span><span class="p">,</span>
                    <span class="n">password</span><span class="o">=</span><span class="n">env</span><span class="o">.</span><span class="n">password</span><span class="p">,</span>
                    <span class="n">known_hosts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">client_keys</span><span class="o">=</span><span class="n">client_keys</span><span class="p">,</span>
                    <span class="n">agent_path</span><span class="o">=</span><span class="n">agent_path</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">timeout</span><span class="o">=</span><span class="n">timeout_sec</span>
            <span class="p">)</span>

            <span class="n">AGI</span><span class="o">.</span><span class="n">_ssh_connections</span><span class="p">[</span><span class="n">ip</span><span class="p">]</span> <span class="o">=</span> <span class="n">conn</span>
            <span class="k">yield</span> <span class="n">conn</span>

        <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">TimeoutError</span><span class="p">:</span>
            <span class="n">err_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Connection to </span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s2"> timed out after </span><span class="si">{</span><span class="n">timeout_sec</span><span class="si">}</span><span class="s2"> seconds.&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ConnectionError</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="kc">None</span>

        <span class="k">except</span> <span class="n">asyncssh</span><span class="o">.</span><span class="n">PermissionDenied</span><span class="p">:</span>
            <span class="n">err_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Authentication failed for SSH user &#39;</span><span class="si">{</span><span class="n">env</span><span class="o">.</span><span class="n">user</span><span class="si">}</span><span class="s2">&#39; on host </span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ConnectionError</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="kc">None</span>

        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">original</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">or</span> <span class="nb">repr</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span> <span class="ow">in</span> <span class="p">{</span>
                <span class="n">errno</span><span class="o">.</span><span class="n">EHOSTUNREACH</span><span class="p">,</span>
                <span class="n">errno</span><span class="o">.</span><span class="n">ENETUNREACH</span><span class="p">,</span>
                <span class="nb">getattr</span><span class="p">(</span><span class="n">errno</span><span class="p">,</span> <span class="s2">&quot;EHOSTDOWN&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                <span class="nb">getattr</span><span class="p">(</span><span class="n">errno</span><span class="p">,</span> <span class="s2">&quot;ENETDOWN&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                <span class="nb">getattr</span><span class="p">(</span><span class="n">errno</span><span class="p">,</span> <span class="s2">&quot;ETIMEDOUT&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="p">}:</span>
                <span class="n">err_msg</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Unable to connect to </span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s2"> on SSH port 22. &quot;</span>
                    <span class="s2">&quot;Please check that the device is powered on, network cable connected, and SSH service running.&quot;</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">original</span><span class="p">:</span>
                    <span class="n">err_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">err_msg</span><span class="si">}</span><span class="s2"> (details: </span><span class="si">{</span><span class="n">original</span><span class="si">}</span><span class="s2">)&quot;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">err_msg</span> <span class="o">=</span> <span class="n">original</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ConnectionError</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="kc">None</span>

        <span class="k">except</span> <span class="n">asyncssh</span><span class="o">.</span><span class="n">Error</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">base_msg</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">or</span> <span class="nb">repr</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="s2">&quot;command&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cmd</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">base_msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ConnectionError</span><span class="p">(</span><span class="n">base_msg</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="kc">None</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">err_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Unexpected error while connecting to </span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ConnectionError</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="kc">None</span></div>


<div class="viewcode-block" id="AGI.exec_ssh">
<a class="viewcode-back" href="../../../module-agi-cluster.html#agi_cluster.agi_distributor.agi_distributor.AGI.exec_ssh">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">exec_ssh</span><span class="p">(</span><span class="n">ip</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">cmd</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">async</span> <span class="k">with</span> <span class="n">AGI</span><span class="o">.</span><span class="n">get_ssh_connection</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s2">] </span><span class="si">{</span><span class="n">cmd</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">if</span> <span class="n">AgiEnv</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">AgiEnv</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">conn</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">stdout</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">stdout</span>
                <span class="n">stderr</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">stderr</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
                    <span class="n">stdout</span> <span class="o">=</span> <span class="n">stdout</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;replace&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
                    <span class="n">stderr</span> <span class="o">=</span> <span class="n">stderr</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;replace&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">stderr</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s2">] </span><span class="si">{</span><span class="n">stderr</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">AgiEnv</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">AgiEnv</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">stdout</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s2">] </span><span class="si">{</span><span class="n">stdout</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">stdout</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="p">(</span><span class="n">stderr</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="k">except</span> <span class="ne">ConnectionError</span><span class="p">:</span>
            <span class="k">raise</span>

        <span class="k">except</span> <span class="n">ProcessError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">stdout</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="s1">&#39;stdout&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">stderr</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="s1">&#39;stderr&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
                <span class="n">stdout</span> <span class="o">=</span> <span class="n">stdout</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;replace&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
                <span class="n">stderr</span> <span class="o">=</span> <span class="n">stderr</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;replace&#39;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Remote command stderr: </span><span class="si">{</span><span class="n">stderr</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span>

        <span class="k">except</span> <span class="p">(</span><span class="n">asyncssh</span><span class="o">.</span><span class="n">Error</span><span class="p">,</span> <span class="ne">OSError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">or</span> <span class="nb">repr</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">friendly</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Connection to </span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s2"> failed: </span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">friendly</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ConnectionError</span><span class="p">(</span><span class="n">friendly</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="kc">None</span></div>


<div class="viewcode-block" id="AGI.exec_ssh_async">
<a class="viewcode-back" href="../../../module-agi-cluster.html#agi_cluster.agi_distributor.agi_distributor.AGI.exec_ssh_async">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">exec_ssh_async</span><span class="p">(</span><span class="n">ip</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">cmd</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Execute a remote command via SSH and return the last line of its stdout output.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">AGI</span><span class="o">.</span><span class="n">get_ssh_connection</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
            <span class="n">process</span> <span class="o">=</span> <span class="k">await</span> <span class="n">conn</span><span class="o">.</span><span class="n">create_process</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>

            <span class="c1"># Read entire stdout output as bytes</span>
            <span class="n">stdout</span> <span class="o">=</span> <span class="k">await</span> <span class="n">process</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="k">await</span> <span class="n">process</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>

            <span class="c1"># Decode output safely</span>
            <span class="c1"># stdout_str = stdout.decode(&#39;utf-8&#39;, errors=&#39;replace&#39;)</span>

            <span class="c1"># Split output into lines and get the last non-empty line</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">stdout</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span> <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
            <span class="k">if</span> <span class="n">lines</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">lines</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="s2">&quot;&quot;</span>  <span class="c1"># or None if no output</span></div>


    <span class="nd">@staticmethod</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_close_all_connections</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Ferme proprement toutes les connexions SSH ouvertes.</span>
<span class="sd">        Ã€ appeler Ã  la fin de ton programme ou avant arrÃªt.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">conn</span> <span class="ow">in</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_ssh_connections</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">await</span> <span class="n">conn</span><span class="o">.</span><span class="n">wait_closed</span><span class="p">()</span>
        <span class="n">AGI</span><span class="o">.</span><span class="n">_ssh_connections</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span></div>



<span class="k">def</span><span class="w"> </span><span class="nf">_format_exception_chain</span><span class="p">(</span><span class="n">exc</span><span class="p">:</span> <span class="ne">BaseException</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return a compact representation of the exception chain, capturing root causes.&quot;&quot;&quot;</span>
    <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">norms</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">visited</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">current</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="ne">BaseException</span><span class="p">]</span> <span class="o">=</span> <span class="n">exc</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_normalize</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">text</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span>
        <span class="n">lowered</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;error:&quot;</span><span class="p">,</span> <span class="s2">&quot;exception:&quot;</span><span class="p">,</span> <span class="s2">&quot;warning:&quot;</span><span class="p">,</span> <span class="s2">&quot;runtimeerror:&quot;</span><span class="p">,</span> <span class="s2">&quot;valueerror:&quot;</span><span class="p">,</span> <span class="s2">&quot;typeerror:&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">lowered</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">token</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">text</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">token</span><span class="p">):]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="s2">&quot;: &quot;</span> <span class="ow">in</span> <span class="n">text</span><span class="p">:</span>
            <span class="n">head</span><span class="p">,</span> <span class="n">tail</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;: &quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">head</span><span class="o">.</span><span class="n">endswith</span><span class="p">((</span><span class="s2">&quot;Error&quot;</span><span class="p">,</span> <span class="s2">&quot;Exception&quot;</span><span class="p">,</span> <span class="s2">&quot;Warning&quot;</span><span class="p">)):</span>
                <span class="k">return</span> <span class="n">tail</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">text</span>

    <span class="k">while</span> <span class="n">current</span> <span class="ow">and</span> <span class="nb">id</span><span class="p">(</span><span class="n">current</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">visited</span><span class="p">:</span>
        <span class="n">visited</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="n">current</span><span class="p">))</span>
        <span class="n">tb_exc</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">TracebackException</span><span class="o">.</span><span class="n">from_exception</span><span class="p">(</span><span class="n">current</span><span class="p">)</span>
        <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tb_exc</span><span class="o">.</span><span class="n">format_exception_only</span><span class="p">())</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">text</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">current</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">current</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">text</span><span class="p">:</span>
            <span class="n">norm</span> <span class="o">=</span> <span class="n">_normalize</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">messages</span><span class="p">:</span>
                <span class="n">last_norm</span> <span class="o">=</span> <span class="n">norms</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">norm</span><span class="p">:</span>
                    <span class="n">norm</span> <span class="o">=</span> <span class="n">text</span>
                <span class="k">if</span> <span class="n">norm</span> <span class="o">==</span> <span class="n">last_norm</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">elif</span> <span class="n">last_norm</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">norm</span><span class="p">):</span>
                    <span class="n">messages</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">text</span>
                    <span class="n">norms</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">norm</span>
                <span class="k">elif</span> <span class="n">norm</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">last_norm</span><span class="p">):</span>
                    <span class="c1"># Current message is a superset; keep existing shorter variant.</span>
                    <span class="k">pass</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
                    <span class="n">norms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">norm</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
                <span class="n">norms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">norm</span> <span class="k">if</span> <span class="n">norm</span> <span class="k">else</span> <span class="n">text</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">current</span><span class="o">.</span><span class="n">__cause__</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">current</span> <span class="o">=</span> <span class="n">current</span><span class="o">.</span><span class="n">__cause__</span>
        <span class="k">elif</span> <span class="n">current</span><span class="o">.</span><span class="n">__context__</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="s2">&quot;__suppress_context__&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="n">current</span> <span class="o">=</span> <span class="n">current</span><span class="o">.</span><span class="n">__context__</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">break</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">messages</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">or</span> <span class="nb">repr</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span>
    <span class="k">return</span> <span class="s2">&quot; -&gt; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">messages</span><span class="p">)</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, THALES SIX GTS France SAS.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>