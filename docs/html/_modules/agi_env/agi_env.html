

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>agi_env.agi_env &mdash; AGILab 1.0.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css?v=4ae1632d" />
      <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />
      <link rel="stylesheet" type="text/css" href="../../_static/custom.css" />

  
    <link rel="canonical" href="https://thalesgroup.github.io/agilab/_modules/agi_env/agi_env.html" />
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=8d563738"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            AGILab
              <img src="../../_static/agi_logo.svg" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../quick-start.html">Quick-Start</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../quick-start.html#license">LICENSE</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../quick-start.html#install-agilab">Install Agilab</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../quick-start.html#support">Support</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../introduction.html">Introduction</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../introduction.html#overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../introduction.html#purpose"><strong>Purpose</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../introduction.html#target-audience"><strong>Target Audience</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../introduction.html#main-dependencies"><strong>Main Dependencies</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../introduction.html#technologies-selection-criteria"><strong>Technologies Selection Criteria</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../introduction.html#example-aircraft-radio-communication">Example: Aircraft Radio Communication</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../features.html">Features</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../features.html#agi-core">agi-core</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../features.html#agilab">agilab</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Core Topics</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../cluster.html">Cluster</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../cluster-help.html">Cluster Help</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../cluster-help.html#overview">Overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../cluster-help.html#principle">Principle</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../key-generation.html">Key Generation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../key-generation.html#generate-the-keys">1. Generate the keys</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../key-generation.html#loading-the-private-key-in-ssh-agent">2. Loading the private key in SSH Agent</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../key-generation.html#load-the-private-key">2.1 Load the private key</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../key-generation.html#verify-the-key-addition">2.2 Verify the key Addition</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../key-generation.html#copy-the-public-key-to-the-server">3. Copy the public key to the server</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../key-generation.html#allow-your-key">3.1 Allow your key</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../key-generation.html#verification">3.2 Verification</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../key-generation.html#troubleshooting">Troubleshooting</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../key-generation.html#sshd-service">SSHD Service</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../key-generation.html#useful-links">Useful links</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../cluster-help.html">Cluster Help</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../cluster-help.html#overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cluster-help.html#principle">Principle</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../agilab.html">AGILab</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../agilab_help.html">AGILab Help</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../framework-api.html">Framework API</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../framework-api.html#core-packages">Core packages</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../agi-env.html">agi-env API</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../agi-env.html#usage-example">Usage Example</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../agi-env.html#reference">Reference</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../agi-node.html">agi-node API</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../agi-node.html#path-handling">Path handling</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../agi-node.html#argument-helpers">Argument helpers</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../agi-node.html#managed-pc-path-remapping">Managed PC path remapping</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../agi-node.html#output-directory-helpers">Output directory helpers</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../agi-node.html#reference">Reference</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../agi-distributor.html">agi-distributor API</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../agi-distributor.html#usage-example">Usage Example</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../agi-distributor.html#reference">Reference</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../framework-api.html#working-with-the-api">Working with the API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../framework-api.html#app-structure-conventions">App structure conventions</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../environment.html">Environment Variables</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../faq.html">FAQ</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../faq.html#missing-worker-packages-during-agi-run">Missing worker packages during <cite>AGI.run_*</cite></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../faq.html#why-installers-still-build-eggs">Why installers still build eggs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../faq.html#do-we-already-have-dag-task-orchestration">Do we already have DAG/task orchestration?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../faq.html#who-manages-multithreading-when-dask-is-disabled">Who manages multithreading when Dask is disabled?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../faq.html#regenerating-ide-run-configurations">Regenerating IDE run configurations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../faq.html#virtual-env-does-not-match-the-project-environment-warning">“VIRTUAL_ENV … does not match the project environment” warning</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../faq.html#why-does-a-run-create-distribution-json">Why does a run create <code class="docutils literal notranslate"><span class="pre">distribution.json</span></code>?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../faq.html#switching-the-active-app-in-streamlit">Switching the active app in Streamlit</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../faq.html#docs-drift-after-touching-core-apis">Docs drift after touching core APIs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../faq.html#agi-install-fails-looking-for-pyproject-toml"><cite>AGI.install_*</cite> fails looking for <code class="docutils literal notranslate"><span class="pre">pyproject.toml</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../faq.html#where-are-installer-logs-written">Where are installer logs written?</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../directory-structure.html">Project Files Structure</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../install-usecase.html">Installation Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../troubleshooting.html">Troubleshooting</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../troubleshooting.html#a-prerequisite">A - Prerequisite:</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../troubleshooting.html#b-pycharm-run-debug-configurations">B - Pycharm Run/Debug configurations:</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../troubleshooting.html#c-exemple-of-tests-sequence">C - Exemple of Tests Sequence:</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../troubleshooting.html#d-agilab-run-dev-vs-agilab-run-enduser-vs-lab-run">D - agilab_run_dev vs agilab_run_enduser vs lab_run:</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../troubleshooting.html#known-bugs">Known Bugs</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../troubleshooting.html#install-sh-freeze">&lt;install.sh&gt; freeze:</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../troubleshooting.html#uv-virtual-env-warning">&lt;UV&gt; VIRTUAL_ENV Warning</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../troubleshooting.html#uv-sync-failed">&lt;UV&gt; Sync Failed</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../troubleshooting.html#dask-debug-issue">&lt;DASK&gt; Debug Issue</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../troubleshooting.html#pycharm-run-debug-configuration-is-broken">&lt;PYCHARM&gt; Run/Debug Configuration is Broken</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../troubleshooting.html#pycharm-can-t-open-your-project">&lt;PYCHARM&gt; Can’t open your project</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../license.html">Licenses</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../agi-cluster-licenses.html">Agi-cluster Licenses</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../agi-node-licenses.html">Agi-node Licenses</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../agi-env-licenses.html">Agi-env Licenses</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../flight-project-licenses.html">Flight-project Licenses</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Pages</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../agilab_help.html">AGILab Help</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../edit-help.html">▶️ EDIT</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../edit-help.html#sidebar">Sidebar</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../edit-help.html#main-content-area">Main Content Area</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../edit-help.html#support">Support</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../execute-help.html">▶️ EXECUTE</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../execute-help.html#introduction">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../execute-help.html#sidebar">Sidebar</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../execute-help.html#main-content-area">Main Content Area</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../experiment-help.html">▶️ EXPERIMENT</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../experiment-help.html#sidebar">Sidebar</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../experiment-help.html#main-content-area">Main Content Area</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../explore-help.html">▶️ EXPLORE</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../explore-help.html#introduction">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../explore-help.html#sidebar">Sidebar</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../explore-help.html#main-content-area">Main Content Area</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../explore-help.html#tips-notes">Tips &amp; Notes</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../apps-pages.html">apps bounded pages</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../apps-pages.html#view-autoencoder-latenspace">view_autoencoder_latenspace</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../apps-pages.html#view-barycentric">view_barycentric</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../apps-pages.html#view-maps">view_maps</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../apps-pages.html#view-maps-3d">view_maps_3d</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../apps-pages.html#view-maps-network">view_maps_network</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Apps Examples</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../mycode-project.html">MyCode Project</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../mycode-project.html#overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../mycode-project.html#manager-mycode-mycode">Manager (<cite>mycode.mycode</cite>)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../mycode-project.html#args-mycode-app-args">Args (<cite>mycode.app_args</cite>)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../mycode-project.html#worker-mycode-worker-mycode-worker">Worker (<cite>mycode_worker.mycode_worker</cite>)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../mycode-project.html#assets-tests">Assets &amp; Tests</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../mycode-project.html#api-reference">API Reference</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../flight-project.html">Flight Project</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../flight-project.html#overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../flight-project.html#manager-flight-flight">Manager (<cite>flight.flight</cite>)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../flight-project.html#args-flight-flight-args">Args (<cite>flight.flight_args</cite>)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../flight-project.html#worker-flight-worker-flight-worker">Worker (<cite>flight_worker.flight_worker</cite>)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../flight-project.html#assets-tests">Assets &amp; Tests</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../flight-project.html#api-reference">API Reference</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../flight-trajectory-project.html">Flight Trajectory Project</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../flight-trajectory-project.html#overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../flight-trajectory-project.html#manager-flight-trajectory-flight-trajectory">Manager (<cite>flight_trajectory.flight_trajectory</cite>)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../flight-trajectory-project.html#args-flight-trajectory-app-args">Args (<cite>flight_trajectory.app_args</cite>)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../flight-trajectory-project.html#worker-flight-trajectory-worker-flight-trajectory-worker">Worker (<cite>flight_trajectory_worker.flight_trajectory_worker</cite>)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../flight-trajectory-project.html#assets-tests">Assets &amp; Tests</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../flight-trajectory-project.html#api-reference">API Reference</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../link-sim-project.html">Link Sim Project</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../link-sim-project.html#overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../link-sim-project.html#manager-link-sim-link-sim">Manager (<cite>link_sim.link_sim</cite>)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../link-sim-project.html#args-link-sim-app-args">Args (<cite>link_sim.app_args</cite>)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../link-sim-project.html#worker-link-sim-worker-link-sim-worker">Worker (<cite>link_sim_worker.link_sim_worker</cite>)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../link-sim-project.html#assets-tests">Assets &amp; Tests</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../link-sim-project.html#api-reference">API Reference</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../sat-trajectory-project.html">Sat Trajectory Project</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../sat-trajectory-project.html#overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../sat-trajectory-project.html#manager-sat-trajectory-sat-trajectory">Manager (<cite>sat_trajectory.sat_trajectory</cite>)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../sat-trajectory-project.html#args-sat-trajectory-app-args">Args (<cite>sat_trajectory.app_args</cite>)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../sat-trajectory-project.html#worker-sat-trajectory-worker-sat-trajectory-worker">Worker (<cite>sat_trajectory_worker.sat_trajectory_worker</cite>)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../sat-trajectory-project.html#assets-tests">Assets &amp; Tests</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../sat-trajectory-project.html#api-reference">API Reference</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../sb3-trainer-project.html">SB3 Trainer Project</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../sb3-trainer-project.html#overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../sb3-trainer-project.html#manager-sb3-trainer-sb3-trainer">Manager (<cite>sb3_trainer.sb3_trainer</cite>)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../sb3-trainer-project.html#worker-sb3-trainer-worker-sb3-trainer-worker">Worker (<cite>sb3_trainer_worker.sb3_trainer_worker</cite>)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../sb3-trainer-project.html#assets-tests">Assets &amp; Tests</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../sb3-trainer-project.html#api-reference">API Reference</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Hosting Sites</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../agilab-github.html"><strong>Agilab project</strong></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../agilab-github.html#agilab-components"><strong>Agilab components</strong></a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">AGILab</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">agi_env.agi_env</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for agi_env.agi_env</h1><div class="highlight"><pre>
<span></span><span class="c1"># BSD 3-Clause License</span>
<span class="c1">#</span>
<span class="c1"># Copyright (c) 2025, Jean-Pierre Morard, THALES SIX GTS France SAS</span>
<span class="c1"># All rights reserved.</span>
<span class="c1">#</span>
<span class="c1"># Redistribution and use in source and binary forms, with or without modification, are permitted provided that the following conditions are met:</span>
<span class="c1">#</span>
<span class="c1"># 1. Redistributions of source code must retain the above copyright notice, this list of conditions and the following disclaimer.</span>
<span class="c1"># 2. Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following disclaimer in the documentation and/or other materials provided with the distribution.</span>
<span class="c1"># 3. Neither the name of Jean-Pierre Morard nor the names of its contributors, or THALES SIX GTS France SAS, may be used to endorse or promote products derived from this software without specific prior written permission.</span>
<span class="c1">#</span>
<span class="c1"># THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>
<span class="sd">&quot;&quot;&quot;AGILab environment bootstrapper and utility helpers.</span>

<span class="sd">The module exposes the :class:`AgiEnv` class which orchestrates project discovery,</span>
<span class="sd">virtual-environment management, packaging helpers, and convenience utilities used</span>
<span class="sd">by installers as well as runtime workers. Supporting free functions provide small</span>
<span class="sd">parsing and path utilities leveraged during setup.</span>

<span class="sd">Notes on singleton and pre‑init behavior</span>
<span class="sd">---------------------------------------</span>
<span class="sd">- ``AgiEnv`` behaves as a true singleton. Instance attributes are the source of</span>
<span class="sd">  truth; class attribute reads proxy to the singleton instance when initialised.</span>
<span class="sd">  Methods and descriptors are never shadowed by the delegation.</span>
<span class="sd">- A small subset of helpers is pre‑init safe and can be used before constructing</span>
<span class="sd">  an instance: :func:`AgiEnv.set_env_var`, :func:`AgiEnv.read_agilab_path`,</span>
<span class="sd">  :func:`AgiEnv._build_env`, and :func:`AgiEnv.log_info`. These functions avoid</span>
<span class="sd">  hard failures when the shared logger/environment has not been configured yet.</span>
<span class="sd">  Logging in that mode is best‑effort and may fall back to ``print``.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">IPython.core.ultratb</span><span class="w"> </span><span class="kn">import</span> <span class="n">FormattedTB</span>
<span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>  <span class="c1"># Optional dependency; fallback if absent</span>
    <span class="n">FormattedTB</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: ignore</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">ast</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">getpass</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">shlex</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">shutil</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">psutil</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">socket</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">subprocess</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">traceback</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">lru_cache</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span><span class="p">,</span> <span class="n">PureWindowsPath</span><span class="p">,</span> <span class="n">PurePosixPath</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">tempfile</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dotenv</span><span class="w"> </span><span class="kn">import</span> <span class="n">dotenv_values</span><span class="p">,</span> <span class="n">set_key</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">tomlkit</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">astor</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathspec</span><span class="w"> </span><span class="kn">import</span> <span class="n">PathSpec</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathspec.patterns</span><span class="w"> </span><span class="kn">import</span> <span class="n">GitWildMatchPattern</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">py7zr</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">urllib.request</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">inspect</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">ctypes</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ctypes</span><span class="w"> </span><span class="kn">import</span> <span class="n">wintypes</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">importlib.util</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">importlib.resources</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">importlib_resources</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">concurrent.futures</span><span class="w"> </span><span class="kn">import</span> <span class="n">ThreadPoolExecutor</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">threading</span><span class="w"> </span><span class="kn">import</span> <span class="n">RLock</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">agi_env.agi_logger</span><span class="w"> </span><span class="kn">import</span> <span class="n">AgiLogger</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">agi_env.defaults</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_default_openai_model</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">inspect</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">_inspect</span>
<span class="k">if</span> <span class="n">FormattedTB</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="c1"># Get constructor parameters of FormattedTB</span>
    <span class="n">_sig</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">FormattedTB</span><span class="o">.</span><span class="fm">__init__</span><span class="p">)</span><span class="o">.</span><span class="n">parameters</span>

    <span class="n">_tb_kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;Verbose&#39;</span><span class="p">,</span> <span class="n">call_pdb</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;color_scheme&#39;</span> <span class="ow">in</span> <span class="n">_sig</span><span class="p">:</span>
        <span class="n">_tb_kwargs</span><span class="p">[</span><span class="s1">&#39;color_scheme&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;NoColor&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">_tb_kwargs</span><span class="p">[</span><span class="s1">&#39;theme_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;NoColor&#39;</span>

    <span class="n">sys</span><span class="o">.</span><span class="n">excepthook</span> <span class="o">=</span> <span class="n">FormattedTB</span><span class="p">(</span><span class="o">**</span><span class="n">_tb_kwargs</span><span class="p">)</span>

<span class="c1"># logger = AgiLogger.get_logger(__name__)</span>


<span class="nd">@lru_cache</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_resolve_worker_hook</span><span class="p">(</span><span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return the path to the shared worker hook.</span>

<span class="sd">    Resolution order:</span>
<span class="sd">    1) If ``agi_node.agi_dispatcher`` is importable, use its installed files.</span>
<span class="sd">    2) In source checkouts, look for ``core/agi-node/src/agi_node/agi_dispatcher/&lt;filename&gt;``</span>
<span class="sd">       relative to this module location.</span>
<span class="sd">    3) As a last resort, try reading the resource via importlib.resources when the</span>
<span class="sd">       package is importable from a zip.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># 1) Try the installed package first</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">find_spec</span><span class="p">(</span><span class="s2">&quot;agi_node.agi_dispatcher&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ModuleNotFoundError</span><span class="p">:</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">candidates</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="n">spec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">search_locations</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">submodule_search_locations</span> <span class="ow">or</span> <span class="p">[])</span>
        <span class="k">for</span> <span class="n">location</span> <span class="ow">in</span> <span class="n">search_locations</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">location</span><span class="p">:</span>
                <span class="n">candidates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">location</span><span class="p">)</span> <span class="o">/</span> <span class="n">filename</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">spec</span><span class="o">.</span><span class="n">origin</span><span class="p">:</span>
            <span class="n">origin_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">origin</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">origin_path</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;__init__.py&quot;</span><span class="p">:</span>
                <span class="n">candidates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">origin_path</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="n">filename</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">candidates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">origin_path</span><span class="o">.</span><span class="n">with_name</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">candidate</span> <span class="ow">in</span> <span class="n">candidates</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">candidate</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="k">return</span> <span class="n">candidate</span>

    <span class="c1"># 2) Fallback for source-tree usage (no agi_node installed)</span>
    <span class="c1"># This file lives at: .../core/agi-env/src/agi_env/agi_env.py</span>
    <span class="n">here</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">repo_agilab_dir</span> <span class="o">=</span> <span class="n">here</span><span class="o">.</span><span class="n">parents</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>  <span class="c1"># .../src/agilab</span>
        <span class="n">core_root</span> <span class="o">=</span> <span class="n">repo_agilab_dir</span> <span class="o">/</span> <span class="s2">&quot;core&quot;</span>
        <span class="n">src_hook</span> <span class="o">=</span> <span class="n">core_root</span> <span class="o">/</span> <span class="s2">&quot;agi-node/src/agi_node/agi_dispatcher&quot;</span> <span class="o">/</span> <span class="n">filename</span>
        <span class="n">pkg_hook</span> <span class="o">=</span> <span class="n">core_root</span> <span class="o">/</span> <span class="s2">&quot;agi-node/agi_dispatcher&quot;</span> <span class="o">/</span> <span class="n">filename</span>
        <span class="k">for</span> <span class="n">candidate</span> <span class="ow">in</span> <span class="p">(</span><span class="n">src_hook</span><span class="p">,</span> <span class="n">pkg_hook</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">candidate</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="k">return</span> <span class="n">candidate</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="c1"># Best-effort only; ignore path probing errors</span>
        <span class="k">pass</span>

    <span class="c1"># 3) Attempt extracting from package resources (zip installs)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">package_root</span> <span class="o">=</span> <span class="n">importlib_resources</span><span class="o">.</span><span class="n">files</span><span class="p">(</span><span class="s2">&quot;agi_node.agi_dispatcher&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">ModuleNotFoundError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">resource</span> <span class="o">=</span> <span class="n">package_root</span> <span class="o">/</span> <span class="n">filename</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">resource</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">cache_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">tempfile</span><span class="o">.</span><span class="n">gettempdir</span><span class="p">())</span> <span class="o">/</span> <span class="s2">&quot;agi_node_hooks&quot;</span>
    <span class="n">cache_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">cached</span> <span class="o">=</span> <span class="n">cache_dir</span> <span class="o">/</span> <span class="n">filename</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">importlib_resources</span><span class="o">.</span><span class="n">as_file</span><span class="p">(</span><span class="n">resource</span><span class="p">)</span> <span class="k">as</span> <span class="n">resource_path</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">resource_path</span> <span class="o">!=</span> <span class="n">cached</span><span class="p">:</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="n">resource_path</span><span class="p">,</span> <span class="n">cached</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">cached</span> <span class="k">if</span> <span class="n">cached</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span> <span class="k">else</span> <span class="kc">None</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_select_hook</span><span class="p">(</span><span class="n">local_candidate</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">fallback_filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">hook_label</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Path</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return the hook to execute and whether it comes from the shared baseline.&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">local_candidate</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">local_candidate</span><span class="p">,</span> <span class="kc">False</span>

    <span class="n">fallback</span> <span class="o">=</span> <span class="n">_resolve_worker_hook</span><span class="p">(</span><span class="n">fallback_filename</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">fallback</span> <span class="ow">and</span> <span class="n">fallback</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">fallback</span><span class="p">,</span> <span class="kc">True</span>

    <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Unable to resolve </span><span class="si">{</span><span class="n">hook_label</span><span class="si">}</span><span class="s2"> script: expected </span><span class="si">{</span><span class="n">local_candidate</span><span class="si">}</span><span class="s2"> or shared agi-node copy.&quot;</span>
    <span class="p">)</span>

<span class="c1"># Compile regex once globally</span>
<span class="n">LEVEL_RES</span> <span class="o">=</span> <span class="p">[</span>
    <span class="c1"># Optional leading time like &quot;11:20:03 &quot; or &quot;11:20:03,123 &quot;</span>
    <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^\s*(?:\d</span><span class="si">{2}</span><span class="s1">:\d</span><span class="si">{2}</span><span class="s1">:\d</span><span class="si">{2}</span><span class="s1">(?:[.,]\d+)?\s+)?(DEBUG|INFO|WARNING|ERROR|CRITICAL)\b&#39;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">),</span>
    <span class="c1"># Bracketed level: &quot;[ERROR] something&quot;</span>
    <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^\s*\[\s*(DEBUG|INFO|WARNING|ERROR|CRITICAL)\s*\]\b&#39;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">),</span>
    <span class="c1"># Key/value style: &quot;level=error ...&quot;</span>
    <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\blevel\s*=\s*(debug|info|warning|error|critical)\b&#39;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">),</span>
<span class="p">]</span>
<span class="n">TIME_LEVEL_PREFIX</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
    <span class="sa">r</span><span class="s1">&#39;^\s*(?:\d</span><span class="si">{2}</span><span class="s1">:\d</span><span class="si">{2}</span><span class="s1">:\d</span><span class="si">{2}</span><span class="s1">(?:[.,]\d+)?)\s+(DEBUG|INFO|WARNING|ERROR|CRITICAL)\s*[:-]?\s*&#39;</span><span class="p">,</span>
    <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">,</span>
<span class="p">)</span>


<div class="viewcode-block" id="normalize_path">
<a class="viewcode-back" href="../../agi-env.html#agi_env.agi_env.normalize_path">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">normalize_path</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return ``path`` coerced to a normalised string representation.</span>

<span class="sd">    ``Path`` objects are converted to a string that matches the current platform</span>
<span class="sd">    conventions so the value can safely be stored in configuration files or</span>
<span class="sd">    environment variables.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="p">(</span>
        <span class="nb">str</span><span class="p">(</span><span class="n">PureWindowsPath</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;nt&quot;</span>
        <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">PurePosixPath</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)))</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="parse_level">
<a class="viewcode-back" href="../../agi-env.html#agi_env.agi_env.parse_level">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">parse_level</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">default_level</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Resolve a logging level token found in ``line``.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    line:</span>
<span class="sd">        The text that might contain a logging level marker.</span>
<span class="sd">    default_level:</span>
<span class="sd">        The integer level returned when no explicit marker is present.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    int</span>
<span class="sd">        The numeric logging level understood by :mod:`logging`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">for</span> <span class="n">rx</span> <span class="ow">in</span> <span class="n">LEVEL_RES</span><span class="p">:</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">rx</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">logging</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">default_level</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">default_level</span></div>


<div class="viewcode-block" id="strip_time_level_prefix">
<a class="viewcode-back" href="../../agi-env.html#agi_env.agi_env.strip_time_level_prefix">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">strip_time_level_prefix</span><span class="p">(</span><span class="n">line</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Remove a ``HH:MM:SS LEVEL`` prefix commonly emitted by log handlers.&quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="n">TIME_LEVEL_PREFIX</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></div>


<div class="viewcode-block" id="is_packaging_cmd">
<a class="viewcode-back" href="../../agi-env.html#agi_env.agi_env.is_packaging_cmd">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">is_packaging_cmd</span><span class="p">(</span><span class="n">cmd</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return ``True`` when ``cmd`` appears to invoke ``uv`` or ``pip``.&quot;&quot;&quot;</span>

    <span class="n">s</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;uv &quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">s</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;pip &quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;uv&quot;</span> <span class="ow">in</span> <span class="n">s</span> <span class="ow">or</span> <span class="s2">&quot;pip&quot;</span> <span class="ow">in</span> <span class="n">s</span></div>


<span class="k">class</span><span class="w"> </span><span class="nc">_AgiEnvMeta</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Delegate AgiEnv class attribute access to the singleton instance.</span>

<span class="sd">    This keeps existing call-sites that use ``AgiEnv.attr`` working while</span>
<span class="sd">    allowing the implementation to set values only on the instance. Methods</span>
<span class="sd">    and descriptors are never shadowed.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__getattribute__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>  <span class="c1"># type: ignore[override]</span>
        <span class="c1"># Core attributes always from the class</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;_instance&quot;</span><span class="p">,</span> <span class="s2">&quot;_lock&quot;</span><span class="p">,</span> <span class="s2">&quot;current&quot;</span><span class="p">,</span> <span class="s2">&quot;reset&quot;</span><span class="p">,</span> <span class="s2">&quot;__dict__&quot;</span><span class="p">,</span> <span class="s2">&quot;__weakref__&quot;</span><span class="p">}:</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

        <span class="c1"># Try to get class attribute; remember if it exists even when value is None</span>
        <span class="n">found_on_class</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="n">found_on_class</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">_inspect</span><span class="o">.</span><span class="n">isfunction</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
                <span class="ow">or</span> <span class="n">_inspect</span><span class="o">.</span><span class="n">ismethoddescriptor</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
                <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="p">(</span><span class="nb">property</span><span class="p">,</span> <span class="nb">staticmethod</span><span class="p">,</span> <span class="nb">classmethod</span><span class="p">,</span> <span class="nb">type</span><span class="p">))</span>
            <span class="p">):</span>
                <span class="k">return</span> <span class="n">obj</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Prefer the instance attribute when available</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">inst</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="s2">&quot;_instance&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">inst</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">inst</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

        <span class="c1"># Fall back to the class attribute (may be None)</span>
        <span class="k">if</span> <span class="n">found_on_class</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">obj</span>

        <span class="c1"># Nothing found</span>
        <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;type object &#39;</span><span class="si">{</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&#39; has no attribute &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>  <span class="c1"># type: ignore[override]</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;_instance&quot;</span><span class="p">,</span> <span class="s2">&quot;_lock&quot;</span><span class="p">}</span> <span class="ow">or</span> <span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;__&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;__&quot;</span><span class="p">)):</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="c1"># Always set callables/descriptors on the class itself to allow patching/overrides</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">_inspect</span><span class="o">.</span><span class="n">isfunction</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="ow">or</span> <span class="n">_inspect</span><span class="o">.</span><span class="n">ismethoddescriptor</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">property</span><span class="p">,</span> <span class="nb">staticmethod</span><span class="p">,</span> <span class="nb">classmethod</span><span class="p">,</span> <span class="nb">type</span><span class="p">))</span>
        <span class="p">):</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="n">inst</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s2">&quot;_instance&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">inst</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>


<div class="viewcode-block" id="AgiEnv">
<a class="viewcode-back" href="../../agi-env.html#agi_env.agi_env.AgiEnv">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">AgiEnv</span><span class="p">(</span><span class="n">metaclass</span><span class="o">=</span><span class="n">_AgiEnvMeta</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Encapsulates filesystem and configuration state for AGILab deployments.</span>

<span class="sd">    Singleton access</span>
<span class="sd">    ----------------</span>
<span class="sd">    - Repeated instantiation reuses the same instance. Use :func:`AgiEnv.reset`</span>
<span class="sd">      to drop it, or :func:`AgiEnv.current` to retrieve it.</span>
<span class="sd">    - Reading ``AgiEnv.attr`` proxies to the singleton&#39;s attribute when the</span>
<span class="sd">      instance exists; callables/properties are always returned from the class.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_instance</span><span class="p">:</span> <span class="s2">&quot;AgiEnv | None&quot;</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_lock</span><span class="p">:</span> <span class="n">RLock</span> <span class="o">=</span> <span class="n">RLock</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_instance</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">cls</span><span class="o">.</span><span class="n">_instance</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_instance</span>

<div class="viewcode-block" id="AgiEnv.current">
<a class="viewcode-back" href="../../agi-env.html#agi_env.agi_env.AgiEnv.current">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">current</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;AgiEnv&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the currently initialised environment instance.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_instance</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;AgiEnv has not been initialised yet&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_instance</span></div>


<div class="viewcode-block" id="AgiEnv.reset">
<a class="viewcode-back" href="../../agi-env.html#agi_env.agi_env.AgiEnv.reset">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">reset</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Drop the cached singleton so a fresh environment can be bootstrapped.&quot;&quot;&quot;</span>

        <span class="k">with</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">_instance</span> <span class="o">=</span> <span class="kc">None</span></div>

    <span class="n">install_type</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># deprecated: derived from flags for backward compatibility</span>
    <span class="n">apps_dir</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">app</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">target</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">TABLE_MAX_ROWS</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">GUI_SAMPLING</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">init_done</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">hw_rapids_capable</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">is_worker_env</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">_is_managed_pc</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">debug</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">uv</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">benchmark</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">pyvers_worker</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">out_log</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">err_log</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="c1"># Minimal class-level fallbacks to support limited static usage pre-init</span>
    <span class="n">resources_path</span><span class="p">:</span> <span class="n">Path</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">Path</span><span class="o">.</span><span class="n">home</span><span class="p">()</span> <span class="o">/</span> <span class="s2">&quot;.agilab&quot;</span>
    <span class="n">envars</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1"># Simplified environment flags</span>
    <span class="n">is_source_env</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">is_local_worker</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">_ip_local_cache</span><span class="p">:</span> <span class="nb">set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">({</span><span class="s2">&quot;127.0.0.1&quot;</span><span class="p">,</span> <span class="s2">&quot;::1&quot;</span><span class="p">})</span>
    <span class="n">INDEX_URL</span><span class="o">=</span><span class="s2">&quot;https://test.pypi.org/simple&quot;</span>
    <span class="n">EXTRA_INDEX_URL</span><span class="o">=</span><span class="s2">&quot;https://pypi.org/simple&quot;</span>
    <span class="n">snippet_tail</span> <span class="o">=</span> <span class="s2">&quot;asyncio.get_event_loop().run_until_complete(main())&quot;</span>
    <span class="n">_pythonpath_entries</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

<div class="viewcode-block" id="AgiEnv.__init__">
<a class="viewcode-back" href="../../agi-env.html#agi_env.agi_env.AgiEnv.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">apps_dir</span><span class="p">:</span> <span class="n">Path</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">app</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">verbose</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                 <span class="n">python_variante</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                 <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="c1"># Backward/forward compat: accept &#39;active_app&#39; alias for &#39;app&#39;</span>
        <span class="k">if</span> <span class="n">app</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s1">&#39;active_app&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;active_app&#39;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">app</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">val</span><span class="p">)</span><span class="o">.</span><span class="n">name</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">app</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_resolve_install_type</span><span class="p">(</span><span class="n">apps_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
                                  <span class="n">agilab_pck</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
                                  <span class="n">envars</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Infer install type without requiring an explicit argument.</span>

<span class="sd">            Precedence:</span>
<span class="sd">            1. honour explicit overrides from environment variables (``AGILAB_INSTALL_TYPE``</span>
<span class="sd">               or ``INSTALL_TYPE``) when they are valid integers;</span>
<span class="sd">            2. when no ``apps_dir`` is provided, assume a worker-only environment (type 2);</span>
<span class="sd">            3. otherwise rely on the directory layout to distinguish source checkouts (type 1)</span>
<span class="sd">               from packaged installs (type 0), falling back to the legacy heuristic based on</span>
<span class="sd">               ``agilab_pck`` when needed.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Heuristic: if apps_dir is not provided (BaseWorker.new) or it resides inside a worker env folder (wenv/*_worker),</span>
                <span class="c1"># treat this as a worker-only environment regardless of source/layout markers.</span>
                <span class="k">if</span> <span class="n">apps_dir</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="s2">&quot;wenv&quot;</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">apps_dir</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span><span class="o">.</span><span class="n">parts</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">is_worker_env</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">return</span> <span class="mi">2</span>

                <span class="k">elif</span> <span class="n">apps_dir</span><span class="o">.</span><span class="n">parents</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;src&quot;</span><span class="p">:</span>
                    <span class="k">return</span> <span class="mi">1</span>

            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>

            <span class="k">return</span> <span class="mi">0</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_package_dir</span><span class="p">(</span><span class="n">package</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">spec</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">find_spec</span><span class="p">(</span><span class="n">package</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">ModuleNotFoundError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
                <span class="n">spec</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="n">spec</span><span class="p">:</span>
                <span class="n">search_locations</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="s2">&quot;submodule_search_locations&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">search_locations</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">location</span> <span class="ow">in</span> <span class="n">search_locations</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">location</span><span class="p">:</span>
                            <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">location</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                                <span class="k">return</span> <span class="n">path</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>

                <span class="n">origin</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="s2">&quot;origin&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">origin</span><span class="p">:</span>
                    <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">origin</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span>
                    <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                        <span class="k">return</span> <span class="n">path</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>

            <span class="k">raise</span> <span class="ne">ModuleNotFoundError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Package &#39;</span><span class="si">{</span><span class="n">package</span><span class="si">}</span><span class="s2">&#39; is not installed in the current environment.&quot;</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">is_managed_pc</span> <span class="o">=</span> <span class="n">getpass</span><span class="o">.</span><span class="n">getuser</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;T0&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_managed_pc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_managed_pc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_agi_resources</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;resources/.agilab&quot;</span><span class="p">)</span>
        <span class="n">home_abs</span> <span class="o">=</span> <span class="n">Path</span><span class="o">.</span><span class="n">home</span><span class="p">()</span> <span class="o">/</span> <span class="s2">&quot;MyApp&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_managed_pc</span> <span class="k">else</span> <span class="n">Path</span><span class="o">.</span><span class="n">home</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">home_abs</span> <span class="o">=</span> <span class="n">home_abs</span>

        <span class="k">if</span> <span class="n">verbose</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">verbose</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uv</span> <span class="o">=</span> <span class="s2">&quot;uv&quot;</span>
        <span class="k">if</span> <span class="n">verbose</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">uv</span> <span class="o">=</span> <span class="s2">&quot;uv --quiet&quot;</span>
        <span class="k">elif</span> <span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">uv</span> <span class="o">=</span> <span class="s2">&quot;uv --verbose&quot;</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">resources_path</span> <span class="o">=</span> <span class="n">home_abs</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_agi_resources</span><span class="o">.</span><span class="n">name</span>
        <span class="n">env_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resources_path</span> <span class="o">/</span> <span class="s2">&quot;.env&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">benchmark</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resources_path</span> <span class="o">/</span> <span class="s2">&quot;benchmark.json&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">envars</span> <span class="o">=</span> <span class="n">dotenv_values</span><span class="p">(</span><span class="n">dotenv_path</span><span class="o">=</span><span class="n">env_path</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
        <span class="n">envars</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">envars</span>
        <span class="n">repo_agilab_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span><span class="o">.</span><span class="n">parents</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>

        <span class="n">agilab_spec</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">find_spec</span><span class="p">(</span><span class="s2">&quot;agilab&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">agilab_spec</span> <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">agilab_spec</span><span class="p">,</span> <span class="s2">&quot;origin&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">agilab_pkg_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">agilab_spec</span><span class="o">.</span><span class="n">origin</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span><span class="o">.</span><span class="n">parent</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">agilab_pkg_dir</span> <span class="o">=</span> <span class="n">repo_agilab_dir</span>
        <span class="n">agilab_pkg_dir</span> <span class="o">=</span> <span class="n">agilab_pkg_dir</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>
        <span class="n">agilab_pck</span> <span class="o">=</span> <span class="n">agilab_pkg_dir</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>
        <span class="n">markers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;site-packages&quot;</span><span class="p">,</span> <span class="s2">&quot;dist-packages&quot;</span><span class="p">}</span>
        <span class="n">is_agilab_installed</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">part</span> <span class="ow">in</span> <span class="n">markers</span> <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">agilab_pkg_dir</span><span class="o">.</span><span class="n">parts</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">any</span><span class="p">(</span>
            <span class="n">part</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;.venv&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">agilab_pkg_dir</span><span class="o">.</span><span class="n">parts</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">apps_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">apps_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">apps_dir</span><span class="p">)</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">apps_dir</span> <span class="o">=</span> <span class="n">apps_dir</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="n">install_type</span> <span class="o">=</span> <span class="n">_resolve_install_type</span><span class="p">(</span><span class="n">apps_dir</span><span class="p">,</span> <span class="n">agilab_pck</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">envars</span><span class="p">)</span>

        <span class="c1"># Default apps_dir for non-worker envs when not provided</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_worker_env</span> <span class="ow">and</span> <span class="n">apps_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">apps_dir</span> <span class="o">=</span> <span class="p">(</span><span class="n">agilab_pck</span> <span class="o">/</span> <span class="s2">&quot;apps&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">apps_dir</span> <span class="o">=</span> <span class="n">agilab_pck</span> <span class="o">/</span> <span class="s2">&quot;apps&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_worker_env</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">app</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;app is required when self.is_worker_env&quot;</span><span class="p">)</span>
            <span class="n">active_app</span> <span class="o">=</span> <span class="n">home_abs</span> <span class="o">/</span> <span class="s2">&quot;wenv&quot;</span> <span class="o">/</span> <span class="n">app</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">app</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">app</span> <span class="o">=</span> <span class="n">envars</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;APP_DEFAULT&quot;</span><span class="p">,</span> <span class="s1">&#39;flight_project&#39;</span><span class="p">)</span>
            <span class="n">base_dir</span> <span class="o">=</span> <span class="n">apps_dir</span> <span class="k">if</span> <span class="n">apps_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">Path</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">base_dir</span> <span class="o">=</span> <span class="n">base_dir</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="n">active_app</span> <span class="o">=</span> <span class="n">base_dir</span> <span class="o">/</span> <span class="n">app</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">app</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;_project&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">app</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;_worker&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">app</span><span class="si">}</span><span class="s2"> must end with &#39;_project&#39; or &#39;_worker&#39;&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">app</span> <span class="o">=</span> <span class="n">app</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">active_app</span> <span class="o">=</span> <span class="n">active_app</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">active_app</span> <span class="o">=</span> <span class="n">active_app</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">apps_dir</span> <span class="o">=</span> <span class="n">apps_dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">apps_repository_root</span><span class="p">:</span> <span class="n">Path</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">target</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_project&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_worker&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">python_variante</span> <span class="o">=</span> <span class="n">python_variante</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">AgiLogger</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span> <span class="n">base_name</span><span class="o">=</span><span class="s2">&quot;agi_env&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="n">debug</span>

        <span class="c1"># Simplified environment flags</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_source_env</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">is_agilab_installed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_local_worker</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># Backward-compat: map booleans to legacy install_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">install_type</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_source_env</span> <span class="k">else</span> <span class="p">(</span><span class="mi">2</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_worker_env</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_source_env</span><span class="p">:</span>
            <span class="n">pkg_dirs</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;env&quot;</span><span class="p">:</span> <span class="s2">&quot;agi-env/src/agi_env&quot;</span><span class="p">,</span>
                <span class="s2">&quot;node&quot;</span><span class="p">:</span> <span class="s2">&quot;agi-node/src/agi_node&quot;</span><span class="p">,</span>
                <span class="s2">&quot;core&quot;</span><span class="p">:</span> <span class="s2">&quot;agi-core/src/agi_core&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cluster&quot;</span><span class="p">:</span> <span class="s2">&quot;agi-cluster/src/agi_cluster&quot;</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="c1"># Force source layout to the repo checkout when available</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">agilab_pck</span> <span class="o">=</span> <span class="n">repo_agilab_dir</span>
            <span class="n">core_root</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agilab_pck</span> <span class="o">/</span> <span class="s2">&quot;core&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">env_pck</span> <span class="o">=</span> <span class="n">core_root</span> <span class="o">/</span> <span class="n">pkg_dirs</span><span class="p">[</span><span class="s2">&quot;env&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">node_pck</span> <span class="o">=</span> <span class="n">core_root</span> <span class="o">/</span> <span class="n">pkg_dirs</span><span class="p">[</span><span class="s2">&quot;node&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">core_pck</span> <span class="o">=</span> <span class="n">core_root</span> <span class="o">/</span> <span class="n">pkg_dirs</span><span class="p">[</span><span class="s2">&quot;core&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cluster_pck</span> <span class="o">=</span> <span class="n">core_root</span> <span class="o">/</span> <span class="n">pkg_dirs</span><span class="p">[</span><span class="s2">&quot;cluster&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cli</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster_pck</span> <span class="o">/</span> <span class="s2">&quot;agi_distributor/cli.py&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">agilab_pck</span> <span class="o">=</span> <span class="n">agilab_pkg_dir</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">env_pck</span> <span class="o">=</span> <span class="n">_package_dir</span><span class="p">(</span><span class="s2">&quot;agi_env&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">node_pck</span> <span class="o">=</span> <span class="n">_package_dir</span><span class="p">(</span><span class="s2">&quot;agi_node&quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">core_pck</span> <span class="o">=</span> <span class="n">_package_dir</span><span class="p">(</span><span class="s2">&quot;agi_core&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ModuleNotFoundError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">core_pck</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">_package_dir</span><span class="p">(</span><span class="s2">&quot;agi_env&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">parent</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cluster_pck</span> <span class="o">=</span> <span class="n">_package_dir</span><span class="p">(</span><span class="s2">&quot;agi_cluster&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ModuleNotFoundError</span><span class="p">:</span>
                <span class="c1"># In minimal worker environments, agi_cluster may be absent; fall back near env/core</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cluster_pck</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">core_pck</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">cli_spec</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">find_spec</span><span class="p">(</span><span class="s2">&quot;agi_cluster.agi_distributor.cli&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ModuleNotFoundError</span><span class="p">:</span>
                <span class="n">cli_spec</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cli</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">cli_spec</span><span class="o">.</span><span class="n">origin</span><span class="p">)</span> <span class="k">if</span> <span class="n">cli_spec</span> <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">cli_spec</span><span class="p">,</span> <span class="s2">&quot;origin&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster_pck</span> <span class="o">/</span> <span class="s2">&quot;agi_distributor/cli.py&quot;</span>

        <span class="n">resolve</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_package</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env_pck</span> <span class="o">=</span> <span class="n">resolve</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env_pck</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node_pck</span> <span class="o">=</span> <span class="n">resolve</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node_pck</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">core_pck</span> <span class="o">=</span> <span class="n">resolve</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">core_pck</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cluster_pck</span> <span class="o">=</span> <span class="n">resolve</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cluster_pck</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">agi_env</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env_pck</span><span class="o">.</span><span class="n">parents</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">agi_node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_pck</span><span class="o">.</span><span class="n">parents</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">agi_core</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">core_pck</span><span class="o">.</span><span class="n">parents</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">agi_cluster</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster_pck</span><span class="o">.</span><span class="n">parents</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_source_env</span><span class="p">:</span>
            <span class="n">resource_candidates</span> <span class="o">=</span> <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">agilab_pck</span> <span class="o">/</span> <span class="s2">&quot;resources&quot;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">agilab_pck</span> <span class="o">/</span> <span class="s2">&quot;agilab/resources&quot;</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">resource_candidates</span> <span class="o">=</span> <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">agilab_pck</span> <span class="o">/</span> <span class="s2">&quot;resources&quot;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">agilab_pck</span> <span class="o">/</span> <span class="s2">&quot;agilab/resources&quot;</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="k">for</span> <span class="n">candidate</span> <span class="ow">in</span> <span class="n">resource_candidates</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">candidate</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">st_resources</span> <span class="o">=</span> <span class="n">candidate</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">st_resources</span> <span class="o">=</span> <span class="n">resource_candidates</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">apps_root</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agilab_pck</span> <span class="o">/</span> <span class="s2">&quot;apps&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_source_env</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_worker_env</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">apps_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="n">link_source</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">apps_repository_root</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_apps_repository_root</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">link_source</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">link_source</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="n">same_tree</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">apps_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">same_tree</span> <span class="o">=</span> <span class="n">apps_dir</span><span class="o">.</span><span class="n">resolve</span><span class="p">(</span><span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">==</span> <span class="n">link_source</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="n">same_tree</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">same_tree</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">src_app</span> <span class="ow">in</span> <span class="n">link_source</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*_project&quot;</span><span class="p">):</span>
                        <span class="n">dest_app</span> <span class="o">=</span> <span class="n">apps_dir</span> <span class="o">/</span> <span class="n">src_app</span><span class="o">.</span><span class="n">relative_to</span><span class="p">(</span><span class="n">link_source</span><span class="p">)</span>
                        <span class="c1"># Avoid self-referential symlinks when the public destination</span>
                        <span class="c1"># already resides inside the apps repository tree.</span>
                        <span class="k">if</span> <span class="n">dest_app</span><span class="o">.</span><span class="n">resolve</span><span class="p">(</span><span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">==</span> <span class="n">src_app</span><span class="o">.</span><span class="n">resolve</span><span class="p">():</span>
                            <span class="n">AgiEnv</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;Skipping symlink for app </span><span class="si">{</span><span class="n">src_app</span><span class="si">}</span><span class="s2"> because destination matches source&quot;</span>
                            <span class="p">)</span>
                            <span class="k">continue</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">dest_app</span><span class="o">.</span><span class="n">is_symlink</span><span class="p">():</span>
                                <span class="n">same_target</span> <span class="o">=</span> <span class="kc">False</span>
                                <span class="k">if</span> <span class="n">dest_app</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                                    <span class="k">try</span><span class="p">:</span>
                                        <span class="n">same_target</span> <span class="o">=</span> <span class="n">dest_app</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span> <span class="o">==</span> <span class="n">src_app</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>
                                    <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                                        <span class="n">same_target</span> <span class="o">=</span> <span class="kc">False</span>
                                <span class="k">if</span> <span class="n">same_target</span><span class="p">:</span>
                                    <span class="k">continue</span>
                                <span class="n">dest_app</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
                            <span class="k">elif</span> <span class="n">dest_app</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                                <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">dest_app</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
                            <span class="k">pass</span>

                        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;nt&quot;</span><span class="p">:</span>
                            <span class="n">AgiEnv</span><span class="o">.</span><span class="n">create_symlink_windows</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">src_app</span><span class="p">),</span> <span class="n">dest_app</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">os</span><span class="o">.</span><span class="n">symlink</span><span class="p">(</span><span class="n">src_app</span><span class="p">,</span> <span class="n">dest_app</span><span class="p">,</span> <span class="n">target_is_directory</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="n">AgiEnv</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Created symbolic link for app: </span><span class="si">{</span><span class="n">src_app</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">dest_app</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">apps_root</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">copy_existing_projects</span><span class="p">(</span><span class="n">apps_root</span><span class="p">,</span> <span class="n">active_app</span><span class="o">.</span><span class="n">parent</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">AgiEnv</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: </span><span class="si">{</span><span class="n">apps_root</span><span class="si">}</span><span class="s2"> does not exist, nothing to copy!&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">active_app</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span> <span class="ow">and</span> <span class="n">apps_root</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="n">packaged_app</span> <span class="o">=</span> <span class="n">apps_root</span> <span class="o">/</span> <span class="n">app</span>
                <span class="k">if</span> <span class="n">packaged_app</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">shutil</span><span class="o">.</span><span class="n">copytree</span><span class="p">(</span>
                            <span class="n">packaged_app</span><span class="p">,</span>
                            <span class="n">active_app</span><span class="p">,</span>
                            <span class="n">dirs_exist_ok</span><span class="o">=</span><span class="kc">True</span>
                        <span class="p">)</span>
                        <span class="n">AgiEnv</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                            <span class="s2">&quot;Copied packaged app </span><span class="si">%s</span><span class="s2"> into </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">packaged_app</span><span class="p">,</span> <span class="n">active_app</span>
                        <span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                        <span class="n">AgiEnv</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Failed to copy packaged app </span><span class="si">{</span><span class="n">packaged_app</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">exc</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">AgiEnv</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="s2">&quot;Private apps root missing </span><span class="si">%s</span><span class="s2">; copying packaged examples instead&quot;</span><span class="p">,</span>
                        <span class="n">app</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">copy_existing_projects</span><span class="p">(</span><span class="n">apps_root</span><span class="p">,</span> <span class="n">apps_dir</span><span class="p">)</span>


        <span class="n">resources_root</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env_pck</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_source_env</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_worker_env</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_init_resources</span><span class="p">(</span><span class="n">resources_root</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_agi_resources</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">TABLE_MAX_ROWS</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">envars</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;TABLE_MAX_ROWS&quot;</span><span class="p">,</span> <span class="mi">1000</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">GUI_SAMPLING</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">envars</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;GUI_SAMPLING&quot;</span><span class="p">,</span> <span class="mi">20</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">target</span> <span class="o">=</span> <span class="n">target</span>
        <span class="n">wenv_root</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;wenv&quot;</span><span class="p">)</span>
        <span class="n">target_worker</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">target</span><span class="si">}</span><span class="s2">_worker&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_worker</span> <span class="o">=</span> <span class="n">target_worker</span>
        <span class="n">wenv_rel</span> <span class="o">=</span> <span class="n">wenv_root</span> <span class="o">/</span> <span class="n">target_worker</span>
        <span class="n">target_class</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">title</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">target</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_class</span> <span class="o">=</span> <span class="n">target_class</span>
        <span class="n">worker_class</span> <span class="o">=</span> <span class="n">target_class</span> <span class="o">+</span> <span class="s2">&quot;Worker&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_worker_class</span> <span class="o">=</span> <span class="n">worker_class</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">wenv_rel</span> <span class="o">=</span> <span class="n">wenv_rel</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dist_rel</span> <span class="o">=</span> <span class="n">wenv_rel</span> <span class="o">/</span> <span class="s1">&#39;dist&#39;</span>
        <span class="n">wenv_abs</span> <span class="o">=</span> <span class="n">home_abs</span> <span class="o">/</span> <span class="n">wenv_rel</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wenv_abs</span> <span class="o">=</span> <span class="n">wenv_abs</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wenv_abs</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pre_install</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">node_pck</span> <span class="o">/</span> <span class="s2">&quot;agi_dispatcher/pre_install.py&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">post_install</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_pck</span> <span class="o">/</span> <span class="s2">&quot;agi_dispatcher/post_install.py&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">post_install_rel</span> <span class="o">=</span>   <span class="s2">&quot;agi_node.agi_dispatcher.post_install&quot;</span>

        <span class="n">dist_abs</span> <span class="o">=</span> <span class="n">wenv_abs</span> <span class="o">/</span> <span class="s1">&#39;dist&#39;</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="n">normalize_path</span><span class="p">(</span><span class="n">dist_abs</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">dist</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dist_abs</span> <span class="o">=</span> <span class="n">dist_abs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">app_src</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_app</span> <span class="o">/</span> <span class="s2">&quot;src&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">manager_pyproject</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_app</span> <span class="o">/</span> <span class="s2">&quot;pyproject.toml&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">worker_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">app_src</span> <span class="o">/</span> <span class="n">target_worker</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">target_worker</span><span class="si">}</span><span class="s2">.py&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">manager_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">app_src</span> <span class="o">/</span> <span class="n">target</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">target</span><span class="si">}</span><span class="s2">.py&quot;</span>
        <span class="n">is_local_worker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_agilab_anywhere_under_home</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agilab_pck</span><span class="p">)</span>
        <span class="n">worker_src</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wenv_rel</span> <span class="o">/</span> <span class="s1">&#39;src&#39;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_worker_env</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_local_worker</span><span class="p">:</span>
            <span class="n">app</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agilab_pck</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">app_src</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agilab_pck</span> <span class="o">/</span> <span class="s2">&quot;src&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">worker_path</span> <span class="o">=</span> <span class="n">worker_src</span> <span class="o">/</span> <span class="n">target_worker</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">target_worker</span><span class="si">}</span><span class="s2">.py&quot;</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">manager_path</span> <span class="o">=</span> <span class="n">worker_src</span> <span class="o">/</span> <span class="n">target</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">target</span><span class="si">}</span><span class="s2">.py&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">worker_pyproject</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">worker_path</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="s2">&quot;pyproject.toml&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uvproject</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_app</span> <span class="o">/</span> <span class="s2">&quot;uv_config.toml&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataset_archive</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">worker_path</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="s2">&quot;dataset.7z&quot;</span>

        <span class="n">src_path</span> <span class="o">=</span> <span class="n">normalize_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">app_src</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">src_path</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">src_path</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">worker_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">copied_packaged_worker</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_repository_app_link</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">app_src</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_app</span> <span class="o">/</span> <span class="s2">&quot;src&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">worker_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">app_src</span> <span class="o">/</span> <span class="n">target_worker</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">target_worker</span><span class="si">}</span><span class="s2">.py&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">worker_pyproject</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">worker_path</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="s2">&quot;pyproject.toml&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dataset_archive</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">worker_path</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="s2">&quot;dataset.7z&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">packaged_app</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agilab_pck</span> <span class="o">/</span> <span class="s2">&quot;apps&quot;</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_worker_env</span> <span class="ow">and</span> <span class="n">packaged_app</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">shutil</span><span class="o">.</span><span class="n">copytree</span><span class="p">(</span>
                            <span class="n">packaged_app</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">active_app</span><span class="p">,</span>
                            <span class="n">dirs_exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="p">)</span>
                        <span class="n">copied_packaged_worker</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">AgiEnv</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                            <span class="s2">&quot;Copied packaged app </span><span class="si">%s</span><span class="s2"> into </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">packaged_app</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_app</span>
                        <span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                        <span class="n">AgiEnv</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Unable to copy packaged worker app from </span><span class="si">{</span><span class="n">packaged_app</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">exc</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
                <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_worker_env</span> <span class="ow">and</span> <span class="n">apps_root</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">copy_existing_projects</span><span class="p">(</span><span class="n">apps_root</span><span class="p">,</span> <span class="n">app</span><span class="o">.</span><span class="n">parent</span><span class="p">)</span>

                <span class="k">if</span> <span class="p">(</span>
                    <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_worker_env</span>
                    <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">worker_path</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
                    <span class="ow">and</span> <span class="n">apps_root</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
                    <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;_worker&quot;</span><span class="p">)</span>
                <span class="p">):</span>
                    <span class="n">project_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_worker&quot;</span><span class="p">,</span> <span class="s2">&quot;_project&quot;</span><span class="p">)</span>
                    <span class="n">project_worker_dir</span> <span class="o">=</span> <span class="n">apps_root</span> <span class="o">/</span> <span class="n">project_name</span> <span class="o">/</span> <span class="s2">&quot;src&quot;</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span>
                    <span class="k">if</span> <span class="n">project_worker_dir</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                        <span class="n">dest_worker_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_app</span> <span class="o">/</span> <span class="s2">&quot;src&quot;</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">shutil</span><span class="o">.</span><span class="n">copytree</span><span class="p">(</span>
                                <span class="n">project_worker_dir</span><span class="p">,</span>
                                <span class="n">dest_worker_dir</span><span class="p">,</span>
                                <span class="n">dirs_exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="p">)</span>
                            <span class="n">AgiEnv</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                                <span class="s2">&quot;Copied project worker sources </span><span class="si">%s</span><span class="s2"> into </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                                <span class="n">project_worker_dir</span><span class="p">,</span>
                                <span class="n">dest_worker_dir</span><span class="p">,</span>
                            <span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                            <span class="n">AgiEnv</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;Failed to copy worker sources from </span><span class="si">{</span><span class="n">project_worker_dir</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">exc</span><span class="si">}</span><span class="s2">&quot;</span>
                            <span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">copied_packaged_worker</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="k">if</span> <span class="n">copied_packaged_worker</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">app_src</span> <span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">active_app</span> <span class="o">/</span> <span class="s2">&quot;src&quot;</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">worker_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">app_src</span> <span class="o">/</span> <span class="n">target_worker</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">target_worker</span><span class="si">}</span><span class="s2">.py&quot;</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">worker_pyproject</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">worker_path</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="s2">&quot;pyproject.toml&quot;</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dataset_archive</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">worker_path</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="s2">&quot;dataset.7z&quot;</span>
                <span class="c1">#elif self.is_worker_env:</span>
                <span class="c1">#    AgiEnv.logger.info(</span>
                <span class="c1">#        &quot;Worker sources not found (is_worker_env=True) at %s&quot;, self.worker_path</span>
                <span class="c1">#    )</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">apps_dir</span> <span class="o">=</span> <span class="n">apps_dir</span>
        <span class="n">distribution_tree</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wenv_abs</span> <span class="o">/</span> <span class="s2">&quot;distribution_tree.json&quot;</span>
        <span class="k">if</span> <span class="n">distribution_tree</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">distribution_tree</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">distribution_tree</span> <span class="o">=</span> <span class="n">distribution_tree</span>

        <span class="n">pythonpath_entries</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collect_pythonpath_entries</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_configure_pythonpath</span><span class="p">(</span><span class="n">pythonpath_entries</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">python_version</span> <span class="o">=</span> <span class="n">envars</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;AGI_PYTHON_VERSION&quot;</span><span class="p">,</span> <span class="s2">&quot;3.13&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pyvers_worker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">python_version</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_free_threading_available</span> <span class="o">=</span> <span class="n">envars</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;AGI_PYTHON_FREE_THREADED&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="c1"># Avoid stray stdout; rely on logger when needed</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">worker_pyproject</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">worker_pyproject</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">tomlkit</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">use_freethread</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;tool&quot;</span><span class="p">][</span><span class="s2">&quot;freethread_info&quot;</span><span class="p">][</span><span class="s2">&quot;is_app_freethreaded&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">use_freethread</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_free_threading_available</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">uv_worker</span> <span class="o">=</span> <span class="s2">&quot;PYTHON_GIL=0 &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">uv</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">pyvers_worker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pyvers_worker</span> <span class="o">+</span> <span class="s2">&quot;t&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">uv_worker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">uv</span>
            <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">use_freethread</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">uv_worker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">uv</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">uv_worker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">uv</span>
            <span class="n">use_freethread</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_worker_env</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">worker_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">base_worker_cls</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_base_worker_module</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_base_worker_cls</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">worker_path</span><span class="p">,</span> <span class="n">worker_class</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">base_worker_cls</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_base_worker_module</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="c1"># In packaged end‑user environments, worker sources may be absent by design.</span>
            <span class="c1"># Proceed without exiting; the installer will materialize required files under wenv.</span>
            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_source_env</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_worker_env</span><span class="p">):</span>
                <span class="n">AgiEnv</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Missing </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">target_worker_class</span><span class="si">}</span><span class="s2"> definition; expected </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">worker_path</span><span class="si">}</span><span class="s2"> (packaged end-user env)&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">AgiEnv</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Missing </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">target_worker_class</span><span class="si">}</span><span class="s2"> definition; expected </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">worker_path</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

        <span class="n">envars</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">envars</span>
        <span class="n">raw_credentials</span> <span class="o">=</span> <span class="n">envars</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;CLUSTER_CREDENTIALS&quot;</span><span class="p">,</span> <span class="n">getpass</span><span class="o">.</span><span class="n">getuser</span><span class="p">())</span>
        <span class="n">credentials_parts</span> <span class="o">=</span> <span class="n">raw_credentials</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">credentials_parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="n">credentials_parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">credentials_parts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">ssh_key_env</span> <span class="o">=</span> <span class="n">envars</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;AGI_SSH_KEY_PATH&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">ssh_key_env</span> <span class="o">=</span> <span class="n">ssh_key_env</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ssh_key_env</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ssh_key_path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">ssh_key_env</span><span class="p">)</span><span class="o">.</span><span class="n">expanduser</span><span class="p">())</span> <span class="k">if</span> <span class="n">ssh_key_env</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">projects</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_projects</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">apps_dir</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">projects</span><span class="p">:</span>
            <span class="n">AgiEnv</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not find any target project app in </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">agilab_pck</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="s1">&#39;apps&#39;</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">setup_app</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_app</span> <span class="o">/</span> <span class="s2">&quot;build.py&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setup_app_module</span> <span class="o">=</span> <span class="s2">&quot;agi_node.agi_dispatcher.build&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">AGILAB_SHARE</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">envars</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;AGI_SHARE_DIR&quot;</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">))</span>
        <span class="n">data_rel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">AGILAB_SHARE</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataframe_path</span> <span class="o">=</span> <span class="n">data_rel</span> <span class="o">/</span> <span class="s2">&quot;dataframe&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_rel</span> <span class="o">=</span> <span class="n">data_rel</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_projects</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">scheduler_ip</span> <span class="o">=</span> <span class="n">envars</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;AGI_SCHEDULER_IP&quot;</span><span class="p">,</span> <span class="s2">&quot;127.0.0.1&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_valid_ip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scheduler_ip</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid scheduler IP address: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">scheduler_ip</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_source_env</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">help_path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agilab_pck</span><span class="o">.</span><span class="n">parents</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="s2">&quot;docs/html&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">help_path</span> <span class="o">=</span> <span class="s2">&quot;https://thalesgroup.github.io/agilab&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">AGILAB_SHARE</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">envars</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;AGI_SHARE_DIR&quot;</span><span class="p">,</span> <span class="n">home_abs</span> <span class="o">/</span> <span class="s2">&quot;data&quot;</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">app_src</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">app_src_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">app_src</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">app_src_str</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">app_src_str</span><span class="p">)</span>

        <span class="c1"># Populate examples/apps in standard environments</span>
        <span class="k">if</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">examples_candidates</span> <span class="o">=</span> <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">agilab_pck</span> <span class="o">/</span> <span class="s2">&quot;agilab/examples&quot;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">agilab_pck</span> <span class="o">/</span> <span class="s2">&quot;examples&quot;</span><span class="p">,</span>
            <span class="p">]</span>
            <span class="k">for</span> <span class="n">candidate</span> <span class="ow">in</span> <span class="n">examples_candidates</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">candidate</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">examples</span> <span class="o">=</span> <span class="n">candidate</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">examples</span> <span class="o">=</span> <span class="n">examples_candidates</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="c1"># examples path available via singleton delegation if accessed as AgiEnv.examples</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">init_envars_app</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">envars</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_init_apps</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;nt&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">export_local_bin</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">export_local_bin</span> <span class="o">=</span> <span class="s1">&#39;export PATH=&quot;~/.local/bin:$PATH&quot;;&#39;</span></div>

        <span class="c1"># export_local_bin available via singleton delegation if accessed as AgiEnv.export_local_bin</span>


    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_resolve_package</span><span class="p">(</span><span class="n">root</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the ``src`` directory for a package when present.</span>

<span class="sd">        Many AGILab components follow the ``src/`` layout; when that folder is</span>
<span class="sd">        missing the package root itself is returned.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">src_dir</span> <span class="o">=</span> <span class="n">root</span> <span class="o">/</span> <span class="s2">&quot;src&quot;</span> <span class="o">/</span> <span class="n">root</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">src_dir</span> <span class="k">if</span> <span class="n">src_dir</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span> <span class="k">else</span> <span class="n">root</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_apps_repository_root</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the apps repository directory when ``APPS_REPOSITORY`` is configured.&quot;&quot;&quot;</span>

        <span class="n">repo_root</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">envars</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;APPS_REPOSITORY&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;APPS_REPOSITORY&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">repo_root</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">repo_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">repo_root</span><span class="p">)</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span>

        <span class="n">candidate</span> <span class="o">=</span> <span class="n">repo_path</span> <span class="o">/</span> <span class="s2">&quot;src/agilab/apps&quot;</span>
        <span class="k">if</span> <span class="n">candidate</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">candidate</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">alt</span> <span class="ow">in</span> <span class="n">repo_path</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;**/apps&quot;</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">child</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;_project&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">alt</span><span class="o">.</span><span class="n">iterdir</span><span class="p">()):</span>
                        <span class="k">return</span> <span class="n">alt</span>
                <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                    <span class="k">continue</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="n">AgiEnv</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error while scanning apps repository: </span><span class="si">{</span><span class="n">exc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">AgiEnv</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;APPS_REPOSITORY is set but apps directory is missing under </span><span class="si">{</span><span class="n">repo_path</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_collect_pythonpath_entries</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Build an ordered list of paths that must live on ``PYTHONPATH``.&quot;&quot;&quot;</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">import_root</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Return the directory that must be added to ``PYTHONPATH`` for ``path``.&quot;&quot;&quot;</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">init_file</span> <span class="o">=</span> <span class="n">path</span> <span class="o">/</span> <span class="s2">&quot;__init__.py&quot;</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">path</span>

            <span class="k">if</span> <span class="n">init_file</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="k">return</span> <span class="n">path</span><span class="o">.</span><span class="n">parent</span>
            <span class="k">return</span> <span class="n">path</span>

        <span class="n">candidates</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">import_root</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env_pck</span><span class="o">.</span><span class="n">parent</span><span class="p">),</span>
            <span class="n">import_root</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node_pck</span><span class="o">.</span><span class="n">parent</span><span class="p">),</span>
            <span class="n">import_root</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">core_pck</span><span class="o">.</span><span class="n">parent</span><span class="p">),</span>
            <span class="n">import_root</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cluster_pck</span><span class="o">.</span><span class="n">parent</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dist_abs</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">app_src</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wenv_abs</span> <span class="o">/</span> <span class="s2">&quot;src&quot;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">agilab_pck</span> <span class="o">/</span> <span class="s2">&quot;agilab&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dedupe_paths</span><span class="p">(</span><span class="n">candidates</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_configure_pythonpath</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entries</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Inject ``entries`` into both ``sys.path`` and the ``PYTHONPATH`` env var.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_pythonpath_entries</span> <span class="o">=</span> <span class="n">entries</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">entries</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">entry</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>
        <span class="n">current</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;PYTHONPATH&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">combined</span> <span class="o">=</span> <span class="n">entries</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">current</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">current</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">pathsep</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">part</span> <span class="ow">and</span> <span class="n">part</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">combined</span><span class="p">:</span>
                    <span class="n">combined</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">part</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;PYTHONPATH&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">pathsep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">combined</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_dedupe_paths</span><span class="p">(</span><span class="n">paths</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Collapse ``paths`` into a list of unique, existing filesystem entries.&quot;&quot;&quot;</span>

        <span class="n">seen</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">result</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">paths</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">path_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">path_str</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">Path</span><span class="p">(</span><span class="n">path_str</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">path_str</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">path_str</span><span class="p">)</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path_str</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>

<div class="viewcode-block" id="AgiEnv.has_agilab_anywhere_under_home">
<a class="viewcode-back" href="../../agi-env.html#agi_env.agi_env.AgiEnv.has_agilab_anywhere_under_home">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">has_agilab_anywhere_under_home</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return ``True`` when ``path`` sits under the user&#39;s home ``agilab`` tree.&quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">rel</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span><span class="o">.</span><span class="n">relative_to</span><span class="p">(</span><span class="n">Path</span><span class="o">.</span><span class="n">home</span><span class="p">())</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>  <span class="c1"># pas sous ~</span>
        <span class="k">return</span> <span class="s2">&quot;agilab&quot;</span> <span class="ow">in</span> <span class="n">rel</span><span class="o">.</span><span class="n">parts</span></div>


<div class="viewcode-block" id="AgiEnv.active">
<a class="viewcode-back" href="../../agi-env.html#agi_env.agi_env.AgiEnv.active">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">active</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Switch :attr:`app` to ``target`` if it differs from the current one.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="p">)</span> <span class="o">!=</span> <span class="n">target</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">change_app</span><span class="p">(</span><span class="n">target</span><span class="p">)</span></div>


<div class="viewcode-block" id="AgiEnv.humanize_validation_errors">
<a class="viewcode-back" href="../../agi-env.html#agi_env.agi_env.AgiEnv.humanize_validation_errors">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">humanize_validation_errors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">error</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Format pydantic-style validation ``error`` messages for human consumption.&quot;&quot;&quot;</span>

        <span class="n">formatted_errors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">err</span> <span class="ow">in</span> <span class="n">error</span><span class="o">.</span><span class="n">errors</span><span class="p">():</span>
            <span class="n">field</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">loc</span><span class="p">)</span> <span class="k">for</span> <span class="n">loc</span> <span class="ow">in</span> <span class="n">err</span><span class="p">[</span><span class="s2">&quot;loc&quot;</span><span class="p">])</span>
            <span class="n">message</span> <span class="o">=</span> <span class="n">err</span><span class="p">[</span><span class="s2">&quot;msg&quot;</span><span class="p">]</span>
            <span class="n">error_type</span> <span class="o">=</span> <span class="n">err</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="s2">&quot;unknown_error&quot;</span><span class="p">)</span>
            <span class="n">input_value</span> <span class="o">=</span> <span class="n">err</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ctx&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;input_value&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">user_message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;❌ **</span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s2">**: </span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="n">input_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">user_message</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; (Received: `</span><span class="si">{</span><span class="n">input_value</span><span class="si">}</span><span class="s2">`)&quot;</span>
            <span class="n">user_message</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;*Error Type:* `</span><span class="si">{</span><span class="n">error_type</span><span class="si">}</span><span class="s2">`&quot;</span>
            <span class="n">formatted_errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">user_message</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">formatted_errors</span></div>


<div class="viewcode-block" id="AgiEnv.set_env_var">
<a class="viewcode-back" href="../../agi-env.html#agi_env.agi_env.AgiEnv.set_env_var">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_env_var</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Persist ``key``/``value`` in :attr:`envars`, ``os.environ`` and the ``.env`` file.&quot;&quot;&quot;</span>
        <span class="n">AgiEnv</span><span class="o">.</span><span class="n">_ensure_defaults</span><span class="p">()</span>
        <span class="n">AgiEnv</span><span class="o">.</span><span class="n">envars</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="n">AgiEnv</span><span class="o">.</span><span class="n">_update_env_file</span><span class="p">({</span><span class="n">key</span><span class="p">:</span> <span class="n">value</span><span class="p">})</span></div>


    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_ensure_defaults</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Ensure minimal class-level defaults exist for limited static usage.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s2">&quot;resources_path&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">cls</span><span class="o">.</span><span class="n">resources_path</span> <span class="o">=</span> <span class="n">Path</span><span class="o">.</span><span class="n">home</span><span class="p">()</span> <span class="o">/</span> <span class="s2">&quot;.agilab&quot;</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="bp">cls</span><span class="o">.</span><span class="n">resources_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;.agilab&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s2">&quot;envars&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">envars</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">env_path</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">resources_path</span> <span class="o">/</span> <span class="s2">&quot;.env&quot;</span>
                <span class="bp">cls</span><span class="o">.</span><span class="n">envars</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">dotenv_values</span><span class="p">(</span><span class="n">dotenv_path</span><span class="o">=</span><span class="n">env_path</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="bp">cls</span><span class="o">.</span><span class="n">envars</span> <span class="o">=</span> <span class="p">{}</span>

<div class="viewcode-block" id="AgiEnv.read_agilab_path">
<a class="viewcode-back" href="../../agi-env.html#agi_env.agi_env.AgiEnv.read_agilab_path">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">read_agilab_path</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the persisted AGILab installation path if previously recorded.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;nt&quot;</span><span class="p">:</span>
            <span class="n">where_is_agi</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;LOCALAPPDATA&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span> <span class="o">/</span> <span class="s2">&quot;agilab/.agilab-path&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">where_is_agi</span> <span class="o">=</span> <span class="n">Path</span><span class="o">.</span><span class="n">home</span><span class="p">()</span> <span class="o">/</span> <span class="s2">&quot;.local/share/agilab/.agilab-path&quot;</span>

        <span class="k">if</span> <span class="n">where_is_agi</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">where_is_agi</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8-sig&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">install_path</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="n">agilab_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">install_path</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">install_path</span> <span class="ow">and</span> <span class="n">agilab_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                        <span class="k">return</span> <span class="n">agilab_path</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Installation path file is empty or invalid.&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
                <span class="n">logger</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">AgiEnv</span><span class="p">,</span> <span class="s2">&quot;logger&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">logger</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File </span><span class="si">{</span><span class="n">where_is_agi</span><span class="si">}</span><span class="s2"> does not exist.&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">PermissionError</span><span class="p">:</span>
                <span class="n">logger</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">AgiEnv</span><span class="p">,</span> <span class="s2">&quot;logger&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">logger</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Permission denied when accessing </span><span class="si">{</span><span class="n">where_is_agi</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">AgiEnv</span><span class="p">,</span> <span class="s2">&quot;logger&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">logger</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;An error occurred: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="AgiEnv.locate_agilab_installation">
<a class="viewcode-back" href="../../agi-env.html#agi_env.agi_env.AgiEnv.locate_agilab_installation">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">locate_agilab_installation</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Attempt to locate the installed AGILab package path on disk.&quot;&quot;&quot;</span>

        <span class="n">base_dir</span><span class="p">:</span> <span class="n">Path</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">path_importer_cache</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">p</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;agi_env&quot;</span><span class="p">):</span>
                <span class="n">base_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">base_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">base_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span><span class="o">.</span><span class="n">parents</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="s2">&quot;agi_env&quot;</span>

        <span class="n">before</span><span class="p">,</span> <span class="n">sep</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">base_dir</span><span class="p">)</span><span class="o">.</span><span class="n">rpartition</span><span class="p">(</span><span class="s2">&quot;agilab&quot;</span><span class="p">)</span>
        <span class="n">candidate_repo</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">before</span><span class="p">)</span> <span class="o">/</span> <span class="n">sep</span> <span class="k">if</span> <span class="n">sep</span> <span class="k">else</span> <span class="n">base_dir</span><span class="o">.</span><span class="n">parent</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">candidate_repo</span> <span class="o">/</span> <span class="s2">&quot;apps&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">candidate_repo</span>
        <span class="k">return</span> <span class="n">base_dir</span><span class="o">.</span><span class="n">parent</span></div>


<div class="viewcode-block" id="AgiEnv.copy_existing_projects">
<a class="viewcode-back" href="../../agi-env.html#agi_env.agi_env.AgiEnv.copy_existing_projects">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">copy_existing_projects</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src_apps</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">dst_apps</span><span class="p">:</span> <span class="n">Path</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Copy ``*_project`` trees from ``src_apps`` into ``dst_apps`` if missing.&quot;&quot;&quot;</span>

        <span class="n">dst_apps</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">AgiEnv</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;copy_existing_projects src=</span><span class="si">{</span><span class="n">src_apps</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span><span class="si">}</span><span class="s2"> dst=</span><span class="si">{</span><span class="n">dst_apps</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">candidates</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">src_apps</span><span class="o">.</span><span class="n">rglob</span><span class="p">(</span><span class="s2">&quot;*_project&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">is_dir</span><span class="p">()]</span>
        <span class="n">AgiEnv</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Matched projects: &quot;</span> <span class="o">+</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">relative_to</span><span class="p">(</span><span class="n">src_apps</span><span class="p">))</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">candidates</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&lt;none&gt;&quot;</span><span class="p">)</span>

        <span class="c1"># match every nested directory ending with &quot;_project&quot;</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">src_apps</span><span class="o">.</span><span class="n">rglob</span><span class="p">(</span><span class="s2">&quot;*_project&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">item</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
                <span class="k">continue</span>

            <span class="n">rel</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">relative_to</span><span class="p">(</span><span class="n">src_apps</span><span class="p">)</span>  <span class="c1"># keep nested structure</span>
            <span class="n">dst_item</span> <span class="o">=</span> <span class="n">dst_apps</span> <span class="o">/</span> <span class="n">rel</span>
            <span class="k">if</span> <span class="n">dst_item</span><span class="o">.</span><span class="n">is_symlink</span><span class="p">():</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">dst_item</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                    <span class="n">AgiEnv</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Failed to remove dangling project symlink </span><span class="si">{</span><span class="n">dst_item</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">exc</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                    <span class="k">continue</span>
            <span class="k">elif</span> <span class="n">dst_item</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">dst_item</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">dst_item</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                    <span class="n">AgiEnv</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Failed to remove conflicting project file </span><span class="si">{</span><span class="n">dst_item</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">exc</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                    <span class="k">continue</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">copytree</span><span class="p">(</span>
                    <span class="n">item</span><span class="p">,</span>
                    <span class="n">dst_item</span><span class="p">,</span>
                    <span class="n">dirs_exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># merge into existing tree</span>
                    <span class="n">symlinks</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># keep symlinks as symlinks</span>
                    <span class="n">ignore</span><span class="o">=</span><span class="n">shutil</span><span class="o">.</span><span class="n">ignore_patterns</span><span class="p">(</span>  <span class="c1"># skip bulky/ephemeral stuff</span>
                        <span class="s2">&quot;.venv&quot;</span><span class="p">,</span> <span class="s2">&quot;build&quot;</span><span class="p">,</span> <span class="s2">&quot;dist&quot;</span><span class="p">,</span> <span class="s2">&quot;__pycache__&quot;</span><span class="p">,</span> <span class="s2">&quot;.pytest_cache&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;.idea&quot;</span><span class="p">,</span> <span class="s2">&quot;.mypy_cache&quot;</span><span class="p">,</span> <span class="s2">&quot;.ruff_cache&quot;</span><span class="p">,</span> <span class="s2">&quot;*.egg-info&quot;</span>
                    <span class="p">),</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">AgiEnv</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Could not copy </span><span class="si">{</span><span class="n">item</span><span class="si">}</span><span class="s2"> → </span><span class="si">{</span><span class="n">dst_item</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


    <span class="c1"># Simplified: keep single copy_missing implementation defined later using _copy_file</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_update_env_file</span><span class="p">(</span><span class="n">updates</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">AgiEnv</span><span class="o">.</span><span class="n">_ensure_defaults</span><span class="p">()</span>
        <span class="n">env_file</span> <span class="o">=</span> <span class="n">AgiEnv</span><span class="o">.</span><span class="n">resources_path</span> <span class="o">/</span> <span class="s2">&quot;.env&quot;</span>
        <span class="c1"># Ensure parent directory exists for pre-init usage</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">env_file</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">updates</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">set_key</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">env_file</span><span class="p">),</span> <span class="n">k</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">),</span> <span class="n">quote_mode</span><span class="o">=</span><span class="s2">&quot;never&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_init_resources</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resources_src</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Replicate ``resources_src`` into the managed ``.agilab`` tree.&quot;&quot;&quot;</span>

        <span class="n">src_env_path</span> <span class="o">=</span> <span class="n">resources_src</span> <span class="o">/</span> <span class="s2">&quot;.env&quot;</span>
        <span class="n">dest_env_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resources_path</span> <span class="o">/</span> <span class="s2">&quot;.env&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">dest_env_file</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">dest_env_file</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">src_env_path</span><span class="p">,</span> <span class="n">dest_env_file</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">root</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">resources_src</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
                <span class="n">src_file</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">root</span><span class="p">)</span> <span class="o">/</span> <span class="n">file</span>
                <span class="n">relative_path</span> <span class="o">=</span> <span class="n">src_file</span><span class="o">.</span><span class="n">relative_to</span><span class="p">(</span><span class="n">resources_src</span><span class="p">)</span>
                <span class="n">dest_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resources_path</span> <span class="o">/</span> <span class="n">relative_path</span>
                <span class="n">dest_file</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">dest_file</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                    <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">src_file</span><span class="p">,</span> <span class="n">dest_file</span><span class="p">)</span>

        <span class="c1"># Ensure UI assets required by Streamlit editors are present.</span>
        <span class="n">extras</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;custom_buttons.json&quot;</span><span class="p">,</span>
            <span class="s2">&quot;info_bar.json&quot;</span><span class="p">,</span>
            <span class="s2">&quot;code_editor.scss&quot;</span><span class="p">,</span>
        <span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_source_env</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">extra</span> <span class="ow">in</span> <span class="n">extras</span><span class="p">:</span>
                <span class="n">src_extra</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">st_resources</span> <span class="o">/</span> <span class="n">extra</span>
                <span class="n">dest_extra</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resources_path</span> <span class="o">/</span> <span class="n">extra</span>
                <span class="k">if</span> <span class="n">src_extra</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">dest_extra</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                    <span class="n">dest_extra</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">src_extra</span><span class="p">,</span> <span class="n">dest_extra</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">extra</span> <span class="ow">in</span> <span class="n">extras</span><span class="p">:</span>
                <span class="n">dest_extra</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resources_path</span> <span class="o">/</span> <span class="n">extra</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">dest_extra</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                        <span class="n">dest_extra</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                    <span class="n">AgiEnv</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not remove legacy resource </span><span class="si">{</span><span class="n">dest_extra</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_init_projects</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Identify available projects and align state with the selected target.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">projects</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_projects</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">apps_dir</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">project</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">projects</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span> <span class="o">==</span> <span class="n">project</span><span class="p">[:</span><span class="o">-</span><span class="mi">8</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">app</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">apps_dir</span> <span class="o">/</span> <span class="n">project</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">app</span> <span class="o">=</span> <span class="n">project</span>
                <span class="k">break</span>

<div class="viewcode-block" id="AgiEnv.get_projects">
<a class="viewcode-back" href="../../agi-env.html#agi_env.agi_env.AgiEnv.get_projects">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_projects</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n">Path</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the names of ``*_project`` directories beneath ``path``.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="n">projects</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">project_path</span> <span class="ow">in</span> <span class="n">path</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*project&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">project_path</span><span class="o">.</span><span class="n">is_symlink</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">project_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">project_path</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
                    <span class="n">AgiEnv</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Removed dangling project symlink: </span><span class="si">{</span><span class="n">project_path</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                    <span class="n">AgiEnv</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Failed to remove dangling project symlink </span><span class="si">{</span><span class="n">project_path</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">exc</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">project_path</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
                <span class="n">projects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">project_path</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">projects</span></div>


<div class="viewcode-block" id="AgiEnv.get_base_worker_cls">
<a class="viewcode-back" href="../../agi-env.html#agi_env.agi_env.AgiEnv.get_base_worker_cls">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_base_worker_cls</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module_path</span><span class="p">,</span> <span class="n">class_name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the base worker class name and module for ``class_name``.&quot;&quot;&quot;</span>

        <span class="n">base_info_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_base_classes</span><span class="p">(</span><span class="n">module_path</span><span class="p">,</span> <span class="n">class_name</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">base_class</span><span class="p">,</span> <span class="n">module_name</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">base</span><span class="p">,</span> <span class="n">mod</span><span class="p">)</span> <span class="k">for</span> <span class="n">base</span><span class="p">,</span> <span class="n">mod</span> <span class="ow">in</span> <span class="n">base_info_list</span> <span class="k">if</span> <span class="n">base</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;Worker&quot;</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">base_class</span><span class="p">,</span> <span class="n">module_name</span>
        <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="AgiEnv.get_base_classes">
<a class="viewcode-back" href="../../agi-env.html#agi_env.agi_env.AgiEnv.get_base_classes">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_base_classes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module_path</span><span class="p">,</span> <span class="n">class_name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Inspect ``module_path`` AST to retrieve base classes of ``class_name``.&quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">module_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
                <span class="n">source</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">IOError</span><span class="p">,</span> <span class="ne">FileNotFoundError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">AgiEnv</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error reading module file </span><span class="si">{</span><span class="n">module_path</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">tree</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">SyntaxError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">AgiEnv</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Syntax error parsing </span><span class="si">{</span><span class="n">module_path</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Syntax error parsing </span><span class="si">{</span><span class="n">module_path</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">import_mapping</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_import_mapping</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
        <span class="n">base_classes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">ast</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">tree</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">ClassDef</span><span class="p">)</span> <span class="ow">and</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">class_name</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">base</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">bases</span><span class="p">:</span>
                    <span class="n">base_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_base_info</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">import_mapping</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">base_info</span><span class="p">:</span>
                        <span class="n">base_classes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">base_info</span><span class="p">)</span>
                <span class="k">break</span>
        <span class="k">return</span> <span class="n">base_classes</span></div>


<div class="viewcode-block" id="AgiEnv.get_import_mapping">
<a class="viewcode-back" href="../../agi-env.html#agi_env.agi_env.AgiEnv.get_import_mapping">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_import_mapping</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Build a mapping of names to modules from ``import`` statements in ``source``.&quot;&quot;&quot;</span>

        <span class="n">mapping</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">tree</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">SyntaxError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">AgiEnv</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Syntax error during import mapping: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">ast</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">tree</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Import</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">alias</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
                    <span class="n">mapping</span><span class="p">[</span><span class="n">alias</span><span class="o">.</span><span class="n">asname</span> <span class="ow">or</span> <span class="n">alias</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">alias</span><span class="o">.</span><span class="n">name</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">ImportFrom</span><span class="p">):</span>
                <span class="n">module</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">module</span>
                <span class="k">for</span> <span class="n">alias</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
                    <span class="n">mapping</span><span class="p">[</span><span class="n">alias</span><span class="o">.</span><span class="n">asname</span> <span class="ow">or</span> <span class="n">alias</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">module</span>
        <span class="k">return</span> <span class="n">mapping</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_ensure_repository_app_link</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a symlink to a repository app when the public tree is missing it.&quot;&quot;&quot;</span>

        <span class="n">link_root</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_apps_repository_root</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">link_root</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="n">candidate</span> <span class="o">=</span> <span class="n">link_root</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">candidate</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="n">dest</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_app</span>
        <span class="k">if</span> <span class="n">dest</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">dest</span><span class="o">.</span><span class="n">is_symlink</span><span class="p">():</span>
                <span class="n">dest</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="n">dest</span><span class="o">.</span><span class="n">symlink_to</span><span class="p">(</span><span class="n">candidate</span><span class="p">,</span> <span class="n">target_is_directory</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">AgiEnv</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Created apps repository symlink: </span><span class="si">%s</span><span class="s2"> -&gt; </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">candidate</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>

<div class="viewcode-block" id="AgiEnv.extract_base_info">
<a class="viewcode-back" href="../../agi-env.html#agi_env.agi_env.AgiEnv.extract_base_info">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">extract_base_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">import_mapping</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the base-class name and originating module for ``base`` nodes.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">):</span>
            <span class="n">module_name</span> <span class="o">=</span> <span class="n">import_mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">base</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">base</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">module_name</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Attribute</span><span class="p">):</span>
            <span class="n">full_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_full_attribute_name</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="n">full_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">alias</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">module_name</span> <span class="o">=</span> <span class="n">import_mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="n">alias</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">parts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">module_name</span>
            <span class="k">return</span> <span class="n">base</span><span class="o">.</span><span class="n">attr</span><span class="p">,</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="AgiEnv.get_full_attribute_name">
<a class="viewcode-back" href="../../agi-env.html#agi_env.agi_env.AgiEnv.get_full_attribute_name">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_full_attribute_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Reconstruct the dotted attribute path represented by ``node``.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">node</span><span class="o">.</span><span class="n">id</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Attribute</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_full_attribute_name</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">node</span><span class="o">.</span><span class="n">attr</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span></div>


<div class="viewcode-block" id="AgiEnv.mode2str">
<a class="viewcode-back" href="../../agi-env.html#agi_env.agi_env.AgiEnv.mode2str">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">mode2str</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Encode a bitmask ``mode`` into readable ``pcdr`` flag form.&quot;&quot;&quot;</span>

        <span class="n">chars</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;p&quot;</span><span class="p">,</span> <span class="s2">&quot;c&quot;</span><span class="p">,</span> <span class="s2">&quot;d&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">]</span>
        <span class="n">reversed_chars</span> <span class="o">=</span> <span class="nb">reversed</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="n">chars</span><span class="p">)))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hw_rapids_capable</span><span class="p">:</span>
            <span class="n">mode</span> <span class="o">+=</span> <span class="mi">8</span>
        <span class="n">mode_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="s2">&quot;_&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">v</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">reversed_chars</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">mode_str</span></div>


<div class="viewcode-block" id="AgiEnv.mode2int">
<a class="viewcode-back" href="../../agi-env.html#agi_env.agi_env.AgiEnv.mode2int">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">mode2int</span><span class="p">(</span><span class="n">mode</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert an iterable of mode flags (``p``, ``c``, ``d``) to the bitmask int.&quot;&quot;&quot;</span>

        <span class="n">mode_int</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">set_rm</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="s2">&quot;p&quot;</span><span class="p">,</span> <span class="s2">&quot;c&quot;</span><span class="p">,</span> <span class="s2">&quot;d&quot;</span><span class="p">]):</span>
            <span class="k">if</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">set_rm</span><span class="p">:</span>
                <span class="n">mode_int</span> <span class="o">+=</span> <span class="mi">2</span> <span class="o">**</span> <span class="p">(</span><span class="nb">len</span><span class="p">([</span><span class="s2">&quot;p&quot;</span><span class="p">,</span> <span class="s2">&quot;c&quot;</span><span class="p">,</span> <span class="s2">&quot;d&quot;</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">i</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">mode_int</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">is_valid_ip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ip</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return ``True`` when ``ip`` is a syntactically valid IPv4 address.&quot;&quot;&quot;</span>

        <span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^(?:[0-9]{1,3}\.)</span><span class="si">{3}</span><span class="s2">[0-9]{1,3}$&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">ip</span><span class="p">):</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="n">ip</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="nb">int</span><span class="p">(</span><span class="n">part</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">255</span> <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">parts</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>

<div class="viewcode-block" id="AgiEnv.init_envars_app">
<a class="viewcode-back" href="../../agi-env.html#agi_env.agi_env.AgiEnv.init_envars_app">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">init_envars_app</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">envars</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Cache frequently used environment variables and ensure directories exist.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">CLUSTER_CREDENTIALS</span> <span class="o">=</span> <span class="n">envars</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;CLUSTER_CREDENTIALS&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">OPENAI_API_KEY</span> <span class="o">=</span> <span class="n">envars</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;OPENAI_API_KEY&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">OPENAI_MODEL</span> <span class="o">=</span> <span class="n">envars</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;OPENAI_MODEL&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">get_default_openai_model</span><span class="p">()</span>
        <span class="n">AGILAB_LOG_ABS</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">envars</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;AGI_LOG_DIR&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">home_abs</span> <span class="o">/</span> <span class="s2">&quot;log&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">AGILAB_LOG_ABS</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">AGILAB_LOG_ABS</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">AGILAB_LOG_ABS</span> <span class="o">=</span> <span class="n">AGILAB_LOG_ABS</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runenv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">examples</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span>
        <span class="n">AGILAB_EXPORT_ABS</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">envars</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;AGI_EXPORT_DIR&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">home_abs</span> <span class="o">/</span> <span class="s2">&quot;export&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">AGILAB_EXPORT_ABS</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">AGILAB_EXPORT_ABS</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">AGILAB_EXPORT_ABS</span> <span class="o">=</span> <span class="n">AGILAB_EXPORT_ABS</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">export_apps</span> <span class="o">=</span> <span class="n">AGILAB_EXPORT_ABS</span> <span class="o">/</span> <span class="s2">&quot;apps&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">export_apps</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">export_apps</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">MLFLOW_TRACKING_DIR</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">envars</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;MLFLOW_TRACKING_DIR&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">home_abs</span> <span class="o">/</span> <span class="s2">&quot;.mlflow&quot;</span><span class="p">))</span>
        <span class="n">pages_override</span> <span class="o">=</span> <span class="n">envars</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;AGI_PAGES_DIR&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pages_override</span><span class="p">:</span>
            <span class="n">pages_root</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">pages_override</span><span class="p">)</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">candidates</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">agilab_pck</span> <span class="o">/</span> <span class="s2">&quot;agilab/apps-pages&quot;</span><span class="p">,</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">agilab_pck</span> <span class="o">/</span> <span class="s2">&quot;apps-pages&quot;</span><span class="p">]</span>
            <span class="n">repo_hint</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_agilab_path</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">repo_hint</span><span class="p">:</span>
                <span class="n">repo_hint</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">repo_hint</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">suffix</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;apps-pages&quot;</span><span class="p">,</span> <span class="s2">&quot;agilab/apps-pages&quot;</span><span class="p">):</span>
                    <span class="n">candidates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">repo_hint</span> <span class="o">/</span> <span class="n">suffix</span><span class="p">)</span>

            <span class="n">pages_root</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">c</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">candidates</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">and</span> <span class="n">c</span><span class="o">.</span><span class="n">exists</span><span class="p">()),</span> <span class="n">candidates</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">AGILAB_PAGES_ABS</span> <span class="o">=</span> <span class="n">pages_root</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">AGILAB_PAGES_ABS</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">AgiEnv</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AGILAB_PAGES_ABS missing: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">AGILAB_PAGES_ABS</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">copilot_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agilab_pck</span> <span class="o">/</span> <span class="s2">&quot;agi_codex.py&quot;</span></div>



    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_copy_file</span><span class="p">(</span><span class="n">src_item</span><span class="p">,</span> <span class="n">dst_item</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Copy ``src_item`` to ``dst_item`` if the destination does not exist.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">dst_item</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">src_item</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="n">logger</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">AgiEnv</span><span class="p">,</span> <span class="s2">&quot;logger&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">logger</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[WARN] Source file missing (skipped): </span><span class="si">{</span><span class="n">src_item</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="n">src_item</span><span class="p">,</span> <span class="n">dst_item</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">AgiEnv</span><span class="p">,</span> <span class="s2">&quot;logger&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">logger</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[WARN] Could not copy </span><span class="si">{</span><span class="n">src_item</span><span class="si">}</span><span class="s2"> → </span><span class="si">{</span><span class="n">dst_item</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># def copy_missing(self, src: Path, dst: Path, max_workers=8):</span>
    <span class="c1">#     dst.mkdir(parents=True, exist_ok=True)</span>
    <span class="c1">#     to_copy = []</span>
    <span class="c1">#     dirs = []</span>
    <span class="c1">#</span>
    <span class="c1">#     for item in src.iterdir():</span>
    <span class="c1">#         src_item = item</span>
    <span class="c1">#         dst_item = dst / item.name</span>
    <span class="c1">#         if src_item.is_dir():</span>
    <span class="c1">#             dirs.append((src_item, dst_item))</span>
    <span class="c1">#         else:</span>
    <span class="c1">#             to_copy.append((src_item, dst_item))</span>
    <span class="c1">#</span>
    <span class="c1">#     # Parallel file copy</span>
    <span class="c1">#     with ThreadPoolExecutor(max_workers=max_workers) as executor:</span>
    <span class="c1">#         list(executor.map(lambda args: AgiEnv._copy_file(*args), to_copy))</span>
    <span class="c1">#</span>
    <span class="c1">#     # Recurse into directories</span>
    <span class="c1">#     for src_dir, dst_dir in dirs:</span>
    <span class="c1">#         self.copy_missing(src_dir, dst_dir, max_workers=max_workers)</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">_init_apps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">app_settings_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">app_src</span> <span class="o">/</span> <span class="s2">&quot;app_settings.toml&quot;</span>
        <span class="n">app_settings_file</span><span class="o">.</span><span class="n">touch</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">app_settings_file</span> <span class="o">=</span> <span class="n">app_settings_file</span>

        <span class="n">app_args_form</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">app_src</span> <span class="o">/</span> <span class="s2">&quot;app_args_form.py&quot;</span>
        <span class="n">app_args_form</span><span class="o">.</span><span class="n">touch</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">app_args_form</span> <span class="o">=</span> <span class="n">app_args_form</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">gitignore_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_app</span> <span class="o">/</span> <span class="s2">&quot;.gitignore&quot;</span>
        <span class="n">dest</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resources_path</span>
        <span class="n">src</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agilab_pck</span> <span class="o">/</span> <span class="s2">&quot;resources&quot;</span>
        <span class="k">if</span> <span class="n">src</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">src</span><span class="o">.</span><span class="n">iterdir</span><span class="p">():</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">file</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
                    <span class="k">continue</span>
                <span class="n">dest_file</span> <span class="o">=</span> <span class="n">dest</span> <span class="o">/</span> <span class="n">file</span><span class="o">.</span><span class="n">name</span>
                <span class="k">if</span> <span class="n">dest_file</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                    <span class="k">continue</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">dest_file</span><span class="p">)</span>
        <span class="c1"># shutil.copytree(self.agilab_pck / &quot;resources&quot;, dest, dirs_exist_ok=True)</span>


    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_build_env</span><span class="p">(</span><span class="n">venv</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Build environment dict for subprocesses, with activated virtualenv paths.&quot;&quot;&quot;</span>
        <span class="n">proc_env</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">venv_path</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">venv</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">venv_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">venv</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">venv_path</span> <span class="o">/</span> <span class="s2">&quot;bin&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span> <span class="ow">and</span> <span class="n">venv_path</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="s2">&quot;.venv&quot;</span><span class="p">:</span>
                <span class="n">venv_path</span> <span class="o">=</span> <span class="n">venv_path</span> <span class="o">/</span> <span class="s2">&quot;.venv&quot;</span>
            <span class="n">proc_env</span><span class="p">[</span><span class="s2">&quot;VIRTUAL_ENV&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">venv_path</span><span class="p">)</span>
            <span class="n">bin_path</span> <span class="o">=</span> <span class="s2">&quot;Scripts&quot;</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;nt&quot;</span> <span class="k">else</span> <span class="s2">&quot;bin&quot;</span>
            <span class="n">venv_bin</span> <span class="o">=</span> <span class="n">venv_path</span> <span class="o">/</span> <span class="n">bin_path</span>
            <span class="n">proc_env</span><span class="p">[</span><span class="s2">&quot;PATH&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">venv_bin</span><span class="p">)</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">pathsep</span> <span class="o">+</span> <span class="n">proc_env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;PATH&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="n">instance</span> <span class="o">=</span> <span class="n">AgiEnv</span><span class="o">.</span><span class="n">_instance</span>
        <span class="k">if</span> <span class="n">instance</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="s2">&quot;_pythonpath_entries&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">extra_paths</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">_pythonpath_entries</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">extra_paths</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">AgiEnv</span><span class="o">.</span><span class="n">_pythonpath_entries</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">venv_path</span> <span class="ow">and</span> <span class="n">Path</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">prefix</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span> <span class="o">!=</span> <span class="n">venv_path</span><span class="o">.</span><span class="n">resolve</span><span class="p">():</span>
            <span class="n">tree_root</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">prefix</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>
            <span class="n">filtered</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">extra_paths</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">entry</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">resolved</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">filtered</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">tree_root</span> <span class="ow">in</span> <span class="n">resolved</span><span class="o">.</span><span class="n">parents</span> <span class="ow">or</span> <span class="n">resolved</span> <span class="o">==</span> <span class="n">tree_root</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">filtered</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">resolved</span><span class="p">))</span>
            <span class="n">extra_paths</span> <span class="o">=</span> <span class="n">filtered</span>
        <span class="n">proc_env</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;PYTHONPATH&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">proc_env</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;PYTHONHOME&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">extra_paths</span><span class="p">:</span>
            <span class="n">current</span> <span class="o">=</span> <span class="n">proc_env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;PYTHONPATH&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">current</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">current</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">pathsep</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">part</span> <span class="ow">and</span> <span class="n">part</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">extra_paths</span><span class="p">:</span>
                        <span class="n">extra_paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">part</span><span class="p">)</span>
            <span class="n">proc_env</span><span class="p">[</span><span class="s2">&quot;PYTHONPATH&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">pathsep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">extra_paths</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">proc_env</span>

<div class="viewcode-block" id="AgiEnv.log_info">
<a class="viewcode-back" href="../../agi-env.html#agi_env.agi_env.AgiEnv.log_info">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">log_info</span><span class="p">(</span><span class="n">line</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Lightweight info logger retained for legacy hooks (e.g. pre_install scripts).&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">line</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">AgiEnv</span><span class="o">.</span><span class="n">logger</span><span class="p">:</span>
            <span class="n">AgiEnv</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></div>


<div class="viewcode-block" id="AgiEnv.run">
<a class="viewcode-back" href="../../agi-env.html#agi_env.agi_env.AgiEnv.run">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">venv</span><span class="p">,</span> <span class="n">cwd</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">wait</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">log_callback</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run a shell command inside a virtual environment.</span>
<span class="sd">        Streams stdout/stderr live without blocking (Windows-safe).</span>
<span class="sd">        Returns the full stdout string.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">AgiEnv</span><span class="o">.</span><span class="n">verbose</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">vname</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">venv</span><span class="p">)</span><span class="o">.</span><span class="n">name</span> <span class="k">if</span> <span class="n">venv</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;&lt;venv&gt;&quot;</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">vname</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">venv</span><span class="p">)</span>
            <span class="n">logger</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">AgiEnv</span><span class="p">,</span> <span class="s2">&quot;logger&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">logger</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;@</span><span class="si">{</span><span class="n">vname</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">cmd</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">cwd</span><span class="p">:</span>
            <span class="n">cwd</span> <span class="o">=</span> <span class="n">venv</span>
        <span class="n">process_env</span> <span class="o">=</span> <span class="n">AgiEnv</span><span class="o">.</span><span class="n">_build_env</span><span class="p">(</span><span class="n">venv</span><span class="p">)</span>

        <span class="n">shell_executable</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s2">&quot;win32&quot;</span> <span class="k">else</span> <span class="s2">&quot;/bin/bash&quot;</span>

        <span class="k">if</span> <span class="n">wait</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">read_stream</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
                    <span class="n">enc</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">encoding</span> <span class="ow">or</span> <span class="s2">&quot;utf-8&quot;</span>
                    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="n">line</span> <span class="o">=</span> <span class="k">await</span> <span class="n">stream</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
                            <span class="k">break</span>
                        <span class="n">text</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;replace&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">text</span><span class="p">:</span>
                            <span class="k">continue</span>
                        <span class="n">safe</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">enc</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;replace&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">enc</span><span class="p">)</span>
                        <span class="n">plain</span> <span class="o">=</span> <span class="n">AgiLogger</span><span class="o">.</span><span class="n">decolorize</span><span class="p">(</span><span class="n">safe</span><span class="p">)</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="n">strip_time_level_prefix</span><span class="p">(</span><span class="n">plain</span><span class="p">)</span>
                        <span class="c1"># If callback looks like a logging function, pass extra</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">callback</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;subprocess&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>
                        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                            <span class="n">callback</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">cmd_list</span> <span class="o">=</span> <span class="n">shlex</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
                    <span class="n">proc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_subprocess_exec</span><span class="p">(</span>
                        <span class="o">*</span><span class="n">cmd_list</span><span class="p">,</span>
                        <span class="n">stdout</span><span class="o">=</span><span class="n">asyncio</span><span class="o">.</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                        <span class="n">stderr</span><span class="o">=</span><span class="n">asyncio</span><span class="o">.</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                        <span class="n">cwd</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">cwd</span><span class="p">)</span> <span class="k">if</span> <span class="n">cwd</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="n">env</span><span class="o">=</span><span class="n">process_env</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">proc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_subprocess_shell</span><span class="p">(</span>
                        <span class="n">cmd</span><span class="p">,</span>
                        <span class="n">stdout</span><span class="o">=</span><span class="n">asyncio</span><span class="o">.</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                        <span class="n">stderr</span><span class="o">=</span><span class="n">asyncio</span><span class="o">.</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                        <span class="n">cwd</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">cwd</span><span class="p">)</span> <span class="k">if</span> <span class="n">cwd</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="n">env</span><span class="o">=</span><span class="n">process_env</span><span class="p">,</span>
                        <span class="n">executable</span><span class="o">=</span><span class="n">shell_executable</span><span class="p">,</span>
                    <span class="p">)</span>

                <span class="n">_logger</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">AgiEnv</span><span class="p">,</span> <span class="s2">&quot;logger&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">out_cb</span> <span class="o">=</span> <span class="n">log_callback</span> <span class="k">if</span> <span class="n">log_callback</span> <span class="k">else</span> <span class="p">(</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span> <span class="k">if</span> <span class="n">_logger</span> <span class="k">else</span> <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">)</span>
                <span class="n">err_cb</span> <span class="o">=</span> <span class="n">log_callback</span> <span class="k">if</span> <span class="n">log_callback</span> <span class="k">else</span> <span class="p">(</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span> <span class="k">if</span> <span class="n">_logger</span> <span class="k">else</span> <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">)</span>
                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">wait_for</span><span class="p">(</span><span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span>
                    <span class="n">read_stream</span><span class="p">(</span><span class="n">proc</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">out_cb</span><span class="p">),</span>
                    <span class="n">read_stream</span><span class="p">(</span><span class="n">proc</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="n">err_cb</span><span class="p">),</span>
                <span class="p">),</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>

                <span class="n">returncode</span> <span class="o">=</span> <span class="k">await</span> <span class="n">proc</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>

                <span class="k">if</span> <span class="n">returncode</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># Promote to ERROR with context even if lines were logged as INFO</span>
                    <span class="n">logger</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">AgiEnv</span><span class="p">,</span> <span class="s2">&quot;logger&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">logger</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Command failed with exit code </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">returncode</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Command failed with exit code </span><span class="si">{</span><span class="n">returncode</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">cmd</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">TimeoutError</span><span class="p">:</span>
                <span class="n">proc</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Command timed out after </span><span class="si">{</span><span class="n">timeout</span><span class="si">}</span><span class="s2"> seconds: </span><span class="si">{</span><span class="n">cmd</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">AgiEnv</span><span class="p">,</span> <span class="s2">&quot;logger&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">logger</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="ne">RuntimeError</span><span class="p">):</span>
                    <span class="k">raise</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Command execution error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">asyncio</span><span class="o">.</span><span class="n">create_subprocess_shell</span><span class="p">(</span>
                <span class="n">cmd</span><span class="p">,</span>
                <span class="n">cwd</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">cwd</span><span class="p">),</span>
                <span class="n">env</span><span class="o">=</span><span class="n">process_env</span><span class="p">,</span>
                <span class="n">stdout</span><span class="o">=</span><span class="n">asyncio</span><span class="o">.</span><span class="n">subprocess</span><span class="o">.</span><span class="n">DEVNULL</span><span class="p">,</span>
                <span class="n">stderr</span><span class="o">=</span><span class="n">asyncio</span><span class="o">.</span><span class="n">subprocess</span><span class="o">.</span><span class="n">DEVNULL</span><span class="p">,</span>
                <span class="n">executable</span><span class="o">=</span><span class="n">shell_executable</span>
            <span class="p">))</span>
            <span class="k">return</span> <span class="mi">0</span></div>


    <span class="nd">@staticmethod</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_run_bg</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">cwd</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="n">venv</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">log_callback</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">env_override</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">remove_env</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run the given command asynchronously, reading stdout and stderr line by line</span>
<span class="sd">        and passing them to the log_callback. Returns (stdout, stderr) as strings.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">process_env</span> <span class="o">=</span> <span class="n">AgiEnv</span><span class="o">.</span><span class="n">_build_env</span><span class="p">(</span><span class="n">venv</span><span class="p">)</span>
        <span class="n">process_env</span><span class="p">[</span><span class="s2">&quot;PYTHONUNBUFFERED&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;1&quot;</span>
        <span class="k">if</span> <span class="n">remove_env</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">remove_env</span><span class="p">:</span>
                <span class="n">process_env</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">env_override</span><span class="p">:</span>
            <span class="n">process_env</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">env_override</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">cmd_list</span> <span class="o">=</span> <span class="n">shlex</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
            <span class="n">proc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_subprocess_exec</span><span class="p">(</span>
                <span class="o">*</span><span class="n">cmd_list</span><span class="p">,</span>
                <span class="n">stdout</span><span class="o">=</span><span class="n">asyncio</span><span class="o">.</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                <span class="n">stderr</span><span class="o">=</span><span class="n">asyncio</span><span class="o">.</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                <span class="n">cwd</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">cwd</span><span class="p">)</span> <span class="k">if</span> <span class="n">cwd</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">env</span><span class="o">=</span><span class="n">process_env</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">proc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_subprocess_shell</span><span class="p">(</span>
                <span class="n">cmd</span><span class="p">,</span>
                <span class="n">stdout</span><span class="o">=</span><span class="n">asyncio</span><span class="o">.</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                <span class="n">stderr</span><span class="o">=</span><span class="n">asyncio</span><span class="o">.</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                <span class="n">cwd</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">cwd</span><span class="p">)</span> <span class="k">if</span> <span class="n">cwd</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">env</span><span class="o">=</span><span class="n">process_env</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">read_stream</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
            <span class="n">enc</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">encoding</span> <span class="ow">or</span> <span class="s2">&quot;utf-8&quot;</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">=</span> <span class="k">await</span> <span class="n">stream</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="n">text</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;replace&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">text</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">safe</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">enc</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;replace&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">enc</span><span class="p">)</span>
                <span class="n">plain</span> <span class="o">=</span> <span class="n">AgiLogger</span><span class="o">.</span><span class="n">decolorize</span><span class="p">(</span><span class="n">safe</span><span class="p">)</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="n">strip_time_level_prefix</span><span class="p">(</span><span class="n">safe</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">callback</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;subprocess&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>
                <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                    <span class="n">callback</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">tasks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">proc</span><span class="o">.</span><span class="n">stdout</span><span class="p">:</span>
            <span class="n">tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span>
                <span class="n">read_stream</span><span class="p">(</span><span class="n">proc</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">log_callback</span> <span class="k">if</span> <span class="n">log_callback</span> <span class="k">else</span> <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">)</span>
            <span class="p">))</span>
        <span class="k">if</span> <span class="n">proc</span><span class="o">.</span><span class="n">stderr</span><span class="p">:</span>
            <span class="n">tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span>
                <span class="n">read_stream</span><span class="p">(</span><span class="n">proc</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="n">log_callback</span> <span class="k">if</span> <span class="n">log_callback</span> <span class="k">else</span> <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">)</span>
            <span class="p">))</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">wait_for</span><span class="p">(</span><span class="n">proc</span><span class="o">.</span><span class="n">wait</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">TimeoutError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">proc</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Timeout expired for command: </span><span class="si">{</span><span class="n">cmd</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">err</span>

        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="n">tasks</span><span class="p">)</span>
        <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="k">await</span> <span class="n">proc</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>

        <span class="n">returncode</span> <span class="o">=</span> <span class="n">proc</span><span class="o">.</span><span class="n">returncode</span>

        <span class="k">if</span> <span class="n">returncode</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">AgiEnv</span><span class="p">,</span> <span class="s2">&quot;logger&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">logger</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Command failed with exit code </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">returncode</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Command failed (exit </span><span class="si">{</span><span class="n">returncode</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">stdout</span><span class="o">.</span><span class="n">decode</span><span class="p">(),</span> <span class="n">stderr</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>

<div class="viewcode-block" id="AgiEnv.run_agi">
<a class="viewcode-back" href="../../agi-env.html#agi_env.agi_env.AgiEnv.run_agi">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run_agi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">log_callback</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">venv</span><span class="p">:</span> <span class="n">Path</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Asynchronous version of run_agi for use within an async context.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;await\s+(?:Agi\.)?([^\(]+)\(&quot;</span>
        <span class="n">matches</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">code</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">matches</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;Could not determine snippet name from code.&quot;</span>
            <span class="k">if</span> <span class="n">log_callback</span><span class="p">:</span>
                <span class="n">log_callback</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">AgiEnv</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span>
        <span class="n">snippet_name</span> <span class="o">=</span> <span class="n">matches</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">is_install_snippet</span> <span class="o">=</span> <span class="s2">&quot;install&quot;</span> <span class="ow">in</span> <span class="n">snippet_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

        <span class="n">runenv_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">runenv</span><span class="p">)</span>
        <span class="n">runenv_path</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">snippet_file</span> <span class="o">=</span> <span class="n">runenv_path</span> <span class="o">/</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">.py&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[^0-9A-Za-z_]+&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">snippet_name</span><span class="p">))</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;AGI.unknown_command&quot;</span><span class="p">,</span>
            <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[^0-9A-Za-z_]+&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">))</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;unknown_app_name&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">snippet_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>

        <span class="n">project_root</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">venv</span><span class="p">)</span> <span class="k">if</span> <span class="n">venv</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">project_venv</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">project_root</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">project_root</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;.venv&quot;</span> <span class="ow">or</span> <span class="p">(</span><span class="n">project_root</span> <span class="o">/</span> <span class="s2">&quot;pyvenv.cfg&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="n">project_venv</span> <span class="o">=</span> <span class="n">project_root</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">candidate</span> <span class="o">=</span> <span class="n">project_root</span> <span class="o">/</span> <span class="s2">&quot;.venv&quot;</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">candidate</span> <span class="o">/</span> <span class="s2">&quot;pyvenv.cfg&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                    <span class="n">project_venv</span> <span class="o">=</span> <span class="n">candidate</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_install_snippet</span> <span class="ow">and</span> <span class="n">project_root</span> <span class="ow">and</span> <span class="n">project_venv</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;No virtual environment found in </span><span class="si">{</span><span class="n">project_root</span><span class="si">}</span><span class="s2">. Run INSTALL first.&quot;</span>
            <span class="k">if</span> <span class="n">log_callback</span><span class="p">:</span>
                <span class="n">log_callback</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">AgiEnv</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">message</span>

        <span class="k">if</span> <span class="n">project_venv</span><span class="p">:</span>
            <span class="n">python_bin</span> <span class="o">=</span> <span class="n">project_venv</span> <span class="o">/</span> <span class="p">(</span><span class="s2">&quot;Scripts/python.exe&quot;</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;nt&quot;</span> <span class="k">else</span> <span class="s2">&quot;bin/python&quot;</span><span class="p">)</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">shlex</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">python_bin</span><span class="p">))</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">shlex</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">snippet_file</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">AgiEnv</span><span class="o">.</span><span class="n">_run_bg</span><span class="p">(</span>
                <span class="n">cmd</span><span class="p">,</span>
                <span class="n">cwd</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">project_root</span><span class="p">),</span>
                <span class="n">venv</span><span class="o">=</span><span class="n">project_venv</span><span class="p">,</span>
                <span class="n">remove_env</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;PYTHONPATH&quot;</span><span class="p">,</span> <span class="s2">&quot;PYTHONHOME&quot;</span><span class="p">},</span>
                <span class="n">log_callback</span><span class="o">=</span><span class="n">log_callback</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">python_bin</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">)</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">shlex</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">python_bin</span><span class="p">))</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">shlex</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">snippet_file</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">AgiEnv</span><span class="o">.</span><span class="n">_run_bg</span><span class="p">(</span>
                <span class="n">cmd</span><span class="p">,</span>
                <span class="n">cwd</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">project_root</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">runenv</span><span class="p">),</span>
                <span class="n">venv</span><span class="o">=</span><span class="n">Path</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">prefix</span><span class="p">),</span>
                <span class="n">remove_env</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;PYTHONPATH&quot;</span><span class="p">,</span> <span class="s2">&quot;PYTHONHOME&quot;</span><span class="p">},</span>
                <span class="n">log_callback</span><span class="o">=</span><span class="n">log_callback</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">log_callback</span><span class="p">:</span>
            <span class="n">log_callback</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Process finished&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Process finished&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="AgiEnv.run_async">
<a class="viewcode-back" href="../../agi-env.html#agi_env.agi_env.AgiEnv.run_async">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run_async</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">venv</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cwd</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">log_callback</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run a shell command asynchronously inside a virtual environment.</span>
<span class="sd">        Streams stdout/stderr live with sensible levels (packaging-aware).</span>
<span class="sd">        Returns the last non-empty line among stderr (preferred) then stdout.</span>
<span class="sd">        Raises on non-zero exit (logs stderr tail).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">AgiEnv</span><span class="o">.</span><span class="n">verbose</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">AgiEnv</span><span class="p">,</span> <span class="s2">&quot;logger&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">logger</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Executing in </span><span class="si">{</span><span class="n">venv</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">cmd</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">cwd</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cwd</span> <span class="o">=</span> <span class="n">venv</span>

        <span class="c1"># Build env similar to your other functions</span>
        <span class="n">process_env</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">venv_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">venv</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">venv_path</span> <span class="o">/</span> <span class="s2">&quot;bin&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span> <span class="ow">and</span> <span class="n">venv_path</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="s2">&quot;.venv&quot;</span><span class="p">:</span>
            <span class="n">venv_path</span> <span class="o">=</span> <span class="n">venv_path</span> <span class="o">/</span> <span class="s2">&quot;.venv&quot;</span>

        <span class="n">process_env</span><span class="p">[</span><span class="s2">&quot;VIRTUAL_ENV&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">venv_path</span><span class="p">)</span>
        <span class="n">bin_dir</span> <span class="o">=</span> <span class="s2">&quot;Scripts&quot;</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;nt&quot;</span> <span class="k">else</span> <span class="s2">&quot;bin&quot;</span>
        <span class="n">venv_bin</span> <span class="o">=</span> <span class="n">venv_path</span> <span class="o">/</span> <span class="n">bin_dir</span>
        <span class="n">process_env</span><span class="p">[</span><span class="s2">&quot;PATH&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">venv_bin</span><span class="p">)</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">pathsep</span> <span class="o">+</span> <span class="n">process_env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;PATH&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">process_env</span><span class="p">[</span><span class="s2">&quot;PYTHONUNBUFFERED&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;1&quot;</span>  <span class="c1"># ensure timely output</span>
        <span class="n">shell_executable</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;nt&quot;</span> <span class="k">else</span> <span class="s2">&quot;/bin/bash&quot;</span>

        <span class="c1"># Normalize cmd to string for create_subprocess_shell</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">cmd_list</span> <span class="o">=</span> <span class="n">shlex</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
            <span class="n">proc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_subprocess_exec</span><span class="p">(</span>
                <span class="o">*</span><span class="n">cmd_list</span><span class="p">,</span>
                <span class="n">stdout</span><span class="o">=</span><span class="n">asyncio</span><span class="o">.</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                <span class="n">stderr</span><span class="o">=</span><span class="n">asyncio</span><span class="o">.</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                <span class="n">cwd</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">cwd</span><span class="p">)</span> <span class="k">if</span> <span class="n">cwd</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">env</span><span class="o">=</span><span class="n">process_env</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">proc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_subprocess_shell</span><span class="p">(</span>
                <span class="n">cmd</span><span class="p">,</span>
                <span class="n">stdout</span><span class="o">=</span><span class="n">asyncio</span><span class="o">.</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                <span class="n">stderr</span><span class="o">=</span><span class="n">asyncio</span><span class="o">.</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                <span class="n">cwd</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">cwd</span><span class="p">)</span> <span class="k">if</span> <span class="n">cwd</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">env</span><span class="o">=</span><span class="n">process_env</span><span class="p">,</span>
                <span class="n">executable</span><span class="o">=</span><span class="n">shell_executable</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">read_stream</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
            <span class="n">enc</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">encoding</span> <span class="ow">or</span> <span class="s2">&quot;utf-8&quot;</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">=</span> <span class="k">await</span> <span class="n">stream</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="n">text</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;replace&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">text</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">safe</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">enc</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;replace&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">enc</span><span class="p">)</span>
                <span class="n">plain</span> <span class="o">=</span> <span class="n">AgiLogger</span><span class="o">.</span><span class="n">decolorize</span><span class="p">(</span><span class="n">safe</span><span class="p">)</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="n">strip_time_level_prefix</span><span class="p">(</span><span class="n">plain</span><span class="p">)</span>
                <span class="n">logger</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">AgiEnv</span><span class="p">,</span> <span class="s2">&quot;logger&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">callback</span> <span class="ow">is</span> <span class="p">(</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span> <span class="k">if</span> <span class="n">logger</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="n">callback</span> <span class="ow">is</span> <span class="p">(</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span> <span class="k">if</span> <span class="n">logger</span> <span class="k">else</span> <span class="kc">None</span><span class="p">):</span>
                    <span class="n">callback</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;subprocess&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">callback</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">_logger</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">AgiEnv</span><span class="p">,</span> <span class="s2">&quot;logger&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">out_cb</span> <span class="o">=</span> <span class="n">log_callback</span> <span class="k">if</span> <span class="n">log_callback</span> <span class="k">else</span> <span class="p">(</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span> <span class="k">if</span> <span class="n">_logger</span> <span class="k">else</span> <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">)</span>
            <span class="n">err_cb</span> <span class="o">=</span> <span class="n">log_callback</span> <span class="k">if</span> <span class="n">log_callback</span> <span class="k">else</span> <span class="p">(</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span> <span class="k">if</span> <span class="n">_logger</span> <span class="k">else</span> <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">wait_for</span><span class="p">(</span>
                <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span>
                    <span class="n">read_stream</span><span class="p">(</span><span class="n">proc</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">out_cb</span><span class="p">),</span>
                    <span class="n">read_stream</span><span class="p">(</span><span class="n">proc</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="n">err_cb</span><span class="p">),</span>
                    <span class="n">proc</span><span class="o">.</span><span class="n">wait</span><span class="p">(),</span>
                <span class="p">),</span>
                <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">proc</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>
            <span class="n">logger</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">AgiEnv</span><span class="p">,</span> <span class="s2">&quot;logger&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">logger</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error during: </span><span class="si">{</span><span class="n">cmd</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="ne">RuntimeError</span><span class="p">):</span>
                <span class="k">raise</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Subprocess execution error for: </span><span class="si">{</span><span class="n">cmd</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">err</span>

        <span class="n">rc</span> <span class="o">=</span> <span class="n">proc</span><span class="o">.</span><span class="n">returncode</span>
        <span class="k">if</span> <span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">AgiEnv</span><span class="p">,</span> <span class="s2">&quot;logger&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">logger</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Command failed with exit code </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Command failed with exit code </span><span class="si">{</span><span class="n">rc</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">cmd</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Preserve original behavior: return last non-empty line (prefer stderr, else stdout)</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">last_non_empty</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">l</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
                    <span class="k">return</span> <span class="n">l</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">last_line</span> <span class="o">=</span> <span class="n">last_non_empty</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
        <span class="k">return</span> <span class="n">last_line</span></div>



<div class="viewcode-block" id="AgiEnv.create_symlink">
<a class="viewcode-back" href="../../agi-env.html#agi_env.agi_env.AgiEnv.create_symlink">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_symlink</span><span class="p">(</span><span class="n">src</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">dest</span><span class="p">:</span> <span class="n">Path</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">dest</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span> <span class="ow">or</span> <span class="n">dest</span><span class="o">.</span><span class="n">is_symlink</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">dest</span><span class="o">.</span><span class="n">is_symlink</span><span class="p">()</span> <span class="ow">and</span> <span class="n">dest</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span> <span class="o">==</span> <span class="n">src</span><span class="o">.</span><span class="n">resolve</span><span class="p">():</span>
                    <span class="n">logger</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">AgiEnv</span><span class="p">,</span> <span class="s2">&quot;logger&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">logger</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Symlink already exists and is correct: </span><span class="si">{</span><span class="n">dest</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">src</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">return</span>
                <span class="n">logger</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">AgiEnv</span><span class="p">,</span> <span class="s2">&quot;logger&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">logger</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Destination already exists and is not a symlink: </span><span class="si">{</span><span class="n">dest</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">dest</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
            <span class="n">dest</span><span class="o">.</span><span class="n">symlink_to</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">target_is_directory</span><span class="o">=</span><span class="n">src</span><span class="o">.</span><span class="n">is_dir</span><span class="p">())</span>
            <span class="n">logger</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">AgiEnv</span><span class="p">,</span> <span class="s2">&quot;logger&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">logger</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Symlink created: @</span><span class="si">{</span><span class="n">dest</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">src</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">AgiEnv</span><span class="p">,</span> <span class="s2">&quot;logger&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">logger</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to create symlink @</span><span class="si">{</span><span class="n">dest</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">src</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="AgiEnv.change_app">
<a class="viewcode-back" href="../../agi-env.html#agi_env.agi_env.AgiEnv.change_app">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">change_app</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">app</span><span class="p">):</span>
        <span class="c1"># Normalize current and requested app identifiers to comparable names</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">_app_name</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Accept Path-like or string; compare by final directory name</span>
                <span class="k">return</span> <span class="n">Path</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">))</span><span class="o">.</span><span class="n">name</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

        <span class="n">current_name</span> <span class="o">=</span> <span class="n">_app_name</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;app&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
        <span class="n">requested_name</span> <span class="o">=</span> <span class="n">_app_name</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">requested_name</span> <span class="o">==</span> <span class="n">current_name</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">apps_dir</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;apps_dir&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="n">AgiEnv</span><span class="o">.</span><span class="n">apps_dir</span>
        <span class="n">active_app</span> <span class="o">=</span> <span class="n">apps_dir</span> <span class="o">/</span> <span class="n">requested_name</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span>
                <span class="n">apps_dir</span><span class="o">=</span><span class="n">active_app</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span>
                <span class="n">app</span><span class="o">=</span><span class="n">requested_name</span><span class="p">,</span>
                <span class="n">verbose</span><span class="o">=</span><span class="n">AgiEnv</span><span class="o">.</span><span class="n">verbose</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">active_app</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">active_app</span><span class="p">,</span> <span class="n">ignore_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">raise</span></div>


<div class="viewcode-block" id="AgiEnv.is_local">
<a class="viewcode-back" href="../../agi-env.html#agi_env.agi_env.AgiEnv.is_local">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_local</span><span class="p">(</span><span class="n">ip</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Args:</span>
<span class="sd">          ip:</span>

<span class="sd">        Returns:</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span>
                <span class="ow">not</span> <span class="n">ip</span> <span class="ow">or</span> <span class="n">ip</span> <span class="ow">in</span> <span class="n">AgiEnv</span><span class="o">.</span><span class="n">_ip_local_cache</span>
        <span class="p">):</span>  <span class="c1"># Check if IP is None, empty, or cached</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">addrs</span> <span class="ow">in</span> <span class="n">psutil</span><span class="o">.</span><span class="n">net_if_addrs</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">addr</span> <span class="ow">in</span> <span class="n">addrs</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">addr</span><span class="o">.</span><span class="n">family</span> <span class="o">==</span> <span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span> <span class="ow">and</span> <span class="n">ip</span> <span class="o">==</span> <span class="n">addr</span><span class="o">.</span><span class="n">address</span><span class="p">:</span>
                    <span class="n">AgiEnv</span><span class="o">.</span><span class="n">_ip_local_cache</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span>  <span class="c1"># Cache the local IP found</span>
                    <span class="k">return</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="AgiEnv.has_admin_rights">
<a class="viewcode-back" href="../../agi-env.html#agi_env.agi_env.AgiEnv.has_admin_rights">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">has_admin_rights</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if the current process has administrative rights on Windows.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True if admin, False otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">windll</span><span class="o">.</span><span class="n">shell32</span><span class="o">.</span><span class="n">IsUserAnAdmin</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="AgiEnv.create_junction_windows">
<a class="viewcode-back" href="../../agi-env.html#agi_env.agi_env.AgiEnv.create_junction_windows">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_junction_windows</span><span class="p">(</span><span class="n">source</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">dest</span><span class="p">:</span> <span class="n">Path</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a directory junction on Windows.</span>

<span class="sd">        Args:</span>
<span class="sd">            source (Path): The target directory path.</span>
<span class="sd">            dest (Path): The destination junction path.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Using the mklink command to create a junction (/J) which doesn&#39;t require admin rights.</span>
            <span class="n">subprocess</span><span class="o">.</span><span class="n">check_call</span><span class="p">([</span><span class="s1">&#39;cmd&#39;</span><span class="p">,</span> <span class="s1">&#39;/c&#39;</span><span class="p">,</span> <span class="s1">&#39;mklink&#39;</span><span class="p">,</span> <span class="s1">&#39;/J&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">dest</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">source</span><span class="p">)])</span>
            <span class="n">logger</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">AgiEnv</span><span class="p">,</span> <span class="s2">&quot;logger&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">logger</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Created junction: </span><span class="si">{</span><span class="n">dest</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">source</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">CalledProcessError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">AgiEnv</span><span class="p">,</span> <span class="s2">&quot;logger&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">logger</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to create junction. Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="AgiEnv.create_symlink_windows">
<a class="viewcode-back" href="../../agi-env.html#agi_env.agi_env.AgiEnv.create_symlink_windows">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_symlink_windows</span><span class="p">(</span><span class="n">source</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">dest</span><span class="p">:</span> <span class="n">Path</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a symbolic link on Windows, handling permissions and types.</span>

<span class="sd">        Args:</span>
<span class="sd">            source (Path): Source directory path.</span>
<span class="sd">            dest (Path): Destination symlink path.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Define necessary Windows API functions and constants</span>
        <span class="n">CreateSymbolicLink</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">windll</span><span class="o">.</span><span class="n">kernel32</span><span class="o">.</span><span class="n">CreateSymbolicLinkW</span>
        <span class="n">CreateSymbolicLink</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="n">wintypes</span><span class="o">.</span><span class="n">BOOL</span>
        <span class="n">CreateSymbolicLink</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">wintypes</span><span class="o">.</span><span class="n">LPCWSTR</span><span class="p">,</span> <span class="n">wintypes</span><span class="o">.</span><span class="n">LPCWSTR</span><span class="p">,</span> <span class="n">wintypes</span><span class="o">.</span><span class="n">DWORD</span><span class="p">]</span>

        <span class="n">SYMBOLIC_LINK_FLAG_DIRECTORY</span> <span class="o">=</span> <span class="mh">0x1</span>

        <span class="c1"># Check if Developer Mode is enabled or if the process has admin rights</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">AgiEnv</span><span class="o">.</span><span class="n">has_admin_rights</span><span class="p">():</span>
            <span class="n">logger</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">AgiEnv</span><span class="p">,</span> <span class="s2">&quot;logger&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">logger</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;Creating symbolic links on Windows requires administrative privileges or Developer Mode enabled.&quot;</span>
                <span class="p">)</span>
            <span class="k">return</span>

        <span class="n">flags</span> <span class="o">=</span> <span class="n">SYMBOLIC_LINK_FLAG_DIRECTORY</span>

        <span class="n">success</span> <span class="o">=</span> <span class="n">CreateSymbolicLink</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dest</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">source</span><span class="p">),</span> <span class="n">flags</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
            <span class="n">logger</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">AgiEnv</span><span class="p">,</span> <span class="s2">&quot;logger&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">logger</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Created symbolic link for .venv: </span><span class="si">{</span><span class="n">dest</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">source</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">error_code</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">GetLastError</span><span class="p">()</span>
            <span class="n">logger</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">AgiEnv</span><span class="p">,</span> <span class="s2">&quot;logger&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">logger</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Failed to create symbolic link for .venv. Error code: </span><span class="si">{</span><span class="n">error_code</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span></div>


<div class="viewcode-block" id="AgiEnv.create_rename_map">
<a class="viewcode-back" href="../../agi-env.html#agi_env.agi_env.AgiEnv.create_rename_map">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_rename_map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target_project</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">dest_project</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a mapping of old → new names for cloning.</span>
<span class="sd">        Includes project names, top-level src folders, worker folders,</span>
<span class="sd">        in-file identifiers and class names.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">cap</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">))</span>

        <span class="n">name_tp</span> <span class="o">=</span> <span class="n">target_project</span><span class="o">.</span><span class="n">name</span>      <span class="c1"># e.g. &quot;flight_project&quot; or &quot;dag_app_template&quot;</span>
        <span class="n">name_dp</span> <span class="o">=</span> <span class="n">dest_project</span><span class="o">.</span><span class="n">name</span>        <span class="c1"># e.g. &quot;tata_project&quot;</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">strip_suffix</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">suffix</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;_project&quot;</span><span class="p">,</span> <span class="s2">&quot;_template&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">suffix</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">name</span><span class="p">[:</span> <span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">suffix</span><span class="p">)]</span>
            <span class="k">return</span> <span class="n">name</span>

        <span class="n">tp</span> <span class="o">=</span> <span class="n">strip_suffix</span><span class="p">(</span><span class="n">name_tp</span><span class="p">)</span>
        <span class="n">dp</span> <span class="o">=</span> <span class="n">strip_suffix</span><span class="p">(</span><span class="n">name_dp</span><span class="p">)</span>

        <span class="n">tm</span> <span class="o">=</span> <span class="n">tp</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span>
        <span class="n">dm</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span>
        <span class="n">tc</span> <span class="o">=</span> <span class="n">cap</span><span class="p">(</span><span class="n">tm</span><span class="p">)</span>                       <span class="c1"># &quot;Flight&quot;</span>
        <span class="n">dc</span> <span class="o">=</span> <span class="n">cap</span><span class="p">(</span><span class="n">dm</span><span class="p">)</span>                       <span class="c1"># &quot;Tata&quot;</span>

        <span class="n">rename_map</span> <span class="o">=</span> <span class="p">{</span>
            <span class="c1"># project-level</span>
            <span class="n">name_tp</span><span class="p">:</span>              <span class="n">name_dp</span><span class="p">,</span>

            <span class="c1"># folder-level (longest keys first)</span>
            <span class="sa">f</span><span class="s2">&quot;src/</span><span class="si">{</span><span class="n">tm</span><span class="si">}</span><span class="s2">_worker&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;src/</span><span class="si">{</span><span class="n">dm</span><span class="si">}</span><span class="s2">_worker&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;src/</span><span class="si">{</span><span class="n">tm</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">:</span>        <span class="sa">f</span><span class="s2">&quot;src/</span><span class="si">{</span><span class="n">dm</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>

            <span class="c1"># sibling-level</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tm</span><span class="si">}</span><span class="s2">_worker&quot;</span><span class="p">:</span>      <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dm</span><span class="si">}</span><span class="s2">_worker&quot;</span><span class="p">,</span>
            <span class="n">tm</span><span class="p">:</span>                    <span class="n">dm</span><span class="p">,</span>

            <span class="c1"># class-level</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tc</span><span class="si">}</span><span class="s2">Worker&quot;</span><span class="p">:</span>       <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dc</span><span class="si">}</span><span class="s2">Worker&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tc</span><span class="si">}</span><span class="s2">Args&quot;</span><span class="p">:</span>         <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dc</span><span class="si">}</span><span class="s2">Args&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tc</span><span class="si">}</span><span class="s2">ArgsTD&quot;</span><span class="p">:</span>       <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dc</span><span class="si">}</span><span class="s2">ArgsTD&quot;</span><span class="p">,</span>
            <span class="n">tc</span><span class="p">:</span>                    <span class="n">dc</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># Add common suffix variants (e.g., flight_args -&gt; toto_args)</span>
        <span class="k">for</span> <span class="n">suffix</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;_args&quot;</span><span class="p">,</span> <span class="s2">&quot;_manager&quot;</span><span class="p">,</span> <span class="s2">&quot;_worker&quot;</span><span class="p">,</span> <span class="s2">&quot;_distributor&quot;</span><span class="p">,</span> <span class="s2">&quot;_project&quot;</span><span class="p">):</span>
            <span class="n">rename_map</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tm</span><span class="si">}{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dm</span><span class="si">}{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">rename_map</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tm</span><span class="si">}</span><span class="s2">_args_td&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dm</span><span class="si">}</span><span class="s2">_args_td&quot;</span><span class="p">)</span>
        <span class="n">rename_map</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tm</span><span class="si">}</span><span class="s2">ArgsTD&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dm</span><span class="si">}</span><span class="s2">ArgsTD&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">rename_map</span></div>


<div class="viewcode-block" id="AgiEnv.clone_project">
<a class="viewcode-back" href="../../agi-env.html#agi_env.agi_env.AgiEnv.clone_project">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">clone_project</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target_project</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">dest_project</span><span class="p">:</span> <span class="n">Path</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Clone a project by copying files and directories, applying renaming,</span>
<span class="sd">        then cleaning up any leftovers.</span>

<span class="sd">        Args:</span>
<span class="sd">            target_project: Path under self.apps_dir (e.g. Path(&quot;flight_project&quot;))</span>
<span class="sd">            dest_project:   Path under self.apps_dir (e.g. Path(&quot;tata_project&quot;))</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># normalize names</span>
        <span class="n">templates_root</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">apps_dir</span> <span class="o">/</span> <span class="s2">&quot;templates&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">target_project</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;_project&quot;</span><span class="p">):</span>
            <span class="n">candidate</span> <span class="o">=</span> <span class="n">target_project</span><span class="o">.</span><span class="n">with_name</span><span class="p">(</span><span class="n">target_project</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_project&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">apps_dir</span> <span class="o">/</span> <span class="n">candidate</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span> <span class="ow">or</span> <span class="p">(</span><span class="n">templates_root</span> <span class="o">/</span> <span class="n">candidate</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="n">target_project</span> <span class="o">=</span> <span class="n">candidate</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">dest_project</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;_project&quot;</span><span class="p">):</span>
            <span class="n">dest_project</span> <span class="o">=</span> <span class="n">dest_project</span><span class="o">.</span><span class="n">with_name</span><span class="p">(</span><span class="n">dest_project</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_project&quot;</span><span class="p">)</span>

        <span class="n">rename_map</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_rename_map</span><span class="p">(</span><span class="n">target_project</span><span class="p">,</span> <span class="n">dest_project</span><span class="p">)</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">_strip</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
            <span class="n">base</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">name</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">Path</span><span class="p">)</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">suffix</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;_project&quot;</span><span class="p">,</span> <span class="s2">&quot;_template&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">base</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">suffix</span><span class="p">):</span>
                    <span class="n">base</span> <span class="o">=</span> <span class="n">base</span><span class="p">[:</span> <span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">suffix</span><span class="p">)]</span>
            <span class="k">return</span> <span class="n">base</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span>

        <span class="n">tm</span> <span class="o">=</span> <span class="n">_strip</span><span class="p">(</span><span class="n">target_project</span><span class="p">)</span>
        <span class="n">dm</span> <span class="o">=</span> <span class="n">_strip</span><span class="p">(</span><span class="n">dest_project</span><span class="p">)</span>
        <span class="n">source_root</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">apps_dir</span> <span class="o">/</span> <span class="n">target_project</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">source_root</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span> <span class="ow">and</span> <span class="n">templates_root</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">source_root</span> <span class="o">=</span> <span class="n">templates_root</span> <span class="o">/</span> <span class="n">target_project</span>
        <span class="n">dest_root</span>   <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">apps_dir</span> <span class="o">/</span> <span class="n">dest_project</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">source_root</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">AgiEnv</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Source project &#39;</span><span class="si">{</span><span class="n">target_project</span><span class="si">}</span><span class="s2">&#39; does not exist.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">dest_root</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">AgiEnv</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Destination project &#39;</span><span class="si">{</span><span class="n">dest_project</span><span class="si">}</span><span class="s2">&#39; already exists.&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># Clone all files by default. Only skip repository metadata such as .git.</span>
        <span class="n">ignore_patterns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;.git&quot;</span><span class="p">,</span> <span class="s2">&quot;.git/&quot;</span><span class="p">,</span> <span class="s2">&quot;.git/**&quot;</span><span class="p">]</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="n">PathSpec</span><span class="o">.</span><span class="n">from_lines</span><span class="p">(</span><span class="n">GitWildMatchPattern</span><span class="p">,</span> <span class="n">ignore_patterns</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">dest_root</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">AgiEnv</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not create &#39;</span><span class="si">{</span><span class="n">dest_root</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># 1) Recursive clone</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clone_directory</span><span class="p">(</span><span class="n">source_root</span><span class="p">,</span> <span class="n">dest_root</span><span class="p">,</span> <span class="n">rename_map</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">source_root</span><span class="p">)</span>

        <span class="c1"># 2) Final cleanup</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cleanup_rename</span><span class="p">(</span><span class="n">dest_root</span><span class="p">,</span> <span class="n">rename_map</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">projects</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dest_project</span><span class="p">)</span>

        <span class="c1"># 3) Mirror data directory if present under ~/data/&lt;source&gt;</span>
        <span class="n">src_data_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">home_abs</span> <span class="o">/</span> <span class="s2">&quot;data&quot;</span> <span class="o">/</span> <span class="n">tm</span>
        <span class="n">dest_data_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">home_abs</span> <span class="o">/</span> <span class="s2">&quot;data&quot;</span> <span class="o">/</span> <span class="n">dm</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">src_data_dir</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">dest_data_dir</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">copytree</span><span class="p">(</span><span class="n">src_data_dir</span><span class="p">,</span> <span class="n">dest_data_dir</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="n">AgiEnv</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unable to copy data directory &#39;</span><span class="si">{</span><span class="n">src_data_dir</span><span class="si">}</span><span class="s2">&#39; to &#39;</span><span class="si">{</span><span class="n">dest_data_dir</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">exc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="AgiEnv.clone_directory">
<a class="viewcode-back" href="../../agi-env.html#agi_env.agi_env.AgiEnv.clone_directory">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">clone_directory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                        <span class="n">source_dir</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
                        <span class="n">dest_dir</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
                        <span class="n">rename_map</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
                        <span class="n">spec</span><span class="p">:</span> <span class="n">PathSpec</span><span class="p">,</span>
                        <span class="n">source_root</span><span class="p">:</span> <span class="n">Path</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Recursively copy + rename directories, files, and contents,</span>
<span class="sd">        applying renaming only on exact path segments.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">source_dir</span><span class="o">.</span><span class="n">iterdir</span><span class="p">():</span>
            <span class="n">rel</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">relative_to</span><span class="p">(</span><span class="n">source_root</span><span class="p">)</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()</span>

            <span class="c1"># Skip files/directories matched by .gitignore spec</span>
            <span class="k">if</span> <span class="n">spec</span><span class="o">.</span><span class="n">match_file</span><span class="p">(</span><span class="n">rel</span> <span class="o">+</span> <span class="p">(</span><span class="s2">&quot;/&quot;</span> <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">is_dir</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)):</span>
                <span class="k">continue</span>

            <span class="c1"># Rename only full segments of the relative path</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="n">rel</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">seg</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">parts</span><span class="p">):</span>
                <span class="c1"># Sort rename_map by key length descending to avoid partial conflicts</span>
                <span class="k">for</span> <span class="n">old</span><span class="p">,</span> <span class="n">new</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">rename_map</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">kv</span><span class="p">:</span> <span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">kv</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
                    <span class="k">if</span> <span class="n">seg</span> <span class="o">==</span> <span class="n">old</span><span class="p">:</span>
                        <span class="n">parts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">new</span>
                        <span class="k">break</span>

            <span class="n">new_rel</span> <span class="o">=</span> <span class="s2">&quot;/&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span>
            <span class="n">dst</span> <span class="o">=</span> <span class="n">dest_dir</span> <span class="o">/</span> <span class="n">new_rel</span>
            <span class="n">dst</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">is_symlink</span><span class="p">():</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">target</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">readlink</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                    <span class="c1"># Fallback to absolute path if readlink fails</span>
                    <span class="n">target</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">resolve</span><span class="p">())</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">symlink</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">target_is_directory</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">is_dir</span><span class="p">())</span>
                <span class="k">except</span> <span class="ne">FileExistsError</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;.venv&quot;</span><span class="p">:</span>
                    <span class="c1"># Keep virtual env directory as a symlink</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">symlink</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">target_is_directory</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">clone_directory</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">dest_dir</span><span class="p">,</span> <span class="n">rename_map</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">source_root</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">item</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
                <span class="n">suf</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="n">base</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">stem</span>

                <span class="c1"># Rename file if its basename is in rename_map</span>
                <span class="k">if</span> <span class="n">base</span> <span class="ow">in</span> <span class="n">rename_map</span><span class="p">:</span>
                    <span class="n">dst</span> <span class="o">=</span> <span class="n">dst</span><span class="o">.</span><span class="n">with_name</span><span class="p">(</span><span class="n">rename_map</span><span class="p">[</span><span class="n">base</span><span class="p">]</span> <span class="o">+</span> <span class="n">item</span><span class="o">.</span><span class="n">suffix</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">suf</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;.7z&quot;</span><span class="p">,</span> <span class="s2">&quot;.zip&quot;</span><span class="p">):</span>
                    <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">dst</span><span class="p">)</span>

                <span class="k">elif</span> <span class="n">suf</span> <span class="o">==</span> <span class="s2">&quot;.py&quot;</span><span class="p">:</span>
                    <span class="n">src</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">read_text</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">tree</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
                        <span class="n">renamer</span> <span class="o">=</span> <span class="n">ContentRenamer</span><span class="p">(</span><span class="n">rename_map</span><span class="p">)</span>
                        <span class="n">new_tree</span> <span class="o">=</span> <span class="n">renamer</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>
                        <span class="n">ast</span><span class="o">.</span><span class="n">fix_missing_locations</span><span class="p">(</span><span class="n">new_tree</span><span class="p">)</span>
                        <span class="n">out</span> <span class="o">=</span> <span class="n">astor</span><span class="o">.</span><span class="n">to_source</span><span class="p">(</span><span class="n">new_tree</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">SyntaxError</span><span class="p">:</span>
                        <span class="n">out</span> <span class="o">=</span> <span class="n">src</span>
                    <span class="c1"># Whole word replacements in Python source text</span>
                    <span class="k">for</span> <span class="n">old</span><span class="p">,</span> <span class="n">new</span> <span class="ow">in</span> <span class="n">rename_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="n">out</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">rf</span><span class="s2">&quot;\b</span><span class="si">{</span><span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">old</span><span class="p">)</span><span class="si">}</span><span class="s2">\b&quot;</span><span class="p">,</span> <span class="n">new</span><span class="p">,</span> <span class="n">out</span><span class="p">)</span>
                    <span class="n">dst</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>

                <span class="k">elif</span> <span class="n">suf</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;.toml&quot;</span><span class="p">,</span> <span class="s2">&quot;.md&quot;</span><span class="p">,</span> <span class="s2">&quot;.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;.json&quot;</span><span class="p">,</span> <span class="s2">&quot;.yaml&quot;</span><span class="p">,</span> <span class="s2">&quot;.yml&quot;</span><span class="p">):</span>
                    <span class="n">txt</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">read_text</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">old</span><span class="p">,</span> <span class="n">new</span> <span class="ow">in</span> <span class="n">rename_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="n">txt</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">rf</span><span class="s2">&quot;\b</span><span class="si">{</span><span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">old</span><span class="p">)</span><span class="si">}</span><span class="s2">\b&quot;</span><span class="p">,</span> <span class="n">new</span><span class="p">,</span> <span class="n">txt</span><span class="p">)</span>
                    <span class="n">dst</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span><span class="n">txt</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">dst</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">item</span><span class="o">.</span><span class="n">is_symlink</span><span class="p">():</span>
                <span class="n">target</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">readlink</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">symlink</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">target_is_directory</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">is_dir</span><span class="p">())</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_cleanup_rename</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">root</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">rename_map</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        1) Rename any leftover file/dir basenames (including .py) that exactly match a key.</span>
<span class="sd">        2) Rewrite text files for any straggler content references.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># build simple name→new map (no slashes)</span>
        <span class="n">simple_map</span> <span class="o">=</span> <span class="p">{</span><span class="n">old</span><span class="p">:</span> <span class="n">new</span> <span class="k">for</span> <span class="n">old</span><span class="p">,</span> <span class="n">new</span> <span class="ow">in</span> <span class="n">rename_map</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="s2">&quot;/&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">old</span><span class="p">}</span>
        <span class="c1"># sort longest first</span>
        <span class="n">sorted_simple</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">simple_map</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">kv</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">kv</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># -- step 1: rename basenames (dirs &amp; files) bottom‑up --</span>
        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">root</span><span class="o">.</span><span class="n">rglob</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">parts</span><span class="p">),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="n">old</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">name</span>
            <span class="k">for</span> <span class="n">o</span><span class="p">,</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">sorted_simple</span><span class="p">:</span>
                <span class="c1"># directory exactly &quot;flight&quot; → &quot;truc&quot;, or &quot;flight_worker&quot; → &quot;truc_worker&quot;</span>
                <span class="k">if</span> <span class="n">old</span> <span class="o">==</span> <span class="n">o</span> <span class="ow">or</span> <span class="n">old</span> <span class="o">==</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">o</span><span class="si">}</span><span class="s2">_worker&quot;</span> <span class="ow">or</span> <span class="n">old</span> <span class="o">==</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">o</span><span class="si">}</span><span class="s2">_project&quot;</span><span class="p">:</span>
                    <span class="n">new_name</span> <span class="o">=</span> <span class="n">old</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">path</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">with_name</span><span class="p">(</span><span class="n">new_name</span><span class="p">))</span>
                    <span class="k">break</span>
                <span class="c1"># file like &quot;flight.py&quot; → &quot;truc.py&quot;</span>
                <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">is_file</span><span class="p">()</span> <span class="ow">and</span> <span class="n">old</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">o</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span><span class="p">):</span>
                    <span class="n">new_name</span> <span class="o">=</span> <span class="n">n</span> <span class="o">+</span> <span class="n">old</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">o</span><span class="p">):]</span>
                    <span class="n">path</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">with_name</span><span class="p">(</span><span class="n">new_name</span><span class="p">))</span>
                    <span class="k">break</span>

        <span class="c1"># -- step 2: rewrite any lingering text references --</span>
        <span class="n">exts</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;.py&quot;</span><span class="p">,</span> <span class="s2">&quot;.toml&quot;</span><span class="p">,</span> <span class="s2">&quot;.md&quot;</span><span class="p">,</span> <span class="s2">&quot;.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;.json&quot;</span><span class="p">,</span> <span class="s2">&quot;.yaml&quot;</span><span class="p">,</span> <span class="s2">&quot;.yml&quot;</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">root</span><span class="o">.</span><span class="n">rglob</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">file</span><span class="o">.</span><span class="n">is_file</span><span class="p">()</span> <span class="ow">or</span> <span class="n">file</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">exts</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">txt</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">read_text</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
            <span class="n">new_txt</span> <span class="o">=</span> <span class="n">txt</span>
            <span class="k">for</span> <span class="n">old</span><span class="p">,</span> <span class="n">new</span> <span class="ow">in</span> <span class="n">rename_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">new_txt</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">rf</span><span class="s2">&quot;\b</span><span class="si">{</span><span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">old</span><span class="p">)</span><span class="si">}</span><span class="s2">\b&quot;</span><span class="p">,</span> <span class="n">new</span><span class="p">,</span> <span class="n">new_txt</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">new_txt</span> <span class="o">!=</span> <span class="n">txt</span><span class="p">:</span>
                <span class="n">file</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span><span class="n">new_txt</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="AgiEnv.replace_content">
<a class="viewcode-back" href="../../agi-env.html#agi_env.agi_env.AgiEnv.replace_content">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">replace_content</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">txt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">rename_map</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">old</span><span class="p">,</span> <span class="n">new</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">rename_map</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">kv</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">kv</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="c1"># only match whole‐word occurrences of `old`</span>
            <span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">rf</span><span class="s2">&quot;\b</span><span class="si">{</span><span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">old</span><span class="p">)</span><span class="si">}</span><span class="s2">\b&quot;</span><span class="p">)</span>
            <span class="n">txt</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">new</span><span class="p">,</span> <span class="n">txt</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">txt</span></div>


<div class="viewcode-block" id="AgiEnv.read_gitignore">
<a class="viewcode-back" href="../../agi-env.html#agi_env.agi_env.AgiEnv.read_gitignore">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">read_gitignore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gitignore_path</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;PathSpec&#39;</span><span class="p">:</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">pathspec</span><span class="w"> </span><span class="kn">import</span> <span class="n">PathSpec</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">pathspec.patterns</span><span class="w"> </span><span class="kn">import</span> <span class="n">GitWildMatchPattern</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">gitignore_path</span><span class="o">.</span><span class="n">read_text</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">PathSpec</span><span class="o">.</span><span class="n">from_lines</span><span class="p">(</span><span class="n">GitWildMatchPattern</span><span class="p">,</span> <span class="n">lines</span><span class="p">)</span></div>


<div class="viewcode-block" id="AgiEnv.is_valid_ip">
<a class="viewcode-back" href="../../agi-env.html#agi_env.agi_env.AgiEnv.is_valid_ip">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_valid_ip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ip</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^(?:[0-9]{1,3}\.)</span><span class="si">{3}</span><span class="s2">[0-9]{1,3}$&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">ip</span><span class="p">):</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="n">ip</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="nb">int</span><span class="p">(</span><span class="n">part</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">255</span> <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">parts</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="AgiEnv.unzip_data">
<a class="viewcode-back" href="../../agi-env.html#agi_env.agi_env.AgiEnv.unzip_data">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">unzip_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">archive_path</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">extract_to</span><span class="p">:</span> <span class="n">Path</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">archive_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">archive_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">archive_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">AgiEnv</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Archive &#39;</span><span class="si">{</span><span class="n">archive_path</span><span class="si">}</span><span class="s2">&#39; does not exist. Skipping extraction.&quot;</span><span class="p">)</span>
            <span class="k">return</span>  <span class="c1"># Do not exit, just warn</span>

        <span class="c1"># Normalize extract_to to a Path relative to cwd or absolute</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">extract_to</span><span class="p">:</span>
            <span class="n">extract_to</span> <span class="o">=</span> <span class="s2">&quot;data&quot;</span>
        <span class="n">dest</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">home_abs</span> <span class="o">/</span> <span class="n">extract_to</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">dest</span> <span class="o">/</span> <span class="s2">&quot;dataset&quot;</span>

        <span class="c1"># Clear existing folder if not empty to avoid extraction errors on second call</span>
        <span class="k">if</span> <span class="n">dataset</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">iterdir</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">AgiEnv</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">AgiEnv</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Destination &#39;</span><span class="si">{</span><span class="n">dataset</span><span class="si">}</span><span class="s2">&#39; exists and is not empty. Clearing it before extraction.&quot;</span><span class="p">)</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
        <span class="n">dest</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">py7zr</span><span class="o">.</span><span class="n">SevenZipFile</span><span class="p">(</span><span class="n">archive_path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">archive</span><span class="p">:</span>
                <span class="n">archive</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">dest</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">AgiEnv</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">AgiEnv</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successfully extracted &#39;</span><span class="si">{</span><span class="n">archive_path</span><span class="si">}</span><span class="s2">&#39; to &#39;</span><span class="si">{</span><span class="n">dest</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">AgiEnv</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to extract &#39;</span><span class="si">{</span><span class="n">archive_path</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="ne">RuntimeError</span><span class="p">):</span>
                <span class="k">raise</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Extraction failed for &#39;</span><span class="si">{</span><span class="n">archive_path</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span></div>


<div class="viewcode-block" id="AgiEnv.check_internet">
<a class="viewcode-back" href="../../agi-env.html#agi_env.agi_env.AgiEnv.check_internet">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">check_internet</span><span class="p">():</span>
        <span class="n">AgiEnv</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Checking internet connectivity...&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># HEAD request to Google</span>
            <span class="n">req</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">Request</span><span class="p">(</span><span class="s2">&quot;https://www.google.com&quot;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;HEAD&quot;</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span> <span class="k">as</span> <span class="n">resp</span><span class="p">:</span>
                <span class="k">pass</span>  <span class="c1"># Success if no exception</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">AgiEnv</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No internet connection detected. Aborting.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">AgiEnv</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Internet connection is OK.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span></div>
</div>




<div class="viewcode-block" id="ContentRenamer">
<a class="viewcode-back" href="../../agi-env.html#agi_env.agi_env.ContentRenamer">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ContentRenamer</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">NodeTransformer</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class that renames identifiers in an abstract syntax tree (AST).</span>
<span class="sd">    Attributes:</span>
<span class="sd">        rename_map (dict): A mapping of old identifiers to new identifiers.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="ContentRenamer.__init__">
<a class="viewcode-back" href="../../agi-env.html#agi_env.agi_env.ContentRenamer.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rename_map</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the ContentRenamer with the rename_map.</span>

<span class="sd">        Args:</span>
<span class="sd">            rename_map (dict): Mapping of old names to new names.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rename_map</span> <span class="o">=</span> <span class="n">rename_map</span></div>


<div class="viewcode-block" id="ContentRenamer.visit_Name">
<a class="viewcode-back" href="../../agi-env.html#agi_env.agi_env.ContentRenamer.visit_Name">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">visit_Name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="c1"># Rename variable and function names</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Visit and potentially rename a Name node in the abstract syntax tree.</span>

<span class="sd">        Args:</span>
<span class="sd">            self: The current object instance.</span>
<span class="sd">            node: The Name node in the abstract syntax tree.</span>

<span class="sd">        Returns:</span>
<span class="sd">            ast.Node: The modified Name node after potential renaming.</span>

<span class="sd">        Note:</span>
<span class="sd">            This function modifies the Name node in place.</span>

<span class="sd">        Raises:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rename_map</span><span class="p">:</span>
            <span class="n">AgiEnv</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Renaming Name: </span><span class="si">{</span><span class="n">node</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2"> ➔ </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">rename_map</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">id</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">node</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rename_map</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">id</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generic_visit</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>  <span class="c1"># Ensure child nodes are visited</span>
        <span class="k">return</span> <span class="n">node</span></div>


<div class="viewcode-block" id="ContentRenamer.visit_Attribute">
<a class="viewcode-back" href="../../agi-env.html#agi_env.agi_env.ContentRenamer.visit_Attribute">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">visit_Attribute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="c1"># Rename attributes</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Visit and potentially rename an attribute in a node.</span>

<span class="sd">        Args:</span>
<span class="sd">            node: A node representing an attribute.</span>

<span class="sd">        Returns:</span>
<span class="sd">            node: The visited node with potential attribute renamed.</span>

<span class="sd">        Raises:</span>
<span class="sd">            None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rename_map</span><span class="p">:</span>
            <span class="n">AgiEnv</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Renaming Attribute: </span><span class="si">{</span><span class="n">node</span><span class="o">.</span><span class="n">attr</span><span class="si">}</span><span class="s2"> ➔ </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">rename_map</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">attr</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">node</span><span class="o">.</span><span class="n">attr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rename_map</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">attr</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generic_visit</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">node</span></div>


<div class="viewcode-block" id="ContentRenamer.visit_FunctionDef">
<a class="viewcode-back" href="../../agi-env.html#agi_env.agi_env.ContentRenamer.visit_FunctionDef">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">visit_FunctionDef</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="c1"># Rename function names</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Rename a function node based on a provided mapping.</span>

<span class="sd">        Args:</span>
<span class="sd">            node (ast.FunctionDef): The function node to be processed.</span>

<span class="sd">        Returns:</span>
<span class="sd">            ast.FunctionDef: The function node with potential name change.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rename_map</span><span class="p">:</span>
            <span class="n">AgiEnv</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Renaming Function: </span><span class="si">{</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> ➔ </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">rename_map</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">node</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rename_map</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generic_visit</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">node</span></div>


<div class="viewcode-block" id="ContentRenamer.visit_ClassDef">
<a class="viewcode-back" href="../../agi-env.html#agi_env.agi_env.ContentRenamer.visit_ClassDef">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">visit_ClassDef</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="c1"># Rename class names</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Visit and potentially rename a ClassDef node.</span>

<span class="sd">        Args:</span>
<span class="sd">            node (ast.ClassDef): The ClassDef node to visit.</span>

<span class="sd">        Returns:</span>
<span class="sd">            ast.ClassDef: The potentially modified ClassDef node.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rename_map</span><span class="p">:</span>
            <span class="n">AgiEnv</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Renaming Class: </span><span class="si">{</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> ➔ </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">rename_map</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">node</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rename_map</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generic_visit</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">node</span></div>


<div class="viewcode-block" id="ContentRenamer.visit_arg">
<a class="viewcode-back" href="../../agi-env.html#agi_env.agi_env.ContentRenamer.visit_arg">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">visit_arg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="c1"># Rename function argument names</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Visit and potentially rename an argument node.</span>

<span class="sd">        Args:</span>
<span class="sd">            self: The instance of the class.</span>
<span class="sd">            node: The argument node to visit and possibly rename.</span>

<span class="sd">        Returns:</span>
<span class="sd">            ast.AST: The modified argument node.</span>

<span class="sd">        Notes:</span>
<span class="sd">            Modifies the argument node in place if its name is found in the rename map.</span>

<span class="sd">        Raises:</span>
<span class="sd">            None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">arg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rename_map</span><span class="p">:</span>
            <span class="n">AgiEnv</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Renaming Argument: </span><span class="si">{</span><span class="n">node</span><span class="o">.</span><span class="n">arg</span><span class="si">}</span><span class="s2"> ➔ </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">rename_map</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">arg</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">node</span><span class="o">.</span><span class="n">arg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rename_map</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">arg</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generic_visit</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">node</span></div>


<div class="viewcode-block" id="ContentRenamer.visit_Global">
<a class="viewcode-back" href="../../agi-env.html#agi_env.agi_env.ContentRenamer.visit_Global">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">visit_Global</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="c1"># Rename global variable names</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Visit and potentially rename global variables in the AST node.</span>

<span class="sd">        Args:</span>
<span class="sd">            self: The instance of the class that contains the renaming logic.</span>
<span class="sd">            node: The AST node to visit and potentially rename global variables.</span>

<span class="sd">        Returns:</span>
<span class="sd">            AST node: The modified AST node with global variable names potentially renamed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">new_names</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rename_map</span><span class="p">:</span>
                <span class="n">AgiEnv</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Renaming Global Variable: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> ➔ </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">rename_map</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">new_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rename_map</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">node</span><span class="o">.</span><span class="n">names</span> <span class="o">=</span> <span class="n">new_names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generic_visit</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">node</span></div>


<div class="viewcode-block" id="ContentRenamer.visit_nonlocal">
<a class="viewcode-back" href="../../agi-env.html#agi_env.agi_env.ContentRenamer.visit_nonlocal">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">visit_nonlocal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="c1"># Rename nonlocal variable names</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Visit and potentially rename nonlocal variables in the AST node.</span>

<span class="sd">        Args:</span>
<span class="sd">            self: An instance of the class containing the visit_nonlocal method.</span>
<span class="sd">            node: The AST node to visit and potentially modify.</span>

<span class="sd">        Returns:</span>
<span class="sd">            ast.AST: The modified AST node after visiting and potentially renaming nonlocal variables.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">new_names</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rename_map</span><span class="p">:</span>
                <span class="n">AgiEnv</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Renaming Nonlocal Variable: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> ➔ </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">rename_map</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="n">new_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rename_map</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">node</span><span class="o">.</span><span class="n">names</span> <span class="o">=</span> <span class="n">new_names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generic_visit</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">node</span></div>


<div class="viewcode-block" id="ContentRenamer.visit_Assign">
<a class="viewcode-back" href="../../agi-env.html#agi_env.agi_env.ContentRenamer.visit_Assign">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">visit_Assign</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="c1"># Rename assigned variable names</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Visit and process an assignment node.</span>

<span class="sd">        Args:</span>
<span class="sd">            self: The instance of the visitor class.</span>
<span class="sd">            node: The assignment node to be visited.</span>

<span class="sd">        Returns:</span>
<span class="sd">            ast.Node: The visited assignment node.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generic_visit</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">node</span></div>


<div class="viewcode-block" id="ContentRenamer.visit_AnnAssign">
<a class="viewcode-back" href="../../agi-env.html#agi_env.agi_env.ContentRenamer.visit_AnnAssign">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">visit_AnnAssign</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="c1"># Rename annotated assignments</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Visit and process an AnnAssign node in an abstract syntax tree.</span>

<span class="sd">        Args:</span>
<span class="sd">            self: The AST visitor object.</span>
<span class="sd">            node: The AnnAssign node to be visited.</span>

<span class="sd">        Returns:</span>
<span class="sd">            AnnAssign: The visited AnnAssign node.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generic_visit</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">node</span></div>


<div class="viewcode-block" id="ContentRenamer.visit_For">
<a class="viewcode-back" href="../../agi-env.html#agi_env.agi_env.ContentRenamer.visit_For">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">visit_For</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="c1"># Rename loop variable names</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Visit and potentially rename the target variable in a For loop node.</span>

<span class="sd">        Args:</span>
<span class="sd">            node (ast.For): The For loop node to visit.</span>

<span class="sd">        Returns:</span>
<span class="sd">            ast.For: The modified For loop node.</span>

<span class="sd">        Note:</span>
<span class="sd">            This function may modify the target variable in the For loop node if it exists in the rename map.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">)</span> <span class="ow">and</span> <span class="n">node</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rename_map</span><span class="p">:</span>
            <span class="n">AgiEnv</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Renaming For Loop Variable: </span><span class="si">{</span><span class="n">node</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2"> ➔ </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">rename_map</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">id</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="n">node</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rename_map</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">id</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generic_visit</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">node</span></div>


<div class="viewcode-block" id="ContentRenamer.visit_Import">
<a class="viewcode-back" href="../../agi-env.html#agi_env.agi_env.ContentRenamer.visit_Import">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">visit_Import</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Rename imported modules in &#39;import module&#39; statements.</span>

<span class="sd">        Args:</span>
<span class="sd">            node (ast.Import): The import node.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">alias</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
            <span class="n">original_name</span> <span class="o">=</span> <span class="n">alias</span><span class="o">.</span><span class="n">name</span>
            <span class="k">if</span> <span class="n">original_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rename_map</span><span class="p">:</span>
                <span class="n">AgiEnv</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Renaming Import Module: </span><span class="si">{</span><span class="n">original_name</span><span class="si">}</span><span class="s2"> ➔ </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">rename_map</span><span class="p">[</span><span class="n">original_name</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="n">alias</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rename_map</span><span class="p">[</span><span class="n">original_name</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Handle compound module names if necessary</span>
                <span class="k">for</span> <span class="n">old</span><span class="p">,</span> <span class="n">new</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rename_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">original_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">old</span><span class="p">):</span>
                        <span class="n">AgiEnv</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Renaming Import Module: </span><span class="si">{</span><span class="n">original_name</span><span class="si">}</span><span class="s2"> ➔ </span><span class="si">{</span><span class="n">original_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">old</span><span class="p">,</span><span class="w"> </span><span class="n">new</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
                        <span class="n">alias</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">original_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                        <span class="k">break</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generic_visit</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">node</span></div>


<div class="viewcode-block" id="ContentRenamer.visit_ImportFrom">
<a class="viewcode-back" href="../../agi-env.html#agi_env.agi_env.ContentRenamer.visit_ImportFrom">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">visit_ImportFrom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Rename modules and imported names in &#39;from module import name&#39; statements.</span>

<span class="sd">        Args:</span>
<span class="sd">            node (ast.ImportFrom): The import from node.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Rename the module being imported from</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">module</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rename_map</span><span class="p">:</span>
            <span class="n">AgiEnv</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Renaming ImportFrom Module: </span><span class="si">{</span><span class="n">node</span><span class="o">.</span><span class="n">module</span><span class="si">}</span><span class="s2"> ➔ </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">rename_map</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">module</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="n">node</span><span class="o">.</span><span class="n">module</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rename_map</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">module</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">old</span><span class="p">,</span> <span class="n">new</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rename_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">module</span> <span class="ow">and</span> <span class="n">node</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">old</span><span class="p">):</span>
                    <span class="n">new_module</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">AgiEnv</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Renaming ImportFrom Module: </span><span class="si">{</span><span class="n">node</span><span class="o">.</span><span class="n">module</span><span class="si">}</span><span class="s2"> ➔ </span><span class="si">{</span><span class="n">new_module</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                    <span class="n">node</span><span class="o">.</span><span class="n">module</span> <span class="o">=</span> <span class="n">new_module</span>
                    <span class="k">break</span>

        <span class="c1"># Rename the imported names</span>
        <span class="k">for</span> <span class="n">alias</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">alias</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rename_map</span><span class="p">:</span>
                <span class="n">AgiEnv</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Renaming Imported Name: </span><span class="si">{</span><span class="n">alias</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> ➔ </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">rename_map</span><span class="p">[</span><span class="n">alias</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="n">alias</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rename_map</span><span class="p">[</span><span class="n">alias</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">old</span><span class="p">,</span> <span class="n">new</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rename_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">alias</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">old</span><span class="p">):</span>
                        <span class="n">AgiEnv</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Renaming Imported Name: </span><span class="si">{</span><span class="n">alias</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> ➔ </span><span class="si">{</span><span class="n">alias</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">old</span><span class="p">,</span><span class="w"> </span><span class="n">new</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
                        <span class="n">alias</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">alias</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                        <span class="k">break</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generic_visit</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">node</span>

        <span class="kn">import</span><span class="w"> </span><span class="nn">getpass</span><span class="o">,</span><span class="w"> </span><span class="nn">os</span><span class="o">,</span><span class="w"> </span><span class="nn">sys</span><span class="o">,</span><span class="w"> </span><span class="nn">subprocess</span><span class="o">,</span><span class="w"> </span><span class="nn">signal</span>

        <span class="n">me</span> <span class="o">=</span> <span class="n">getpass</span><span class="o">.</span><span class="n">getuser</span><span class="p">()</span>
        <span class="n">my_pid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span></div>
</div>

<span class="k">def</span><span class="w"> </span><span class="nf">_is_relative_to</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return ``True`` if ``path`` lies under ``other`` (without requiring Python 3.9).&quot;&quot;&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">path</span><span class="o">.</span><span class="n">relative_to</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, THALES SIX GTS France SAS.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>