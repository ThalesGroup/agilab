

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>agi_runner.agi_runner &mdash; AGILab 1.0.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css?v=4ae1632d" />
      <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />
      <link rel="stylesheet" type="text/css" href="../../_static/custom.css?v=28052664" />

  
    <link rel="canonical" href="https://thalesgroup.github.io/agilab/_modules/agi_runner/agi_runner.html" />
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=8d563738"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            AGILab
              <img src="../../_static/agi_logo.svg" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../quick-start.html">Quick-Start</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../quick-start.html#license">LICENSE</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../quick-start.html#install-agilab">Install Agilab</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../quick-start.html#support">Support</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../introduction.html">Introduction</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../introduction.html#overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../introduction.html#purpose"><strong>Purpose</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../introduction.html#target-audience"><strong>Target Audience</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../introduction.html#main-dependencies"><strong>Main Dependencies</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../introduction.html#technologies-selection-criteria"><strong>Technologies Selection Criteria</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../introduction.html#example-aircraft-telecommunication">Example: Aircraft Telecommunication</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../features.html">Features</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../features.html#agi-core">agi-core</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../features.html#agilab">agilab</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Core Topics</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../cluster.html">Cluster</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../cluster-help.html">Cluster Help</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../cluster-help.html#overview">Overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../cluster-help.html#principle">Principle</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../key-generation.html">Key Generation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../key-generation.html#generate-the-keys">1. Generate the keys</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../key-generation.html#loading-the-private-key-in-ssh-agent">2. Loading the private key in SSH Agent</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../key-generation.html#load-the-private-key">2.1 Load the private key</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../key-generation.html#verify-the-key-addition">2.2 Verify the key Addition</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../key-generation.html#copy-the-public-key-to-the-server">3. Copy the public key to the server</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../key-generation.html#allow-your-key">3.1 Allow your key</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../key-generation.html#verification">3.2 Verification</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../key-generation.html#troubleshooting">Troubleshooting</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../key-generation.html#sshd-service">SSHD Service</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../key-generation.html#useful-links">Useful links</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../agilab.html">AGILab</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../edit_help.html">▶️ EDIT</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../edit_help.html#sidebar">Sidebar</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../edit_help.html#main-content-area">Main Content Area</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../edit_help.html#support">Support</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../execute_help.html">▶️ EXECUTE</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../execute_help.html#introduction">Introduction</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../execute_help.html#sidebar">Sidebar</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../execute_help.html#main-content-area">Main Content Area</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../experiment_help.html">▶️ EXPERIMENT</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../experiment_help.html#sidebar">Sidebar</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../experiment_help.html#main-content-area">Main Content Area</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../views_help.html">▶️ VIEW</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../views_help.html#introduction">Introduction</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../views_help.html#sidebar">Sidebar</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../views_help.html#main-content-area">Main Content Area</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../framework-api.html">Framework API</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../agi-env.html">agi_env API</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../agi-env.html#usage-example">Usage Example</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../agi-env.html#instanciation">Instanciation</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../agi-env.html#reference">Reference</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../agi-env.html#agi_env.agi_env.AgiEnv"><code class="docutils literal notranslate"><span class="pre">AgiEnv</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../agi-env.html#agi_env.agi_env.ContentRenamer"><code class="docutils literal notranslate"><span class="pre">ContentRenamer</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../agi-env.html#agi_env.agi_env.normalize_path"><code class="docutils literal notranslate"><span class="pre">normalize_path()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../agi-runner.html">agi_runner API</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../agi-runner.html#usage-example">Usage Example</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../agi-runner.html#installation">Installation</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../agi-runner.html#update">Update</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../agi-runner.html#distribute">Distribute</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../agi-runner.html#run">Run</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../agi-runner.html#reference">Reference</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../agi-runner.html#agi_runner.agi_runner.AGI"><code class="docutils literal notranslate"><span class="pre">AGI</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../workers.html">workers API</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../workers.html#workers-reference">Workers Reference</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../workers.html#agent-worker">agent_worker</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../workers.html#dag-worker">dag_worker</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../workers.html#pandas-worker">pandas_worker</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../workers.html#polars-worker">polars_worker</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../directory-structure.html">Project Files Structure</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../install-usecase.html">Installation Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../troubleshooting.html">Troubleshooting</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../troubleshooting.html#a-prerequisite">A - Prerequisite:</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../troubleshooting.html#b-pycharm-run-debug-configurations">B - Pycharm Run/Debug configurations:</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../troubleshooting.html#c-exemple-of-tests-sequence">C - Exemple of Tests Sequence:</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../troubleshooting.html#d-agilab-run-vs-gui-run">D - agilab_run vs gui_run:</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../troubleshooting.html#known-bugs">Known Bugs</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../troubleshooting.html#uv-sync-failed">&lt;UV&gt; Sync Failed</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../troubleshooting.html#dask-debug-issue">&lt;DASK&gt; Debug Issue</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../troubleshooting.html#pycharm-run-debug-configuration-is-broken">&lt;PYCHARM&gt; Run/Debug Configuration is Broken</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../license.html">Licenses</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../gui-licenses.html">Gui Licenses</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../node-licenses.html">Node Licenses</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../env-licenses.html">Env Licenses</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../my-code-project-licenses.html">My-code-project Licenses</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../flight-project-licenses.html">Flight-project Licenses</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Example Projects</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../my-code-project.html">Example1: Mycode-Project</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../my-code-project.html#manager">manager:</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../my-code-project.html#worker-mycode-worker">worker: mycode_worker</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../my-code-project.html#mycode_worker.mycode_worker.MycodeWorker"><code class="docutils literal notranslate"><span class="pre">MycodeWorker</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../my-code-project.html#mycode_worker.mycode_worker.MycodeWorker.algo_A"><code class="docutils literal notranslate"><span class="pre">MycodeWorker.algo_A()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../my-code-project.html#mycode_worker.mycode_worker.MycodeWorker.algo_B"><code class="docutils literal notranslate"><span class="pre">MycodeWorker.algo_B()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../my-code-project.html#mycode_worker.mycode_worker.MycodeWorker.algo_C"><code class="docutils literal notranslate"><span class="pre">MycodeWorker.algo_C()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../my-code-project.html#mycode_worker.mycode_worker.MycodeWorker.algo_X"><code class="docutils literal notranslate"><span class="pre">MycodeWorker.algo_X()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../my-code-project.html#mycode_worker.mycode_worker.MycodeWorker.algo_Y"><code class="docutils literal notranslate"><span class="pre">MycodeWorker.algo_Y()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../my-code-project.html#mycode_worker.mycode_worker.MycodeWorker.algo_Z"><code class="docutils literal notranslate"><span class="pre">MycodeWorker.algo_Z()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../my-code-project.html#mycode_worker.mycode_worker.MycodeWorker.build"><code class="docutils literal notranslate"><span class="pre">MycodeWorker.build()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../my-code-project.html#mycode_worker.mycode_worker.MycodeWorker.cython_decorators"><code class="docutils literal notranslate"><span class="pre">MycodeWorker.cython_decorators</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../my-code-project.html#mycode_worker.mycode_worker.MycodeWorker.dask_home"><code class="docutils literal notranslate"><span class="pre">MycodeWorker.dask_home</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../my-code-project.html#mycode_worker.mycode_worker.MycodeWorker.do_works"><code class="docutils literal notranslate"><span class="pre">MycodeWorker.do_works()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../my-code-project.html#mycode_worker.mycode_worker.MycodeWorker.env"><code class="docutils literal notranslate"><span class="pre">MycodeWorker.env</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../my-code-project.html#mycode_worker.mycode_worker.MycodeWorker.exec"><code class="docutils literal notranslate"><span class="pre">MycodeWorker.exec()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../my-code-project.html#mycode_worker.mycode_worker.MycodeWorker.exec_mono_process"><code class="docutils literal notranslate"><span class="pre">MycodeWorker.exec_mono_process()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../my-code-project.html#mycode_worker.mycode_worker.MycodeWorker.exec_multi_process"><code class="docutils literal notranslate"><span class="pre">MycodeWorker.exec_multi_process()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../my-code-project.html#mycode_worker.mycode_worker.MycodeWorker.expand"><code class="docutils literal notranslate"><span class="pre">MycodeWorker.expand()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../my-code-project.html#mycode_worker.mycode_worker.MycodeWorker.expand_and_join"><code class="docutils literal notranslate"><span class="pre">MycodeWorker.expand_and_join()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../my-code-project.html#mycode_worker.mycode_worker.MycodeWorker.get_logs_and_result"><code class="docutils literal notranslate"><span class="pre">MycodeWorker.get_logs_and_result()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../my-code-project.html#mycode_worker.mycode_worker.MycodeWorker.get_work"><code class="docutils literal notranslate"><span class="pre">MycodeWorker.get_work()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../my-code-project.html#mycode_worker.mycode_worker.MycodeWorker.get_worker_info"><code class="docutils literal notranslate"><span class="pre">MycodeWorker.get_worker_info()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../my-code-project.html#mycode_worker.mycode_worker.MycodeWorker.home_dir"><code class="docutils literal notranslate"><span class="pre">MycodeWorker.home_dir</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../my-code-project.html#mycode_worker.mycode_worker.MycodeWorker.is_managed_pc"><code class="docutils literal notranslate"><span class="pre">MycodeWorker.is_managed_pc</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../my-code-project.html#mycode_worker.mycode_worker.MycodeWorker.join"><code class="docutils literal notranslate"><span class="pre">MycodeWorker.join()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../my-code-project.html#mycode_worker.mycode_worker.MycodeWorker.logs"><code class="docutils literal notranslate"><span class="pre">MycodeWorker.logs</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../my-code-project.html#mycode_worker.mycode_worker.MycodeWorker.mode"><code class="docutils literal notranslate"><span class="pre">MycodeWorker.mode</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../my-code-project.html#mycode_worker.mycode_worker.MycodeWorker.new"><code class="docutils literal notranslate"><span class="pre">MycodeWorker.new()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../my-code-project.html#mycode_worker.mycode_worker.MycodeWorker.onerror"><code class="docutils literal notranslate"><span class="pre">MycodeWorker.onerror()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../my-code-project.html#mycode_worker.mycode_worker.MycodeWorker.run"><code class="docutils literal notranslate"><span class="pre">MycodeWorker.run()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../my-code-project.html#mycode_worker.mycode_worker.MycodeWorker.share_path"><code class="docutils literal notranslate"><span class="pre">MycodeWorker.share_path</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../my-code-project.html#mycode_worker.mycode_worker.MycodeWorker.start"><code class="docutils literal notranslate"><span class="pre">MycodeWorker.start()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../my-code-project.html#mycode_worker.mycode_worker.MycodeWorker.stop"><code class="docutils literal notranslate"><span class="pre">MycodeWorker.stop()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../my-code-project.html#mycode_worker.mycode_worker.MycodeWorker.t0"><code class="docutils literal notranslate"><span class="pre">MycodeWorker.t0</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../my-code-project.html#mycode_worker.mycode_worker.MycodeWorker.topological_sort"><code class="docutils literal notranslate"><span class="pre">MycodeWorker.topological_sort()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../my-code-project.html#mycode_worker.mycode_worker.MycodeWorker.verbose"><code class="docutils literal notranslate"><span class="pre">MycodeWorker.verbose</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../my-code-project.html#mycode_worker.mycode_worker.MycodeWorker.worker"><code class="docutils literal notranslate"><span class="pre">MycodeWorker.worker</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../my-code-project.html#mycode_worker.mycode_worker.MycodeWorker.worker_id"><code class="docutils literal notranslate"><span class="pre">MycodeWorker.worker_id</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../my-code-project.html#mycode_worker.mycode_worker.MycodeWorker.works"><code class="docutils literal notranslate"><span class="pre">MycodeWorker.works()</span></code></a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../flight-project.html">Example2: Flight-Project</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../flight-project.html#manager-flight">manager: flight</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../flight-project.html#flight.flight.Flight"><code class="docutils literal notranslate"><span class="pre">Flight</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../flight-project.html#flight.flight.Flight.__init__"><code class="docutils literal notranslate"><span class="pre">Flight.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../flight-project.html#flight.flight.Flight.args"><code class="docutils literal notranslate"><span class="pre">Flight.args</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../flight-project.html#flight.flight.Flight.build_distribution"><code class="docutils literal notranslate"><span class="pre">Flight.build_distribution()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../flight-project.html#flight.flight.Flight.convert_functions_to_names"><code class="docutils literal notranslate"><span class="pre">Flight.convert_functions_to_names()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../flight-project.html#flight.flight.Flight.data_out"><code class="docutils literal notranslate"><span class="pre">Flight.data_out</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../flight-project.html#flight.flight.Flight.do_distrib"><code class="docutils literal notranslate"><span class="pre">Flight.do_distrib()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../flight-project.html#flight.flight.Flight.extract_plane_from_file_name"><code class="docutils literal notranslate"><span class="pre">Flight.extract_plane_from_file_name()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../flight-project.html#flight.flight.Flight.get_data_from_files"><code class="docutils literal notranslate"><span class="pre">Flight.get_data_from_files()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../flight-project.html#flight.flight.Flight.get_data_from_hawk"><code class="docutils literal notranslate"><span class="pre">Flight.get_data_from_hawk()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../flight-project.html#flight.flight.Flight.get_partition_by_planes"><code class="docutils literal notranslate"><span class="pre">Flight.get_partition_by_planes()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../flight-project.html#flight.flight.Flight.ivq_logs"><code class="docutils literal notranslate"><span class="pre">Flight.ivq_logs</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../flight-project.html#flight.flight.Flight.make_chunks"><code class="docutils literal notranslate"><span class="pre">Flight.make_chunks()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../flight-project.html#flight.flight.Flight.onerror"><code class="docutils literal notranslate"><span class="pre">Flight.onerror()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../flight-project.html#flight.flight.Flight.verbose"><code class="docutils literal notranslate"><span class="pre">Flight.verbose</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../flight-project.html#flight.flight.FlightArgs"><code class="docutils literal notranslate"><span class="pre">FlightArgs</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../flight-project.html#flight.flight.FlightArgs.__init__"><code class="docutils literal notranslate"><span class="pre">FlightArgs.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../flight-project.html#flight.flight.FlightArgs.check_date"><code class="docutils literal notranslate"><span class="pre">FlightArgs.check_date()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../flight-project.html#flight.flight.FlightArgs.check_date_order"><code class="docutils literal notranslate"><span class="pre">FlightArgs.check_date_order()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../flight-project.html#flight.flight.FlightArgs.check_valid_regex"><code class="docutils literal notranslate"><span class="pre">FlightArgs.check_valid_regex()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../flight-project.html#flight.flight.FlightArgs.construct"><code class="docutils literal notranslate"><span class="pre">FlightArgs.construct()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../flight-project.html#flight.flight.FlightArgs.copy"><code class="docutils literal notranslate"><span class="pre">FlightArgs.copy()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../flight-project.html#flight.flight.FlightArgs.data_source"><code class="docutils literal notranslate"><span class="pre">FlightArgs.data_source</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../flight-project.html#flight.flight.FlightArgs.datemax"><code class="docutils literal notranslate"><span class="pre">FlightArgs.datemax</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../flight-project.html#flight.flight.FlightArgs.datemin"><code class="docutils literal notranslate"><span class="pre">FlightArgs.datemin</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../flight-project.html#flight.flight.FlightArgs.dict"><code class="docutils literal notranslate"><span class="pre">FlightArgs.dict()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../flight-project.html#flight.flight.FlightArgs.files"><code class="docutils literal notranslate"><span class="pre">FlightArgs.files</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../flight-project.html#flight.flight.FlightArgs.from_orm"><code class="docutils literal notranslate"><span class="pre">FlightArgs.from_orm()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../flight-project.html#flight.flight.FlightArgs.json"><code class="docutils literal notranslate"><span class="pre">FlightArgs.json()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../flight-project.html#flight.flight.FlightArgs.model_computed_fields"><code class="docutils literal notranslate"><span class="pre">FlightArgs.model_computed_fields</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../flight-project.html#flight.flight.FlightArgs.model_config"><code class="docutils literal notranslate"><span class="pre">FlightArgs.model_config</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../flight-project.html#flight.flight.FlightArgs.model_construct"><code class="docutils literal notranslate"><span class="pre">FlightArgs.model_construct()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../flight-project.html#flight.flight.FlightArgs.model_copy"><code class="docutils literal notranslate"><span class="pre">FlightArgs.model_copy()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../flight-project.html#flight.flight.FlightArgs.model_dump"><code class="docutils literal notranslate"><span class="pre">FlightArgs.model_dump()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../flight-project.html#flight.flight.FlightArgs.model_dump_json"><code class="docutils literal notranslate"><span class="pre">FlightArgs.model_dump_json()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../flight-project.html#flight.flight.FlightArgs.model_extra"><code class="docutils literal notranslate"><span class="pre">FlightArgs.model_extra</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../flight-project.html#flight.flight.FlightArgs.model_fields"><code class="docutils literal notranslate"><span class="pre">FlightArgs.model_fields</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../flight-project.html#flight.flight.FlightArgs.model_fields_set"><code class="docutils literal notranslate"><span class="pre">FlightArgs.model_fields_set</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../flight-project.html#flight.flight.FlightArgs.model_json_schema"><code class="docutils literal notranslate"><span class="pre">FlightArgs.model_json_schema()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../flight-project.html#flight.flight.FlightArgs.model_parametrized_name"><code class="docutils literal notranslate"><span class="pre">FlightArgs.model_parametrized_name()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../flight-project.html#flight.flight.FlightArgs.model_post_init"><code class="docutils literal notranslate"><span class="pre">FlightArgs.model_post_init()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../flight-project.html#flight.flight.FlightArgs.model_rebuild"><code class="docutils literal notranslate"><span class="pre">FlightArgs.model_rebuild()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../flight-project.html#flight.flight.FlightArgs.model_validate"><code class="docutils literal notranslate"><span class="pre">FlightArgs.model_validate()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../flight-project.html#flight.flight.FlightArgs.model_validate_json"><code class="docutils literal notranslate"><span class="pre">FlightArgs.model_validate_json()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../flight-project.html#flight.flight.FlightArgs.model_validate_strings"><code class="docutils literal notranslate"><span class="pre">FlightArgs.model_validate_strings()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../flight-project.html#flight.flight.FlightArgs.nfile"><code class="docutils literal notranslate"><span class="pre">FlightArgs.nfile</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../flight-project.html#flight.flight.FlightArgs.nread"><code class="docutils literal notranslate"><span class="pre">FlightArgs.nread</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../flight-project.html#flight.flight.FlightArgs.nskip"><code class="docutils literal notranslate"><span class="pre">FlightArgs.nskip</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../flight-project.html#flight.flight.FlightArgs.output_format"><code class="docutils literal notranslate"><span class="pre">FlightArgs.output_format</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../flight-project.html#flight.flight.FlightArgs.parse_file"><code class="docutils literal notranslate"><span class="pre">FlightArgs.parse_file()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../flight-project.html#flight.flight.FlightArgs.parse_obj"><code class="docutils literal notranslate"><span class="pre">FlightArgs.parse_obj()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../flight-project.html#flight.flight.FlightArgs.parse_raw"><code class="docutils literal notranslate"><span class="pre">FlightArgs.parse_raw()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../flight-project.html#flight.flight.FlightArgs.path"><code class="docutils literal notranslate"><span class="pre">FlightArgs.path</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../flight-project.html#flight.flight.FlightArgs.sampling_rate"><code class="docutils literal notranslate"><span class="pre">FlightArgs.sampling_rate</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../flight-project.html#flight.flight.FlightArgs.schema"><code class="docutils literal notranslate"><span class="pre">FlightArgs.schema()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../flight-project.html#flight.flight.FlightArgs.schema_json"><code class="docutils literal notranslate"><span class="pre">FlightArgs.schema_json()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../flight-project.html#flight.flight.FlightArgs.update_forward_refs"><code class="docutils literal notranslate"><span class="pre">FlightArgs.update_forward_refs()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../flight-project.html#flight.flight.FlightArgs.validate"><code class="docutils literal notranslate"><span class="pre">FlightArgs.validate()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../flight-project.html#worker-flight-worker">worker: flight_worker</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../flight-project.html#flight_worker.flight_worker.FlightWorker"><code class="docutils literal notranslate"><span class="pre">FlightWorker</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../flight-project.html#flight_worker.flight_worker.FlightWorker.build"><code class="docutils literal notranslate"><span class="pre">FlightWorker.build()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../flight-project.html#flight_worker.flight_worker.FlightWorker.calculate_speed"><code class="docutils literal notranslate"><span class="pre">FlightWorker.calculate_speed()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../flight-project.html#flight_worker.flight_worker.FlightWorker.cython_decorators"><code class="docutils literal notranslate"><span class="pre">FlightWorker.cython_decorators</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../flight-project.html#flight_worker.flight_worker.FlightWorker.dask_home"><code class="docutils literal notranslate"><span class="pre">FlightWorker.dask_home</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../flight-project.html#flight_worker.flight_worker.FlightWorker.do_works"><code class="docutils literal notranslate"><span class="pre">FlightWorker.do_works()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../flight-project.html#flight_worker.flight_worker.FlightWorker.env"><code class="docutils literal notranslate"><span class="pre">FlightWorker.env</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../flight-project.html#flight_worker.flight_worker.FlightWorker.exec"><code class="docutils literal notranslate"><span class="pre">FlightWorker.exec()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../flight-project.html#flight_worker.flight_worker.FlightWorker.exec_mono_process"><code class="docutils literal notranslate"><span class="pre">FlightWorker.exec_mono_process()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../flight-project.html#flight_worker.flight_worker.FlightWorker.exec_multi_process"><code class="docutils literal notranslate"><span class="pre">FlightWorker.exec_multi_process()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../flight-project.html#flight_worker.flight_worker.FlightWorker.expand"><code class="docutils literal notranslate"><span class="pre">FlightWorker.expand()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../flight-project.html#flight_worker.flight_worker.FlightWorker.expand_and_join"><code class="docutils literal notranslate"><span class="pre">FlightWorker.expand_and_join()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../flight-project.html#flight_worker.flight_worker.FlightWorker.get_logs_and_result"><code class="docutils literal notranslate"><span class="pre">FlightWorker.get_logs_and_result()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../flight-project.html#flight_worker.flight_worker.FlightWorker.get_worker_info"><code class="docutils literal notranslate"><span class="pre">FlightWorker.get_worker_info()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../flight-project.html#flight_worker.flight_worker.FlightWorker.home_dir"><code class="docutils literal notranslate"><span class="pre">FlightWorker.home_dir</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../flight-project.html#flight_worker.flight_worker.FlightWorker.is_managed_pc"><code class="docutils literal notranslate"><span class="pre">FlightWorker.is_managed_pc</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../flight-project.html#flight_worker.flight_worker.FlightWorker.join"><code class="docutils literal notranslate"><span class="pre">FlightWorker.join()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../flight-project.html#flight_worker.flight_worker.FlightWorker.logs"><code class="docutils literal notranslate"><span class="pre">FlightWorker.logs</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../flight-project.html#flight_worker.flight_worker.FlightWorker.mode"><code class="docutils literal notranslate"><span class="pre">FlightWorker.mode</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../flight-project.html#flight_worker.flight_worker.FlightWorker.new"><code class="docutils literal notranslate"><span class="pre">FlightWorker.new()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../flight-project.html#flight_worker.flight_worker.FlightWorker.onerror"><code class="docutils literal notranslate"><span class="pre">FlightWorker.onerror()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../flight-project.html#flight_worker.flight_worker.FlightWorker.pool_init"><code class="docutils literal notranslate"><span class="pre">FlightWorker.pool_init()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../flight-project.html#flight_worker.flight_worker.FlightWorker.pool_vars"><code class="docutils literal notranslate"><span class="pre">FlightWorker.pool_vars</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../flight-project.html#flight_worker.flight_worker.FlightWorker.preprocess_df"><code class="docutils literal notranslate"><span class="pre">FlightWorker.preprocess_df()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../flight-project.html#flight_worker.flight_worker.FlightWorker.run"><code class="docutils literal notranslate"><span class="pre">FlightWorker.run()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../flight-project.html#flight_worker.flight_worker.FlightWorker.share_path"><code class="docutils literal notranslate"><span class="pre">FlightWorker.share_path</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../flight-project.html#flight_worker.flight_worker.FlightWorker.start"><code class="docutils literal notranslate"><span class="pre">FlightWorker.start()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../flight-project.html#flight_worker.flight_worker.FlightWorker.stop"><code class="docutils literal notranslate"><span class="pre">FlightWorker.stop()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../flight-project.html#flight_worker.flight_worker.FlightWorker.t0"><code class="docutils literal notranslate"><span class="pre">FlightWorker.t0</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../flight-project.html#flight_worker.flight_worker.FlightWorker.verbose"><code class="docutils literal notranslate"><span class="pre">FlightWorker.verbose</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../flight-project.html#flight_worker.flight_worker.FlightWorker.work_done"><code class="docutils literal notranslate"><span class="pre">FlightWorker.work_done()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../flight-project.html#flight_worker.flight_worker.FlightWorker.work_init"><code class="docutils literal notranslate"><span class="pre">FlightWorker.work_init()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../flight-project.html#flight_worker.flight_worker.FlightWorker.work_pool"><code class="docutils literal notranslate"><span class="pre">FlightWorker.work_pool()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../flight-project.html#flight_worker.flight_worker.FlightWorker.worker"><code class="docutils literal notranslate"><span class="pre">FlightWorker.worker</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../flight-project.html#flight_worker.flight_worker.FlightWorker.worker_id"><code class="docutils literal notranslate"><span class="pre">FlightWorker.worker_id</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../flight-project.html#flight_worker.flight_worker.FlightWorker.works"><code class="docutils literal notranslate"><span class="pre">FlightWorker.works()</span></code></a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Hosting Sites</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../agilab-github.html"><strong>Agilab project</strong></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../agilab-github.html#agilab-components"><strong>Agilab components</strong></a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">AGILab</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">agi_runner.agi_runner</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for agi_runner.agi_runner</h1><div class="highlight"><pre>
<span></span><span class="c1"># BSD 3-Clause License</span>
<span class="c1">#</span>
<span class="c1"># Copyright (c) 2025, Jean-Pierre Morard, THALES SIX GTS France SAS</span>
<span class="c1"># All rights reserved.</span>
<span class="c1">#</span>
<span class="c1"># Redistribution and use in source and binary forms, with or without modification, are permitted provided that the following conditions are met:</span>
<span class="c1">#</span>
<span class="c1"># 1. Redistributions of source code must retain the above copyright notice, this list of conditions and the following disclaimer.</span>
<span class="c1"># 2. Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following disclaimer in the documentation and/or other materials provided with the distribution.</span>
<span class="c1"># 3. Neither the name of Jean-Pierre Morard nor the names of its contributors, or THALES SIX GTS France SAS, may be used to endorse or promote products derived from this software without specific prior written permission.</span>
<span class="c1">#</span>
<span class="c1"># THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Set</span>  <span class="c1"># Ajoute Tuple et Set</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">IPython.lib</span><span class="w"> </span><span class="kn">import</span> <span class="n">backgroundjobs</span> <span class="k">as</span> <span class="n">bg</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">getpass</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">importlib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">io</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pickle</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">random</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">shutil</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">socket</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">copy</span><span class="w"> </span><span class="kn">import</span> <span class="n">deepcopy</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">timedelta</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ipaddress</span><span class="w"> </span><span class="kn">import</span> <span class="n">ip_address</span> <span class="k">as</span> <span class="n">is_ip</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tempfile</span><span class="w"> </span><span class="kn">import</span> <span class="n">gettempdir</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Union</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sysconfig</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">contextlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">redirect_stdout</span><span class="p">,</span> <span class="n">redirect_stderr</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">errno</span>

<span class="c1"># External Libraries</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">asyncssh</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">asyncssh.process</span><span class="w"> </span><span class="kn">import</span> <span class="n">ProcessError</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">contextlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">asynccontextmanager</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">humanize</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">polars</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pl</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">psutil</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dask.distributed</span><span class="w"> </span><span class="kn">import</span> <span class="n">Client</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.ensemble</span><span class="w"> </span><span class="kn">import</span> <span class="n">RandomForestRegressor</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">subprocess</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">runpy</span>

<span class="c1"># Project Libraries:</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">agi_env</span><span class="w"> </span><span class="kn">import</span> <span class="n">AgiEnv</span><span class="p">,</span> <span class="n">normalize_path</span>
<span class="n">node_src</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">prefix</span><span class="p">)</span><span class="o">.</span><span class="n">parents</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="s2">&quot;node/src&quot;</span><span class="p">)</span>
<span class="k">if</span> <span class="n">node_src</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="p">:</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node_src</span><span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">agi_manager</span><span class="w"> </span><span class="kn">import</span> <span class="n">WorkDispatcher</span><span class="p">,</span> <span class="n">BaseWorker</span>

<span class="c1"># os.environ[&quot;DASK_DISTRIBUTED__LOGGING__DISTRIBUTED__LEVEL&quot;] = &quot;INFO&quot;</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
<span class="n">workers_default</span> <span class="o">=</span> <span class="p">{</span><span class="n">socket</span><span class="o">.</span><span class="n">gethostbyname</span><span class="p">(</span><span class="s2">&quot;localhost&quot;</span><span class="p">):</span> <span class="mi">1</span><span class="p">}</span>


<div class="viewcode-block" id="AGI">
<a class="viewcode-back" href="../../agi-runner.html#agi_runner.agi_runner.AGI">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">AGI</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Agi Class.</span>

<span class="sd">    Agi (Speedy-Python-Dask) is a scalable core based on Cython, Dask, and a pool of processes that supports High-Performance Computing (HPC) with or without out¬put data.</span>
<span class="sd">    It offers a command-line interface in Python and an optional LAB with Streamlit, featuring advanced capabilities like embedded ChatGPT and visualizations.</span>

<span class="sd">    Agi stands for Speedy-Python-Dask.</span>

<span class="sd">    **To run on a cluster:**</span>
<span class="sd">        1. Create a Agi account on each host with SSH access.</span>
<span class="sd">        2. Copy your project&#39;s `pyproject.toml` to each host.</span>
<span class="sd">        3. Run `uv sync` before using AGI.</span>
<span class="sd">        4. To run with output data, provide a shared directory accessible from all hosts. Use this directory in your Python target code as both input and output.</span>

<span class="sd">    **Remarks:**</span>
<span class="sd">        - Interactive Matplotlib graphics are not supported by Jupyter Lab. Use Jupyter Notebook instead.</span>
<span class="sd">        - While debugging in a Jupyter cell, it&#39;s better to comment out `#%%time` to allow line numbers to display correctly.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Constants as class attributes</span>
    <span class="n">TIMEOUT</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="n">PYTHON_MODE</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">CYTHON_MODE</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">DASK_MODE</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="n">RAPIDS_MODE</span> <span class="o">=</span> <span class="mi">16</span>
    <span class="n">INSTALL_MASK</span> <span class="o">=</span> <span class="mb">0b11</span> <span class="o">&lt;&lt;</span> <span class="n">DASK_MODE</span>
    <span class="n">INSTALL_MODE</span> <span class="o">=</span> <span class="mb">0b01</span> <span class="o">&lt;&lt;</span> <span class="n">DASK_MODE</span>
    <span class="n">UPDATE_MODE</span> <span class="o">=</span> <span class="mb">0b10</span> <span class="o">&lt;&lt;</span> <span class="n">DASK_MODE</span>
    <span class="n">SIMULATE_MODE</span> <span class="o">=</span> <span class="mb">0b11</span> <span class="o">&lt;&lt;</span> <span class="n">DASK_MODE</span>
    <span class="n">DEPLOYEMENT_MASK</span> <span class="o">=</span> <span class="mb">0b110000</span>
    <span class="n">RUN_MASK</span> <span class="o">=</span> <span class="mb">0b001111</span>
    <span class="n">RAPIDS_SET</span> <span class="o">=</span> <span class="mb">0b111111</span>
    <span class="n">RAPIDS_RESET</span> <span class="o">=</span> <span class="mb">0b110111</span>
    <span class="n">DASK_RESET</span> <span class="o">=</span> <span class="mb">0b111011</span>
    <span class="n">_args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_dask_client</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Client</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_dask_scheduler</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_dask_workers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_jobs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">bg</span><span class="o">.</span><span class="n">BackgroundJobManager</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_local_ip</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">_install_done_local</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">_mode</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_mode_auto</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">_remote_ip</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">_install_done</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">_install_todo</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">_scheduler</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_scheduler_ip</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_target</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">verbose</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_worker_init_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">workers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_capacity</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_capacity_data_file</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_capacity_model_file</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_capacity_predictor</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">RandomForestRegressor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_worker_default</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">workers_default</span>
    <span class="n">_run_time</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">_run_type</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_run_types</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">_sys_path_to_clean</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">_target_built</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_module_to_clean</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">_ssh_connections</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">best_mode</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">workers_tree</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">workers_tree_info</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">debug</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># Cache with default local IPs</span>
    <span class="n">env</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AgiEnv</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="AGI.__init__">
<a class="viewcode-back" href="../../agi-runner.html#agi_runner.agi_runner.AGI.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize a Agi object with a target and verbosity level.</span>

<span class="sd">        Args:</span>
<span class="sd">            target (str): The target for the env object.</span>
<span class="sd">            verbose (int): Verbosity level (0-3).</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>

<span class="sd">        Raises:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># At the top of __init__:</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">AGI</span><span class="p">,</span> <span class="s2">&quot;_instantiated&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_instantiated</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;AGI class is a singleton. Only one instance allowed per process.&quot;</span><span class="p">)</span>
        <span class="n">AGI</span><span class="o">.</span><span class="n">_instantiated</span> <span class="o">=</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="AGI.run">
<a class="viewcode-back" href="../../agi-runner.html#agi_runner.agi_runner.AGI.run">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span>
            <span class="n">target</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="n">env</span><span class="p">:</span> <span class="n">AgiEnv</span><span class="p">,</span>  <span class="c1"># some_default_value must be defined</span>
            <span class="n">scheduler</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">workers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">verbose</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
            <span class="n">mode</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">rapids_enabled</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
            <span class="o">**</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compiles the target module in Cython and runs it on the cluster.</span>

<span class="sd">        Args:</span>
<span class="sd">            target (str): The target Python module to run.</span>
<span class="sd">            scheduler (str, optional): IP and port address of the Dask scheduler. Defaults to &#39;127.0.0.1:8786&#39;.</span>
<span class="sd">            workers (dict, optional): Dictionary of worker IPs and their counts. Defaults to `workers_default`.</span>
<span class="sd">            verbose (int, optional): Verbosity level. Defaults to 0.</span>
<span class="sd">            mode (int or list, optional): Mode(s) for execution. Defaults to None.</span>
<span class="sd">                - Bitmask `0b----` (4 bits) where each bit enables/disables specific features:</span>
<span class="sd">                    - `1---`: Rapids</span>
<span class="sd">                    - `-1--`: Dask</span>
<span class="sd">                    - `--1-`: Cython</span>
<span class="sd">                    - `---1`: Pool</span>
<span class="sd">                - `mode` can also be a list of modes to chain for the run.</span>
<span class="sd">            rapids_enabled (bool, optional): Flag to enable RAPIDS. Defaults to False.</span>
<span class="sd">            **args (Any): Additional keyword arguments.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Any: Result of the execution.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If `mode` is invalid.</span>
<span class="sd">            RuntimeError: If the target module fails to load.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">AGI</span><span class="o">.</span><span class="n">env</span> <span class="o">=</span> <span class="n">env</span>
        <span class="n">env</span><span class="o">.</span><span class="n">active</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">env</span><span class="o">.</span><span class="n">install_type</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">workers</span><span class="p">:</span>
            <span class="n">workers</span> <span class="o">=</span> <span class="n">workers_default</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">workers</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;workers must be a dict. {&#39;ip-address&#39;:nb-worker}&quot;</span><span class="p">)</span>

        <span class="n">AGI</span><span class="o">.</span><span class="n">target_path</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">module_path</span>
        <span class="n">AGI</span><span class="o">.</span><span class="n">_target</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">target</span>
        <span class="n">AGI</span><span class="o">.</span><span class="n">_rapids_enabled</span> <span class="o">=</span> <span class="n">rapids_enabled</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AGI instance created for target </span><span class="si">{</span><span class="n">target</span><span class="si">}</span><span class="s2"> with verbosity </span><span class="si">{</span><span class="n">env</span><span class="o">.</span><span class="n">verbose</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">mode</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">mode_range</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="k">if</span> <span class="n">mode</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>
            <span class="k">return</span> <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_run_all_modes</span><span class="p">(</span>
                <span class="n">target</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">scheduler</span><span class="p">,</span> <span class="n">workers</span><span class="p">,</span> <span class="n">verbose</span><span class="p">,</span> <span class="n">mode_range</span><span class="p">,</span> <span class="n">rapids_enabled</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;^[dcrp]+$&quot;</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">fullmatch</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">mode</span><span class="o">.</span><span class="n">lower</span><span class="p">()):</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;parameter &lt;mode&gt; must only contain the letters &#39;d&#39;, &#39;c&#39;, &#39;r&#39;, &#39;p&#39;&quot;</span><span class="p">)</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">AGI</span><span class="o">.</span><span class="n">_mode</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">mode2int</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                <span class="n">AGI</span><span class="o">.</span><span class="n">_mode</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;parameter &lt;mode&gt; must be an int, a list of int or a string&quot;</span><span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

            <span class="n">AGI</span><span class="o">.</span><span class="n">_run_types</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;run&quot;</span><span class="p">,</span> <span class="s2">&quot;sync --upgrade&quot;</span><span class="p">,</span> <span class="s2">&quot;sync --upgradeƒ&quot;</span><span class="p">,</span> <span class="s2">&quot;simulate&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_mode</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_mode</span> <span class="o">&amp;</span> <span class="n">AGI</span><span class="o">.</span><span class="n">RUN_MASK</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">AGI</span><span class="o">.</span><span class="n">RAPIDS_MODE</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;mode </span><span class="si">{</span><span class="n">AGI</span><span class="o">.</span><span class="n">_mode</span><span class="si">}</span><span class="s2"> not implemented&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># 16 first modes are &quot;run&quot; type, then there 16, 17 and 18</span>
                <span class="n">AGI</span><span class="o">.</span><span class="n">_run_type</span> <span class="o">=</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_run_types</span><span class="p">[(</span><span class="n">AGI</span><span class="o">.</span><span class="n">_mode</span> <span class="o">&amp;</span> <span class="n">AGI</span><span class="o">.</span><span class="n">DEPLOYEMENT_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">AGI</span><span class="o">.</span><span class="n">DASK_MODE</span><span class="p">]</span>
            <span class="n">AGI</span><span class="o">.</span><span class="n">_args</span> <span class="o">=</span> <span class="n">args</span>
            <span class="n">AGI</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>
            <span class="n">AGI</span><span class="o">.</span><span class="n">workers</span> <span class="o">=</span> <span class="n">workers</span>
            <span class="n">AGI</span><span class="o">.</span><span class="n">_run_time</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="n">AGI</span><span class="o">.</span><span class="n">_capacity_data_file</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">resource_path</span> <span class="o">/</span> <span class="s2">&quot;balancer_df.csv&quot;</span>
            <span class="n">AGI</span><span class="o">.</span><span class="n">_capacity_model_file</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">resource_path</span> <span class="o">/</span> <span class="s2">&quot;balancer_model.pkl&quot;</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">AGI</span><span class="o">.</span><span class="n">_capacity_model_file</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">AGI</span><span class="o">.</span><span class="n">_capacity_predictor</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">AGI</span><span class="o">.</span><span class="n">_train_model</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">home_abs</span><span class="p">)</span>

            <span class="c1"># import of derived Class of WorkDispatcher, name target_inst which is typically instance of Flight or MyCode</span>
            <span class="n">AGI</span><span class="o">.</span><span class="n">agi_workers</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;PolarsWorker&quot;</span><span class="p">:</span> <span class="s2">&quot;polars-worker&quot;</span><span class="p">,</span>
                <span class="s2">&quot;PandasWorker&quot;</span><span class="p">:</span> <span class="s2">&quot;pandas-worker&quot;</span><span class="p">,</span>
                <span class="s2">&quot;DagWorker&quot;</span><span class="p">:</span> <span class="s2">&quot;dag-worker&quot;</span><span class="p">,</span>
                <span class="s2">&quot;AgentWorker&quot;</span><span class="p">:</span> <span class="s2">&quot;agent-worker&quot;</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="c1"># AGI.install_worker_group = AGI.agi_workers[env.base_worker_cls]</span>
            <span class="n">AGI</span><span class="o">.</span><span class="n">install_worker_group</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;agi-manager &quot;</span><span class="p">,</span> <span class="n">AGI</span><span class="o">.</span><span class="n">agi_workers</span><span class="p">[</span><span class="n">env</span><span class="o">.</span><span class="n">base_worker_cls</span><span class="p">]]</span>
            <span class="n">base_worker_dir</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">cluster_root</span> <span class="o">/</span> <span class="s2">&quot;src&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">base_worker_dir</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">base_worker_dir</span><span class="p">)</span>
            <span class="n">AGI</span><span class="o">.</span><span class="n">_target_module</span> <span class="o">=</span> <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_load_module</span><span class="p">(</span>
                <span class="n">AGI</span><span class="o">.</span><span class="n">_target</span><span class="p">,</span>
                <span class="n">env</span><span class="o">.</span><span class="n">module</span><span class="p">,</span>
                <span class="n">path</span><span class="o">=</span><span class="n">env</span><span class="o">.</span><span class="n">app_src</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_target_module</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;failed to load </span><span class="si">{</span><span class="n">AGI</span><span class="o">.</span><span class="n">_target</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">target_class</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">AGI</span><span class="o">.</span><span class="n">_target_module</span><span class="p">,</span> <span class="n">env</span><span class="o">.</span><span class="n">target_class</span><span class="p">)</span>
            <span class="n">AGI</span><span class="o">.</span><span class="n">_target_inst</span> <span class="o">=</span> <span class="n">target_class</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">main</span><span class="p">(</span><span class="n">scheduler</span><span class="p">)</span>

            <span class="k">except</span> <span class="n">ProcessError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;failed to run </span><span class="se">\n</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="k">except</span> <span class="ne">ConnectionError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;failed to connect </span><span class="se">\n</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unhandled exception in AGI.run: </span><span class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">raise</span></div>


    <span class="nd">@staticmethod</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_run_all_modes</span><span class="p">(</span>
        <span class="n">target</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">env</span><span class="p">:</span> <span class="n">AgiEnv</span><span class="p">,</span>
        <span class="n">scheduler</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">workers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">verbose</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">mode_range</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="nb">range</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">rapids_enabled</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run all modes to find the fastest one.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: A dictionary where keys are each mode (from mode_range) and values are dicts</span>
<span class="sd">                  with keys including:</span>
<span class="sd">                    - &quot;mode&quot;: an identifying string for the mode,</span>
<span class="sd">                    - &quot;timing&quot;: a human-readable formatted string of the runtime,</span>
<span class="sd">                    - &quot;time&quot;: the runtime in seconds (as a float),</span>
<span class="sd">                    - &quot;order&quot;: the rank order (an integer, 1 for fastest, etc.).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">AGI</span><span class="o">.</span><span class="n">_mode_auto</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">rapids_mode_mask</span> <span class="o">=</span> <span class="n">AGI</span><span class="o">.</span><span class="n">RAPIDS_SET</span> <span class="k">if</span> <span class="n">rapids_enabled</span> <span class="k">else</span> <span class="n">AGI</span><span class="o">.</span><span class="n">RAPIDS_RESET</span>
        <span class="n">runs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">env</span><span class="o">.</span><span class="n">benchmark</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">benchmark</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">mode_range</span><span class="p">:</span>
            <span class="c1"># Determine which run mode to use.</span>
            <span class="n">run_mode</span> <span class="o">=</span> <span class="n">m</span> <span class="o">&amp;</span> <span class="n">rapids_mode_mask</span> <span class="k">if</span> <span class="n">rapids_enabled</span> <span class="k">else</span> <span class="n">m</span>

            <span class="c1"># Run the target with the current mode.</span>
            <span class="n">run</span> <span class="o">=</span> <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
                <span class="n">target</span><span class="p">,</span>
                <span class="n">env</span><span class="p">,</span>
                <span class="n">scheduler</span><span class="o">=</span><span class="n">scheduler</span><span class="p">,</span>
                <span class="n">workers</span><span class="o">=</span><span class="n">workers</span><span class="p">,</span>
                <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
                <span class="n">mode</span><span class="o">=</span><span class="n">run_mode</span><span class="p">,</span>
                <span class="o">**</span><span class="n">args</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="c1"># Assume run string splits into two parts:</span>
                <span class="c1">#  runtime[0] -&gt; an identifying string for the mode,</span>
                <span class="c1">#  runtime[1] -&gt; the time in seconds as a float</span>
                <span class="n">runtime</span> <span class="o">=</span> <span class="n">run</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">runtime</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected run format: </span><span class="si">{</span><span class="n">run</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">runtime_float</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">runtime</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

                <span class="c1"># Store in dictionary with key m</span>
                <span class="n">runs</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;mode&quot;</span><span class="p">:</span> <span class="n">runtime</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="s2">&quot;timing&quot;</span><span class="p">:</span> <span class="n">humanize</span><span class="o">.</span><span class="n">precisedelta</span><span class="p">(</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">runtime_float</span><span class="p">)),</span>
                    <span class="s2">&quot;seconds&quot;</span><span class="p">:</span> <span class="n">runtime_float</span><span class="p">,</span>
                <span class="p">}</span>

        <span class="c1"># Sort the runs by &quot;seconds&quot; (fastest to slowest) and assign order values.</span>
        <span class="n">ordered_runs</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">runs</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;seconds&quot;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="p">(</span><span class="n">mode_key</span><span class="p">,</span> <span class="n">run_data</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ordered_runs</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">run_data</span><span class="p">[</span><span class="s2">&quot;order&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">idx</span>

        <span class="c1"># The fastest run is the first in the ordered list.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ordered_runs</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;No ordered runs available after sorting.&quot;</span><span class="p">)</span>

        <span class="n">best_mode_key</span><span class="p">,</span> <span class="n">best_run_data</span> <span class="o">=</span> <span class="n">ordered_runs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Calculate delta based on &quot;seconds&quot;</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">runs</span><span class="p">:</span>
            <span class="n">runs</span><span class="p">[</span><span class="n">m</span><span class="p">][</span><span class="s2">&quot;delta&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">runs</span><span class="p">[</span><span class="n">m</span><span class="p">][</span><span class="s2">&quot;seconds&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">best_run_data</span><span class="p">[</span><span class="s2">&quot;seconds&quot;</span><span class="p">]</span>

        <span class="n">AGI</span><span class="o">.</span><span class="n">best_mode</span><span class="p">[</span><span class="n">target</span><span class="p">]</span> <span class="o">=</span> <span class="n">best_run_data</span>
        <span class="n">AGI</span><span class="o">.</span><span class="n">_mode_auto</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Convert numeric keys to strings for valid JSON output.</span>
        <span class="n">runs_str_keys</span> <span class="o">=</span> <span class="p">{</span><span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">):</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">runs</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

        <span class="c1"># Return a JSON-formatted string</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">benchmark</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">runs_str_keys</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">runs_str_keys</span><span class="p">)</span>

<div class="viewcode-block" id="AGI.get_default_local_ip">
<a class="viewcode-back" href="../../agi-runner.html#agi_runner.agi_runner.AGI.get_default_local_ip">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_default_local_ip</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the default local IP address of the machine.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: The default local IP address.</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception: If unable to determine the local IP address.</span>
<span class="sd">        &quot;&quot;&quot;</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Attempt to connect to a non-local address and capture the local endpoint&#39;s IP</span>
            <span class="k">with</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_DGRAM</span><span class="p">)</span> <span class="k">as</span> <span class="n">s</span><span class="p">:</span>
                <span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="s2">&quot;8.8.8.8&quot;</span><span class="p">,</span> <span class="mi">80</span><span class="p">))</span>
                <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">getsockname</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;Unable to determine local IP&quot;</span></div>


<div class="viewcode-block" id="AGI.find_free_port">
<a class="viewcode-back" href="../../agi-runner.html#agi_runner.agi_runner.AGI.find_free_port">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">find_free_port</span><span class="p">(</span><span class="n">start</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5000</span><span class="p">,</span> <span class="n">end</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">,</span> <span class="n">attempts</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">attempts</span><span class="p">):</span>
            <span class="n">port</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span> <span class="k">as</span> <span class="n">sock</span><span class="p">:</span>
                <span class="c1"># set SO_REUSEADDR to avoid &#39;address already in use&#39; issues during testing</span>
                <span class="n">sock</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SO_REUSEADDR</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">sock</span><span class="o">.</span><span class="n">bind</span><span class="p">((</span><span class="s2">&quot;localhost&quot;</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>
                    <span class="c1"># if binding succeeds, the port is free; close socket and return port</span>
                    <span class="k">return</span> <span class="n">port</span>
                <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                    <span class="c1"># port is already in use, try another</span>
                    <span class="k">continue</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;No free port found in the specified range.&quot;</span><span class="p">)</span></div>


    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_get_scheduler</span><span class="p">(</span><span class="n">ip_sched</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;get scheduler ip V4 address</span>
<span class="sd">        when no scheduler provided, scheduler address is localhost or the first address if workers are not local.</span>
<span class="sd">        port is random</span>

<span class="sd">        Args:</span>
<span class="sd">          ip_sched:</span>

<span class="sd">        Returns:</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">port</span> <span class="o">=</span> <span class="n">AGI</span><span class="o">.</span><span class="n">find_free_port</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ip_sched</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">AGI</span><span class="o">.</span><span class="n">workers</span><span class="p">:</span>
                <span class="n">ip</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">AGI</span><span class="o">.</span><span class="n">workers</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ip</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostbyname</span><span class="p">(</span><span class="s2">&quot;localhost&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ip_sched</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="c1"># end-user already has provided a port</span>
            <span class="n">ip</span><span class="p">,</span> <span class="n">port</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">ip_sched</span><span class="o">.</span><span class="n">items</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ip_sched</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Scheduler ip address is not valid&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ip</span> <span class="o">=</span> <span class="n">ip_sched</span>
        <span class="n">AGI</span><span class="o">.</span><span class="n">_scheduler</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">return</span> <span class="n">ip</span><span class="p">,</span> <span class="n">port</span>

    <span class="nd">@staticmethod</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_load_module</span><span class="p">(</span>
        <span class="n">module</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">package</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;load a module</span>

<span class="sd">        Args:</span>
<span class="sd">          module: the name of the Agi apps module</span>
<span class="sd">          package: the package name where is the module (Default value = None)</span>
<span class="sd">          path: the path where is the package (Default value = None)</span>

<span class="sd">        Returns:</span>
<span class="sd">          : the instance of the module</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">normalize_path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">path</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
            <span class="n">AGI</span><span class="o">.</span><span class="n">_sys_path_to_clean</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;import </span><span class="si">{</span><span class="n">module</span><span class="si">}</span><span class="s2"> from </span><span class="si">{</span><span class="n">package</span><span class="si">}</span><span class="s2"> located in </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">package</span><span class="p">:</span>
                <span class="c1"># Import module from a package</span>
                <span class="k">return</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">package</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">module</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Import module directly</span>
                <span class="k">return</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">ModuleNotFoundError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">module_to_install</span> <span class="o">=</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;No module named &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
            <span class="n">app_path</span> <span class="o">=</span> <span class="n">AGI</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">app_abs</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">AGI</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">uv</span><span class="si">}</span><span class="s2"> add --upgrade </span><span class="si">{</span><span class="n">module_to_install</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cmd</span><span class="si">}</span><span class="s2"> from </span><span class="si">{</span><span class="n">app_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">AgiEnv</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">app_path</span><span class="p">)</span>
            <span class="n">AGI</span><span class="o">.</span><span class="n">_module_to_clean</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">module_to_install</span><span class="p">)</span>
            <span class="k">return</span> <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_load_module</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">package</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_get_stdout</span><span class="p">(</span><span class="n">func</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;to get the stdout stream</span>

<span class="sd">        Args:</span>
<span class="sd">          func: param args:</span>
<span class="sd">          kwargs: return: the return of the func</span>
<span class="sd">          *args:</span>
<span class="sd">          **kwargs:</span>

<span class="sd">        Returns:</span>
<span class="sd">          : the return of the func</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">redirect_stdout</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">f</span><span class="o">.</span><span class="n">getvalue</span><span class="p">(),</span> <span class="n">result</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_read_stderr</span><span class="p">(</span><span class="n">output_stream</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Read remote stderr robustly on Linux (UTF-8), Windows OEM (CP850), then ANSI (CP1252).&quot;&quot;&quot;</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">decode_bytes</span><span class="p">(</span><span class="n">bs</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
            <span class="c1"># try UTF-8, then OEM (CP850) for console accents, then ANSI (CP1252)</span>
            <span class="k">for</span> <span class="n">enc</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="s1">&#39;cp850&#39;</span><span class="p">,</span> <span class="s1">&#39;cp1252&#39;</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">bs</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">enc</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">continue</span>
            <span class="c1"># final fallback</span>
            <span class="k">return</span> <span class="n">bs</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;cp850&#39;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;replace&#39;</span><span class="p">)</span>

        <span class="n">chan</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">output_stream</span><span class="p">,</span> <span class="s1">&#39;channel&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">chan</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># simple iteration fallback</span>
            <span class="k">for</span> <span class="n">raw</span> <span class="ow">in</span> <span class="n">output_stream</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
                    <span class="n">decoded</span> <span class="o">=</span> <span class="n">decode_bytes</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">decoded</span> <span class="o">=</span> <span class="n">decode_bytes</span><span class="p">(</span><span class="n">raw</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;latin-1&#39;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;replace&#39;</span><span class="p">))</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">decoded</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="n">AGI</span><span class="o">.</span><span class="n">_worker_init_error</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;[ProjectError]&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># non-blocking channel read</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">chan</span><span class="o">.</span><span class="n">recv_stderr_ready</span><span class="p">():</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">raw</span> <span class="o">=</span> <span class="n">chan</span><span class="o">.</span><span class="n">recv_stderr</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">raw</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="n">decoded</span> <span class="o">=</span> <span class="n">decode_bytes</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">decoded</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="n">part</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                    <span class="n">AGI</span><span class="o">.</span><span class="n">_worker_init_error</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;[ProjectError]&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">chan</span><span class="o">.</span><span class="n">exit_status_ready</span><span class="p">():</span>
                <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_kill</span><span class="p">(</span><span class="n">ip</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">current_pid</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">force</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Terminate &#39;uv&#39; and Dask processes on the given host and clean up pid files.</span>

<span class="sd">        Args:</span>
<span class="sd">            ip (str, optional): IP address of the host to kill processes on. Defaults to local host.</span>
<span class="sd">            current_pid (int, optional): PID of this process to exclude. Defaults to this process.</span>
<span class="sd">            force (bool, optional): Whether to kill all &#39;dask&#39; processes by name. Defaults to True.</span>
<span class="sd">        Returns:</span>
<span class="sd">            The result of the last kill command (dict or None).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">env</span> <span class="o">=</span> <span class="n">AGI</span><span class="o">.</span><span class="n">env</span>
        <span class="n">uv</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">uv</span>
        <span class="n">localhost</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostbyname</span><span class="p">(</span><span class="s2">&quot;localhost&quot;</span><span class="p">)</span>
        <span class="n">ip</span> <span class="o">=</span> <span class="n">ip</span> <span class="ow">or</span> <span class="n">localhost</span>
        <span class="n">current_pid</span> <span class="o">=</span> <span class="n">current_pid</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span>

        <span class="c1"># 1) Collect PIDs from any pid files and remove those files</span>
        <span class="n">pids_to_kill</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">pid_file</span> <span class="ow">in</span> <span class="n">Path</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">wenv_abs</span><span class="o">.</span><span class="n">parent</span><span class="p">)</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*.pid&quot;</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">text</span> <span class="o">=</span> <span class="n">pid_file</span><span class="o">.</span><span class="n">read_text</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">pid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">pid</span> <span class="o">!=</span> <span class="n">current_pid</span><span class="p">:</span>
                    <span class="n">pids_to_kill</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">AGI</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">log_warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not read PID from </span><span class="si">{</span><span class="n">pid_file</span><span class="si">}</span><span class="s2">, skipping&quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">pid_file</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">AGI</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">log_warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to remove pid file </span><span class="si">{</span><span class="n">pid_file</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">cmds</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">cli_rel</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">wenv_rel</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="s2">&quot;cli.py&quot;</span>
        <span class="n">cli_abs</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">wenv_abs</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="n">cli_rel</span><span class="o">.</span><span class="n">name</span>
        <span class="n">cmd_prefix</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">envars</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s2">_CMD_PREFIX&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">kill_prefix</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">cmd_prefix</span><span class="si">}{</span><span class="n">uv</span><span class="si">}</span><span class="s1"> run -p </span><span class="si">{</span><span class="n">env</span><span class="o">.</span><span class="n">python_version</span><span class="si">}</span><span class="s1"> python&#39;</span>

        <span class="k">if</span> <span class="n">env</span><span class="o">.</span><span class="n">is_local</span><span class="p">(</span><span class="n">ip</span><span class="p">):</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">cluster_root</span> <span class="o">/</span> <span class="s2">&quot;src/agi_runner/cli.py&quot;</span><span class="p">,</span> <span class="n">cli_abs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">force</span><span class="p">:</span>
                <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">kill_prefix</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">cli_abs</span><span class="si">}</span><span class="s2"> kill&quot;</span>
                <span class="n">cmds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">force</span><span class="p">:</span>
                <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">kill_prefix</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">cli_rel</span><span class="si">}</span><span class="s2"> kill&quot;</span>
                <span class="n">cmds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>

        <span class="c1"># # 3) If we found any explicit pid files, terminate those PIDs</span>
        <span class="c1"># if pids_to_kill:</span>
        <span class="c1">#     cmds.append(</span>
        <span class="c1">#         f&#39;{kill_prefix} -c &quot;import os, psutil; &#39;</span>
        <span class="c1">#         f&quot;pids={pids_to_kill}; &quot;</span>
        <span class="c1">#         &quot;[psutil.Process(p).kill() for p in pids if p!=os.getpid()]&quot;</span>
        <span class="c1">#         &#39;&quot;&#39;</span>
        <span class="c1">#     )</span>

        <span class="n">last_res</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="n">cmds</span><span class="p">:</span>
            <span class="c1"># choose working directory based on local vs remote</span>
            <span class="n">cwd</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">cluster_root</span> <span class="k">if</span> <span class="n">ip</span> <span class="o">==</span> <span class="n">localhost</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">wenv_abs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">env</span><span class="o">.</span><span class="n">is_local</span><span class="p">(</span><span class="n">ip</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">env</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">argv</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;python &#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
                    <span class="n">runpy</span><span class="o">.</span><span class="n">run_path</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">run_name</span><span class="o">=</span><span class="s2">&quot;__main__&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">AgiEnv</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">cwd</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cli</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">wenv_rel</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="s2">&quot;cli.py&quot;</span>
                <span class="n">last_res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">exec_ssh</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span>

            <span class="c1"># handle tuple or dict result</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">last_res</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">out</span> <span class="o">=</span> <span class="n">last_res</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;stdout&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="n">err</span> <span class="o">=</span> <span class="n">last_res</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;stderr&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">last_res</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_clean_dirs_local</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Clean up local worker env directory</span>

<span class="sd">        Args:</span>
<span class="sd">          wenv: worker environment dictionary</span>

<span class="sd">        Returns:</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">me</span> <span class="o">=</span> <span class="n">getpass</span><span class="o">.</span><span class="n">getuser</span><span class="p">()</span>
        <span class="n">self_pid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">psutil</span><span class="o">.</span><span class="n">process_iter</span><span class="p">([</span><span class="s1">&#39;pid&#39;</span><span class="p">,</span> <span class="s1">&#39;username&#39;</span><span class="p">,</span> <span class="s1">&#39;cmdline&#39;</span><span class="p">]):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span>
                        <span class="n">p</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">p</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">me</span><span class="p">)</span>
                        <span class="ow">and</span> <span class="n">p</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;pid&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">p</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;pid&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">self_pid</span>
                        <span class="ow">and</span> <span class="n">p</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;cmdline&#39;</span><span class="p">]</span>
                        <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="s1">&#39;dask&#39;</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;cmdline&#39;</span><span class="p">])</span>
                <span class="p">):</span>
                    <span class="n">p</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>
            <span class="k">except</span> <span class="p">(</span><span class="n">psutil</span><span class="o">.</span><span class="n">NoSuchProcess</span><span class="p">,</span> <span class="n">psutil</span><span class="o">.</span><span class="n">AccessDenied</span><span class="p">):</span>
                <span class="k">pass</span>

        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">gettempdir</span><span class="p">()</span><span class="si">}</span><span class="s2">/dask-scratch-space&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">AGI</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">wenv_abs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="p">]:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">ignore_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>

    <span class="nd">@staticmethod</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_clean_dirs</span><span class="p">(</span><span class="n">ip</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Clean up remote worker</span>

<span class="sd">        Args:</span>
<span class="sd">          ip: address of remote worker</span>

<span class="sd">        Returns:</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">env</span> <span class="o">=</span> <span class="n">AGI</span><span class="o">.</span><span class="n">env</span>
        <span class="n">uv</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">uv</span>
        <span class="n">wenv_abs</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">wenv_abs</span>
        <span class="k">if</span> <span class="n">wenv_abs</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">env</span><span class="o">.</span><span class="n">remove_dir_forcefully</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">wenv_abs</span><span class="p">))</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">wenv_abs</span> <span class="o">/</span> <span class="s2">&quot;src&quot;</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">cmd_prefix</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">envars</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s2">_CMD_PREFIX&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">wenv</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">wenv_rel</span>
        <span class="n">cli</span> <span class="o">=</span> <span class="n">wenv</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="s1">&#39;cli.py&#39;</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cmd_prefix</span><span class="si">}{</span><span class="n">uv</span><span class="si">}</span><span class="s2"> run -p </span><span class="si">{</span><span class="n">env</span><span class="o">.</span><span class="n">python_version</span><span class="si">}</span><span class="s2"> python </span><span class="si">{</span><span class="n">cli</span><span class="si">}</span><span class="s2"> clean </span><span class="si">{</span><span class="n">wenv</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">exec_ssh</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span>


    <span class="nd">@staticmethod</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_clean_nodes</span><span class="p">(</span><span class="n">scheduler_addr</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">force</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="c1"># Compose list of IPs: workers plus scheduler&#39;s IP</span>
        <span class="n">list_ip</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">AGI</span><span class="o">.</span><span class="n">workers</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="n">AGI</span><span class="o">.</span><span class="n">_get_scheduler</span><span class="p">(</span><span class="n">scheduler_addr</span><span class="p">)[</span><span class="mi">0</span><span class="p">]])</span>
        <span class="n">localhost_ip</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostbyname</span><span class="p">(</span><span class="s2">&quot;localhost&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">list_ip</span><span class="p">:</span>
            <span class="n">list_ip</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">localhost_ip</span><span class="p">)</span>


        <span class="k">for</span> <span class="n">ip</span> <span class="ow">in</span> <span class="n">list_ip</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">AgiEnv</span><span class="o">.</span><span class="n">is_local</span><span class="p">(</span><span class="n">ip</span><span class="p">):</span>
                <span class="c1"># Assuming this cleans local dirs once per IP (or should be once per call)</span>
                <span class="n">AGI</span><span class="o">.</span><span class="n">_clean_dirs_local</span><span class="p">()</span>

        <span class="n">AGI</span><span class="o">.</span><span class="n">_clean_remote_procs</span><span class="p">()</span>
        <span class="n">AGI</span><span class="o">.</span><span class="n">_clean_remote_dirs</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">list_ip</span>

    <span class="nd">@staticmethod</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_clean_remote_procs</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">tasks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ip</span> <span class="ow">in</span> <span class="n">list_ip</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">AgiEnv</span><span class="o">.</span><span class="n">is_local</span><span class="p">(</span><span class="n">ip</span><span class="p">):</span>
                <span class="n">tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">AGI</span><span class="o">.</span><span class="n">_kill</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">(),</span> <span class="n">force</span><span class="o">=</span><span class="n">force</span><span class="p">)))</span>

        <span class="k">if</span> <span class="n">tasks</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="n">tasks</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_clean_remote_dirs</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">tasks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ip</span> <span class="ow">in</span> <span class="n">list_ip</span><span class="p">:</span>
            <span class="n">tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">AGI</span><span class="o">.</span><span class="n">_clean_dirs</span><span class="p">(</span><span class="n">ip</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">tasks</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="n">tasks</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_install_venv_cluster</span><span class="p">(</span><span class="n">scheduler_addr</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Validate and prepare each remote node in the cluster:</span>
<span class="sd">        - Verify each IP is valid and reachable.</span>
<span class="sd">        - Detect and install Python interpreters if missing.</span>
<span class="sd">        - Detect and install &#39;uv&#39; CLI via pip if missing.</span>
<span class="sd">        - Use &#39;uv&#39; to install the specified Pytho</span>
<span class="sd">        n version, create necessary directories, and install packages.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">list_ip</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">AGI</span><span class="o">.</span><span class="n">workers</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="n">AGI</span><span class="o">.</span><span class="n">_get_scheduler</span><span class="p">(</span><span class="n">scheduler_addr</span><span class="p">)[</span><span class="mi">0</span><span class="p">]])</span>
        <span class="n">localhost_ip</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostbyname</span><span class="p">(</span><span class="s2">&quot;localhost&quot;</span><span class="p">)</span>
        <span class="n">env</span> <span class="o">=</span> <span class="n">AGI</span><span class="o">.</span><span class="n">env</span>
        <span class="n">dist_rel</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">dist_rel</span>
        <span class="n">wenv_rel</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">wenv_rel</span>
        <span class="n">pyvers</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">python_version</span>

        <span class="c1"># You can remove this check or keep it if you expect no scheduler/workers (rare)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">list_ip</span><span class="p">:</span>
            <span class="n">list_ip</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">localhost_ip</span><span class="p">)</span>

        <span class="c1"># Validate IPs</span>
        <span class="k">for</span> <span class="n">ip</span> <span class="ow">in</span> <span class="n">list_ip</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">env</span><span class="o">.</span><span class="n">is_local</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_ip</span><span class="p">(</span><span class="n">ip</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid IP address: </span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Prepare each remote node (skip local)</span>
        <span class="n">AGI</span><span class="o">.</span><span class="n">list_ip</span> <span class="o">=</span> <span class="n">list_ip</span>
        <span class="k">for</span> <span class="n">ip</span> <span class="ow">in</span> <span class="n">list_ip</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">env</span><span class="o">.</span><span class="n">is_local</span><span class="p">(</span><span class="n">ip</span><span class="p">):</span>
                <span class="k">continue</span>

            <span class="c1"># 1) Check if need to export path (linux and macos)</span>
            <span class="n">cmd_prefix</span> <span class="o">=</span> <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_detect_export_cmd</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span>
            <span class="n">env</span><span class="o">.</span><span class="n">set_env_var</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s2">_CMD_PREFIX&quot;</span><span class="p">,</span> <span class="n">cmd_prefix</span><span class="p">)</span>
            <span class="n">uv_is_installed</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="c1"># 2) Check uv</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">exec_ssh</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cmd_prefix</span><span class="si">}{</span><span class="n">env</span><span class="o">.</span><span class="n">uv</span><span class="si">}</span><span class="s2"> --version&quot;</span><span class="p">)</span>
                <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">exec_ssh</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cmd_prefix</span><span class="si">}{</span><span class="n">env</span><span class="o">.</span><span class="n">uv</span><span class="si">}</span><span class="s2"> self update&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">uv_is_installed</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="c1"># Try Windows installer</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">exec_ssh</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span>
                                       <span class="s1">&#39;powershell -ExecutionPolicy ByPass -c &quot;irm https://astral.sh/uv/install.ps1 | iex&quot;&#39;</span>
                                       <span class="p">)</span>
                    <span class="n">uv_is_installed</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">uv_is_installed</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="c1"># Fallback to Unix installer</span>
                    <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">exec_ssh</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="s1">&#39;curl -LsSf https://astral.sh/uv/install.sh | sh&#39;</span><span class="p">)</span>
                    <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">exec_ssh</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="s1">&#39;source $HOME/.local/bin/env&#39;</span><span class="p">)</span>
                    <span class="n">uv_is_installed</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">uv_is_installed</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">AgiEnv</span><span class="o">.</span><span class="n">check_internet</span><span class="p">():</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Failed to install uv&quot;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">EnvironmentError</span><span class="p">(</span><span class="s2">&quot;Failed to install uv&quot;</span><span class="p">)</span>

            <span class="c1"># 3) Install Python</span>
            <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">exec_ssh</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cmd_prefix</span><span class="si">}{</span><span class="n">env</span><span class="o">.</span><span class="n">uv</span><span class="si">}</span><span class="s2"> python install </span><span class="si">{</span><span class="n">pyvers</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">env</span><span class="o">.</span><span class="n">send_file</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">env</span><span class="o">.</span><span class="n">cluster_root</span> <span class="o">/</span> <span class="s2">&quot;src/agi_runner/cli.py&quot;</span><span class="p">,</span> <span class="n">env</span><span class="o">.</span><span class="n">wenv_rel</span><span class="o">.</span><span class="n">parent</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_kill</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_clean_dirs</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span>

            <span class="n">cmd_prefix</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">envars</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s2">_CMD_PREFIX&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">uv</span> <span class="o">=</span> <span class="n">cmd_prefix</span> <span class="o">+</span> <span class="n">env</span><span class="o">.</span><span class="n">uv</span>

            <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">uv</span><span class="si">}</span><span class="s2"> run python -c </span><span class="se">\&quot;</span><span class="s2">import os; os.makedirs(&#39;</span><span class="si">{</span><span class="n">dist_rel</span><span class="si">}</span><span class="s2">&#39;, exist_ok=True)</span><span class="se">\&quot;</span><span class="s2">&quot;</span>
            <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">exec_ssh</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span>

            <span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cmd_prefix</span><span class="si">}{</span><span class="n">env</span><span class="o">.</span><span class="n">uv</span><span class="si">}</span><span class="s2"> --project </span><span class="si">{</span><span class="n">wenv_rel</span><span class="si">}</span><span class="s2"> init --bare --no-workspace&quot;</span>
            <span class="p">)</span>
            <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">exec_ssh</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_install</span><span class="p">(</span><span class="n">scheduler_addr</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">AGI</span><span class="o">.</span><span class="n">_initialize_installation</span><span class="p">()</span>
        <span class="n">env</span> <span class="o">=</span> <span class="n">AGI</span><span class="o">.</span><span class="n">env</span>
        <span class="n">app_path</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">app_abs</span>
        <span class="n">wenv_rel</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">wenv_rel</span>
        <span class="n">wenv_abs</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">wenv_abs</span>
        <span class="n">pyvers</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">python_version</span>
        <span class="n">extras</span> <span class="o">=</span> <span class="s2">&quot;--dev -p &quot;</span> <span class="o">+</span> <span class="n">pyvers</span>
        <span class="n">options</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;manager&quot;</span><span class="p">:</span> <span class="n">extras</span><span class="p">,</span> <span class="s2">&quot;worker&quot;</span><span class="p">:</span> <span class="n">extras</span> <span class="o">+</span> <span class="n">env</span><span class="o">.</span><span class="n">python_variante</span><span class="p">}</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">base_worker_cls</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">options</span><span class="p">[</span><span class="s2">&quot;worker&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="s2">&quot; --extra &quot;</span> <span class="o">+</span> <span class="s2">&quot; --extra &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">AGI</span><span class="o">.</span><span class="n">install_worker_group</span><span class="p">)</span>

        <span class="c1">#node_ips = await AGI._clean_nodes(scheduler)</span>
        <span class="n">node_ips</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">AGI</span><span class="o">.</span><span class="n">workers</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="n">AGI</span><span class="o">.</span><span class="n">_get_scheduler</span><span class="p">(</span><span class="n">scheduler_addr</span><span class="p">)[</span><span class="mi">0</span><span class="p">]])</span>
        <span class="n">AGI</span><span class="o">.</span><span class="n">_venv_todo</span><span class="p">(</span><span class="n">node_ips</span><span class="p">)</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;********   Starting </span><span class="si">{</span><span class="n">AGI</span><span class="o">.</span><span class="n">_run_type</span><span class="si">}</span><span class="s2"> for </span><span class="si">{</span><span class="n">app_path</span><span class="si">}</span><span class="s2"> in .env on 127.0.0.1&quot;</span><span class="p">)</span>

        <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_install_app_local</span><span class="p">(</span><span class="n">app_path</span><span class="p">,</span> <span class="n">Path</span><span class="p">(</span><span class="n">wenv_rel</span><span class="p">),</span> <span class="n">options</span><span class="p">)</span>
        <span class="c1"># logging.info(AGI.run(cmd, wenv_abs))</span>
        <span class="k">if</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_mode</span> <span class="o">&amp;</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">tasks</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">ip</span> <span class="ow">in</span> <span class="n">node_ips</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;********   Starting </span><span class="si">{</span><span class="n">AGI</span><span class="o">.</span><span class="n">_run_type</span><span class="si">}</span><span class="s2"> for worker in .venv on </span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">env</span><span class="o">.</span><span class="n">is_local</span><span class="p">(</span><span class="n">ip</span><span class="p">):</span>
                    <span class="n">tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span>
                        <span class="n">AGI</span><span class="o">.</span><span class="n">_install_app_remote</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">wenv_rel</span><span class="p">,</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;worker&quot;</span><span class="p">])</span>
                    <span class="p">))</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="n">tasks</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">AGI</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">duration</span> <span class="o">=</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_format_duration</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;********   Agi </span><span class="si">{</span><span class="n">AGI</span><span class="o">.</span><span class="n">_run_type</span><span class="si">}</span><span class="s2"> completed in </span><span class="si">{</span><span class="n">duration</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_initialize_installation</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize installation flags and run type.&quot;&quot;&quot;</span>
        <span class="n">AGI</span><span class="o">.</span><span class="n">_run_type</span> <span class="o">=</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_run_types</span><span class="p">[(</span><span class="n">AGI</span><span class="o">.</span><span class="n">_mode</span> <span class="o">&amp;</span> <span class="n">AGI</span><span class="o">.</span><span class="n">DEPLOYEMENT_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">]</span>
        <span class="n">AGI</span><span class="o">.</span><span class="n">_install_done_local</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">AGI</span><span class="o">.</span><span class="n">_install_done</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">AGI</span><span class="o">.</span><span class="n">_worker_init_error</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_hardware_supports_rapids</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
                <span class="p">[</span><span class="s2">&quot;nvidia-smi&quot;</span><span class="p">],</span>
                <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">DEVNULL</span><span class="p">,</span>
                <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">DEVNULL</span><span class="p">,</span>
                <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="p">(</span><span class="n">subprocess</span><span class="o">.</span><span class="n">CalledProcessError</span><span class="p">,</span> <span class="ne">FileNotFoundError</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="nd">@staticmethod</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_install_app_local</span><span class="p">(</span><span class="n">src</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">wenv_rel</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">options</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Installe l’environnement localement.</span>

<span class="sd">        Args:</span>
<span class="sd">            src: chemin vers la racine du projet local</span>
<span class="sd">            wenv_rel: chemin relatif vers l’environnement virtuel local</span>
<span class="sd">            x: dict contenant les options &#39;manager&#39; et &#39;worker&#39; pour la commande uv</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">env</span> <span class="o">=</span> <span class="n">AGI</span><span class="o">.</span><span class="n">env</span>
        <span class="n">dist_abs</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">dist_abs</span>
        <span class="n">run_type</span> <span class="o">=</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_run_type</span>
        <span class="n">ip</span> <span class="o">=</span> <span class="s2">&quot;127.0.0.1&quot;</span>
        <span class="n">has_rapids_hw</span> <span class="o">=</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_hardware_supports_rapids</span><span class="p">()</span> <span class="ow">and</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_rapids_enabled</span>
        <span class="n">env</span><span class="o">.</span><span class="n">has_rapids_hw</span> <span class="o">=</span> <span class="n">has_rapids_hw</span>
        <span class="n">wenv_abs</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">wenv_abs</span>
        <span class="n">dist_abs</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">dist_abs</span>
        <span class="n">cmd_prefix</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">envars</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s2">_CMD_PREFIX&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">uv</span> <span class="o">=</span> <span class="n">cmd_prefix</span> <span class="o">+</span> <span class="n">env</span><span class="o">.</span><span class="n">uv</span>

        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">wenv_abs</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">file</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">worker_pyproject</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Copying </span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">wenv_abs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">wenv_abs</span> <span class="o">/</span> <span class="n">file</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">file</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">setup_core</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Copying </span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">wenv_abs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">wenv_abs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">has_rapids_hw</span><span class="p">:</span>
            <span class="n">env</span><span class="o">.</span><span class="n">set_env_var</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="s2">&quot;has_rapids_hw&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">env</span><span class="o">.</span><span class="n">set_env_var</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="s2">&quot;no_rapids_hw&quot;</span><span class="p">)</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Rapids-capable GPU[</span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s2">]: </span><span class="si">{</span><span class="n">has_rapids_hw</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># manager install command with and without rapids capable</span>
        <span class="n">app_path</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">app_abs</span>
        <span class="k">if</span> <span class="n">has_rapids_hw</span><span class="p">:</span>
            <span class="n">cmd_manager</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">uv</span><span class="si">}</span><span class="s2"> --config-file uv_config.toml  </span><span class="si">{</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;manager&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> --project </span><span class="si">{</span><span class="n">app_path</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">run_type</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cmd_manager</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">uv</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;manager&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> --project </span><span class="si">{</span><span class="n">app_path</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">run_type</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Installing manager: </span><span class="si">{</span><span class="n">cmd_manager</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">AgiEnv</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd_manager</span><span class="p">,</span> <span class="n">app_path</span><span class="p">)</span>

        <span class="c1"># worker install command with and without rapids capable</span>
        <span class="k">if</span> <span class="n">has_rapids_hw</span><span class="p">:</span>
            <span class="n">cmd_worker</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">uv</span><span class="si">}</span><span class="s2"> --config-file uv_config.toml --project </span><span class="si">{</span><span class="n">wenv_abs</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">run_type</span><span class="si">}</span><span class="s2"> &quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cmd_worker</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">uv</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;worker&quot;</span><span class="p">]</span><span class="si">}</span><span class="s2"> --project </span><span class="si">{</span><span class="n">wenv_abs</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">run_type</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Installing workers: </span><span class="si">{</span><span class="n">cmd_worker</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">AgiEnv</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd_worker</span><span class="p">,</span> <span class="n">wenv_abs</span><span class="p">)</span>

        <span class="c1">######################</span>
        <span class="c1"># install env &amp; core</span>
        <span class="c1">######################</span>

        <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">uv</span><span class="si">}</span><span class="s2"> --project </span><span class="si">{</span><span class="n">wenv_abs</span><span class="si">}</span><span class="s2"> run python -m ensurepip&quot;</span>
        <span class="k">await</span> <span class="n">AgiEnv</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">wenv_abs</span><span class="p">)</span>

        <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">uv</span><span class="si">}</span><span class="s2"> --project </span><span class="si">{</span><span class="n">wenv_abs</span><span class="si">}</span><span class="s2"> run python -m pip install -e </span><span class="si">{</span><span class="n">wenv_abs</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">await</span> <span class="n">AgiEnv</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">wenv_abs</span><span class="p">)</span>

        <span class="c1"># build agi_env*.whl</span>
        <span class="n">menv</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">env_root</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">uv</span><span class="si">}</span><span class="s2"> --project </span><span class="si">{</span><span class="n">menv</span><span class="si">}</span><span class="s2"> build --wheel&quot;</span>
        <span class="k">await</span> <span class="n">AgiEnv</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">menv</span><span class="p">)</span>
        <span class="n">src</span> <span class="o">=</span> <span class="n">menv</span> <span class="o">/</span> <span class="s2">&quot;dist&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">whl</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;agi_env*.whl&quot;</span><span class="p">)))</span>
            <span class="c1">#shutil.copy2(whl, wenv_abs)</span>
        <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>

        <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">uv</span><span class="si">}</span><span class="s2"> --project </span><span class="si">{</span><span class="n">wenv_abs</span><span class="si">}</span><span class="s2"> add </span><span class="si">{</span><span class="n">whl</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">await</span> <span class="n">AgiEnv</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">wenv_abs</span><span class="p">)</span>

        <span class="c1"># Build target_worker lib local</span>
        <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_build_lib_local</span><span class="p">()</span>

        <span class="c1"># Cleanup modules</span>
        <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_uninstall_modules</span><span class="p">()</span>
        <span class="n">AGI</span><span class="o">.</span><span class="n">_install_done_local</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="nd">@staticmethod</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_install_app_remote</span><span class="p">(</span><span class="n">ip</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">env</span><span class="p">:</span> <span class="n">AgiEnv</span><span class="p">,</span> <span class="n">wenv_rel</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">option</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Install packages and set up the environment on a remote node.&quot;&quot;&quot;</span>

        <span class="n">wenv_abs</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">wenv_abs</span>
        <span class="n">wenv_rel</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">wenv_rel</span>
        <span class="n">dist_rel</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">dist_rel</span>
        <span class="n">dist_abs</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">dist_abs</span>
        <span class="n">cmd_prefix</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">envars</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s2">_CMD_PREFIX&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">uv</span>  <span class="o">=</span> <span class="n">cmd_prefix</span> <span class="o">+</span> <span class="n">env</span><span class="o">.</span><span class="n">uv</span>

        <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">uv</span><span class="si">}</span><span class="s2"> run python -c </span><span class="se">\&quot;</span><span class="s2">import os; os.makedirs(&#39;</span><span class="si">{</span><span class="n">dist_rel</span><span class="si">}</span><span class="s2">&#39;, exist_ok=True)</span><span class="se">\&quot;</span><span class="s2">&quot;</span>
        <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">exec_ssh</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span>

        <span class="c1"># Then send the files to the remote directory</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">egg_file</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">dist_abs</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">env</span><span class="o">.</span><span class="n">app</span><span class="si">}</span><span class="s2">*.egg&quot;</span><span class="p">)),</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;searching for </span><span class="si">{</span><span class="n">wenv_abs</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">env</span><span class="o">.</span><span class="n">app</span><span class="si">}</span><span class="s2">*.egg&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;no existing egg file in </span><span class="si">{</span><span class="n">wenv_abs</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">env</span><span class="o">.</span><span class="n">app</span><span class="si">}</span><span class="s2">*&quot;</span><span class="p">)</span>

        <span class="c1"># build agi_env*.whl</span>
        <span class="n">wenv</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">env_root</span> <span class="o">/</span> <span class="s1">&#39;dist&#39;</span>
        <span class="k">try</span><span class="p">:</span>

            <span class="n">env_whl</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">wenv</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;agi_env*.whl&quot;</span><span class="p">)))</span>
        <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;no existing whl file in </span><span class="si">{</span><span class="n">wenv</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="s2">&quot;agi_env*&quot;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">await</span> <span class="n">env</span><span class="o">.</span><span class="n">send_files</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="p">[</span><span class="n">egg_file</span><span class="p">,</span> <span class="n">env_whl</span><span class="p">,</span> <span class="n">env</span><span class="o">.</span><span class="n">setup_core</span><span class="p">,</span> <span class="n">env</span><span class="o">.</span><span class="n">worker_pyproject</span><span class="p">,</span> <span class="n">env</span><span class="o">.</span><span class="n">uvproject</span><span class="p">],</span> <span class="n">wenv_rel</span><span class="p">)</span>

        <span class="c1"># 5) Check remote Rapids hardware support via nvidia-smi</span>
        <span class="n">has_rapids_hw</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_rapids_enabled</span><span class="p">:</span>
            <span class="n">check_rapids</span> <span class="o">=</span> <span class="s1">&#39;nvidia-smi&#39;</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">exec_ssh</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">check_rapids</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;rapids is requested but not supported by node [</span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
                <span class="k">raise</span>

            <span class="n">has_rapids_hw</span> <span class="o">=</span> <span class="p">(</span><span class="n">result</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_rapids_enabled</span>
            <span class="n">env</span><span class="o">.</span><span class="n">has_rapids_hw</span> <span class="o">=</span> <span class="n">has_rapids_hw</span>
            <span class="k">if</span> <span class="n">has_rapids_hw</span><span class="p">:</span>
                <span class="n">env</span><span class="o">.</span><span class="n">set_env_var</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="s2">&quot;has_rapids_hw&quot;</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Rapids-capable GPU[</span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s2">]: </span><span class="si">{</span><span class="n">has_rapids_hw</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># unzip egg to get src/</span>
        <span class="n">cli</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">wenv_rel</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="s2">&quot;cli.py&quot;</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">uv</span><span class="si">}</span><span class="s2"> run python </span><span class="si">{</span><span class="n">cli</span><span class="si">}</span><span class="s2"> unzip </span><span class="si">{</span><span class="n">wenv_rel</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">exec_ssh</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span>

        <span class="c1">#####################################################</span>
        <span class="c1"># install env &amp; core for enabling dask worker spawn</span>
        <span class="c1">######################################################</span>

        <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">uv</span><span class="si">}</span><span class="s2"> --project </span><span class="si">{</span><span class="n">wenv_rel</span><span class="si">}</span><span class="s2"> run python -m ensurepip&quot;</span>
        <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">exec_ssh</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span>

        <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">uv</span><span class="si">}</span><span class="s2"> --project </span><span class="si">{</span><span class="n">wenv_rel</span><span class="si">}</span><span class="s2"> run python -m pip install -e </span><span class="si">{</span><span class="n">wenv_rel</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">exec_ssh</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span>

        <span class="c1"># install env</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">uv</span><span class="si">}</span><span class="s2"> --project </span><span class="si">{</span><span class="n">wenv_rel</span><span class="si">}</span><span class="s2"> add --upgrade </span><span class="si">{</span><span class="n">wenv_rel</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">env_whl</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">exec_ssh</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span>

        <span class="c1"># unzip egg to get src/</span>
        <span class="n">cli</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">wenv_rel</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="s2">&quot;cli.py&quot;</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">uv</span><span class="si">}</span><span class="s2"> run python </span><span class="si">{</span><span class="n">cli</span><span class="si">}</span><span class="s2"> unzip </span><span class="si">{</span><span class="n">wenv_rel</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">exec_ssh</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span>

        <span class="c1"># Post-install script</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">uv</span><span class="si">}</span><span class="s2"> --project </span><span class="si">{</span><span class="n">wenv_rel</span><span class="si">}</span><span class="s2"> run python </span><span class="si">{</span><span class="n">env</span><span class="o">.</span><span class="n">post_install_rel</span><span class="si">}</span><span class="s2"> --install-type 2 </span><span class="si">{</span><span class="n">env</span><span class="o">.</span><span class="n">data_rel</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">exec_ssh</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span>

        <span class="c1"># build target_worker lib from src/</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">uv</span><span class="si">}</span><span class="s2"> --project </span><span class="si">{</span><span class="n">wenv_rel</span><span class="si">}</span><span class="s2"> run python </span><span class="si">{</span><span class="n">wenv_rel</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">env</span><span class="o">.</span><span class="n">setup_app</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> build_ext -i 2 -b </span><span class="si">{</span><span class="n">wenv_rel</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">exec_ssh</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_should_install_pip</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">getpass</span><span class="o">.</span><span class="n">getuser</span><span class="p">())</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;T0&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">prefix</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;Scripts/pip.exe&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>

    <span class="nd">@staticmethod</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_uninstall_modules</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Uninstall specified modules.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">module</span> <span class="ow">in</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_module_to_clean</span><span class="p">:</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">env</span><span class="o">.</span><span class="n">uv</span><span class="si">}</span><span class="s2"> pip uninstall </span><span class="si">{</span><span class="n">module</span><span class="si">}</span><span class="s2"> -y&quot;</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Executing: </span><span class="si">{</span><span class="n">cmd</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">AgiEnv</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">AGI</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">env_root</span><span class="p">)</span>
        <span class="n">AGI</span><span class="o">.</span><span class="n">_module_to_clean</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_format_duration</span><span class="p">(</span><span class="n">seconds</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Format the duration from seconds to a human-readable format.</span>

<span class="sd">        Args:</span>
<span class="sd">            seconds (float): The duration in seconds.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: The formatted duration.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">humanize</span><span class="o">.</span><span class="n">precisedelta</span><span class="p">(</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">seconds</span><span class="p">))</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_venv_todo</span><span class="p">(</span><span class="n">list_ip</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Args:</span>
<span class="sd">          list_ip: return:</span>

<span class="sd">        Returns:</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="n">AGI</span><span class="o">.</span><span class="n">_local_ip</span><span class="p">,</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_remote_ip</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">ip</span> <span class="ow">in</span> <span class="n">list_ip</span><span class="p">:</span>
            <span class="p">(</span><span class="n">AGI</span><span class="o">.</span><span class="n">_local_ip</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span> <span class="k">if</span> <span class="n">AgiEnv</span><span class="o">.</span><span class="n">is_local</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span> <span class="k">else</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_remote_ip</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ip</span><span class="p">))</span>
        <span class="n">AGI</span><span class="o">.</span><span class="n">_install_todo</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">AGI</span><span class="o">.</span><span class="n">_remote_ip</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;********   </span><span class="si">{</span><span class="n">AGI</span><span class="o">.</span><span class="n">_install_todo</span><span class="si">}</span><span class="s2"> remote .venv to </span><span class="si">{</span><span class="n">AGI</span><span class="o">.</span><span class="n">_run_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="AGI.install">
<a class="viewcode-back" href="../../agi-runner.html#agi_runner.agi_runner.AGI.install">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">install</span><span class="p">(</span>
    <span class="n">module_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">env</span><span class="p">:</span> <span class="n">AgiEnv</span><span class="p">,</span>
    <span class="n">scheduler</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">workers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">modes_enabled</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">RUN_MASK</span><span class="p">,</span>
    <span class="n">verbose</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the cluster&#39;s virtual environment.</span>

<span class="sd">        Args:</span>
<span class="sd">            module_name_or_path (str):</span>
<span class="sd">                The name of the module to install or the path to the module.</span>
<span class="sd">            list_ip (List[str], optional):</span>
<span class="sd">                A list of IPv4 addresses with SSH access. Each IP should have Python,</span>
<span class="sd">                `psutil`, and `pdm` installed. Defaults to None.</span>
<span class="sd">            modes_enabled (int, optional):</span>
<span class="sd">                Bitmask indicating enabled modes. Defaults to `0b0111`.</span>
<span class="sd">            verbose (int, optional):</span>
<span class="sd">                Verbosity level (0-3). Higher numbers increase the verbosity of the output.</span>
<span class="sd">                Defaults to 1.</span>
<span class="sd">            **args:</span>
<span class="sd">                Additional keyword arguments.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool:</span>
<span class="sd">                `True` if the installation was successful, `False` otherwise.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError:</span>
<span class="sd">                If `module_name_or_path` is invalid.</span>
<span class="sd">            ConnectionError:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">AGI</span><span class="o">.</span><span class="n">_run_type</span> <span class="o">=</span> <span class="s2">&quot;sync&quot;</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="p">(</span><span class="n">AGI</span><span class="o">.</span><span class="n">INSTALL_MODE</span> <span class="o">|</span> <span class="n">modes_enabled</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">module_name</span><span class="p">,</span>
                      <span class="n">scheduler</span><span class="o">=</span><span class="n">scheduler</span><span class="p">,</span>
                      <span class="n">workers</span><span class="o">=</span><span class="n">workers</span><span class="p">,</span>
                      <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">,</span>
                      <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span>
                      <span class="n">rapids_enabled</span><span class="o">=</span><span class="n">AGI</span><span class="o">.</span><span class="n">INSTALL_MODE</span> <span class="o">&amp;</span> <span class="n">modes_enabled</span><span class="p">,</span>
                      <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">)</span></div>


<div class="viewcode-block" id="AGI.update">
<a class="viewcode-back" href="../../agi-runner.html#agi_runner.agi_runner.AGI.update">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span>
    <span class="n">module_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">scheduler</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">workers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">env</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AgiEnv</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">modes_enabled</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">RUN_MASK</span><span class="p">,</span>
    <span class="n">verbose</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        install cluster virtual environment</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        package: any Agi target apps or project created with AGILAB</span>
<span class="sd">        list_ip: any ip V4 with ssh access and python (upto you to link it to python3) with psutil and uv synced</span>
<span class="sd">        mode_enabled: this is typically a mode mask to know for example if cython or rapids are required</span>
<span class="sd">        force_update: make a Spud.update before the installation, default is True</span>
<span class="sd">        verbose: verbosity [0-3]</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">AGI</span><span class="o">.</span><span class="n">_run_type</span> <span class="o">=</span> <span class="s2">&quot;upgrade&quot;</span>
        <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">module_name</span><span class="p">,</span> <span class="n">scheduler</span><span class="o">=</span><span class="n">scheduler</span><span class="p">,</span> <span class="n">workers</span><span class="o">=</span><span class="n">workers</span><span class="p">,</span>
                      <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="p">(</span><span class="n">AGI</span><span class="o">.</span><span class="n">UPDATE_MODE</span> <span class="o">|</span> <span class="n">modes_enabled</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">AGI</span><span class="o">.</span><span class="n">DASK_RESET</span><span class="p">,</span>
                      <span class="n">rapids_enabled</span><span class="o">=</span><span class="n">AGI</span><span class="o">.</span><span class="n">UPDATE_MODE</span> <span class="o">&amp;</span> <span class="n">modes_enabled</span><span class="p">,</span>
                      <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">)</span></div>


<div class="viewcode-block" id="AGI.distribute">
<a class="viewcode-back" href="../../agi-runner.html#agi_runner.agi_runner.AGI.distribute">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">distribute</span><span class="p">(</span>
    <span class="n">app</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">env</span><span class="p">:</span> <span class="n">AgiEnv</span><span class="p">,</span>
    <span class="n">scheduler</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">workers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">verbose</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="o">**</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        check the distribution with a dry run</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        package: any Agi target apps or project created by AGILAB</span>
<span class="sd">        list_ip: any ip V4 with ssh access and python (upto you to link it to python3) with psutil and uv synced</span>
<span class="sd">        verbose: verbosity [0-3]</span>

<span class="sd">        Returns</span>
<span class="sd">        the distribution tree</span>
<span class="sd">        -------</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">AGI</span><span class="o">.</span><span class="n">_run_type</span> <span class="o">=</span> <span class="s2">&quot;simulate&quot;</span>
        <span class="k">return</span> <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">scheduler</span><span class="p">,</span> <span class="n">workers</span><span class="p">,</span> <span class="n">verbose</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">AGI</span><span class="o">.</span><span class="n">SIMULATE_MODE</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">)</span></div>


    <span class="nd">@staticmethod</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_start_scheduler</span><span class="p">(</span><span class="n">scheduler</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Start Dask scheduler either locally or remotely.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True on success.</span>

<span class="sd">        Raises:</span>
<span class="sd">            FileNotFoundError: if worker initialization error occurs.</span>
<span class="sd">            SystemExit: on fatal error starting scheduler or Dask client.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">env</span> <span class="o">=</span> <span class="n">AGI</span><span class="o">.</span><span class="n">env</span>
        <span class="n">cli_rel</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">wenv_rel</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="s2">&quot;cli.py&quot;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">AGI</span><span class="o">.</span><span class="n">_mode_auto</span> <span class="ow">and</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_mode</span> <span class="o">==</span> <span class="n">AGI</span><span class="o">.</span><span class="n">DASK_MODE</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_mode_auto</span><span class="p">:</span>
            <span class="n">env</span><span class="o">.</span><span class="n">has_rapids_hw</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_mode</span> <span class="o">&amp;</span> <span class="n">AGI</span><span class="o">.</span><span class="n">DASK_MODE</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">scheduler</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">list</span><span class="p">(</span><span class="n">AGI</span><span class="o">.</span><span class="n">workers</span><span class="p">)</span> <span class="o">==</span> <span class="p">[</span><span class="s2">&quot;127.0.0.1&quot;</span><span class="p">]:</span>
                        <span class="n">scheduler</span> <span class="o">=</span> <span class="s2">&quot;127.0.0.1&quot;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;AGI.run(...scheduler=&#39;scheduler ip address&#39; is required -&gt; Stop&quot;</span><span class="p">)</span>

                <span class="n">AGI</span><span class="o">.</span><span class="n">_scheduler_ip</span><span class="p">,</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_scheduler_port</span> <span class="o">=</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_get_scheduler</span><span class="p">(</span><span class="n">scheduler</span><span class="p">)</span>

            <span class="c1"># Clean worker</span>
            <span class="k">for</span> <span class="n">ip</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">AGI</span><span class="o">.</span><span class="n">workers</span><span class="p">):</span>
                <span class="k">await</span> <span class="n">env</span><span class="o">.</span><span class="n">send_file</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">env</span><span class="o">.</span><span class="n">cluster_root</span> <span class="o">/</span> <span class="s2">&quot;src/agi_runner/cli.py&quot;</span><span class="p">,</span> <span class="n">cli_rel</span><span class="o">.</span><span class="n">parent</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">env</span><span class="o">.</span><span class="n">envars</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
                    <span class="n">env</span><span class="o">.</span><span class="n">has_rapids_hw</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_kill</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">(),</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">raise</span>

            <span class="c1"># clean scheduler</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_kill</span><span class="p">(</span><span class="n">AGI</span><span class="o">.</span><span class="n">_scheduler_ip</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">(),</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span>

            <span class="n">toml_local</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">app_abs</span> <span class="o">/</span> <span class="s2">&quot;pyproject.toml&quot;</span>
            <span class="n">wenv_rel</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">wenv_rel</span>
            <span class="n">wenv_abs</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">wenv_abs</span>
            <span class="k">if</span> <span class="n">env</span><span class="o">.</span><span class="n">is_local</span><span class="p">(</span><span class="n">AGI</span><span class="o">.</span><span class="n">_scheduler_ip</span><span class="p">):</span>
                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># non-blocking sleep</span>
                <span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">env</span><span class="o">.</span><span class="n">uv</span><span class="si">}</span><span class="s2"> run --project </span><span class="si">{</span><span class="n">env</span><span class="o">.</span><span class="n">wenv_abs</span><span class="si">}</span><span class="s2"> dask scheduler --port </span><span class="si">{</span><span class="n">AGI</span><span class="o">.</span><span class="n">_scheduler_port</span><span class="si">}</span><span class="s2"> &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;--host </span><span class="si">{</span><span class="n">AGI</span><span class="o">.</span><span class="n">_scheduler_ip</span><span class="si">}</span><span class="s2"> --pid-file </span><span class="si">{</span><span class="n">wenv_abs</span><span class="o">.</span><span class="n">parent</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="s1">&#39;dask_scheduler.pid&#39;</span><span class="w"> </span><span class="si">}</span><span class="s2"> &quot;</span>
                <span class="p">)</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting dask scheduler locally: </span><span class="si">{</span><span class="n">cmd</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_exec_bg</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">env</span><span class="o">.</span><span class="n">app_abs</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">result</span><span class="p">:</span><span class="c1"># assuming _exec_bg is sync</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Create remote directory</span>
                <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">env</span><span class="o">.</span><span class="n">uv</span><span class="si">}</span><span class="s2"> run -p </span><span class="si">{</span><span class="n">env</span><span class="o">.</span><span class="n">python_version</span><span class="si">}</span><span class="s2"> python -c </span><span class="se">\&quot;</span><span class="s2">import os; os.makedirs(&#39;</span><span class="si">{</span><span class="n">wenv_rel</span><span class="si">}</span><span class="s2">&#39;, exist_ok=True)</span><span class="se">\&quot;</span><span class="s2">&quot;</span>
                <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">exec_ssh</span><span class="p">(</span><span class="n">AGI</span><span class="o">.</span><span class="n">_scheduler_ip</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span>

                <span class="n">toml_wenv</span> <span class="o">=</span> <span class="n">wenv_rel</span> <span class="o">/</span> <span class="s2">&quot;pyproject.toml&quot;</span>
                <span class="k">await</span> <span class="n">env</span><span class="o">.</span><span class="n">send_file</span><span class="p">(</span><span class="n">AGI</span><span class="o">.</span><span class="n">_scheduler_ip</span><span class="p">,</span> <span class="n">toml_local</span><span class="p">,</span> <span class="n">toml_wenv</span><span class="p">)</span>

                <span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">env</span><span class="o">.</span><span class="n">uv</span><span class="si">}</span><span class="s2"> --project </span><span class="si">{</span><span class="n">wenv_rel</span><span class="si">}</span><span class="s2"> run dask scheduler --port </span><span class="si">{</span><span class="n">AGI</span><span class="o">.</span><span class="n">_scheduler_port</span><span class="si">}</span><span class="s2"> &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;--host </span><span class="si">{</span><span class="n">AGI</span><span class="o">.</span><span class="n">_scheduler_ip</span><span class="si">}</span><span class="s2"> --pid-file dask_scheduler.pid&quot;</span>
                <span class="p">)</span>
                <span class="c1"># Run scheduler asynchronously over SSH without awaiting completion (fire and forget)</span>
                <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">AGI</span><span class="o">.</span><span class="n">exec_ssh_async</span><span class="p">(</span><span class="n">AGI</span><span class="o">.</span><span class="n">_scheduler_ip</span><span class="p">,</span> <span class="n">cmd</span><span class="p">))</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Give scheduler a moment to start</span>
                <span class="n">client</span> <span class="o">=</span> <span class="k">await</span> <span class="n">Client</span><span class="p">(</span><span class="n">AGI</span><span class="o">.</span><span class="n">_scheduler</span><span class="p">,</span>
                                      <span class="n">heartbeat_interval</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span>
                                      <span class="n">timeout</span><span class="o">=</span><span class="n">AGI</span><span class="o">.</span><span class="n">TIMEOUT</span><span class="p">)</span>
                <span class="n">client</span><span class="o">.</span><span class="n">forward_logging</span><span class="p">()</span>
                <span class="n">AGI</span><span class="o">.</span><span class="n">_dask_client</span> <span class="o">=</span> <span class="n">client</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Dask Client instantiation trouble, run aborted due to:&quot;</span><span class="p">)</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

            <span class="n">AGI</span><span class="o">.</span><span class="n">_install_done</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_worker_init_error</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Please run AGI.install([</span><span class="si">{</span><span class="n">AGI</span><span class="o">.</span><span class="n">_scheduler_ip</span><span class="si">}</span><span class="s2">])&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="kc">True</span>

    <span class="nd">@staticmethod</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_detect_export_cmd</span><span class="p">(</span><span class="n">ip</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">AgiEnv</span><span class="o">.</span><span class="n">is_local</span><span class="p">(</span><span class="n">ip</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">AgiEnv</span><span class="o">.</span><span class="n">export_local_bin</span>

        <span class="c1"># probe remote OS via SSH</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os_id</span> <span class="o">=</span> <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">exec_ssh</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="s2">&quot;uname -s&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">os_id</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">x</span> <span class="ow">in</span> <span class="n">os_id</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;Linux&#39;</span><span class="p">,</span> <span class="s1">&#39;Darwin&#39;</span><span class="p">,</span> <span class="s1">&#39;BSD&#39;</span><span class="p">)):</span>
            <span class="k">return</span> <span class="s1">&#39;export PATH=&quot;$HOME/.local/bin:$PATH&quot;;export PYTHON_GIL=0;&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span>  <span class="c1"># &#39;set PATH=%USERPROFILE%\\.local\\bin;%PATH% &amp;&amp;&#39;</span>

    <span class="nd">@staticmethod</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_start</span><span class="p">(</span><span class="n">scheduler</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;_start(</span>
<span class="sd">        Start Dask workers locally and remotely,</span>
<span class="sd">        launching remote workers detached in background,</span>
<span class="sd">        compatible with Windows and POSIX.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">env</span> <span class="o">=</span> <span class="n">AGI</span><span class="o">.</span><span class="n">env</span>

        <span class="c1"># Start scheduler first</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_start_scheduler</span><span class="p">(</span><span class="n">scheduler</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">AGI</span><span class="o">.</span><span class="n">workers</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="n">is_local</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">is_local</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span>
            <span class="n">cmd_prefix</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">envars</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s2">_CMD_PREFIX&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting worker #</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s2"> on [</span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
                    <span class="n">pid_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;dask_worker_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s2">.pid&quot;</span>

                    <span class="k">if</span> <span class="n">is_local</span><span class="p">:</span>
                        <span class="n">wenv_abs</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">wenv_abs</span>
                        <span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="c1"># f&#39;{export_cmd} &#39;</span>
                            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">cmd_prefix</span><span class="si">}{</span><span class="n">env</span><span class="o">.</span><span class="n">uv</span><span class="si">}</span><span class="s1"> --project </span><span class="si">{</span><span class="n">wenv_abs</span><span class="si">}</span><span class="s1"> run dask worker tcp://</span><span class="si">{</span><span class="n">AGI</span><span class="o">.</span><span class="n">_scheduler</span><span class="si">}</span><span class="s1"> --no-nanny &#39;</span>
                            <span class="sa">f</span><span class="s1">&#39;--pid-file </span><span class="si">{</span><span class="n">wenv_abs</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">pid_file</span><span class="si">}</span><span class="s1">&#39;</span>
                        <span class="p">)</span>
                        <span class="c1"># Run locally in background (non-blocking)</span>
                        <span class="n">AGI</span><span class="o">.</span><span class="n">_exec_bg</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">wenv_abs</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">wenv_rel</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">wenv_rel</span>
                        <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">cmd_prefix</span><span class="si">}{</span><span class="n">env</span><span class="o">.</span><span class="n">uv</span><span class="si">}</span><span class="s1"> --project </span><span class="si">{</span><span class="n">wenv_rel</span><span class="si">}</span><span class="s1"> run dask worker tcp://</span><span class="si">{</span><span class="n">AGI</span><span class="o">.</span><span class="n">_scheduler</span><span class="si">}</span><span class="s1"> --no-nanny --pid-file </span><span class="si">{</span><span class="n">wenv_rel</span><span class="o">.</span><span class="n">parent</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">pid_file</span><span class="si">}</span><span class="s1">&#39;</span>
                        <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">AGI</span><span class="o">.</span><span class="n">exec_ssh_async</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">cmd</span><span class="p">))</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Launched remote worker in background on </span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">cmd</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to start worker on </span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">raise</span>

                <span class="k">if</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_worker_init_error</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Please run AGI.install([</span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s2">])&quot;</span><span class="p">)</span>

        <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_sync</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="n">AGI</span><span class="o">.</span><span class="n">TIMEOUT</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_mode_auto</span> <span class="ow">or</span> <span class="p">(</span><span class="n">AGI</span><span class="o">.</span><span class="n">_mode_auto</span> <span class="ow">and</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_mode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="c1"># in case of core src has changed</span>
            <span class="n">AGI</span><span class="o">.</span><span class="n">_build_lib_local</span><span class="p">()</span>
            <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_build_lib_remote</span><span class="p">()</span>
            <span class="c1"># if not (AGI._mode &amp; AGI.DASK_MODE):</span>
            <span class="c1">#     # load lib</span>
            <span class="c1">#     for egg_file in (AGI.env.wenv_abs / &quot;dist&quot;).glob(&quot;*.egg&quot;):</span>
            <span class="c1">#         AGI._dask_client.upload_file(str(egg_file))</span>

    <span class="nd">@staticmethod</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_sync</span><span class="p">(</span><span class="n">timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">60</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">AGI</span><span class="o">.</span><span class="n">_dask_client</span><span class="p">,</span> <span class="n">Client</span><span class="p">):</span>
            <span class="k">return</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">expected_workers</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">AGI</span><span class="o">.</span><span class="n">workers</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">info</span> <span class="o">=</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_dask_client</span><span class="o">.</span><span class="n">scheduler_info</span><span class="p">()</span>
                <span class="n">workers_info</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;workers&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">workers_info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Scheduler info &#39;workers&#39; not ready yet.&quot;</span><span class="p">)</span>
                    <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span> <span class="o">&gt;</span> <span class="n">timeout</span><span class="p">:</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Timeout waiting for scheduler workers info.&quot;</span><span class="p">)</span>
                        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                    <span class="k">continue</span>

                <span class="n">runners</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">workers_info</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                <span class="n">current_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">runners</span><span class="p">)</span>
                <span class="n">remaining</span> <span class="o">=</span> <span class="n">expected_workers</span> <span class="o">-</span> <span class="n">current_count</span>

                <span class="k">if</span> <span class="n">runners</span><span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Current workers connected: </span><span class="si">{</span><span class="n">runners</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Waiting for number of workers to attach: </span><span class="si">{</span><span class="n">remaining</span><span class="si">}</span><span class="s2"> remaining...&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">current_count</span> <span class="o">&gt;=</span> <span class="n">expected_workers</span><span class="p">:</span>
                    <span class="k">break</span>

                <span class="k">if</span> <span class="n">remaining</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">break</span>

                <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span> <span class="o">&gt;</span> <span class="n">timeout</span><span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Timeout waiting for all workers. </span><span class="si">{remaining}</span><span class="s2"> workers missing.&quot;</span><span class="p">)</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Exception in _sync: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span> <span class="o">&gt;</span> <span class="n">timeout</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">TimeoutError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Timeout waiting for all workers due to exception: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;All workers successfully attached to scheduler&quot;</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_build_lib_local</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Returns:</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">env</span> <span class="o">=</span> <span class="n">AGI</span><span class="o">.</span><span class="n">env</span>
        <span class="n">wenv</span> <span class="o">=</span> <span class="n">normalize_path</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">wenv_abs</span><span class="p">))</span>
        <span class="n">is_cy</span> <span class="o">=</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_mode</span> <span class="o">&amp;</span> <span class="n">AGI</span><span class="o">.</span><span class="n">CYTHON_MODE</span>
        <span class="n">packages</span> <span class="o">=</span> <span class="s2">&quot;agi_manager, &quot;</span>

        <span class="n">baseworker</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">base_worker_cls</span>
        <span class="k">if</span> <span class="n">baseworker</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;Agent&quot;</span><span class="p">):</span>
            <span class="n">packages</span> <span class="o">+=</span> <span class="s2">&quot;agent_worker&quot;</span>
        <span class="k">elif</span> <span class="n">baseworker</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;Dag&quot;</span><span class="p">):</span>
            <span class="n">packages</span> <span class="o">+=</span> <span class="s2">&quot;dag_worker&quot;</span>
        <span class="k">elif</span> <span class="n">baseworker</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;Pandas&quot;</span><span class="p">):</span>
            <span class="n">packages</span> <span class="o">+=</span> <span class="s2">&quot;pandas_worker&quot;</span>
        <span class="k">elif</span> <span class="n">baseworker</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;Polars&quot;</span><span class="p">):</span>
            <span class="n">packages</span> <span class="o">+=</span> <span class="s2">&quot;polars_worker&quot;</span>

        <span class="n">app_path</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">app_abs</span>
        <span class="n">wenv_abs</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">wenv_abs</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">setup_core</span><span class="p">,</span> <span class="n">app_path</span><span class="p">)</span>

        <span class="c1"># build egg and unzip it into wenv</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">env</span><span class="o">.</span><span class="n">uv</span><span class="si">}</span><span class="s2"> --project </span><span class="si">{</span><span class="n">app_path</span><span class="si">}</span><span class="s2"> run python </span><span class="si">{</span><span class="n">env</span><span class="o">.</span><span class="n">setup_app</span><span class="si">}</span><span class="s2"> bdist_egg --packages </span><span class="se">\&quot;</span><span class="si">{</span><span class="n">packages</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2"> --install_type </span><span class="si">{</span><span class="n">env</span><span class="o">.</span><span class="n">install_type</span><span class="si">}</span><span class="s2"> -d </span><span class="si">{</span><span class="n">wenv_abs</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">await</span> <span class="n">AgiEnv</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">app_path</span><span class="p">)</span>

        <span class="n">dask_client</span> <span class="o">=</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_dask_client</span>
        <span class="k">if</span> <span class="n">dask_client</span><span class="p">:</span>
            <span class="n">egg_files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">((</span><span class="n">wenv_abs</span> <span class="o">/</span> <span class="s2">&quot;dist&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*.egg&quot;</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">egg_file</span> <span class="ow">in</span> <span class="n">egg_files</span><span class="p">:</span>
                <span class="n">dask_client</span><span class="o">.</span><span class="n">upload_file</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">egg_file</span><span class="p">))</span>

        <span class="c1"># compile in cython when cython is requested</span>
        <span class="k">if</span> <span class="n">is_cy</span><span class="p">:</span>
            <span class="c1"># cython compilation of wenv/src into wenv</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">setup_core</span><span class="p">,</span> <span class="n">wenv_abs</span><span class="p">)</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">env</span><span class="o">.</span><span class="n">uv</span><span class="si">}</span><span class="s2"> --project </span><span class="si">{</span><span class="n">app_path</span><span class="si">}</span><span class="s2"> run python </span><span class="si">{</span><span class="n">env</span><span class="o">.</span><span class="n">setup_app</span><span class="si">}</span><span class="s2"> build_ext -b </span><span class="si">{</span><span class="n">wenv_abs</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">AgiEnv</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">app_path</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">worker_lib</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">((</span><span class="n">wenv_abs</span> <span class="o">/</span> <span class="s1">&#39;dist&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*_cy.*&quot;</span><span class="p">)),</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>

            <span class="n">platlib</span> <span class="o">=</span> <span class="n">sysconfig</span><span class="o">.</span><span class="n">get_path</span><span class="p">(</span><span class="s2">&quot;platlib&quot;</span><span class="p">)</span>
            <span class="n">platlib_idx</span> <span class="o">=</span> <span class="n">platlib</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;.venv&#39;</span><span class="p">)</span>
            <span class="n">wenv_platlib</span> <span class="o">=</span> <span class="n">platlib</span><span class="p">[</span><span class="n">platlib_idx</span><span class="p">:]</span>
            <span class="n">target_platlib</span> <span class="o">=</span> <span class="n">wenv_abs</span> <span class="o">/</span> <span class="n">wenv_platlib</span>
            <span class="n">destination</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">target_platlib</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">worker_lib</span><span class="p">))</span>

            <span class="c1"># Copy the file while preserving metadata.</span>
            <span class="n">destination_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">destination</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">destination_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># create directory if missing</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="n">worker_lib</span><span class="p">,</span> <span class="n">destination</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>

        <span class="k">return</span>

    <span class="nd">@staticmethod</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_build_lib_remote</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        workers init</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># worker</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">AGI</span><span class="o">.</span><span class="n">_dask_client</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">open</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="n">AGI</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">runners</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">AGI</span><span class="o">.</span><span class="n">_dask_client</span><span class="o">.</span><span class="n">scheduler_info</span><span class="p">()[</span><span class="s2">&quot;workers&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;warning: no scheduler found but requested mode is dask=1 =&gt; switch to dask&quot;</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_run_local</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Returns:</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">env</span> <span class="o">=</span> <span class="n">AGI</span><span class="o">.</span><span class="n">env</span>
        <span class="n">env</span><span class="o">.</span><span class="n">has_rapids_hw</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">envars</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;127.0.0.1&quot;</span><span class="p">,</span> <span class="s2">&quot;HAS_RAPIDS_HW&quot;</span><span class="p">)</span>

        <span class="c1"># check first that install is done</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">wenv_abs</span> <span class="o">/</span> <span class="s2">&quot;.venv&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Worker installlation not found&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">pid_file</span> <span class="o">=</span> <span class="s2">&quot;dask_worker_0.pid&quot;</span>
        <span class="n">current_pid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">pid_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">current_pid</span><span class="p">))</span>

        <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_kill</span><span class="p">(</span><span class="n">current_pid</span><span class="o">=</span><span class="n">current_pid</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_mode</span> <span class="o">&amp;</span> <span class="n">AGI</span><span class="o">.</span><span class="n">CYTHON_MODE</span><span class="p">:</span>
            <span class="n">wenv_abs</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">wenv_abs</span>
            <span class="n">cython_lib_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">wenv_abs</span><span class="p">)</span>

            <span class="c1"># Look for any files or directories in the Cython lib path that match the &quot;*cy*&quot; pattern.</span>
            <span class="n">cython_libs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">cython_lib_path</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*cy*&quot;</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">cython_libs</span><span class="p">:</span>
                <span class="n">lib_path</span> <span class="o">=</span> <span class="n">normalize_path</span><span class="p">(</span><span class="n">cython_libs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="c1"># else:</span>
            <span class="c1">#     AGI._build_lib_local()</span>

        <span class="k">if</span> <span class="n">env</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
            <span class="n">BaseWorker</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">app</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">AGI</span><span class="o">.</span><span class="n">_mode</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">AGI</span><span class="o">.</span><span class="n">verbose</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">AGI</span><span class="o">.</span><span class="n">_args</span><span class="p">)</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">BaseWorker</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">AGI</span><span class="o">.</span><span class="n">workers</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">AGI</span><span class="o">.</span><span class="n">_mode</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">AGI</span><span class="o">.</span><span class="n">verbose</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">AGI</span><span class="o">.</span><span class="n">_args</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">env</span><span class="o">.</span><span class="n">uv</span><span class="si">}</span><span class="s2"> run --project </span><span class="si">{</span><span class="n">env</span><span class="o">.</span><span class="n">wenv_abs</span><span class="si">}</span><span class="s2"> python -c </span><span class="se">\&quot;</span><span class="s2">from agi_manager import  BaseWorker;&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;from dask.distributed import print;&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;BaseWorker.new(&#39;</span><span class="si">{</span><span class="n">env</span><span class="o">.</span><span class="n">app</span><span class="si">}</span><span class="s2">&#39;, mode=</span><span class="si">{</span><span class="n">AGI</span><span class="o">.</span><span class="n">_mode</span><span class="si">}</span><span class="s2">, verbose=</span><span class="si">{</span><span class="n">AGI</span><span class="o">.</span><span class="n">verbose</span><span class="si">}</span><span class="s2">, args=</span><span class="si">{</span><span class="n">AGI</span><span class="o">.</span><span class="n">_args</span><span class="si">}</span><span class="s2">);&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;res = BaseWorker.run(</span><span class="si">{</span><span class="n">AGI</span><span class="o">.</span><span class="n">workers</span><span class="si">}</span><span class="s2">, mode=</span><span class="si">{</span><span class="n">AGI</span><span class="o">.</span><span class="n">_mode</span><span class="si">}</span><span class="s2">, verbose=</span><span class="si">{</span><span class="n">AGI</span><span class="o">.</span><span class="n">verbose</span><span class="si">}</span><span class="s2">, args=</span><span class="si">{</span><span class="n">AGI</span><span class="o">.</span><span class="n">_args</span><span class="si">}</span><span class="s2">);&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;print(res)</span><span class="se">\&quot;</span><span class="s2">&quot;</span>
            <span class="p">)</span>

            <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">AgiEnv</span><span class="o">.</span><span class="n">run_async</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">env</span><span class="o">.</span><span class="n">wenv_abs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">res</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">res</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">res_lines</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">res_lines</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">res</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">res</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>

    <span class="nd">@staticmethod</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_run_by_mode</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        workers run calibration and targets job</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">env</span> <span class="o">=</span> <span class="n">AGI</span><span class="o">.</span><span class="n">env</span>

        <span class="c1"># AGI distribute work on cluster</span>
        <span class="n">AGI</span><span class="o">.</span><span class="n">_dask_workers</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">worker</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">worker</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">AGI</span><span class="o">.</span><span class="n">_dask_client</span><span class="o">.</span><span class="n">scheduler_info</span><span class="p">()[</span><span class="s2">&quot;workers&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="p">]</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AGI run mode=</span><span class="si">{</span><span class="n">AGI</span><span class="o">.</span><span class="n">_mode</span><span class="si">}</span><span class="s2"> on </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">AGI</span><span class="o">.</span><span class="n">_dask_workers</span><span class="p">)</span><span class="si">}</span><span class="s2"> ... &quot;</span><span class="p">)</span>

        <span class="n">AGI</span><span class="o">.</span><span class="n">workers</span><span class="p">,</span> <span class="n">workers_tree</span><span class="p">,</span> <span class="n">workers_tree_info</span> <span class="o">=</span> <span class="n">WorkDispatcher</span><span class="o">.</span><span class="n">do_distrib</span><span class="p">(</span>
            <span class="n">AGI</span><span class="o">.</span><span class="n">_target_inst</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">AGI</span><span class="o">.</span><span class="n">workers</span>
        <span class="p">)</span>
        <span class="n">AGI</span><span class="o">.</span><span class="n">workers_tree</span> <span class="o">=</span> <span class="n">workers_tree</span>
        <span class="n">AGI</span><span class="o">.</span><span class="n">workers_tree_info</span> <span class="o">=</span> <span class="n">workers_tree_info</span>

        <span class="n">AGI</span><span class="o">.</span><span class="n">_scale_cluster</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_mode</span> <span class="o">==</span> <span class="n">AGI</span><span class="o">.</span><span class="n">INSTALL_MODE</span><span class="p">:</span>
            <span class="n">workers_tree</span>

        <span class="n">dask_workers</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">AGI</span><span class="o">.</span><span class="n">_dask_workers</span><span class="p">)</span>
        <span class="n">client</span> <span class="o">=</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_dask_client</span>

        <span class="n">AGI</span><span class="o">.</span><span class="n">_dask_client</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">client</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span>
                    <span class="n">BaseWorker</span><span class="o">.</span><span class="n">new</span><span class="p">,</span>
                    <span class="n">env</span><span class="o">.</span><span class="n">app</span><span class="p">,</span>
                    <span class="n">env</span><span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">env</span><span class="o">.</span><span class="n">debug</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="n">mode</span><span class="o">=</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_mode</span><span class="p">,</span>
                    <span class="n">verbose</span><span class="o">=</span><span class="n">AGI</span><span class="o">.</span><span class="n">verbose</span><span class="p">,</span>
                    <span class="n">worker_id</span><span class="o">=</span><span class="n">dask_workers</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">worker</span><span class="p">),</span>
                    <span class="n">worker</span><span class="o">=</span><span class="n">worker</span><span class="p">,</span>
                    <span class="n">args</span><span class="o">=</span><span class="n">AGI</span><span class="o">.</span><span class="n">_args</span><span class="p">,</span>
                    <span class="n">workers</span><span class="o">=</span><span class="p">[</span><span class="n">worker</span><span class="p">],</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">worker</span> <span class="ow">in</span> <span class="n">dask_workers</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_calibration</span><span class="p">()</span>

        <span class="n">t</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="n">AGI</span><span class="o">.</span><span class="n">_run_time</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
            <span class="n">BaseWorker</span><span class="o">.</span><span class="n">do_works</span><span class="p">,</span>
            <span class="n">workers_tree</span><span class="p">,</span>
            <span class="n">workers_tree_info</span><span class="p">,</span>
            <span class="n">workers</span><span class="o">=</span><span class="n">dask_workers</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">runtime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">env</span><span class="o">.</span><span class="n">mode2str</span><span class="p">(</span><span class="n">AGI</span><span class="o">.</span><span class="n">_mode</span><span class="p">)</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">runtime</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">env</span><span class="o">.</span><span class="n">mode2str</span><span class="p">(</span><span class="n">AGI</span><span class="o">.</span><span class="n">_mode</span><span class="p">)</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">runtime</span><span class="si">}</span><span class="s2">&quot;</span>

<div class="viewcode-block" id="AGI.main">
<a class="viewcode-back" href="../../agi-runner.html#agi_runner.agi_runner.AGI.main">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">scheduler</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="n">cond_clean</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">AGI</span><span class="o">.</span><span class="n">_jobs</span> <span class="o">=</span> <span class="n">bg</span><span class="o">.</span><span class="n">BackgroundJobManager</span><span class="p">()</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">AGI</span><span class="o">.</span><span class="n">_mode</span> <span class="o">&amp;</span> <span class="n">AGI</span><span class="o">.</span><span class="n">DEPLOYEMENT_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">AGI</span><span class="o">.</span><span class="n">SIMULATE_MODE</span><span class="p">:</span>
            <span class="c1"># case simulate mode #0b11xxxx</span>
            <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_run_local</span><span class="p">()</span>

        <span class="k">elif</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_mode</span> <span class="o">&gt;=</span> <span class="n">AGI</span><span class="o">.</span><span class="n">INSTALL_MODE</span><span class="p">:</span>
            <span class="c1"># case install modes</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_mode</span> <span class="o">&amp;</span> <span class="n">AGI</span><span class="o">.</span><span class="n">DASK_MODE</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_install_venv_cluster</span><span class="p">(</span><span class="n">scheduler</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">AGI</span><span class="o">.</span><span class="n">_clean_dirs_local</span><span class="p">()</span>

            <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_install</span><span class="p">(</span><span class="n">scheduler</span><span class="p">)</span>

            <span class="n">res</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t</span>

        <span class="k">elif</span> <span class="p">(</span><span class="n">AGI</span><span class="o">.</span><span class="n">_mode</span> <span class="o">&amp;</span> <span class="n">AGI</span><span class="o">.</span><span class="n">DEPLOYEMENT_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">AGI</span><span class="o">.</span><span class="n">SIMULATE_MODE</span><span class="p">:</span>
            <span class="c1"># case simulate mode #0b11xxxx</span>
            <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_run_local</span><span class="p">()</span>

        <span class="k">elif</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_mode</span> <span class="o">&amp;</span> <span class="n">AGI</span><span class="o">.</span><span class="n">DASK_MODE</span><span class="p">:</span>

            <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_start</span><span class="p">(</span><span class="n">scheduler</span><span class="p">)</span>

            <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_run_by_mode</span><span class="p">()</span>
            <span class="n">AGI</span><span class="o">.</span><span class="n">_update_model</span><span class="p">()</span>

            <span class="c1"># stop the cluster</span>
            <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_stop</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># case local run</span>
            <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_run_local</span><span class="p">()</span>

        <span class="n">AGI</span><span class="o">.</span><span class="n">_clean_job</span><span class="p">(</span><span class="n">cond_clean</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_sys_path_to_clean</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span></div>


    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_clean_job</span><span class="p">(</span><span class="n">cond_clean</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Args:</span>
<span class="sd">          cond_clean:</span>

<span class="sd">        Returns:</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># clean background job</span>
        <span class="k">if</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_jobs</span> <span class="ow">and</span> <span class="n">cond_clean</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">AGI</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="n">AGI</span><span class="o">.</span><span class="n">_jobs</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">devnull</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">,</span> <span class="n">redirect_stdout</span><span class="p">(</span><span class="n">f</span><span class="p">),</span> <span class="n">redirect_stderr</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
                    <span class="n">AGI</span><span class="o">.</span><span class="n">_jobs</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_scale_cluster</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Remove unnecessary workers&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_dask_workers</span><span class="p">:</span>
            <span class="n">nb_kept_workers</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">workers_to_remove</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">dask_worker</span> <span class="ow">in</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_dask_workers</span><span class="p">:</span>
                <span class="n">ip</span> <span class="o">=</span> <span class="n">dask_worker</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">ip</span> <span class="ow">in</span> <span class="n">AGI</span><span class="o">.</span><span class="n">workers</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">ip</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">nb_kept_workers</span><span class="p">:</span>
                        <span class="n">nb_kept_workers</span><span class="p">[</span><span class="n">ip</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">if</span> <span class="n">nb_kept_workers</span><span class="p">[</span><span class="n">ip</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">AGI</span><span class="o">.</span><span class="n">workers</span><span class="p">[</span><span class="n">ip</span><span class="p">]:</span>
                        <span class="n">workers_to_remove</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dask_worker</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">nb_kept_workers</span><span class="p">[</span><span class="n">ip</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">workers_to_remove</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dask_worker</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">workers_to_remove</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;unused workers: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">workers_to_remove</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">worker</span> <span class="ow">in</span> <span class="n">workers_to_remove</span><span class="p">:</span>
                    <span class="n">AGI</span><span class="o">.</span><span class="n">_dask_workers</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">worker</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_stop</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Stop the Dask workers and scheduler&quot;&quot;&quot;</span>
        <span class="n">env</span> <span class="o">=</span> <span class="n">AGI</span><span class="o">.</span><span class="n">env</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;stop Agi core&quot;</span><span class="p">)</span>

        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">AGI</span><span class="o">.</span><span class="n">_dask_client</span><span class="o">.</span><span class="n">scheduler_info</span><span class="p">()[</span><span class="s2">&quot;workers&quot;</span><span class="p">])</span> <span class="ow">and</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">AGI</span><span class="o">.</span><span class="n">TIMEOUT</span><span class="p">):</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">AGI</span><span class="o">.</span><span class="n">_dask_client</span><span class="o">.</span><span class="n">retire_workers</span><span class="p">()</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span>
                <span class="n">AGI</span><span class="o">.</span><span class="n">_mode_auto</span> <span class="ow">and</span> <span class="p">(</span><span class="n">AGI</span><span class="o">.</span><span class="n">_mode</span> <span class="o">==</span> <span class="mi">7</span> <span class="ow">or</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_mode</span> <span class="o">==</span> <span class="mi">15</span><span class="p">)</span>
        <span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_mode_auto</span><span class="p">:</span>
            <span class="n">AGI</span><span class="o">.</span><span class="n">_dask_client</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>

        <span class="k">await</span> <span class="n">AGI</span><span class="o">.</span><span class="n">close_all_connections</span><span class="p">()</span>


    <span class="nd">@staticmethod</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_calibration</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        balancer calibration</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">res_workers_info</span> <span class="o">=</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_dask_client</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">AGI</span><span class="o">.</span><span class="n">_dask_client</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
                    <span class="c1"># BaseWorker.get_logs_and_result,</span>
                    <span class="n">BaseWorker</span><span class="o">.</span><span class="n">get_worker_info</span><span class="p">,</span>
                    <span class="n">BaseWorker</span><span class="o">.</span><span class="n">worker_id</span><span class="p">,</span>
                    <span class="n">workers</span><span class="o">=</span><span class="n">AGI</span><span class="o">.</span><span class="n">_dask_workers</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="n">infos</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">res_workers_info</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">worker</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">info</span><span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">worker</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">info</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">infos</span><span class="p">[</span><span class="n">worker</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span>

        <span class="n">AGI</span><span class="o">.</span><span class="n">workers_info</span> <span class="o">=</span> <span class="n">infos</span>
        <span class="n">AGI</span><span class="o">.</span><span class="n">_capacity</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">workers_info</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">worker</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">AGI</span><span class="o">.</span><span class="n">workers_info</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">ipport</span> <span class="o">=</span> <span class="n">worker</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">infos</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">AGI</span><span class="o">.</span><span class="n">workers_info</span><span class="p">[</span><span class="n">worker</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
            <span class="n">infos</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">[</span><span class="n">AGI</span><span class="o">.</span><span class="n">workers</span><span class="p">[</span><span class="n">ipport</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]])</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">infos</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
            <span class="n">AGI</span><span class="o">.</span><span class="n">_capacity</span><span class="p">[</span><span class="n">ipport</span><span class="p">]</span> <span class="o">=</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_capacity_predictor</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">data</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">info</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_capacity</span><span class="p">[</span><span class="n">ipport</span><span class="p">]</span>
            <span class="n">workers_info</span><span class="p">[</span><span class="n">ipport</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span>

        <span class="n">AGI</span><span class="o">.</span><span class="n">workers_info</span> <span class="o">=</span> <span class="n">workers_info</span>
        <span class="n">cap_min</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">AGI</span><span class="o">.</span><span class="n">_capacity</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="n">workers_capacity</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">ipport</span><span class="p">,</span> <span class="n">pred_cap</span> <span class="ow">in</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_capacity</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">workers_capacity</span><span class="p">[</span><span class="n">ipport</span><span class="p">]</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">pred_cap</span> <span class="o">/</span> <span class="n">cap_min</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">AGI</span><span class="o">.</span><span class="n">_capacity</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="nb">sorted</span><span class="p">(</span><span class="n">workers_capacity</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_train_model</span><span class="p">(</span><span class="n">train_home</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;train the balancer model</span>

<span class="sd">        Args:</span>
<span class="sd">          train_home:</span>

<span class="sd">        Returns:</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data_file</span> <span class="o">=</span> <span class="n">train_home</span> <span class="o">/</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_capacity_data_file</span>
        <span class="k">if</span> <span class="n">data_file</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">balancer_csv</span> <span class="o">=</span> <span class="n">data_file</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="n">data_file</span><span class="p">)</span>

        <span class="n">schema</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;nb_workers&quot;</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Int64</span><span class="p">,</span>
            <span class="s2">&quot;ram_total&quot;</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Float64</span><span class="p">,</span>
            <span class="s2">&quot;ram_available&quot;</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Float64</span><span class="p">,</span>
            <span class="s2">&quot;cpu_count&quot;</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Float64</span><span class="p">,</span>  <span class="c1"># Assuming CPU count can be a float</span>
            <span class="s2">&quot;cpu_frequency&quot;</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Float64</span><span class="p">,</span>
            <span class="s2">&quot;network_speed&quot;</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Float64</span><span class="p">,</span>
            <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Float64</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># Read the CSV file with correct parameters</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
            <span class="n">balancer_csv</span><span class="p">,</span>
            <span class="n">has_header</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># Correctly identifies the header row</span>
            <span class="n">skip_rows_after_header</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>  <span class="c1"># Skips the next two rows after the header</span>
            <span class="n">schema_overrides</span><span class="o">=</span><span class="n">schema</span><span class="p">,</span>  <span class="c1"># Applies the defined schema</span>
            <span class="n">ignore_errors</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>  <span class="c1"># Set to True if you want to skip malformed rows</span>
        <span class="p">)</span>
        <span class="c1"># Get the list of column names</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span>

        <span class="c1"># Select all columns except the last one as features</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">columns</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

        <span class="c1"># Select the last column as the target variable</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">columns</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

        <span class="c1"># Split the data into training and testing sets</span>
        <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
            <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span>
        <span class="p">)</span>
        <span class="n">AGI</span><span class="o">.</span><span class="n">_capacity_predictor</span> <span class="o">=</span> <span class="n">RandomForestRegressor</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;AGI.balancer_train_mode - Accuracy of the prediction of the workers capacity = &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">AGI</span><span class="o">.</span><span class="n">_capacity_predictor</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span><span class="w"> </span><span class="n">y_test</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

        <span class="n">capacity_model</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">train_home</span><span class="p">,</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_capacity_model_file</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">capacity_model</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">AGI</span><span class="o">.</span><span class="n">_capacity_predictor</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_update_model</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;update the balancer model&quot;&quot;&quot;</span>
        <span class="n">workers_rt</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">balancer_cols</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;nb_workers&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ram_total&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ram_available&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cpu_count&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cpu_frequency&quot;</span><span class="p">,</span>
            <span class="s2">&quot;network_speed&quot;</span><span class="p">,</span>
            <span class="s2">&quot;label&quot;</span><span class="p">,</span>
        <span class="p">]</span>

        <span class="k">for</span> <span class="n">wrt</span> <span class="ow">in</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_run_time</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">wrt</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">return</span>

            <span class="n">worker</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">wrt</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">w</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">AGI</span><span class="o">.</span><span class="n">workers_info</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">w</span> <span class="o">==</span> <span class="n">worker</span><span class="p">:</span>
                    <span class="n">info</span><span class="p">[</span><span class="s2">&quot;run_time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">wrt</span><span class="p">[</span><span class="n">w</span><span class="p">]</span>
                    <span class="n">workers_rt</span><span class="p">[</span><span class="n">w</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span>

        <span class="n">current_state</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">workers_rt</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">worker</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">workers_rt</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">worker_cap</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span>  <span class="c1"># Capacité actuelle du mycode_wprker</span>
            <span class="n">worker_rt</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;run_time&quot;</span><span class="p">]</span>  <span class="c1"># Temps d&#39;exécution du mycode_worker</span>

            <span class="c1"># Calculer le delta de temps et mettre à jour la capacité pour chaque autre mycode_worker</span>
            <span class="k">for</span> <span class="n">other_worker</span><span class="p">,</span> <span class="n">other_data</span> <span class="ow">in</span> <span class="n">current_state</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">other_worker</span> <span class="o">!=</span> <span class="n">worker</span><span class="p">:</span>
                    <span class="n">other_rt</span> <span class="o">=</span> <span class="n">other_data</span><span class="p">[</span>
                        <span class="s2">&quot;run_time&quot;</span>
                    <span class="p">]</span>  <span class="c1"># Temps d&#39;exécution de l&#39;autre mycode_worker</span>
                    <span class="n">delta</span> <span class="o">=</span> <span class="n">worker_rt</span> <span class="o">-</span> <span class="n">other_rt</span>
                    <span class="n">workers_rt</span><span class="p">[</span><span class="n">worker</span><span class="p">][</span><span class="s2">&quot;label&quot;</span><span class="p">]</span> <span class="o">-=</span> <span class="p">(</span>
                            <span class="mf">0.1</span> <span class="o">*</span> <span class="n">worker_cap</span> <span class="o">*</span> <span class="n">delta</span> <span class="o">/</span> <span class="n">worker_rt</span> <span class="o">/</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">current_state</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">workers_rt</span><span class="p">[</span><span class="n">worker</span><span class="p">][</span><span class="s2">&quot;nb_workers&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
                        <span class="n">AGI</span><span class="o">.</span><span class="n">workers</span><span class="p">[</span><span class="n">worker</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span>
                    <span class="p">)</span>

        <span class="k">for</span> <span class="n">w</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">workers_rt</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">del</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;run_time&quot;</span><span class="p">]</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">balancer_cols</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">df</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="n">df</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;inf&quot;</span><span class="p">):</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">AGI</span><span class="o">.</span><span class="n">_capacity_data_file</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">df</span><span class="o">.</span><span class="n">write_csv</span><span class="p">(</span>
                        <span class="n">f</span><span class="p">,</span>
                        <span class="n">include_header</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">line_terminator</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">w</span><span class="si">}</span><span class="s2"> workers BaseWorker.do_works failed&quot;</span><span class="p">)</span>

        <span class="n">AGI</span><span class="o">.</span><span class="n">_train_model</span><span class="p">(</span><span class="n">AGI</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">home_abs</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_exec_bg</span><span class="p">(</span><span class="n">cmd</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">cwd</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Execute background command</span>
<span class="sd">        Args:</span>
<span class="sd">            cmd: the command to be run</span>
<span class="sd">            cwd: the current working directory</span>

<span class="sd">        Returns:</span>
<span class="sd">            &quot;&quot;&quot;</span>
        <span class="n">AGI</span><span class="o">.</span><span class="n">_jobs</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;subprocess.Popen(cmd, shell=True)&quot;</span><span class="p">,</span> <span class="n">cwd</span><span class="o">=</span><span class="n">cwd</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_jobs</span><span class="o">.</span><span class="n">result</span><span class="p">(</span><span class="mi">0</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;running </span><span class="si">{</span><span class="n">cmd</span><span class="si">}</span><span class="s2"> at </span><span class="si">{</span><span class="n">cwd</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="AGI.get_ssh_connection">
<a class="viewcode-back" href="../../agi-runner.html#agi_runner.agi_runner.AGI.get_ssh_connection">[docs]</a>
    <span class="nd">@asynccontextmanager</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_ssh_connection</span><span class="p">(</span><span class="n">ip</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">timeout_sec</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">):</span>

        <span class="n">env</span> <span class="o">=</span> <span class="n">AGI</span><span class="o">.</span><span class="n">env</span>
        <span class="k">if</span> <span class="n">AgiEnv</span><span class="o">.</span><span class="n">is_local</span><span class="p">(</span><span class="n">ip</span><span class="p">):</span>
            <span class="n">env</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">getpass</span><span class="o">.</span><span class="n">getuser</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">env</span><span class="o">.</span><span class="n">user</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;SSH username is not configured. Please set &#39;user&#39; in your .env file.&quot;</span><span class="p">)</span>

        <span class="n">conn</span> <span class="o">=</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_ssh_connections</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">conn</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">conn</span><span class="o">.</span><span class="n">is_closed</span><span class="p">():</span>
            <span class="k">yield</span> <span class="n">conn</span>
            <span class="k">return</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">ssh_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;~/.ssh&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">ssh_dir</span><span class="o">.</span><span class="n">iterdir</span><span class="p">():</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">file</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
                    <span class="k">continue</span>

                <span class="n">name</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">name</span>
                <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;authorized_keys&#39;</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;known_hosts&#39;</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;id_&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.pub&#39;</span><span class="p">):</span>
                    <span class="k">continue</span>

                <span class="n">keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">file</span><span class="p">))</span>

            <span class="n">client_keys</span> <span class="o">=</span> <span class="n">keys</span> <span class="k">if</span> <span class="n">keys</span> <span class="k">else</span> <span class="kc">None</span>

            <span class="n">conn</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">wait_for</span><span class="p">(</span>
                <span class="n">asyncssh</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
                    <span class="n">ip</span><span class="p">,</span>
                    <span class="n">username</span><span class="o">=</span><span class="n">env</span><span class="o">.</span><span class="n">user</span><span class="p">,</span>
                    <span class="n">password</span><span class="o">=</span><span class="n">env</span><span class="o">.</span><span class="n">password</span><span class="p">,</span>
                    <span class="n">known_hosts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">client_keys</span><span class="o">=</span><span class="n">client_keys</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">timeout</span><span class="o">=</span><span class="n">timeout_sec</span>
            <span class="p">)</span>

            <span class="n">AGI</span><span class="o">.</span><span class="n">_ssh_connections</span><span class="p">[</span><span class="n">ip</span><span class="p">]</span> <span class="o">=</span> <span class="n">conn</span>
            <span class="k">yield</span> <span class="n">conn</span>

        <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">TimeoutError</span><span class="p">:</span>
            <span class="n">err_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Connection to </span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s2"> timed out after </span><span class="si">{</span><span class="n">timeout_sec</span><span class="si">}</span><span class="s2"> seconds.&quot;</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>
            <span class="k">raise</span>

        <span class="k">except</span> <span class="n">asyncssh</span><span class="o">.</span><span class="n">PermissionDenied</span><span class="p">:</span>
            <span class="n">err_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Authentication failed for SSH user &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="si">}</span><span class="s2">&#39; on host </span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>
            <span class="k">raise</span>

        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="n">errno</span><span class="o">.</span><span class="n">EHOSTUNREACH</span><span class="p">:</span>
                <span class="n">err_msg</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Unable to connect to </span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s2"> on SSH port 22. &quot;</span>
                    <span class="s2">&quot;Please check that the device is powered on, network cable connected, and SSH service running.&quot;</span>
                <span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ConnectionError</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span> <span class="ow">in</span> <span class="p">(</span><span class="n">errno</span><span class="o">.</span><span class="n">EACCES</span><span class="p">,</span> <span class="n">errno</span><span class="o">.</span><span class="n">ECONNREFUSED</span><span class="p">):</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="k">raise</span>

        <span class="k">except</span> <span class="n">asyncssh</span><span class="o">.</span><span class="n">Error</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">command</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="s1">&#39;command&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;No command attribute&quot;</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">raise</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected error while connecting to </span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span></div>


<div class="viewcode-block" id="AGI.exec_ssh">
<a class="viewcode-back" href="../../agi-runner.html#agi_runner.agi_runner.AGI.exec_ssh">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">exec_ssh</span><span class="p">(</span><span class="n">ip</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">cmd</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">async</span> <span class="k">with</span> <span class="n">AGI</span><span class="o">.</span><span class="n">get_ssh_connection</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s2">] </span><span class="si">{</span><span class="n">cmd</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">if</span> <span class="n">AgiEnv</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">AgiEnv</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">conn</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">stdout</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">stdout</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
                    <span class="n">stdout</span> <span class="o">=</span> <span class="n">stdout</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;replace&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">AgiEnv</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">AgiEnv</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s2">] </span><span class="si">{</span><span class="n">stdout</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">stdout</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="k">except</span> <span class="ne">ConnectionError</span><span class="p">:</span>
            <span class="k">raise</span>

        <span class="k">except</span> <span class="n">ProcessError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">stdout</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="s1">&#39;stdout&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">stderr</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="s1">&#39;stderr&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
                <span class="n">stdout</span> <span class="o">=</span> <span class="n">stdout</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;replace&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
                <span class="n">stderr</span> <span class="o">=</span> <span class="n">stderr</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;replace&#39;</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Remote command stderr: </span><span class="si">{</span><span class="n">stderr</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span>

        <span class="k">except</span> <span class="p">(</span><span class="n">asyncssh</span><span class="o">.</span><span class="n">Error</span><span class="p">,</span> <span class="ne">OSError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">raise</span></div>


<div class="viewcode-block" id="AGI.exec_ssh_async">
<a class="viewcode-back" href="../../agi-runner.html#agi_runner.agi_runner.AGI.exec_ssh_async">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">exec_ssh_async</span><span class="p">(</span><span class="n">ip</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">cmd</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Execute a remote command via SSH and return the last line of its stdout output.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">AGI</span><span class="o">.</span><span class="n">get_ssh_connection</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
            <span class="n">process</span> <span class="o">=</span> <span class="k">await</span> <span class="n">conn</span><span class="o">.</span><span class="n">create_process</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>

            <span class="c1"># Read entire stdout output as bytes</span>
            <span class="n">stdout</span> <span class="o">=</span> <span class="k">await</span> <span class="n">process</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="k">await</span> <span class="n">process</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>

            <span class="c1"># Decode output safely</span>
            <span class="c1">#stdout_str = stdout.decode(&#39;utf-8&#39;, errors=&#39;replace&#39;)</span>

            <span class="c1"># Split output into lines and get the last non-empty line</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">stdout</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span> <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
            <span class="k">if</span> <span class="n">lines</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">lines</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="s2">&quot;&quot;</span>  <span class="c1"># or None if no output</span></div>


<div class="viewcode-block" id="AGI.close_all_connections">
<a class="viewcode-back" href="../../agi-runner.html#agi_runner.agi_runner.AGI.close_all_connections">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">close_all_connections</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Ferme proprement toutes les connexions SSH ouvertes.</span>
<span class="sd">        À appeler à la fin de ton programme ou avant arrêt.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">conn</span> <span class="ow">in</span> <span class="n">AGI</span><span class="o">.</span><span class="n">_ssh_connections</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">await</span> <span class="n">conn</span><span class="o">.</span><span class="n">wait_closed</span><span class="p">()</span>
        <span class="n">AGI</span><span class="o">.</span><span class="n">_ssh_connections</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, THALES SIX GTS France SAS.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>